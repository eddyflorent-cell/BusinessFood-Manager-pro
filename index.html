<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BusinessFood Manager - Gestion Pro</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&family=Bebas+Neue&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Colors - Funky Bakery Theme */
            --primary: #FF6B35;
            --primary-dark: #E55A2B;
            --secondary: #4ECDC4;
            --accent: #FFE66D;
            --success: #26DE81;
            --danger: #FC5C65;
            --warning: #FFA502;
            --info: #45AAF2;
            
            /* Neutrals */
            --dark: #1A1A2E;
            --dark-light: #16213E;
            --gray: #8B8B8B;
            --light: #F8F9FA;
            --white: #FFFFFF;
            
            /* Gradients */
            --gradient-primary: linear-gradient(135deg, #FF6B35 0%, #FFE66D 100%);
            --gradient-dark: linear-gradient(135deg, #1A1A2E 0%, #16213E 100%);
            --gradient-success: linear-gradient(135deg, #26DE81 0%, #4ECDC4 100%);
            
            /* Shadows */
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.08);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.12);
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.16);
            --shadow-primary: 0 8px 24px rgba(255, 107, 53, 0.3);
            
            /* Typography */
            --font-display: 'Bebas Neue', sans-serif;
            --font-body: 'Poppins', sans-serif;
            
            /* Spacing */
            --space-xs: 0.5rem;
            --space-sm: 1rem;
            --space-md: 1.5rem;
            --space-lg: 2rem;
            --space-xl: 3rem;
            
            /* Border Radius */
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 20px;
            --radius-xl: 32px;
            
            /* Transitions */
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            font-family: var(--font-body);
            background: var(--light);
            color: var(--dark);
            overflow-x: hidden;
        }

        /* Layout */
        .app-container {
            display: grid;
            grid-template-columns: 280px 1fr;
            grid-template-rows: 70px 1fr;
            grid-template-areas:
                "sidebar header"
                "sidebar main";
            min-height: 100vh;
        }

        /* Header */
        .header {
            grid-area: header;
            background: var(--white);
            padding: 0 var(--space-lg);
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--shadow-sm);
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: var(--space-md);
        }

        .search-bar {
            position: relative;
            width: 400px;
        }

        .search-bar input {
            width: 100%;
            padding: 12px 20px 12px 48px;
            border: 2px solid transparent;
            background: var(--light);
            border-radius: var(--radius-lg);
            font-family: var(--font-body);
            font-size: 14px;
            transition: var(--transition);
        }

        .search-bar input:focus {
            outline: none;
            border-color: var(--primary);
            background: var(--white);
        }

        .search-bar::before {
            content: 'üîç';
            position: absolute;
            left: 18px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 18px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: var(--space-md);
        }

        /* Language & Currency Switcher */
        .switcher {
            display: flex;
            gap: var(--space-xs);
            background: var(--light);
            padding: 6px;
            border-radius: var(--radius-md);
        }

        .switcher button {
            padding: 8px 16px;
            border: none;
            background: transparent;
            border-radius: var(--radius-sm);
            font-family: var(--font-body);
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            transition: var(--transition);
            color: var(--gray);
        }

        .switcher button.active {
            background: var(--white);
            color: var(--primary);
            box-shadow: var(--shadow-sm);
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            padding: 8px 16px;
            background: var(--gradient-primary);
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow-primary);
        }

        .user-menu:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 32px rgba(255, 107, 53, 0.4);
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--white);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: var(--primary);
            font-size: 16px;
        }

        .user-name {
            color: var(--white);
            font-weight: 600;
            font-size: 14px;
        }

        /* Sidebar */
        .sidebar {
            grid-area: sidebar;
            background: var(--gradient-dark);
            padding: var(--space-lg);
            box-shadow: var(--shadow-lg);
            position: relative;
            overflow-y: auto;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            margin-bottom: var(--space-xl);
            padding-bottom: var(--space-lg);
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }

        .logo-icon {
            width: 48px;
            height: 48px;
            background: var(--gradient-primary);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
        }

        .logo-text {
            font-family: var(--font-display);
            font-size: 28px;
            color: var(--white);
            letter-spacing: 1px;
        }

        .nav-menu {
            list-style: none;
        }

        .nav-item {
            margin-bottom: var(--space-xs);
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            padding: 14px 18px;
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
            border-radius: var(--radius-md);
            transition: var(--transition);
            font-weight: 500;
            font-size: 15px;
            position: relative;
        }

        .nav-link:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--white);
            transform: translateX(4px);
        }

        .nav-link.active {
            background: var(--gradient-primary);
            color: var(--white);
            box-shadow: var(--shadow-primary);
        }

        .nav-link.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 70%;
            background: var(--white);
            border-radius: 0 4px 4px 0;
        }

        .nav-icon {
            font-size: 22px;
            width: 28px;
            text-align: center;
        }

        .nav-badge {
            margin-left: auto;
            background: var(--danger);
            color: var(--white);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
        }

        /* Main Content */
        .main-content {
            grid-area: main;
            padding: var(--space-lg);
            overflow-y: auto;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .page-header {
            margin-bottom: var(--space-lg);
        }

        .page-title {
            font-family: var(--font-display);
            font-size: 48px;
            color: var(--dark);
            margin-bottom: var(--space-xs);
            letter-spacing: 1px;
        }

        .page-subtitle {
            color: var(--gray);
            font-size: 16px;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: var(--space-md);
            margin-bottom: var(--space-xl);
        }

        .stat-card {
            background: var(--white);
            padding: var(--space-lg);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            position: relative;
            overflow: hidden;
            transition: var(--transition);
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
        }

        .stat-card.primary::before {
            background: var(--gradient-primary);
        }

        .stat-card.success::before {
            background: var(--gradient-success);
        }

        .stat-card.warning::before {
            background: linear-gradient(135deg, #FFA502 0%, #FFE66D 100%);
        }

        .stat-card.danger::before {
            background: linear-gradient(135deg, #FC5C65 0%, #FF6B35 100%);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-sm);
        }

        .stat-label {
            color: var(--gray);
            font-size: 14px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-icon {
            font-size: 32px;
            opacity: 0.3;
        }

        .stat-value {
            font-size: 36px;
            font-weight: 800;
            color: var(--dark);
            margin-bottom: var(--space-xs);
        }

        .stat-change {
            display: flex;
            align-items: center;
            gap: var(--space-xs);
            font-size: 13px;
            font-weight: 600;
        }

        .stat-change.positive {
            color: var(--success);
        }

        .stat-change.negative {
            color: var(--danger);
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: var(--radius-md);
            font-family: var(--font-body);
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: var(--space-xs);
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: var(--white);
            box-shadow: var(--shadow-primary);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 32px rgba(255, 107, 53, 0.4);
        }

        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-md);
            margin-bottom: var(--space-xl);
        }

        .action-card {
            background: var(--white);
            padding: var(--space-lg);
            border-radius: var(--radius-lg);
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            border: 2px solid transparent;
        }

        .action-card:hover {
            border-color: var(--primary);
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .action-icon {
            font-size: 48px;
            margin-bottom: var(--space-sm);
        }

        .action-title {
            font-weight: 600;
            font-size: 16px;
            color: var(--dark);
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .app-container {
                grid-template-columns: 1fr;
                grid-template-areas:
                    "header"
                    "main";
            }

            .sidebar {
                position: fixed;
                left: -280px;
                top: 0;
                height: 100vh;
                z-index: 1000;
                transition: var(--transition);
            }

            .sidebar.open {
                left: 0;
            }
        }

        /* Loading Animation */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: var(--space-xl);
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--light);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Hidden class */
        .hidden {
            display: none !important;
        }

        /* Ingredients Module Styles */
        .ingredient-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            box-shadow: var(--shadow-sm);
            transition: var(--transition);
            border: 2px solid transparent;
        }
        
        .ingredient-card:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow-md);
            transform: translateY(-4px);
        }
        
        .ingredient-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--space-md);
            padding-bottom: var(--space-md);
            border-bottom: 2px solid var(--light);
        }
        
        .ingredient-name {
            font-weight: 700;
            font-size: 18px;
            color: var(--dark);
            margin-bottom: 4px;
        }
        
        .ingredient-category {
            display: inline-block;
            background: var(--light);
            color: var(--gray);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .alert-badge {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }
        
        .alert-badge.warning {
            background: #FFF3CD;
        }
        
        .alert-badge.danger {
            background: #F8D7DA;
        }
        
        .ingredient-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--space-sm);
            margin-bottom: var(--space-md);
        }
        
        .stat-item {
            display: flex;
            flex-direction: column;
        }
        
        .stat-label {
            font-size: 11px;
            text-transform: uppercase;
            color: var(--gray);
            font-weight: 600;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        
        .stat-value {
            font-size: 16px;
            font-weight: 700;
            color: var(--dark);
        }
        
        .text-danger {
            color: var(--danger) !important;
        }
        
        .ingredient-alerts {
            margin-bottom: var(--space-md);
        }
        
        .alert-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: var(--radius-sm);
            font-size: 13px;
            margin-bottom: 6px;
        }
        
        .alert-item.warning {
            background: #FFF3CD;
            color: #856404;
        }
        
        .alert-item.error {
            background: #F8D7DA;
            color: #721C24;
        }
        
        .alert-more {
            font-size: 12px;
            color: var(--gray);
            text-align: center;
            margin-top: 4px;
        }
        
        .ingredient-actions {
            display: flex;
            gap: 8px;
        }
        
        .action-btn {
            flex: 1;
            padding: 10px;
            border: 2px solid var(--light);
            background: white;
            border-radius: var(--radius-md);
            font-size: 18px;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .action-btn:hover {
            border-color: var(--primary);
            background: var(--light);
            transform: scale(1.05);
        }
        
        /* Progress bar */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--light);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--success);
            transition: width 0.3s ease;
        }
        
        .progress-fill.low {
            background: var(--warning);
        }
        
        .progress-fill.exhausted {
            background: var(--gray);
        }
        
        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }
        
        .modal-content {
            background: white;
            border-radius: var(--radius-xl);
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }
        
        .modal-header {
            padding: var(--space-lg);
            border-bottom: 2px solid var(--light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 {
            font-family: var(--font-display);
            font-size: 28px;
            margin: 0;
        }
        
        .modal-close {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background: var(--light);
            font-size: 20px;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .modal-close:hover {
            background: var(--danger);
            color: white;
        }
        
        .modal-body {
            padding: var(--space-lg);
        }
        
        .form-group {
            margin-bottom: var(--space-md);
        }
        
        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--dark);
            font-size: 14px;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--light);
            border-radius: var(--radius-md);
            font-family: var(--font-body);
            font-size: 14px;
            transition: var(--transition);
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-md);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes slideOut {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(100px);
            }
        }
        
        /* Print styles for recipes */
        @media print {
            /* Hide everything except recipe modal */
            body > *:not(.modal) {
                display: none !important;
            }
            
            /* Show only recipe modal */
            .modal {
                position: static !important;
                background: white !important;
                padding: 0 !important;
            }
            
            .modal-content {
                box-shadow: none !important;
                max-width: 100% !important;
                margin: 0 !important;
                border: none !important;
            }
            
            /* Hide buttons and close */
            .modal-close,
            .modal-footer,
            .ingredient-actions,
            button {
                display: none !important;
            }
            
            /* Recipe title */
            .modal-header {
                border: none !important;
                padding: 20px 0 !important;
            }
            
            .modal-header h2 {
                font-size: 24pt !important;
                margin: 0 !important;
            }
            
            /* Recipe content */
            .modal-body {
                padding: 0 !important;
            }
            
            /* Stats cards */
            .stat-card {
                break-inside: avoid;
                page-break-inside: avoid;
                border: 1px solid #ddd !important;
                padding: 10px !important;
            }
            
            /* Ingredients table */
            table {
                width: 100% !important;
                border-collapse: collapse !important;
                margin: 20px 0 !important;
            }
            
            table th,
            table td {
                border: 1px solid #ddd !important;
                padding: 8px !important;
                text-align: left !important;
            }
            
            table th {
                background-color: #f5f5f5 !important;
                font-weight: bold !important;
            }
            
            /* Instructions */
            pre {
                white-space: pre-wrap !important;
                font-family: Arial, sans-serif !important;
                font-size: 11pt !important;
                line-height: 1.6 !important;
                page-break-inside: avoid !important;
            }
            
            /* Page breaks */
            h3 {
                page-break-after: avoid !important;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo">
                <div class="logo-icon">üçû</div>
                <span class="logo-text" data-i18n="app_name">BUSINESSFOOD</span>
            </div>

            <nav>
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a href="#" class="nav-link active" data-page="dashboard">
                            <span class="nav-icon">üìä</span>
                            <span data-i18n="dashboard">Dashboard</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-page="ingredients">
                            <span class="nav-icon">üì¶</span>
                            <span data-i18n="ingredients">Ingr√©dients</span>
                            <span class="nav-badge" id="ingredientsAlertBadge"></span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-page="recipes">
                            <span class="nav-icon">üìã</span>
                            <span data-i18n="recipes">Recettes</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-page="packs">
                            <span class="nav-icon">üéÅ</span>
                            <span>Packs</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-page="production">
                            <span class="nav-icon">‚öôÔ∏è</span>
                            <span data-i18n="production">Production</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-page="sales">
                            <span class="nav-icon">üí∞</span>
                            <span data-i18n="sales">Ventes</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-page="expenses">
                            <span class="nav-icon">üí∏</span>
                            <span data-i18n="expenses">D√©penses</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-page="suppliers">
                            <span class="nav-icon">üöö</span>
                            <span data-i18n="suppliers">Fournisseurs</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-page="personnel">
                            <span class="nav-icon">üë•</span>
                            <span data-i18n="personnel">Personnel</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-page="clients">
                            <span class="nav-icon">üë§</span>
                            <span data-i18n="clients">Clients</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-page="settings">
                            <span class="nav-icon">‚öôÔ∏è</span>
                            <span data-i18n="settings">Param√®tres</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </aside>

        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <div class="search-bar">
                    <input type="text" data-i18n-placeholder="search_placeholder" placeholder="Rechercher...">
                </div>
            </div>

            <div class="header-right">
                <!-- Demo Mode Button -->
                <button class="btn" style="background: var(--warning); color: var(--dark); font-weight: 700;" onclick="loadDemoData()">
                    üé≠ Mode D√©mo
                </button>
                
                <!-- Language Switcher -->
                <div class="switcher">
                    <button class="active" data-lang="fr">üá´üá∑ FR</button>
                    <button data-lang="en">üá¨üáß EN</button>
                </div>

                <!-- Currency Switcher -->
                <div class="switcher">
                    <button class="active" data-currency="XAF">FCFA</button>
                    <button data-currency="EUR">‚Ç¨</button>
                    <button data-currency="USD">$</button>
                </div>

                <!-- User Menu -->
                <div class="user-menu">
                    <div class="user-avatar">FG</div>
                    <span class="user-name">Fotsi</span>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content" id="mainContent">
            <!-- Dashboard will be loaded here -->
        </main>
    </div>

    <script type="module">
        // Import CORE services
        import { IngredientService } from './src/core/services/IngredientService.js';
        import { RecipeService } from './src/core/services/RecipeService.js';
        import { SaleService } from './src/core/services/SaleService.js';
        import { DashboardService } from './src/core/services/DashboardService.js';
        import { ExpenseService } from './src/core/services/ExpenseService.js';
        import { StorageManager } from './src/core/data/StorageManager.js';
        
        // Import CORE models
        import { Ingredient } from './src/core/models/Ingredient.js';
        import { Lot } from './src/core/models/Lot.js';
        import { Recipe, RecipeIngredient } from './src/core/models/Recipe.js';
        import { Production, UsedLot } from './src/core/models/Production.js';
        import { Sale, SaleItem } from './src/core/models/Sale.js';
        import { Expense } from './src/core/models/Expense.js';
        import { Pack, PackItem } from './src/core/models/Pack.js';
        
        // Import DEMO DATA
        import { demoWESalon } from './src/demo-we-salon.js';
        
        // Make classes available globally for demo data conversion and loadData
        window.Ingredient = Ingredient;
        window.Lot = Lot;
        window.Recipe = Recipe;
        window.RecipeIngredient = RecipeIngredient;
        window.Production = Production;
        window.UsedLot = UsedLot;
        window.Sale = Sale;
        window.SaleItem = SaleItem;
        window.Expense = Expense;
        window.Pack = Pack;
        window.PackItem = PackItem;
        
        // ========================================
        // DEMO DATA (inline)
        // ========================================
        
        const demoData = {
            categories: [
                { id: 'cat_1', name: 'C√©r√©ales & Farines', parent: null },
                { id: 'cat_1_1', name: 'Bl√©', parent: 'C√©r√©ales & Farines' },
                { id: 'cat_1_2', name: 'Ma√Øs', parent: 'C√©r√©ales & Farines' },
                { id: 'cat_2', name: 'Sucres & √âdulcorants', parent: null },
                { id: 'cat_2_1', name: 'Sucres blancs', parent: 'Sucres & √âdulcorants' },
                { id: 'cat_2_2', name: 'Sucres bruns', parent: 'Sucres & √âdulcorants' },
                { id: 'cat_3', name: 'Mati√®res grasses', parent: null },
                { id: 'cat_3_1', name: 'Beurres', parent: 'Mati√®res grasses' },
                { id: 'cat_3_2', name: 'Huiles', parent: 'Mati√®res grasses' },
                { id: 'cat_4', name: 'Produits laitiers', parent: null },
                { id: 'cat_4_1', name: 'Lait', parent: 'Produits laitiers' },
                { id: 'cat_4_2', name: '≈íufs', parent: 'Produits laitiers' },
                { id: 'cat_5', name: 'Additifs & Levures', parent: null },
                { id: 'cat_5_1', name: 'Levures', parent: 'Additifs & Levures' },
                { id: 'cat_5_2', name: 'Sel', parent: 'Additifs & Levures' },
                { id: 'cat_6', name: 'Chocolats & Cacao', parent: null },
                { id: 'cat_6_1', name: 'Cacao poudre', parent: 'Chocolats & Cacao' }
            ],
            
            ingredients: [
                {
                    id: 'ing_1',
                    name: 'Farine de bl√© T55',
                    category: 'Bl√©',
                    baseUnit: 'g',
                    displayUnit: 'kg',
                    alertBaseQty: 5000,
                    baseQtyRemaining: 23000,
                    stockValue: 69000,
                    lots: [{
                        id: 'lot_1_1',
                        quantiteInitiale: 25000,
                        quantite: 23000,
                        prixTotal: 75000,
                        fraisApproche: 3000,
                        dlc: new Date('2026-07-15').toISOString(),
                        dateReception: new Date('2026-01-10').toISOString(),
                        fournisseur: 'Minoterie du Cameroun',
                        numeroLot: 'MCF-2026-001',
                        epuise: false
                    }],
                    alerts: [],
                    createdAt: new Date('2026-01-10').toISOString(),
                    updatedAt: new Date('2026-01-17').toISOString()
                },
                {
                    id: 'ing_2',
                    name: 'Farine de bl√© T65',
                    category: 'Bl√©',
                    baseUnit: 'g',
                    displayUnit: 'kg',
                    alertBaseQty: 3000,
                    baseQtyRemaining: 8500,
                    stockValue: 30600,
                    lots: [{
                        id: 'lot_2_1',
                        quantiteInitiale: 10000,
                        quantite: 8500,
                        prixTotal: 32000,
                        fraisApproche: 2000,
                        dlc: new Date('2026-07-20').toISOString(),
                        dateReception: new Date('2026-01-12').toISOString(),
                        fournisseur: 'Minoterie du Cameroun',
                        numeroLot: 'MCF-2026-002',
                        epuise: false
                    }],
                    alerts: [],
                    createdAt: new Date('2026-01-12').toISOString(),
                    updatedAt: new Date('2026-01-17').toISOString()
                },
                {
                    id: 'ing_3',
                    name: 'Sucre cristallis√©',
                    category: 'Sucres blancs',
                    baseUnit: 'g',
                    displayUnit: 'kg',
                    alertBaseQty: 5000,
                    baseQtyRemaining: 18300,
                    stockValue: 13176,
                    lots: [{
                        id: 'lot_3_1',
                        quantiteInitiale: 25000,
                        quantite: 18300,
                        prixTotal: 18000,
                        fraisApproche: 0,
                        dlc: new Date('2028-01-15').toISOString(),
                        dateReception: new Date('2026-01-05').toISOString(),
                        fournisseur: 'SOSUCAM',
                        numeroLot: 'SSC-2026-A12',
                        epuise: false
                    }],
                    alerts: [],
                    createdAt: new Date('2026-01-05').toISOString(),
                    updatedAt: new Date('2026-01-17').toISOString()
                },
                {
                    id: 'ing_4',
                    name: 'Beurre doux 82%',
                    category: 'Beurres',
                    baseUnit: 'g',
                    displayUnit: 'kg',
                    alertBaseQty: 2000,
                    baseQtyRemaining: 3200,
                    stockValue: 22400,
                    lots: [{
                        id: 'lot_4_1',
                        quantiteInitiale: 5000,
                        quantite: 3200,
                        prixTotal: 35000,
                        fraisApproche: 2000,
                        dlc: new Date('2026-04-15').toISOString(),
                        dateReception: new Date('2026-01-15').toISOString(),
                        fournisseur: 'Laiterie Centrale',
                        numeroLot: 'LC-BTR-2026-18',
                        epuise: false
                    }],
                    createdAt: new Date('2026-01-15').toISOString(),
                    updatedAt: new Date('2026-01-17').toISOString()
                },
                {
                    id: 'ing_5',
                    name: 'Lait entier liquide',
                    category: 'Lait',
                    baseUnit: 'ml',
                    displayUnit: 'L',
                    alertBaseQty: 3000,
                    baseQtyRemaining: 6800,
                    stockValue: 4080,
                    lots: [{
                        id: 'lot_5_1',
                        quantiteInitiale: 10000,
                        quantite: 6800,
                        prixTotal: 6000,
                        fraisApproche: 500,
                        dlc: new Date('2026-01-25').toISOString(),
                        dateReception: new Date('2026-01-18').toISOString(),
                        fournisseur: 'Laiterie Centrale',
                        numeroLot: 'LC-LAIT-2026-20',
                        epuise: false
                    }],
                    createdAt: new Date('2026-01-18').toISOString(),
                    updatedAt: new Date('2026-01-18').toISOString()
                },
                {
                    id: 'ing_6',
                    name: '≈íufs frais calibre L',
                    category: '≈íufs',
                    baseUnit: 'piece',
                    displayUnit: 'piece',
                    alertBaseQty: 20,
                    baseQtyRemaining: 38,
                    stockValue: 5700,
                    lots: [{
                        id: 'lot_6_1',
                        quantiteInitiale: 60,
                        quantite: 38,
                        prixTotal: 9000,
                        fraisApproche: 0,
                        dlc: new Date('2026-02-08').toISOString(),
                        dateReception: new Date('2026-01-18').toISOString(),
                        fournisseur: 'Ferme Avicole du Sud',
                        numeroLot: 'FAS-OEUFS-2026-15',
                        epuise: false
                    }],
                    alerts: [],
                    createdAt: new Date('2026-01-18').toISOString(),
                    updatedAt: new Date('2026-01-18').toISOString()
                },
                {
                    id: 'ing_7',
                    name: 'Levure fra√Æche',
                    category: 'Levures',
                    baseUnit: 'g',
                    displayUnit: 'g',
                    alertBaseQty: 200,
                    baseQtyRemaining: 320,
                    stockValue: 1600,
                    lots: [{
                        id: 'lot_7_1',
                        quantiteInitiale: 500,
                        quantite: 320,
                        prixTotal: 2500,
                        fraisApproche: 0,
                        dlc: new Date('2026-02-02').toISOString(),
                        dateReception: new Date('2026-01-18').toISOString(),
                        fournisseur: 'Lesaffre Cameroun',
                        numeroLot: 'LES-LF-2026-08',
                        epuise: false
                    }],
                    createdAt: new Date('2026-01-18').toISOString(),
                    updatedAt: new Date('2026-01-18').toISOString()
                }
            ],
            
            recipes: [],
            productions: [],
            sales: [],
            expenses: [],
            vendors: [],
            staff: []
        };
        
        // ========================================
        // DEMO MODE
        // ========================================
        
        // Load demo data
        window.loadDemoData = function() {
            if (!confirm('‚ö†Ô∏è Charger les donn√©es de d√©monstration ?\n\nCela remplacera toutes les donn√©es actuelles par un jeu de donn√©es complet pour une boulangerie.')) {
                return;
            }
            
            try {
                console.log('üé≠ Loading demo data...');
                console.log('window.Ingredient exists?', !!window.Ingredient);
                console.log('window.Ingredient.fromJSON exists?', !!(window.Ingredient && window.Ingredient.fromJSON));
                
                // Load demo data and convert to proper class instances
                appState.data.categories = demoData.categories;
                
                // Convert ingredients JSON to Ingredient instances
                appState.data.ingredients = demoData.ingredients.map((ingData, index) => {
                    try {
                        const Ingredient = window.Ingredient;
                        if (Ingredient && Ingredient.fromJSON) {
                            const ingredient = Ingredient.fromJSON(ingData);
                            console.log(`‚úÖ Ingredient ${index} converted:`, ingredient.name, 'has getPriceTotal?', typeof ingredient.getPriceTotal);
                            return ingredient;
                        } else {
                            console.error('‚ùå Ingredient class not available!');
                            return ingData;
                        }
                    } catch (err) {
                        console.error('‚ùå Error converting ingredient:', err, ingData);
                        return ingData;
                    }
                });
                
                console.log('‚úÖ Ingredients converted:', appState.data.ingredients.length);
                console.log('First ingredient:', appState.data.ingredients[0]);
                
                appState.data.recipes = demoData.recipes || [];
                appState.data.productions = demoData.productions || [];
                appState.data.sales = demoData.sales || [];
                appState.data.expenses = demoData.expenses || [];
                appState.data.vendors = demoData.vendors || [];
                appState.data.staff = demoData.staff || [];
                
                // Save to storage
                saveData();
                
                // Refresh current page
                showPage(appState.currentPage);
                
                showToast('üé≠ Mode D√©mo activ√© ! ' + demoData.ingredients.length + ' ingr√©dients charg√©s', 'success');
                
            } catch (error) {
                console.error('Erreur chargement d√©mo:', error);
                showToast('‚ùå Erreur: ' + error.message, 'error');
            }
        };
        
        // ========================================
        // I18N & TRANSLATIONS
        // ========================================

        // i18n Translations
        const translations = {
            fr: {
                app_name: 'BUSINESSFOOD',
                dashboard: 'Tableau de bord',
                ingredients: 'Ingr√©dients',
                recipes: 'Recettes',
                production: 'Production',
                sales: 'Ventes',
                expenses: 'D√©penses',
                suppliers: 'Fournisseurs',
                personnel: 'Personnel',
                clients: 'Clients',
                settings: 'Param√®tres',
                search_placeholder: 'Rechercher...',
                welcome: 'Bienvenue',
                today_overview: 'Aper√ßu d\'aujourd\'hui',
                total_revenue: 'Chiffre d\'affaires',
                total_margin: 'Marge brute',
                stock_value: 'Valeur stock',
                alerts: 'Alertes',
                quick_actions: 'Actions rapides',
                add_ingredient: 'Ajouter ingr√©dient',
                new_recipe: 'Nouvelle recette',
                record_sale: 'Enregistrer vente',
                add_expense: 'Ajouter d√©pense'
            },
            en: {
                app_name: 'BUSINESSFOOD',
                dashboard: 'Dashboard',
                ingredients: 'Ingredients',
                recipes: 'Recipes',
                production: 'Production',
                sales: 'Sales',
                expenses: 'Expenses',
                suppliers: 'Suppliers',
                personnel: 'Staff',
                clients: 'Clients',
                settings: 'Settings',
                search_placeholder: 'Search...',
                welcome: 'Welcome',
                today_overview: 'Today\'s overview',
                total_revenue: 'Total Revenue',
                total_margin: 'Gross Margin',
                stock_value: 'Stock Value',
                alerts: 'Alerts',
                quick_actions: 'Quick Actions',
                add_ingredient: 'Add ingredient',
                new_recipe: 'New recipe',
                record_sale: 'Record sale',
                add_expense: 'Add expense'
            }
        };

        // Currency Formats
        const currencyFormats = {
            XAF: { symbol: 'FCFA', position: 'after', decimals: 0, separator: ' ' },
            EUR: { symbol: '‚Ç¨', position: 'after', decimals: 2, separator: ',' },
            USD: { symbol: '$', position: 'before', decimals: 2, separator: ',' },
            GBP: { symbol: '¬£', position: 'before', decimals: 2, separator: ',' }
        };
        
        // Taux de change (base: FCFA)
        const exchangeRates = {
            XAF: 1,           // 1 FCFA = 1 FCFA
            EUR: 655.96,      // 1 EUR = 655.96 FCFA
            USD: 600,         // 1 USD = 600 FCFA
            GBP: 800          // 1 GBP = 800 FCFA
        };
        
        // Convertir montant de FCFA vers devise cible
        function convertCurrency(amountInXAF, targetCurrency) {
            if (targetCurrency === 'XAF') return amountInXAF;
            return amountInXAF / exchangeRates[targetCurrency];
        }
        
        // Convertir montant de devise source vers FCFA
        function convertToXAF(amount, sourceCurrency) {
            if (sourceCurrency === 'XAF') return amount;
            return amount * exchangeRates[sourceCurrency];
        }

        // App State
        const appState = {
            currentLang: 'fr',
            currentCurrency: 'XAF',
            currentPage: 'dashboard',
            data: {
                ingredients: [],
                recipes: [],
                productions: [],
                sales: [],
                expenses: [],
                packs: [],
                staff: [],
                categories: [
                    // Cat√©gories par d√©faut
                    { id: 'cat1', name: 'Farines', parent: null },
                    { id: 'cat2', name: 'Farine T55', parent: 'Farines' },
                    { id: 'cat3', name: 'Farine T65', parent: 'Farines' },
                    { id: 'cat4', name: 'Sucres', parent: null },
                    { id: 'cat5', name: 'Sucre blanc', parent: 'Sucres' },
                    { id: 'cat6', name: 'Sucre roux', parent: 'Sucres' },
                    { id: 'cat7', name: 'Mati√®res grasses', parent: null },
                    { id: 'cat8', name: 'Oeufs & Lait', parent: null },
                    { id: 'cat9', name: 'Additifs', parent: null }
                ]
            },
            customDlcFilter: null
        };

        // Load data from StorageManager
        function loadData() {
            const saved = StorageManager.load();
            if (saved) {
                // Convert ingredients back to class instances
                if (saved.ingredients && window.Ingredient && window.Ingredient.fromJSON) {
                    saved.ingredients = saved.ingredients.map(ing => {
                        try {
                            return window.Ingredient.fromJSON(ing);
                        } catch (err) {
                            console.error('Error converting ingredient on load:', err);
                            return ing;
                        }
                    });
                }
                
                // Convert recipes back to class instances
                if (saved.recipes && window.Recipe && window.Recipe.fromJSON) {
                    saved.recipes = saved.recipes.map(recipe => {
                        try {
                            return window.Recipe.fromJSON(recipe);
                        } catch (err) {
                            console.error('Error converting recipe on load:', err);
                            return recipe;
                        }
                    });
                }
                
                // Convert productions back to class instances
                if (saved.productions && window.Production && window.Production.fromJSON) {
                    saved.productions = saved.productions.map(prod => {
                        try {
                            return window.Production.fromJSON(prod);
                        } catch (err) {
                            console.error('Error converting production on load:', err);
                            return prod;
                        }
                    });
                }
                
                // Convert sales back to class instances
                if (saved.sales && window.Sale && window.Sale.fromJSON) {
                    saved.sales = saved.sales.map(sale => {
                        try {
                            return window.Sale.fromJSON(sale);
                        } catch (err) {
                            console.error('Error converting sale on load:', err);
                            return sale;
                        }
                    });
                }
                
                // Convert expenses back to class instances
                if (saved.expenses && window.Expense && window.Expense.fromJSON) {
                    saved.expenses = saved.expenses.map(expense => {
                        try {
                            return window.Expense.fromJSON(expense);
                        } catch (err) {
                            console.error('Error converting expense on load:', err);
                            return expense;
                        }
                    });
                }
                
                // Convert packs back to class instances
                if (saved.packs && window.Pack && window.Pack.fromJSON) {
                    saved.packs = saved.packs.map(pack => {
                        try {
                            return window.Pack.fromJSON(pack);
                        } catch (err) {
                            console.error('Error converting pack on load:', err);
                            return pack;
                        }
                    });
                }
                
                appState.data = saved;
            }
        }

        // Save data to StorageManager
        function saveData() {
            StorageManager.save(appState.data);
        }

        // i18n Translation function
        function t(key) {
            return translations[appState.currentLang][key] || key;
        }

        // Update UI translations
        function updateTranslations() {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                el.textContent = t(key);
            });

            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                el.placeholder = t(key);
            });
        }

        // Format currency
        function formatCurrency(amount) {
            // Tous les montants sont stock√©s en FCFA
            // On convertit selon la devise s√©lectionn√©e
            const convertedAmount = convertCurrency(amount, appState.currentCurrency);
            const format = currencyFormats[appState.currentCurrency];
            const value = convertedAmount.toFixed(format.decimals).replace('.', format.separator);
            
            if (format.position === 'before') {
                return `${format.symbol}${value}`;
            } else {
                return `${value} ${format.symbol}`;
            }
        }
        
        // Format date FR (JJ/MM/AAAA)
        function formatDateFR(date) {
            const d = date instanceof Date ? date : new Date(date);
            const day = String(d.getDate()).padStart(2, '0');
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const year = d.getFullYear();
            return `${day}/${month}/${year}`;
        }

        // Render Dashboard
        function renderDashboard() {
            const stats = DashboardService.getDashboardStats(appState.data);

            const html = `
                <div class="page-header">
                    <h1 class="page-title" data-i18n="welcome">${t('welcome')}</h1>
                    <p class="page-subtitle" data-i18n="today_overview">${t('today_overview')}</p>
                </div>

                <div class="stats-grid">
                    <div class="stat-card primary">
                        <div class="stat-header">
                            <span class="stat-label" data-i18n="total_revenue">${t('total_revenue')}</span>
                            <span class="stat-icon">üí∞</span>
                        </div>
                        <div class="stat-value">${formatCurrency(stats.sales.revenue)}</div>
                        <div class="stat-change positive">
                            <span>‚Üó</span>
                            <span>+12.5%</span>
                        </div>
                    </div>

                    <div class="stat-card success">
                        <div class="stat-header">
                            <span class="stat-label" data-i18n="total_margin">${t('total_margin')}</span>
                            <span class="stat-icon">üìà</span>
                        </div>
                        <div class="stat-value">${formatCurrency(stats.sales.margin)}</div>
                        <div class="stat-change positive">
                            <span>‚Üó</span>
                            <span>+8.2%</span>
                        </div>
                    </div>

                    <div class="stat-card warning">
                        <div class="stat-header">
                            <span class="stat-label" data-i18n="stock_value">${t('stock_value')}</span>
                            <span class="stat-icon">üì¶</span>
                        </div>
                        <div class="stat-value">${formatCurrency(stats.stock.total)}</div>
                        <div class="stat-change negative">
                            <span>‚Üò</span>
                            <span>-3.1%</span>
                        </div>
                    </div>

                    <div class="stat-card danger">
                        <div class="stat-header">
                            <span class="stat-label" data-i18n="alerts">${t('alerts')}</span>
                            <span class="stat-icon">‚ö†Ô∏è</span>
                        </div>
                        <div class="stat-value">${stats.alerts.length}</div>
                        <div class="stat-change">
                            <span>Requires attention</span>
                        </div>
                    </div>
                </div>

                <h2 style="font-family: var(--font-display); font-size: 32px; margin-bottom: var(--space-md);" data-i18n="quick_actions">${t('quick_actions')}</h2>
                <div class="quick-actions">
                    <div class="action-card" onclick="showPage('ingredients')">
                        <div class="action-icon">üì¶</div>
                        <div class="action-title" data-i18n="add_ingredient">${t('add_ingredient')}</div>
                    </div>
                    <div class="action-card" onclick="showPage('recipes')">
                        <div class="action-icon">üìã</div>
                        <div class="action-title" data-i18n="new_recipe">${t('new_recipe')}</div>
                    </div>
                    <div class="action-card" onclick="showPage('production')">
                        <div class="action-icon">‚öôÔ∏è</div>
                        <div class="action-title" data-i18n="new_production">${t('new_production')}</div>
                    </div>
                    <div class="action-card" onclick="showPage('sales')">
                        <div class="action-icon">üí∞</div>
                        <div class="action-title" data-i18n="record_sale">${t('record_sale')}</div>
                    </div>
                    <div class="action-card" onclick="showPage('expenses')">
                        <div class="action-icon">üí∏</div>
                        <div class="action-title" data-i18n="add_expense">${t('add_expense')}</div>
                    </div>
                    <div class="action-card" onclick="loadDemoWE()" style="border: 2px dashed var(--primary);">
                        <div class="action-icon">üßá</div>
                        <div class="action-title">D√©mo W.E Salon</div>
                    </div>
                </div>
            `;

            document.getElementById('mainContent').innerHTML = html;
            updateTranslations();
        }

        // ========================================
        // MODULE INGR√âDIENTS
        // ========================================
        
        // Render Ingredients Page
        function renderIngredientsPage() {
            const ingredients = appState.data.ingredients || [];
            
            const html = `
                <div class="page-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h1 class="page-title" data-i18n="ingredients">Ingr√©dients</h1>
                            <p class="page-subtitle">${ingredients.length} ingr√©dients ‚Ä¢ ${(() => {
                                const count = getAlertsCount();
                                return count === 0 ? 'Aucune alerte' : count === 1 ? '1 alerte' : count + ' alertes';
                            })()}</p>
                        </div>
                        <button class="btn btn-primary" onclick="showAddIngredientModal()">
                            <span>‚ûï</span>
                            <span data-i18n="add_ingredient">Ajouter ingr√©dient</span>
                        </button>
                    </div>
                </div>

                <!-- Filters -->
                <div style="background: white; padding: var(--space-md); border-radius: var(--radius-lg); margin-bottom: var(--space-md); box-shadow: var(--shadow-sm);">
                    <div style="display: flex; gap: var(--space-md); flex-wrap: wrap; align-items: flex-end;">
                        <div style="flex: 1; min-width: 250px;">
                            <input type="text" id="searchIngredients" placeholder="üîç Rechercher..." 
                                style="width: 100%; padding: 12px 20px; border: 2px solid var(--light); border-radius: var(--radius-md); font-family: var(--font-body);">
                        </div>
                        
                        <div style="flex: 1; min-width: 200px;">
                            <label style="display: block; font-size: 12px; font-weight: 600; color: var(--gray); margin-bottom: 6px;">Cat√©gorie</label>
                            <select id="filterCategory" style="width: 100%; padding: 12px 20px; border: 2px solid var(--light); border-radius: var(--radius-md); font-family: var(--font-body);">
                                <option value="">Toutes cat√©gories</option>
                                ${getCategoriesOptions()}
                            </select>
                        </div>
                        
                        <div style="flex: 1; min-width: 200px;">
                            <label style="display: block; font-size: 12px; font-weight: 600; color: var(--gray); margin-bottom: 6px;">Alerte Stock</label>
                            <select id="filterAlert" style="width: 100%; padding: 12px 20px; border: 2px solid var(--light); border-radius: var(--radius-md); font-family: var(--font-body);">
                                <option value="">Tous les stocks</option>
                                <option value="low">Stock bas uniquement</option>
                            </select>
                        </div>
                        
                        <div style="flex: 1; min-width: 200px;">
                            <label style="display: block; font-size: 12px; font-weight: 600; color: var(--gray); margin-bottom: 6px;">Filtre DLC</label>
                            <select id="filterDlcType" style="width: 100%; padding: 12px 20px; border: 2px solid var(--light); border-radius: var(--radius-md); font-family: var(--font-body);">
                                <option value="">Toutes DLC</option>
                                <option value="expired">DLC d√©pass√©e</option>
                                <option value="7days">DLC < 7 jours</option>
                                <option value="30days">DLC < 30 jours</option>
                                <option value="custom">P√©riode personnalis√©e</option>
                                <option value="date">Date pr√©cise</option>
                            </select>
                        </div>
                        
                        <button class="btn" style="background: var(--secondary); color: white;" onclick="showCategoryManager()">
                            ‚öôÔ∏è G√©rer cat√©gories
                        </button>
                    </div>
                    
                    <!-- Custom DLC Filters (hidden by default) -->
                    <div id="customDlcFilters" class="hidden" style="margin-top: var(--space-md); padding-top: var(--space-md); border-top: 2px solid var(--light);">
                        <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: var(--space-md);">
                            <div>
                                <label style="display: block; font-size: 12px; font-weight: 600; color: var(--gray); margin-bottom: 6px;">Du</label>
                                <input type="date" id="dlcFrom" style="width: 100%; padding: 12px 16px; border: 2px solid var(--light); border-radius: var(--radius-md); font-family: var(--font-body);">
                            </div>
                            <div>
                                <label style="display: block; font-size: 12px; font-weight: 600; color: var(--gray); margin-bottom: 6px;">Au</label>
                                <input type="date" id="dlcTo" style="width: 100%; padding: 12px 16px; border: 2px solid var(--light); border-radius: var(--radius-md); font-family: var(--font-body);">
                            </div>
                            <button class="btn btn-primary" onclick="applyCustomDlcFilter()" style="align-self: flex-end;">
                                Appliquer
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Ingredients Grid -->
                <div id="ingredientsGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: var(--space-md);">
                    ${renderIngredientsCards(ingredients)}
                </div>

                <!-- Empty State -->
                ${ingredients.length === 0 ? `
                    <div style="text-align: center; padding: var(--space-xl); background: white; border-radius: var(--radius-lg); margin-top: var(--space-lg);">
                        <div style="font-size: 64px; margin-bottom: var(--space-md);">üì¶</div>
                        <h3 style="font-family: var(--font-display); font-size: 24px; margin-bottom: var(--space-sm);">Aucun ingr√©dient</h3>
                        <p style="color: var(--gray); margin-bottom: var(--space-md);">Commencez par ajouter votre premier ingr√©dient</p>
                        <button class="btn btn-primary" onclick="showAddIngredientModal()">
                            ‚ûï Ajouter un ingr√©dient
                        </button>
                    </div>
                ` : ''}

                <!-- Add Ingredient Modal -->
                <div id="addIngredientModal" class="modal hidden">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2 data-i18n="add_ingredient">Ajouter un ingr√©dient</h2>
                            <button class="modal-close" onclick="closeModal('addIngredientModal')">‚úï</button>
                        </div>
                        <div class="modal-body">
                            <form id="addIngredientForm">
                                <div class="form-group">
                                    <label>Nom de l'ingr√©dient *</label>
                                    <input type="text" name="name" required placeholder="Ex: Farine T55">
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Cat√©gorie</label>
                                        <select name="category">
                                            <option value="">Aucune cat√©gorie</option>
                                            ${getCategoriesOptions()}
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Unit√© de base *</label>
                                        <select name="baseUnit" required>
                                            <option value="g">Grammes (g)</option>
                                            <option value="ml">Millilitres (ml)</option>
                                            <option value="piece">Pi√®ces</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>Seuil d'alerte stock</label>
                                    <input type="number" name="alertQty" placeholder="Ex: 1000" min="0">
                                </div>
                                
                                <h3 style="margin-top: var(--space-lg); margin-bottom: var(--space-md); font-family: var(--font-display);">
                                    R√©ception du lot
                                </h3>
                                
                                <div class="form-group">
                                    <label>R√©ceptionnaire * <span style="color: var(--danger); font-weight: bold;">OBLIGATOIRE</span></label>
                                    <select name="lotReceivedBy" required>
                                        <option value="">Qui a r√©ceptionn√© ce lot ?</option>
                                        ${(appState.data.staff || []).filter(s => s.active).map(s => `
                                            <option value="${s.name}">${s.name} (${s.role})</option>
                                        `).join('')}
                                    </select>
                                    <small style="color: var(--gray);">Personne qui a v√©rifi√© et r√©ceptionn√© cette livraison (tra√ßabilit√© HACCP)</small>
                                </div>
                                
                                <h3 style="margin-top: var(--space-lg); margin-bottom: var(--space-md); font-family: var(--font-display);">
                                    Premier lot
                                </h3>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Quantit√© *</label>
                                        <input type="number" name="lotQuantity" required placeholder="Ex: 5000" min="0" step="0.01">
                                    </div>
                                    <div class="form-group">
                                        <label>Unit√© *</label>
                                        <select name="lotUnit" required>
                                            <option value="g">Grammes (g)</option>
                                            <option value="kg">Kilogrammes (kg)</option>
                                            <option value="ml">Millilitres (ml)</option>
                                            <option value="L">Litres (L)</option>
                                            <option value="piece">Pi√®ces</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Prix d'achat *</label>
                                        <input type="number" name="lotPrice" required placeholder="Ex: 5000" min="0" step="0.01">
                                    </div>
                                    <div class="form-group">
                                        <label>Frais d'approche</label>
                                        <input type="number" name="lotFees" placeholder="Ex: 500" min="0" step="0.01">
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>DLC *</label>
                                        <input type="date" name="lotDlc" required>
                                    </div>
                                    <div class="form-group">
                                        <label>Date r√©ception *</label>
                                        <input type="date" name="lotReception" required>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>Fournisseur</label>
                                    <input type="text" name="lotSupplier" placeholder="Nom du fournisseur">
                                </div>
                                <div class="form-group">
                                    <label>Num√©ro de lot</label>
                                    <input type="text" name="lotNumber" placeholder="Ex: LOT123456">
                                </div>
                                
                                <div style="display: flex; gap: var(--space-md); margin-top: var(--space-lg);">
                                    <button type="button" class="btn" style="flex: 1; background: var(--gray); color: white;" onclick="closeModal('addIngredientModal')">
                                        Annuler
                                    </button>
                                    <button type="submit" class="btn btn-primary" style="flex: 1;">
                                        ‚úÖ Ajouter
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- Category Manager Modal -->
                <div id="categoryManagerModal" class="modal hidden">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2>‚öôÔ∏è Gestion des Cat√©gories</h2>
                            <button class="modal-close" onclick="closeModal('categoryManagerModal')">‚úï</button>
                        </div>
                        <div class="modal-body">
                            <!-- Add New Category -->
                            <div style="background: var(--light); padding: var(--space-md); border-radius: var(--radius-md); margin-bottom: var(--space-lg);">
                                <h3 style="font-weight: 600; margin-bottom: var(--space-sm);">‚ûï Nouvelle cat√©gorie</h3>
                                <form id="addCategoryForm" style="display: flex; gap: var(--space-sm);">
                                    <input type="text" id="newCategoryName" placeholder="Nom de la cat√©gorie" required
                                        style="flex: 1; padding: 12px 16px; border: 2px solid white; border-radius: var(--radius-md); font-family: var(--font-body);">
                                    <input type="text" id="newCategoryParent" placeholder="Cat√©gorie parente (optionnel)"
                                        style="flex: 1; padding: 12px 16px; border: 2px solid white; border-radius: var(--radius-md); font-family: var(--font-body);">
                                    <button type="submit" class="btn btn-primary">Ajouter</button>
                                </form>
                            </div>
                            
                            <!-- Categories List -->
                            <h3 style="font-weight: 600; margin-bottom: var(--space-md);">üìã Cat√©gories existantes</h3>
                            <div id="categoriesList" style="max-height: 400px; overflow-y: auto;">
                                ${renderCategoriesList()}
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('mainContent').innerHTML = html;
            
            // Event listeners
            document.getElementById('searchIngredients')?.addEventListener('input', filterIngredients);
            document.getElementById('filterCategory')?.addEventListener('change', filterIngredients);
            document.getElementById('filterAlert')?.addEventListener('change', filterIngredients);
            document.getElementById('filterDlcType')?.addEventListener('change', handleDlcFilterChange);
            document.getElementById('addIngredientForm')?.addEventListener('submit', handleAddIngredient);
            document.getElementById('addCategoryForm')?.addEventListener('submit', handleAddCategory);
            
            // Set default dates
            const today = new Date().toISOString().split('T')[0];
            const receptionInput = document.querySelector('[name="lotReception"]');
            if (receptionInput) receptionInput.value = today;
            
            const futureDate = new Date();
            futureDate.setMonth(futureDate.getMonth() + 6);
            const dlcInput = document.querySelector('[name="lotDlc"]');
            if (dlcInput) dlcInput.value = futureDate.toISOString().split('T')[0];
            
            // Update sidebar badge
            updateAlertsBadge();
        }

        // Render Ingredients Cards
        function renderIngredientsCards(ingredients) {
            if (ingredients.length === 0) return '';
            
            return ingredients.map(ing => {
                // Appeler les m√©thodes pour calculer les valeurs
                const stock = ing.getBaseQtyRemaining ? ing.getBaseQtyRemaining() : (ing.baseQtyRemaining || 0);
                // ‚úÖ CORRECTION: Utiliser IngredientService pour calculer la valeur
                const stockValue = IngredientService.getStockValue(ing);
                const alerts = ing.getAlerts ? ing.getAlerts() : (ing.alerts || []);
                
                const hasLowStock = alerts.some(a => a.type === 'STOCK_LOW');
                const hasDlcIssue = alerts.some(a => a.type && a.type.includes('DLC'));
                
                return `
                    <div class="ingredient-card" data-ingredient-id="${ing.id}">
                        <div class="ingredient-header">
                            <div>
                                <h3 class="ingredient-name">${ing.name}</h3>
                                <span class="ingredient-category">${ing.category || 'Non class√©'}</span>
                            </div>
                            ${hasLowStock || hasDlcIssue ? `
                                <div class="alert-badge ${hasDlcIssue ? 'danger' : 'warning'}">
                                    ${hasDlcIssue ? 'üî¥' : '‚ö†Ô∏è'}
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="ingredient-stats">
                            <div class="stat-item">
                                <span class="stat-label">Stock</span>
                                <span class="stat-value ${hasLowStock ? 'text-danger' : ''}">${stock} ${ing.baseUnit}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Valeur</span>
                                <span class="stat-value">${formatCurrency(stockValue)}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Lots</span>
                                <span class="stat-value">${ing.lots?.length || 0}</span>
                            </div>
                        </div>
                        
                        ${alerts.length > 0 ? `
                            <div class="ingredient-alerts">
                                ${alerts.slice(0, 2).map(alert => `
                                    <div class="alert-item ${alert.severity}">
                                        <span>${alert.severity === 'error' ? 'üî¥' : '‚ö†Ô∏è'}</span>
                                        <span>${alert.message}</span>
                                    </div>
                                `).join('')}
                                ${alerts.length > 2 ? `<div class="alert-more">+${alerts.length - 2} autres</div>` : ''}
                            </div>
                        ` : ''}
                        
                        <div class="ingredient-actions">
                            <button class="action-btn" onclick="showIngredientDetails('${ing.id}')" title="D√©tails">
                                üëÅÔ∏è
                            </button>
                            <button class="action-btn" onclick="showAddLotModal('${ing.id}')" title="Ajouter lot">
                                ‚ûï
                            </button>
                            <button class="action-btn" onclick="showRecordLossModal('${ing.id}')" title="Enregistrer perte">
                                ‚ùå
                            </button>
                            <button class="action-btn" onclick="showInventoryModal('${ing.id}')" title="Inventaire">
                                üìä
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Get alerts count
        function getAlertsCount() {
            const ingredients = appState.data.ingredients || [];
            return ingredients.reduce((count, ing) => {
                // ‚úÖ TOUJOURS utiliser getAlerts() pour calcul dynamique
                if (typeof ing.getAlerts === 'function') {
                    const alerts = ing.getAlerts();
                    return count + alerts.length;
                }
                // Si pas de m√©thode, pas d'alertes
                return count;
            }, 0);
        }
        
        // Update alerts badge in sidebar
        function updateAlertsBadge() {
            const count = getAlertsCount();
            const badge = document.getElementById('ingredientsAlertBadge');
            if (badge) {
                if (count > 0) {
                    badge.textContent = count;
                    badge.style.display = 'inline-block';
                } else {
                    badge.style.display = 'none';
                }
            }
        }
        
        // ========================================
        // CATEGORIES MANAGEMENT
        // ========================================
        
        // Get categories as select options
        function getCategoriesOptions() {
            const categories = appState.data.categories || [];
            const mainCategories = categories.filter(c => !c.parent);
            
            let html = '';
            mainCategories.forEach(main => {
                html += `<optgroup label="${main.name}">`;
                html += `<option value="${main.name}">${main.name}</option>`;
                
                // Add subcategories
                const subs = categories.filter(c => c.parent === main.name);
                subs.forEach(sub => {
                    html += `<option value="${sub.name}">  ‚îî ${sub.name}</option>`;
                });
                
                html += '</optgroup>';
            });
            
            return html;
        }
        
        // ========================================
        // RECIPES PAGE
        // ========================================
        
        function renderRecipesPage() {
            const recipes = appState.data.recipes || [];
            
            const html = `
                <div class="page-header">
                    <h1 class="page-title">üìã Recettes</h1>
                    <button class="btn btn-primary" onclick="showCreateRecipeModal()">
                        ‚ûï Nouvelle Recette
                    </button>
                </div>

                <div class="filters-bar">
                    <input type="text" id="searchRecipes" placeholder="üîç Rechercher..." class="search-input">
                    
                    <select id="filterRecipeCategory" class="filter-select">
                        <option value="">Toutes cat√©gories</option>
                        <option value="Pain">Pain</option>
                        <option value="Viennoiserie">Viennoiserie</option>
                        <option value="P√¢tisserie">P√¢tisserie</option>
                    </select>
                </div>

                <div id="recipesGrid" class="ingredients-grid">
                    ${recipes.length === 0 ? `
                        <div class="empty-state">
                            <div class="empty-icon">üìã</div>
                            <h3>Aucune recette</h3>
                            <p>Cr√©ez votre premi√®re recette</p>
                            <button class="btn btn-primary" onclick="showCreateRecipeModal()">
                                ‚ûï Nouvelle Recette
                            </button>
                        </div>
                    ` : renderRecipeCards(recipes)}
                </div>
            `;
            
            document.getElementById('mainContent').innerHTML = html;
            
            document.getElementById('searchRecipes')?.addEventListener('input', filterRecipes);
            document.getElementById('filterRecipeCategory')?.addEventListener('change', filterRecipes);
        }

        // Render recipe cards
        function renderRecipeCards(recipes) {
            return recipes.map(recipe => {
                const capacity = RecipeService.calculateCapacity(recipe, appState.data.ingredients);
                
                return `
                    <div class="ingredient-card">
                        <div class="ingredient-header">
                            <div>
                                <h3 class="ingredient-name">${recipe.name}</h3>
                                <span class="ingredient-category">${recipe.category || 'Sans cat√©gorie'}</span>
                            </div>
                        </div>
                        
                        <div class="ingredient-stats">
                            <div class="stat-item">
                                <span class="stat-label">Rendement</span>
                                <span class="stat-value">${recipe.producedQty} ${recipe.producedUnit}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Ingr√©dients</span>
                                <span class="stat-value">${recipe.ingredients?.length || 0}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Fabricable</span>
                                <span class="stat-value">${capacity.batches} batch${capacity.batches > 1 ? 'es' : ''}</span>
                            </div>
                        </div>
                        
                        <div class="ingredient-actions">
                            <button class="action-btn" onclick="showRecipeDetails('${recipe.id}')" title="D√©tails">üëÅÔ∏è</button>
                            <button class="action-btn" onclick="editRecipe('${recipe.id}')" title="Modifier">‚úèÔ∏è</button>
                            <button class="action-btn" onclick="deleteRecipe('${recipe.id}')" title="Supprimer">üóëÔ∏è</button>
                            <button class="action-btn" onclick="alert('Produire - Bient√¥t')" title="Produire">‚öôÔ∏è</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ========================================
        // PRODUCTIONS PAGE
        // ========================================
        
        function renderProductionsPage() {
            const productions = appState.data.productions || [];
            
            let html = `
                <div class="page-container">
                    <div class="page-header">
                        <h1 class="page-title">‚öôÔ∏è Productions</h1>
                        <button class="btn btn-primary" onclick="showNewProductionModal()">
                            ‚ûï Nouvelle Production
                        </button>
                    </div>
                    
                    ${productions.length === 0 ? `
                        <div class="empty-state">
                            <div class="empty-icon">‚öôÔ∏è</div>
                            <h3>Aucune production</h3>
                            <p>Lancez votre premi√®re production pour commencer</p>
                            <button class="btn btn-primary" onclick="showNewProductionModal()">
                                ‚ûï Nouvelle Production
                            </button>
                        </div>
                    ` : `
                        <div class="filters-bar">
                            <input type="text" id="searchProductions" placeholder="üîç Rechercher..." class="search-input">
                            <select id="filterProductionRecipe" class="filter-select">
                                <option value="">Toutes les recettes</option>
                                ${[...new Set(productions.map(p => p.recipeName))].map(name => `
                                    <option value="${name}">${name}</option>
                                `).join('')}
                            </select>
                        </div>
                        
                        <div class="stats-grid" style="margin-bottom: var(--space-lg);">
                            <div class="stat-card primary">
                                <div class="stat-label">Productions</div>
                                <div class="stat-value">${productions.length}</div>
                            </div>
                            <div class="stat-card success">
                                <div class="stat-label">Produits finis</div>
                                <div class="stat-value">${productions.reduce((sum, p) => sum + p.producedQty, 0)}</div>
                            </div>
                            <div class="stat-card warning">
                                <div class="stat-label">Stock restant</div>
                                <div class="stat-value">${productions.reduce((sum, p) => sum + p.remainingQty, 0)}</div>
                            </div>
                            <div class="stat-card info">
                                <div class="stat-label">Valeur stock</div>
                                <div class="stat-value">${formatCurrency(DashboardService.getFinishedGoodsStockValue(productions))}</div>
                            </div>
                        </div>
                        
                        <div id="productionsListContainer" class="ingredients-list">
                            ${renderProductionCards(productions)}
                        </div>
                    `}
                </div>
            `;
            
            document.getElementById('mainContent').innerHTML = html;
            
            if (productions.length > 0) {
                document.getElementById('searchProductions')?.addEventListener('input', filterProductions);
                document.getElementById('filterProductionRecipe')?.addEventListener('change', filterProductions);
            }
        }
        
        // Render production cards
        function renderProductionCards(productions) {
            return productions.map(production => {
                const progressPercent = (production.remainingQty / production.producedQty) * 100;
                const status = production.remainingQty === 0 ? 'exhausted' : (progressPercent < 30 ? 'low' : 'ok');
                
                return `
                    <div class="ingredient-card">
                        <div class="ingredient-header">
                            <div>
                                <h3 class="ingredient-name">${production.recipeName}</h3>
                                <p class="ingredient-meta">
                                    Production du ${formatDateFR(production.productionDate)}
                                    ${production.operator ? ` ‚Ä¢ Par ${production.operator}` : ''}
                                </p>
                            </div>
                            <div class="ingredient-stock ${status}">
                                ${production.remainingQty} / ${production.producedQty} ${production.producedUnit}
                            </div>
                        </div>
                        
                        <div class="ingredient-stats">
                            <div class="stat-item">
                                <span class="stat-label">Multiplicateur</span>
                                <span class="stat-value">√ó${production.multiplier}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Co√ªt total</span>
                                <span class="stat-value">${formatCurrency(production.costTotal)}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Co√ªt unitaire</span>
                                <span class="stat-value">${formatCurrency(production.costPerUnit)}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Valeur restante</span>
                                <span class="stat-value">${formatCurrency(
                                    typeof production.getRemainingValue === 'function' 
                                        ? production.getRemainingValue() 
                                        : (production.remainingQty / production.producedQty) * production.costTotal
                                )}</span>
                            </div>
                        </div>
                        
                        <div class="progress-bar" style="margin-top: var(--space-md);">
                            <div class="progress-fill ${status}" style="width: ${progressPercent}%"></div>
                        </div>
                        
                        <div class="ingredient-actions">
                            <button class="action-btn" onclick="showProductionDetails('${production.id}')" title="D√©tails">üëÅÔ∏è</button>
                            ${production.remainingQty > 0 ? `
                                <button class="action-btn" onclick="alert('Vendre - Bient√¥t')" title="Vendre">üí∞</button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Filter productions
        function filterProductions() {
            const searchTerm = document.getElementById('searchProductions').value.toLowerCase();
            const recipeFilter = document.getElementById('filterProductionRecipe').value;
            
            let filtered = appState.data.productions || [];
            
            if (searchTerm) {
                filtered = filtered.filter(p => 
                    p.recipeName.toLowerCase().includes(searchTerm) ||
                    p.operator.toLowerCase().includes(searchTerm)
                );
            }
            
            if (recipeFilter) {
                filtered = filtered.filter(p => p.recipeName === recipeFilter);
            }
            
            document.getElementById('productionsListContainer').innerHTML = renderProductionCards(filtered);
        }
        
        // Show new production modal (placeholder)
        window.showNewProductionModal = function() {
            const recipes = appState.data.recipes || [];
            const ingredients = appState.data.ingredients || [];
            
            if (recipes.length === 0) {
                showToast('‚ùå Cr√©ez d\'abord une recette', 'error');
                return;
            }
            
            const modal = document.createElement('div');
            modal.id = 'newProductionModal';
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 900px;">
                    <div class="modal-header">
                        <h2>‚öôÔ∏è Nouvelle Production</h2>
                        <button class="modal-close" onclick="closeModal('newProductionModal')">‚úï</button>
                    </div>
                    <div class="modal-body">
                        <form id="newProductionForm">
                            <!-- S√©lection recette -->
                            <div class="form-group">
                                <label>Recette *</label>
                                <select name="recipeId" id="productionRecipeSelect" required onchange="updateProductionPreview()">
                                    <option value="">S√©lectionner une recette...</option>
                                    ${recipes.map(r => `<option value="${r.id}">${r.name} (${r.producedQty} ${r.producedUnit})</option>`).join('')}
                                </select>
                            </div>
                            
                            <!-- Multiplicateur -->
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Multiplicateur (batches) *</label>
                                    <div style="display: flex; gap: var(--space-md); align-items: center;">
                                        <input type="range" id="multiplierSlider" min="1" max="10" value="1" 
                                               oninput="updateMultiplierValue(); updateProductionPreview();" 
                                               style="flex: 1;">
                                        <input type="number" name="multiplier" id="multiplierInput" required 
                                               min="1" value="1" style="width: 80px;"
                                               oninput="updateMultiplierSlider(); updateProductionPreview();">
                                    </div>
                                    <small style="color: var(--gray);">1 batch = quantit√© de base de la recette</small>
                                </div>
                            </div>
                            
                            <!-- Informations optionnelles -->
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Op√©rateur * <span style="color: var(--danger); font-weight: bold;">OBLIGATOIRE</span></label>
                                    <select name="operator" required>
                                        <option value="">Qui produit ?</option>
                                        ${(appState.data.staff || []).filter(s => s.active).map(s => `
                                            <option value="${s.name}">${s.name} (${s.role})</option>
                                        `).join('')}
                                    </select>
                                    <small style="color: var(--gray);">Responsable de cette production (tra√ßabilit√© HACCP)</small>
                                </div>
                                <div class="form-group">
                                    <label>Notes</label>
                                    <input type="text" name="notes" placeholder="Notes de production">
                                </div>
                            </div>
                            
                            <hr style="margin: var(--space-lg) 0;">
                            
                            <!-- Pr√©visualisation -->
                            <div id="productionPreview">
                                <p style="text-align: center; color: var(--gray);">
                                    S√©lectionnez une recette pour voir la pr√©visualisation
                                </p>
                            </div>
                            
                            <!-- Boutons -->
                            <div style="display: flex; gap: var(--space-md); margin-top: var(--space-xl);">
                                <button type="button" class="btn" style="flex: 1; background: var(--gray); color: white;" onclick="closeModal('newProductionModal')">
                                    Annuler
                                </button>
                                <button type="submit" class="btn btn-primary" style="flex: 1;" id="produceButton" disabled>
                                    ‚öôÔ∏è Produire
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            document.getElementById('newProductionForm').addEventListener('submit', handleNewProduction);
        };
        
        // Update multiplier value from slider
        window.updateMultiplierValue = function() {
            const slider = document.getElementById('multiplierSlider');
            const input = document.getElementById('multiplierInput');
            input.value = slider.value;
        };
        
        // Update multiplier slider from input
        window.updateMultiplierSlider = function() {
            const slider = document.getElementById('multiplierSlider');
            const input = document.getElementById('multiplierInput');
            const value = Math.max(1, Math.min(100, Number(input.value) || 1));
            input.value = value;
            if (value <= 10) {
                slider.value = value;
            }
        };
        
        // Update production preview
        window.updateProductionPreview = function() {
            const recipeId = document.getElementById('productionRecipeSelect').value;
            const multiplier = Number(document.getElementById('multiplierInput').value) || 1;
            const preview = document.getElementById('productionPreview');
            const produceBtn = document.getElementById('produceButton');
            
            if (!recipeId) {
                preview.innerHTML = `
                    <p style="text-align: center; color: var(--gray);">
                        S√©lectionnez une recette pour voir la pr√©visualisation
                    </p>
                `;
                produceBtn.disabled = true;
                return;
            }
            
            const recipe = appState.data.recipes.find(r => r.id === recipeId);
            const ingredients = appState.data.ingredients || [];
            
            if (!recipe) {
                preview.innerHTML = '<p style="color: var(--danger);">‚ùå Recette introuvable</p>';
                produceBtn.disabled = true;
                return;
            }
            
            // Calculer capacit√©
            const capacity = RecipeService.calculateCapacity(recipe, ingredients);
            const canProduce = capacity.batches >= multiplier;
            
            // Calculer quantit√© totale produite
            const totalProduced = recipe.producedQty * multiplier;
            
            // Calculer co√ªt estim√©
            let totalCost = 0;
            const ingredientsList = recipe.ingredients.map(recipeIng => {
                const ing = ingredients.find(i => i.id === recipeIng.ingredientId);
                if (!ing) {
                    return {
                        name: recipeIng.ingredientName,
                        needed: recipeIng.baseQty * multiplier,
                        available: 0,
                        unit: recipeIng.baseUnit,
                        sufficient: false,
                        cost: 0
                    };
                }
                
                const needed = recipeIng.baseQty * multiplier;
                const available = ing.getBaseQtyRemaining ? ing.getBaseQtyRemaining() : 0;
                const costPerUnit = ing.getPricePerBaseUnit ? ing.getPricePerBaseUnit() : 0;
                const cost = needed * costPerUnit;
                totalCost += cost;
                
                return {
                    name: recipeIng.ingredientName,
                    needed,
                    available,
                    unit: recipeIng.baseUnit,
                    sufficient: available >= needed,
                    cost
                };
            });
            
            const unitCost = totalProduced > 0 ? totalCost / totalProduced : 0;
            
            // Afficher pr√©visualisation
            preview.innerHTML = `
                <div style="background: var(--light); padding: var(--space-md); border-radius: var(--radius-md); margin-bottom: var(--space-md);">
                    <h3 style="margin-bottom: var(--space-md);">üìä R√©sum√© Production</h3>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--space-md);">
                        <div>
                            <strong>Recette :</strong><br>
                            ${recipe.name}
                        </div>
                        <div>
                            <strong>Quantit√© produite :</strong><br>
                            ${totalProduced} ${recipe.producedUnit}
                        </div>
                        <div>
                            <strong>Multiplicateur :</strong><br>
                            √ó${multiplier} batch${multiplier > 1 ? 'es' : ''}
                        </div>
                        <div>
                            <strong>Co√ªt total :</strong><br>
                            ${formatCurrency(totalCost)}
                        </div>
                        <div>
                            <strong>Co√ªt unitaire :</strong><br>
                            ${formatCurrency(unitCost)}
                        </div>
                        <div>
                            <strong>Capacit√© max :</strong><br>
                            ${capacity.batches} batch${capacity.batches > 1 ? 'es' : ''}
                        </div>
                    </div>
                </div>
                
                <h3 style="margin-bottom: var(--space-md);">üì¶ Ingr√©dients n√©cessaires</h3>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead style="background: var(--light);">
                            <tr>
                                <th style="padding: 12px; text-align: left;">Ingr√©dient</th>
                                <th style="padding: 12px; text-align: right;">N√©cessaire</th>
                                <th style="padding: 12px; text-align: right;">Disponible</th>
                                <th style="padding: 12px; text-align: right;">Statut</th>
                                <th style="padding: 12px; text-align: right;">Co√ªt</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${ingredientsList.map(item => `
                                <tr style="border-bottom: 1px solid var(--light);">
                                    <td style="padding: 12px;">${item.name}</td>
                                    <td style="padding: 12px; text-align: right; font-weight: 600;">
                                        ${item.needed} ${item.unit}
                                    </td>
                                    <td style="padding: 12px; text-align: right; color: ${item.sufficient ? 'var(--success)' : 'var(--danger)'};">
                                        ${item.available} ${item.unit}
                                    </td>
                                    <td style="padding: 12px; text-align: right;">
                                        ${item.sufficient ? '‚úÖ OK' : '‚ö†Ô∏è INSUFFISANT'}
                                    </td>
                                    <td style="padding: 12px; text-align: right;">
                                        ${formatCurrency(item.cost)}
                                    </td>
                                </tr>
                            `).join('')}
                            <tr style="border-top: 2px solid var(--primary); font-weight: 600;">
                                <td colspan="4" style="padding: 12px; text-align: right;">TOTAL :</td>
                                <td style="padding: 12px; text-align: right; color: var(--primary);">
                                    ${formatCurrency(totalCost)}
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                ${!canProduce ? `
                    <div style="background: #FFF3CD; padding: var(--space-md); border-radius: var(--radius-md); margin-top: var(--space-md); border-left: 4px solid #FFA502;">
                        <h4 style="margin-bottom: var(--space-sm); color: #856404;">‚ö†Ô∏è Stock insuffisant</h4>
                        <p style="color: #856404; margin: 0;">
                            Vous ne pouvez produire que <strong>${capacity.batches} batch${capacity.batches > 1 ? 'es' : ''}</strong> 
                            avec le stock actuel${capacity.limitingIngredient ? ` (limit√© par: ${capacity.limitingIngredient})` : ''}.
                        </p>
                    </div>
                ` : `
                    <div style="background: #d4edda; padding: var(--space-md); border-radius: var(--radius-md); margin-top: var(--space-md); border-left: 4px solid #28a745;">
                        <p style="color: #155724; margin: 0;">
                            ‚úÖ <strong>Stock suffisant</strong> pour produire ${multiplier} batch${multiplier > 1 ? 'es' : ''} !
                        </p>
                    </div>
                `}
            `;
            
            produceBtn.disabled = !canProduce;
        };
        
        // Handle new production
        async function handleNewProduction(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const recipeId = formData.get('recipeId');
            const multiplier = Number(formData.get('multiplier'));
            const operator = formData.get('operator') || '';
            const notes = formData.get('notes') || '';
            
            // Validation op√©rateur obligatoire
            if (!operator) {
                showToast('‚ùå Op√©rateur obligatoire pour tra√ßabilit√© HACCP', 'error');
                return;
            }
            
            const recipe = appState.data.recipes.find(r => r.id === recipeId);
            if (!recipe) {
                showToast('‚ùå Recette introuvable', 'error');
                return;
            }
            
            try {
                // Produire avec RecipeService
                const result = RecipeService.produce(
                    recipe, 
                    appState.data.ingredients,
                    multiplier,
                    { operator, notes }
                );
                
                // Mettre √† jour les ingr√©dients
                result.ingredientUpdates.forEach(update => {
                    const index = appState.data.ingredients.findIndex(i => i.id === update.ingredientId);
                    if (index !== -1) {
                        appState.data.ingredients[index] = update.ingredient;
                    }
                });
                
                // Ajouter la production
                appState.data.productions.push(result.production);
                
                // Sauvegarder
                saveData();
                
                closeModal('newProductionModal');
                renderProductionsPage();
                
                showToast(`‚úÖ Production "${recipe.name}" cr√©√©e : ${result.production.producedQty} ${result.production.producedUnit}`, 'success');
                
            } catch (error) {
                console.error('Erreur production:', error);
                showToast('‚ùå Erreur: ' + error.message, 'error');
            }
        }
        
        // Show production details (placeholder)
        window.showProductionDetails = function(productionId) {
            showToast('üöß D√©tails production - En d√©veloppement', 'info');
        };

        // ========================================
        // SALES PAGE
        // ========================================
        
        function renderSalesPage() {
            const sales = appState.data.sales || [];
            const vendors = appState.data.vendors || [];
            
            // Calculate stats
            const totalRevenue = sales.reduce((sum, s) => sum + s.revenue, 0);
            const totalCOGS = sales.reduce((sum, s) => sum + s.cogs, 0);
            const totalMargin = totalRevenue - totalCOGS;
            const avgMarginPercent = totalRevenue > 0 ? (totalMargin / totalRevenue) * 100 : 0;
            const totalCommissions = sales.reduce((sum, s) => sum + s.commission, 0);
            
            let html = `
                <div class="page-container">
                    <div class="page-header">
                        <h1 class="page-title">üí∞ Ventes</h1>
                        <button class="btn btn-primary" onclick="showNewSaleModal()">
                            ‚ûï Nouvelle Vente
                        </button>
                    </div>
                    
                    ${sales.length === 0 ? `
                        <div class="empty-state">
                            <div class="empty-icon">üí∞</div>
                            <h3>Aucune vente</h3>
                            <p>Enregistrez votre premi√®re vente pour commencer</p>
                            <button class="btn btn-primary" onclick="showNewSaleModal()">
                                ‚ûï Nouvelle Vente
                            </button>
                        </div>
                    ` : `
                        <div class="filters-bar">
                            <input type="text" id="searchSales" placeholder="üîç Rechercher..." class="search-input">
                            <select id="filterSaleVendor" class="filter-select">
                                <option value="">Tous les vendeurs</option>
                                ${vendors.map(v => `
                                    <option value="${v.id}">${v.name}</option>
                                `).join('')}
                            </select>
                        </div>
                        
                        <div class="stats-grid" style="margin-bottom: var(--space-lg);">
                            <div class="stat-card success">
                                <div class="stat-label">Chiffre d'Affaires</div>
                                <div class="stat-value">${formatCurrency(totalRevenue)}</div>
                            </div>
                            <div class="stat-card warning">
                                <div class="stat-label">Co√ªt des Ventes</div>
                                <div class="stat-value">${formatCurrency(totalCOGS)}</div>
                            </div>
                            <div class="stat-card primary">
                                <div class="stat-label">Marge Brute</div>
                                <div class="stat-value">${formatCurrency(totalMargin)}</div>
                            </div>
                            <div class="stat-card info">
                                <div class="stat-label">Marge %</div>
                                <div class="stat-value">${avgMarginPercent.toFixed(1)}%</div>
                            </div>
                            <div class="stat-card secondary">
                                <div class="stat-label">Commissions</div>
                                <div class="stat-value">${formatCurrency(totalCommissions)}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Ventes</div>
                                <div class="stat-value">${sales.length}</div>
                            </div>
                        </div>
                        
                        <div id="salesListContainer" class="ingredients-list">
                            ${renderSaleCards(sales)}
                        </div>
                    `}
                </div>
            `;
            
            document.getElementById('mainContent').innerHTML = html;
            
            if (sales.length > 0) {
                document.getElementById('searchSales')?.addEventListener('input', filterSales);
                document.getElementById('filterSaleVendor')?.addEventListener('change', filterSales);
            }
        }
        
        // Render sale cards
        function renderSaleCards(sales) {
            return sales.map(sale => {
                const saleDate = sale.saleDate instanceof Date ? sale.saleDate : new Date(sale.saleDate);
                const marginPercent = sale.marginPercent || 0;
                const marginStatus = marginPercent > 30 ? 'success' : (marginPercent > 15 ? 'warning' : 'danger');
                
                return `
                    <div class="ingredient-card">
                        <div class="ingredient-header">
                            <div>
                                <h3 class="ingredient-name">Vente #${sale.id.substring(0, 8)}</h3>
                                <p class="ingredient-meta">
                                    ${formatDateFR(saleDate)}
                                    ${sale.vendorName ? ` ‚Ä¢ ${sale.vendorName}` : ''}
                                    ‚Ä¢ ${sale.items?.length || 0} produit${(sale.items?.length || 0) > 1 ? 's' : ''}
                                </p>
                            </div>
                            <div class="ingredient-stock ${marginStatus}">
                                ${formatCurrency(sale.revenue)}
                            </div>
                        </div>
                        
                        <div class="ingredient-stats">
                            <div class="stat-item">
                                <span class="stat-label">CA</span>
                                <span class="stat-value">${formatCurrency(sale.revenue)}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">COGS</span>
                                <span class="stat-value">${formatCurrency(sale.cogs)}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Marge</span>
                                <span class="stat-value">${formatCurrency(sale.margin)}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Marge %</span>
                                <span class="stat-value">${marginPercent.toFixed(1)}%</span>
                            </div>
                            ${sale.commission > 0 ? `
                                <div class="stat-item">
                                    <span class="stat-label">Commission</span>
                                    <span class="stat-value">${formatCurrency(sale.commission)}</span>
                                </div>
                            ` : ''}
                        </div>
                        
                        ${sale.items && sale.items.length > 0 ? `
                            <div style="margin-top: var(--space-md); padding-top: var(--space-md); border-top: 1px solid var(--light);">
                                <strong>Produits vendus :</strong>
                                <ul style="margin: var(--space-sm) 0 0 var(--space-md); padding: 0;">
                                    ${sale.items.map(item => `
                                        <li>${item.quantity} ${item.unit} ${item.itemName} @ ${formatCurrency(item.unitPrice)}</li>
                                    `).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        
                        <div class="ingredient-actions">
                            <button class="action-btn" onclick="showSaleDetails('${sale.id}')" title="D√©tails">üëÅÔ∏è</button>
                            <button class="action-btn" onclick="alert('Annuler - Bient√¥t')" title="Annuler">‚ùå</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Filter sales
        function filterSales() {
            const searchTerm = document.getElementById('searchSales').value.toLowerCase();
            const vendorFilter = document.getElementById('filterSaleVendor').value;
            
            let filtered = appState.data.sales || [];
            
            if (searchTerm) {
                filtered = filtered.filter(s => 
                    s.id.toLowerCase().includes(searchTerm) ||
                    s.vendorName.toLowerCase().includes(searchTerm) ||
                    s.items.some(item => item.itemName.toLowerCase().includes(searchTerm))
                );
            }
            
            if (vendorFilter) {
                filtered = filtered.filter(s => s.vendorId === vendorFilter);
            }
            
            document.getElementById('salesListContainer').innerHTML = renderSaleCards(filtered);
        }
        
        // Show new sale modal
        window.showNewSaleModal = function() {
            const productions = appState.data.productions?.filter(p => p.remainingQty > 0) || [];
            const vendors = appState.data.vendors || [];
            
            if (productions.length === 0) {
                showToast('‚ùå Aucun produit en stock. Cr√©ez d\'abord une production.', 'error');
                return;
            }
            
            const modal = document.createElement('div');
            modal.id = 'newSaleModal';
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 900px;">
                    <div class="modal-header">
                        <h2>üí∞ Nouvelle Vente</h2>
                        <button class="modal-close" onclick="closeModal('newSaleModal')">‚úï</button>
                    </div>
                    <div class="modal-body">
                        <form id="newSaleForm">
                            <!-- Production selection -->
                            <div class="form-group">
                                <label>Produit *</label>
                                <select id="saleProductSelect" required>
                                    <option value="">S√©lectionner un produit...</option>
                                    ${productions.map(p => `
                                        <option value="${p.id}" data-recipe-id="${p.recipeId}" data-recipe-name="${p.recipeName}" 
                                                data-unit="${p.producedUnit}" data-cost-per-unit="${p.costPerUnit}" 
                                                data-remaining="${p.remainingQty}">
                                            ${p.recipeName} (${p.remainingQty} ${p.producedUnit} dispo)
                                        </option>
                                    `).join('')}
                                </select>
                            </div>
                            
                            <!-- Quantity and price -->
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Quantit√© *</label>
                                    <input type="number" id="saleQuantity" required min="0.1" step="0.1" 
                                           placeholder="Quantit√©" oninput="updateSalePreview()">
                                    <small id="stockAvailable" style="color: var(--gray);"></small>
                                </div>
                                <div class="form-group">
                                    <label>Prix unitaire (FCFA) *</label>
                                    <input type="number" id="saleUnitPrice" required min="0" step="1" 
                                           placeholder="Prix de vente" oninput="updateSalePreview()">
                                    <small id="suggestedPrice" style="color: var(--info);"></small>
                                </div>
                            </div>
                            
                            <!-- Vendor selection -->
                            <div class="form-group">
                                <label>Vendeur</label>
                                <select id="saleVendorSelect" onchange="updateSalePreview()">
                                    <option value="">Aucun vendeur</option>
                                    ${vendors.map(v => `
                                        <option value="${v.id}" data-commission="${v.commissionRate}" data-name="${v.name}">
                                            ${v.name} (${v.commissionRate}% commission)
                                        </option>
                                    `).join('')}
                                </select>
                            </div>
                            
                            <!-- Notes -->
                            <div class="form-group">
                                <label>Notes</label>
                                <textarea id="saleNotes" rows="2" placeholder="Notes de vente (optionnel)"></textarea>
                            </div>
                            
                            <hr style="margin: var(--space-lg) 0;">
                            
                            <!-- Preview -->
                            <div id="salePreview">
                                <p style="text-align: center; color: var(--gray);">
                                    Remplissez les champs pour voir le r√©capitulatif
                                </p>
                            </div>
                            
                            <!-- Buttons -->
                            <div style="display: flex; gap: var(--space-md); margin-top: var(--space-xl);">
                                <button type="button" class="btn" style="flex: 1; background: var(--gray); color: white;" 
                                        onclick="closeModal('newSaleModal')">
                                    Annuler
                                </button>
                                <button type="submit" class="btn btn-primary" style="flex: 1;" id="sellButton" disabled>
                                    üí∞ Vendre
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Event listeners
            document.getElementById('saleProductSelect').addEventListener('change', updateSalePreview);
            document.getElementById('newSaleForm').addEventListener('submit', handleNewSale);
            
            updateSalePreview();
        };
        
        // Update sale preview
        window.updateSalePreview = function() {
            const productSelect = document.getElementById('saleProductSelect');
            const quantity = Number(document.getElementById('saleQuantity').value) || 0;
            const unitPrice = Number(document.getElementById('saleUnitPrice').value) || 0;
            const vendorSelect = document.getElementById('saleVendorSelect');
            const preview = document.getElementById('salePreview');
            const sellButton = document.getElementById('sellButton');
            
            const selectedOption = productSelect.options[productSelect.selectedIndex];
            const productId = productSelect.value;
            
            if (!productId) {
                preview.innerHTML = `
                    <p style="text-align: center; color: var(--gray);">
                        S√©lectionnez un produit pour voir le r√©capitulatif
                    </p>
                `;
                sellButton.disabled = true;
                return;
            }
            
            const recipeName = selectedOption.getAttribute('data-recipe-name');
            const unit = selectedOption.getAttribute('data-unit');
            const costPerUnit = Number(selectedOption.getAttribute('data-cost-per-unit'));
            const remaining = Number(selectedOption.getAttribute('data-remaining'));
            
            // Update stock available message
            document.getElementById('stockAvailable').textContent = `Stock disponible: ${remaining} ${unit}`;
            
            // Suggested price (cost + 50% margin)
            const suggestedPrice = Math.round(costPerUnit * 1.5);
            document.getElementById('suggestedPrice').textContent = `Prix sugg√©r√© (marge 50%): ${formatCurrency(suggestedPrice)}`;
            
            // Calculate totals
            const revenue = quantity * unitPrice;
            const cogs = quantity * costPerUnit;
            const margin = revenue - cogs;
            const marginPercent = revenue > 0 ? (margin / revenue) * 100 : 0;
            
            // Commission
            let commissionRate = 0;
            let commission = 0;
            let vendorName = '';
            if (vendorSelect.value) {
                const vendorOption = vendorSelect.options[vendorSelect.selectedIndex];
                commissionRate = Number(vendorOption.getAttribute('data-commission')) || 0;
                commission = (revenue * commissionRate) / 100;
                vendorName = vendorOption.getAttribute('data-name');
            }
            
            // Check stock
            const canSell = quantity > 0 && quantity <= remaining && unitPrice > 0;
            
            // Debug log
            console.log('Validation vente:', {
                quantity,
                remaining,
                unitPrice,
                canSell,
                checks: {
                    hasQuantity: quantity > 0,
                    stockOK: quantity <= remaining,
                    hasPrice: unitPrice > 0
                }
            });
            
            // Display preview
            preview.innerHTML = `
                <div style="background: var(--light); padding: var(--space-md); border-radius: var(--radius-md); margin-bottom: var(--space-md);">
                    <h3 style="margin-bottom: var(--space-md);">üìä R√©capitulatif Vente</h3>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-md);">
                        <div>
                            <strong>Produit :</strong><br>
                            ${recipeName}
                        </div>
                        <div>
                            <strong>Quantit√© :</strong><br>
                            ${quantity} ${unit}
                        </div>
                        <div>
                            <strong>Prix unitaire :</strong><br>
                            ${formatCurrency(unitPrice)}
                        </div>
                        <div>
                            <strong>Chiffre d'Affaires :</strong><br>
                            <span style="color: var(--success); font-weight: 600;">${formatCurrency(revenue)}</span>
                        </div>
                        <div>
                            <strong>Co√ªt de revient :</strong><br>
                            ${formatCurrency(cogs)}
                        </div>
                        <div>
                            <strong>Marge brute :</strong><br>
                            <span style="color: ${margin > 0 ? 'var(--success)' : 'var(--danger)'}; font-weight: 600;">
                                ${formatCurrency(margin)} (${marginPercent.toFixed(1)}%)
                            </span>
                        </div>
                        ${vendorName ? `
                            <div>
                                <strong>Vendeur :</strong><br>
                                ${vendorName}
                            </div>
                            <div>
                                <strong>Commission (${commissionRate}%) :</strong><br>
                                ${formatCurrency(commission)}
                            </div>
                        ` : ''}
                    </div>
                </div>
                
                ${!canSell ? `
                    <div style="background: #FFF3CD; padding: var(--space-md); border-radius: var(--radius-md); border-left: 4px solid #FFA502;">
                        <h4 style="margin-bottom: var(--space-sm); color: #856404;">‚ö†Ô∏è V√©rification</h4>
                        ${quantity === 0 ? '<p style="color: #856404; margin: 0;">Entrez une quantit√©</p>' : ''}
                        ${quantity > remaining ? `<p style="color: #856404; margin: 0;">Stock insuffisant (dispo: ${remaining} ${unit})</p>` : ''}
                        ${unitPrice === 0 ? '<p style="color: #856404; margin: 0;">Entrez un prix de vente</p>' : ''}
                    </div>
                ` : `
                    <div style="background: #d4edda; padding: var(--space-md); border-radius: var(--radius-md); border-left: 4px solid #28a745;">
                        <p style="color: #155724; margin: 0;">
                            ‚úÖ <strong>Pr√™t √† vendre</strong> !
                        </p>
                    </div>
                `}
            `;
            
            sellButton.disabled = !canSell;
        };
        
        // Handle new sale
        async function handleNewSale(e) {
            e.preventDefault();
            
            const productSelect = document.getElementById('saleProductSelect');
            const selectedOption = productSelect.options[productSelect.selectedIndex];
            
            const recipeId = selectedOption.getAttribute('data-recipe-id');
            const recipeName = selectedOption.getAttribute('data-recipe-name');
            const unit = selectedOption.getAttribute('data-unit');
            const quantity = Number(document.getElementById('saleQuantity').value);
            const unitPrice = Number(document.getElementById('saleUnitPrice').value);
            
            const vendorSelect = document.getElementById('saleVendorSelect');
            let vendorId = null;
            let vendorName = '';
            let commissionRate = 0;
            
            if (vendorSelect.value) {
                const vendorOption = vendorSelect.options[vendorSelect.selectedIndex];
                vendorId = vendorSelect.value;
                vendorName = vendorOption.getAttribute('data-name');
                commissionRate = Number(vendorOption.getAttribute('data-commission')) || 0;
            }
            
            const notes = document.getElementById('saleNotes').value;
            
            // Double-check stock availability
            const remaining = Number(selectedOption.getAttribute('data-remaining'));
            if (quantity > remaining) {
                showToast(`‚ùå Stock insuffisant ! Disponible: ${remaining} ${unit}, Demand√©: ${quantity} ${unit}`, 'error');
                return;
            }
            
            if (quantity <= 0) {
                showToast('‚ùå Quantit√© invalide', 'error');
                return;
            }
            
            if (unitPrice <= 0) {
                showToast('‚ùå Prix invalide', 'error');
                return;
            }
            
            try {
                // Prepare sale data
                const saleData = {
                    items: [{
                        type: 'recipe',
                        itemId: recipeId,
                        itemName: recipeName,
                        quantity,
                        unit,
                        unitPrice
                    }],
                    vendorId,
                    vendorName,
                    commissionRate,
                    notes,
                    saleDate: new Date()
                };
                
                // Find vendor if selected
                const vendor = vendorId ? appState.data.vendors.find(v => v.id === vendorId) : null;
                
                // Create sale using SaleService
                const result = SaleService.create(saleData, appState.data.productions, vendor);
                
                // Update productions
                result.productionUpdates.forEach(update => {
                    const index = appState.data.productions.findIndex(p => p.id === update.productionId);
                    if (index !== -1) {
                        appState.data.productions[index] = update.production;
                    }
                });
                
                // Add sale
                appState.data.sales.push(result.sale);
                
                // Save
                saveData();
                
                closeModal('newSaleModal');
                renderSalesPage();
                
                showToast(`‚úÖ Vente enregistr√©e : ${formatCurrency(result.sale.revenue)} (marge: ${result.sale.marginPercent.toFixed(1)}%)`, 'success');
                
            } catch (error) {
                console.error('Erreur vente:', error);
                showToast('‚ùå Erreur: ' + error.message, 'error');
            }
        }
        
        // Show sale details (placeholder)
        window.showSaleDetails = function(saleId) {
            showToast('üöß D√©tails vente - En d√©veloppement', 'info');
        };

        // ========================================
        // PERSONNEL PAGE
        // ========================================
        
        function renderPersonnelPage() {
            const staff = appState.data.staff || [];
            
            let html = `
                <div class="page-container">
                    <div class="page-header">
                        <h1 class="page-title">üë• Personnel</h1>
                        <button class="btn btn-primary" onclick="showNewStaffModal()">‚ûï Ajouter Membre</button>
                    </div>
                    ${staff.length === 0 ? `
                        <div class="empty-state">
                            <div class="empty-icon">üë•</div>
                            <h3>Aucun membre du personnel</h3>
                            <p>Ajoutez les membres de votre √©quipe</p>
                            <button class="btn btn-primary" onclick="showNewStaffModal()">‚ûï Ajouter Membre</button>
                        </div>
                    ` : `
                        <div class="stats-grid" style="margin-bottom: var(--space-lg);">
                            <div class="stat-card primary">
                                <div class="stat-label">Total Personnel</div>
                                <div class="stat-value">${staff.length}</div>
                            </div>
                            <div class="stat-card success">
                                <div class="stat-label">Actifs</div>
                                <div class="stat-value">${staff.filter(s => s.active).length}</div>
                            </div>
                        </div>
                        <div class="ingredients-list">
                            ${staff.map(member => `
                                <div class="ingredient-card">
                                    <div class="ingredient-header">
                                        <div>
                                            <h3 class="ingredient-name">${member.name}</h3>
                                            <p class="ingredient-meta">${member.role}${member.phone ? ' ‚Ä¢ ' + member.phone : ''}</p>
                                        </div>
                                        <div class="ingredient-stock ${member.active ? 'success' : 'danger'}">
                                            ${member.active ? 'Actif' : 'Inactif'}
                                        </div>
                                    </div>
                                    <div class="ingredient-actions">
                                        <button class="action-btn" onclick="editStaffMember('${member.id}')" title="Modifier">‚úèÔ∏è</button>
                                        <button class="action-btn" onclick="deleteStaffMember('${member.id}')" title="Supprimer">üóëÔ∏è</button>
                                        <button class="action-btn" onclick="toggleStaffStatus('${member.id}')" title="${member.active ? 'D√©sactiver' : 'Activer'}">
                                            ${member.active ? 'üî¥' : 'üü¢'}
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `}
                </div>
            `;
            document.getElementById('mainContent').innerHTML = html;
        }
        
        window.showNewStaffModal = function() {
            const modal = document.createElement('div');
            modal.id = 'newStaffModal';
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>üë• Nouveau Membre</h2>
                        <button class="modal-close" onclick="closeModal('newStaffModal')">‚úï</button>
                    </div>
                    <div class="modal-body">
                        <form id="newStaffForm">
                            <div class="form-group">
                                <label>Nom complet *</label>
                                <input type="text" id="staffName" required>
                            </div>
                            <div class="form-group">
                                <label>R√¥le *</label>
                                <select id="staffRole" required>
                                    <option value="">S√©lectionner...</option>
                                    <option value="Chef">Chef</option>
                                    <option value="P√¢tissier">P√¢tissier</option>
                                    <option value="Vendeur">Vendeur</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>T√©l√©phone</label>
                                <input type="tel" id="staffPhone">
                            </div>
                            <div style="display: flex; gap: var(--space-md); margin-top: var(--space-xl);">
                                <button type="button" class="btn" style="flex: 1;" onclick="closeModal('newStaffModal')">Annuler</button>
                                <button type="submit" class="btn btn-primary" style="flex: 1;">‚ûï Ajouter</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            document.getElementById('newStaffForm').addEventListener('submit', handleNewStaff);
        };
        
        function handleNewStaff(e) {
            e.preventDefault();
            const newMember = {
                id: 'staff_' + Date.now(),
                name: document.getElementById('staffName').value,
                role: document.getElementById('staffRole').value,
                phone: document.getElementById('staffPhone').value || '',
                active: true
            };
            appState.data.staff = appState.data.staff || [];
            appState.data.staff.push(newMember);
            saveData();
            closeModal('newStaffModal');
            renderPersonnelPage();
            showToast('‚úÖ ' + newMember.name + ' ajout√©', 'success');
        }
        
        window.editStaffMember = function(staffId) {
            const member = appState.data.staff.find(s => s.id === staffId);
            if (!member) return;
            
            const modal = document.createElement('div');
            modal.id = 'editStaffModal';
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>‚úèÔ∏è Modifier Membre</h2>
                        <button class="modal-close" onclick="closeModal('editStaffModal')">‚úï</button>
                    </div>
                    <div class="modal-body">
                        <form id="editStaffForm">
                            <div class="form-group">
                                <label>Nom complet *</label>
                                <input type="text" id="editStaffName" value="${member.name}" required>
                            </div>
                            <div class="form-group">
                                <label>R√¥le *</label>
                                <select id="editStaffRole" required>
                                    <option value="">S√©lectionner...</option>
                                    <option value="Chef" ${member.role === 'Chef' || member.role === 'Chef cuisinier' ? 'selected' : ''}>Chef</option>
                                    <option value="P√¢tissier" ${member.role === 'P√¢tissier' || member.role === 'P√¢tissi√®re' ? 'selected' : ''}>P√¢tissier</option>
                                    <option value="Vendeur" ${member.role === 'Vendeur' || member.role === 'Vendeuse' ? 'selected' : ''}>Vendeur</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>T√©l√©phone</label>
                                <input type="tel" id="editStaffPhone" value="${member.phone || ''}">
                            </div>
                            <input type="hidden" id="editStaffId" value="${member.id}">
                            <div style="display: flex; gap: var(--space-md); margin-top: var(--space-xl);">
                                <button type="button" class="btn" style="flex: 1;" onclick="closeModal('editStaffModal')">Annuler</button>
                                <button type="submit" class="btn btn-primary" style="flex: 1;">üíæ Enregistrer</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            document.getElementById('editStaffForm').addEventListener('submit', handleEditStaff);
        };
        
        function handleEditStaff(e) {
            e.preventDefault();
            const staffId = document.getElementById('editStaffId').value;
            const member = appState.data.staff.find(s => s.id === staffId);
            if (member) {
                member.name = document.getElementById('editStaffName').value;
                member.role = document.getElementById('editStaffRole').value;
                member.phone = document.getElementById('editStaffPhone').value || '';
                saveData();
                closeModal('editStaffModal');
                renderPersonnelPage();
                showToast('‚úÖ ' + member.name + ' modifi√©', 'success');
            }
        }
        
        window.toggleStaffStatus = function(staffId) {
            const member = appState.data.staff.find(s => s.id === staffId);
            if (member) {
                member.active = !member.active;
                saveData();
                renderPersonnelPage();
                showToast(member.name + ' ' + (member.active ? 'activ√©' : 'd√©sactiv√©'), 'info');
            }
        };
        
        window.deleteStaffMember = function(staffId) {
            const member = appState.data.staff.find(s => s.id === staffId);
            if (!member) return;
            
            if (confirm('‚ö†Ô∏è Supprimer ' + member.name + ' ?\n\nCette action est irr√©versible.')) {
                appState.data.staff = appState.data.staff.filter(s => s.id !== staffId);
                saveData();
                renderPersonnelPage();
                showToast('üóëÔ∏è ' + member.name + ' supprim√©', 'success');
            }
        };

        // ========================================
        // PACKS PAGE
        // ========================================
        
        function renderPacksPage() {
            const packs = appState.data.packs || [];
            const recipes = appState.data.recipes || [];
            const ingredients = appState.data.ingredients || [];
            
            let html = `
                <div class="page-container">
                    <div class="page-header">
                        <h1 class="page-title">üéÅ Packs</h1>
                        <button class="btn btn-primary" onclick="showNewPackModal()">‚ûï Cr√©er Pack</button>
                    </div>
                    ${packs.length === 0 ? `
                        <div class="empty-state">
                            <div class="empty-icon">üéÅ</div>
                            <h3>Aucun pack</h3>
                            <p>Cr√©ez des packs de produits pour vendre plusieurs articles ensemble</p>
                            <button class="btn btn-primary" onclick="showNewPackModal()">‚ûï Cr√©er Pack</button>
                        </div>
                    ` : `
                        <div class="stats-grid" style="margin-bottom: var(--space-lg);">
                            <div class="stat-card primary">
                                <div class="stat-label">Total Packs</div>
                                <div class="stat-value">${packs.length}</div>
                            </div>
                            <div class="stat-card success">
                                <div class="stat-label">Actifs</div>
                                <div class="stat-value">${packs.filter(p => p.active).length}</div>
                            </div>
                        </div>
                        <div class="ingredients-list">
                            ${packs.map(pack => {
                                const cost = pack.getCost ? pack.getCost(recipes, ingredients) : 0;
                                const margin = pack.price - cost;
                                const marginPercent = pack.price > 0 ? (margin / pack.price) * 100 : 0;
                                const hasStock = pack.hasStock ? pack.hasStock(recipes, ingredients) : false;
                                
                                return `
                                    <div class="ingredient-card">
                                        <div class="ingredient-header">
                                            <div>
                                                <h3 class="ingredient-name">${pack.name}</h3>
                                                <p class="ingredient-meta">
                                                    ${pack.items ? pack.items.length : 0} produit${(pack.items && pack.items.length > 1) ? 's' : ''}
                                                    ${pack.description ? ' ‚Ä¢ ' + pack.description : ''}
                                                </p>
                                            </div>
                                            <div class="ingredient-stock ${pack.active && hasStock ? 'success' : 'danger'}">
                                                ${formatCurrency(pack.price)}
                                            </div>
                                        </div>
                                        <div class="ingredient-stats">
                                            <div class="stat-item">
                                                <span class="stat-label">Prix</span>
                                                <span class="stat-value">${formatCurrency(pack.price)}</span>
                                            </div>
                                            <div class="stat-item">
                                                <span class="stat-label">Co√ªt</span>
                                                <span class="stat-value">${formatCurrency(cost)}</span>
                                            </div>
                                            <div class="stat-item">
                                                <span class="stat-label">Marge</span>
                                                <span class="stat-value">${formatCurrency(margin)}</span>
                                            </div>
                                            <div class="stat-item">
                                                <span class="stat-label">Marge %</span>
                                                <span class="stat-value">${marginPercent.toFixed(1)}%</span>
                                            </div>
                                            <div class="stat-item">
                                                <span class="stat-label">Stock</span>
                                                <span class="stat-value">${hasStock ? '‚úÖ Dispo' : '‚ùå Rupture'}</span>
                                            </div>
                                        </div>
                                        <div style="margin-top: var(--space-md); padding-top: var(--space-md); border-top: 1px solid var(--light);">
                                            <strong>Contenu :</strong>
                                            <ul style="margin: var(--space-sm) 0 0 var(--space-md); padding: 0;">
                                                ${pack.items ? pack.items.map(item => `
                                                    <li>${item.quantity} ${item.unit} ${item.productionName}</li>
                                                `).join('') : ''}
                                            </ul>
                                        </div>
                                        <div class="ingredient-actions">
                                            <button class="action-btn" onclick="editPack('${pack.id}')" title="Modifier">‚úèÔ∏è</button>
                                            <button class="action-btn" onclick="deletePack('${pack.id}')" title="Supprimer">üóëÔ∏è</button>
                                            <button class="action-btn" onclick="togglePackStatus('${pack.id}')" title="${pack.active ? 'D√©sactiver' : 'Activer'}">
                                                ${pack.active ? 'üî¥' : 'üü¢'}
                                            </button>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `}
                </div>
            `;
            document.getElementById('mainContent').innerHTML = html;
        }
        
        window.showNewPackModal = function() {
            const recipes = appState.data.recipes || [];
            if (recipes.length === 0) {
                showToast('‚ùå Cr√©ez d\'abord des recettes', 'error');
                return;
            }
            
            const modal = document.createElement('div');
            modal.id = 'newPackModal';
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 900px;">
                    <div class="modal-header">
                        <h2>üéÅ Cr√©er Pack</h2>
                        <button class="modal-close" onclick="closeModal('newPackModal')">‚úï</button>
                    </div>
                    <div class="modal-body">
                        <form id="newPackForm">
                            <div class="form-group">
                                <label>Nom du pack *</label>
                                <input type="text" id="packName" required placeholder="Ex: Pack Petit-D√©jeuner">
                            </div>
                            <div class="form-group">
                                <label>Description</label>
                                <textarea id="packDescription" rows="2" placeholder="Description du pack"></textarea>
                            </div>
                            <h3 style="margin-top: var(--space-lg);">Produits inclus</h3>
                            <div id="packItemsContainer">
                                <div class="pack-item-row" data-index="0">
                                    <div class="form-row" style="align-items: flex-end;">
                                        <div class="form-group" style="flex: 2;">
                                            <label>Produit</label>
                                            <select class="pack-item-product" required>
                                                <option value="">S√©lectionner...</option>
                                                ${recipes.map(r => `
                                                    <option value="${r.id}" data-name="${r.name}" data-unit="${r.producedUnit}">
                                                        ${r.name}
                                                    </option>
                                                `).join('')}
                                            </select>
                                        </div>
                                        <div class="form-group" style="flex: 1;">
                                            <label>Quantit√©</label>
                                            <input type="number" class="pack-item-quantity" required min="1" step="1" value="1">
                                        </div>
                                        <button type="button" class="btn" style="background: var(--danger);" onclick="removePackItem(0)">‚ùå</button>
                                    </div>
                                </div>
                            </div>
                            <button type="button" class="btn" onclick="addPackItem()" style="margin-top: var(--space-md);">
                                ‚ûï Ajouter Produit
                            </button>
                            <div class="form-group" style="margin-top: var(--space-lg);">
                                <label>Prix de vente du pack (FCFA) *</label>
                                <input type="number" id="packPrice" required min="0" step="1" placeholder="Prix total du pack">
                            </div>
                            <div style="display: flex; gap: var(--space-md); margin-top: var(--space-xl);">
                                <button type="button" class="btn" style="flex: 1;" onclick="closeModal('newPackModal')">Annuler</button>
                                <button type="submit" class="btn btn-primary" style="flex: 1;">üéÅ Cr√©er Pack</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            document.getElementById('newPackForm').addEventListener('submit', handleNewPack);
        };
        
        let packItemIndex = 1;
        window.addPackItem = function() {
            const recipes = appState.data.recipes || [];
            const container = document.getElementById('packItemsContainer');
            const newRow = document.createElement('div');
            newRow.className = 'pack-item-row';
            newRow.setAttribute('data-index', packItemIndex);
            newRow.innerHTML = `
                <div class="form-row" style="align-items: flex-end;">
                    <div class="form-group" style="flex: 2;">
                        <label>Produit</label>
                        <select class="pack-item-product" required>
                            <option value="">S√©lectionner...</option>
                            ${recipes.map(r => `
                                <option value="${r.id}" data-name="${r.name}" data-unit="${r.producedUnit}">
                                    ${r.name}
                                </option>
                            `).join('')}
                        </select>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>Quantit√©</label>
                        <input type="number" class="pack-item-quantity" required min="1" step="1" value="1">
                    </div>
                    <button type="button" class="btn" style="background: var(--danger);" onclick="removePackItem(${packItemIndex})">‚ùå</button>
                </div>
            `;
            container.appendChild(newRow);
            packItemIndex++;
        };
        
        window.removePackItem = function(index) {
            const row = document.querySelector('[data-index="' + index + '"]');
            if (row && document.querySelectorAll('.pack-item-row').length > 1) {
                row.remove();
            } else {
                showToast('‚ö†Ô∏è Un pack doit contenir au moins 1 produit', 'warning');
            }
        };
        
        function handleNewPack(e) {
            e.preventDefault();
            const name = document.getElementById('packName').value;
            const description = document.getElementById('packDescription').value;
            const price = Number(document.getElementById('packPrice').value);
            
            const items = [];
            document.querySelectorAll('.pack-item-row').forEach(row => {
                const productSelect = row.querySelector('.pack-item-product');
                const quantity = Number(row.querySelector('.pack-item-quantity').value);
                if (productSelect.value) {
                    const option = productSelect.options[productSelect.selectedIndex];
                    items.push({
                        productionId: productSelect.value,
                        productionName: option.getAttribute('data-name'),
                        quantity: quantity,
                        unit: option.getAttribute('data-unit')
                    });
                }
            });
            
            if (items.length === 0) {
                showToast('‚ùå Ajoutez au moins un produit au pack', 'error');
                return;
            }
            
            // Cr√©er Pack instance avec classe Pack
            const newPack = new Pack({
                id: 'pack_' + Date.now(),
                name: name,
                description: description,
                items: items.map(item => new PackItem(item)),
                price: price,
                active: true,
                createdAt: new Date()
            });
            
            appState.data.packs = appState.data.packs || [];
            appState.data.packs.push(newPack);
            saveData();
            closeModal('newPackModal');
            renderPacksPage();
            showToast('‚úÖ Pack "' + name + '" cr√©√© !', 'success');
        }
        
        window.togglePackStatus = function(packId) {
            const pack = appState.data.packs.find(p => p.id === packId);
            if (pack) {
                pack.active = !pack.active;
                saveData();
                renderPacksPage();
                showToast('Pack ' + (pack.active ? 'activ√©' : 'd√©sactiv√©'), 'info');
            }
        };
        
        window.editPack = function(packId) {
            showToast('üöß Modification pack - En d√©veloppement', 'info');
        };
        
        window.deletePack = function(packId) {
            const pack = appState.data.packs.find(p => p.id === packId);
            if (!pack) return;
            if (confirm('‚ö†Ô∏è Supprimer le pack "' + pack.name + '" ?\n\nCette action est irr√©versible.')) {
                appState.data.packs = appState.data.packs.filter(p => p.id !== packId);
                saveData();
                renderPacksPage();
                showToast('üóëÔ∏è Pack "' + pack.name + '" supprim√©', 'success');
            }
        };
        
        window.editRecipe = function(recipeId) {
            showToast('üöß Modification recette - En d√©veloppement', 'info');
        };
        
        window.deleteRecipe = function(recipeId) {
            const recipe = appState.data.recipes.find(r => r.id === recipeId);
            if (!recipe) return;
            if (confirm('‚ö†Ô∏è Supprimer la recette "' + recipe.name + '" ?\n\nCette action est irr√©versible.')) {
                appState.data.recipes = appState.data.recipes.filter(r => r.id !== recipeId);
                saveData();
                renderRecipesPage();
                showToast('üóëÔ∏è Recette "' + recipe.name + '" supprim√©e', 'success');
            }
        };

        // Filter recipes
        function filterRecipes() {
            const search = document.getElementById('searchRecipes')?.value.toLowerCase() || '';
            const category = document.getElementById('filterRecipeCategory')?.value || '';
            
            let filtered = appState.data.recipes || [];
            
            if (search) {
                filtered = filtered.filter(r => r.name.toLowerCase().includes(search));
            }
            
            if (category) {
                filtered = filtered.filter(r => r.category === category);
            }
            
            document.getElementById('recipesGrid').innerHTML = 
                filtered.length > 0 ? renderRecipeCards(filtered) : '<div class="empty-state"><p>Aucune recette</p></div>';
        }

        window.showCreateRecipeModal = function() {
            const ingredients = appState.data.ingredients || [];
            
            const modal = document.createElement('div');
            modal.id = 'createRecipeModal';
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px;">
                    <div class="modal-header">
                        <h2>üìã Nouvelle Recette</h2>
                        <button class="modal-close" onclick="closeModal('createRecipeModal')">‚úï</button>
                    </div>
                    <div class="modal-body">
                        <form id="createRecipeForm">
                            <div class="form-row">
                                <div class="form-group" style="flex: 2;">
                                    <label>Nom de la recette *</label>
                                    <input type="text" name="name" required placeholder="Ex: Croissant au beurre">
                                </div>
                                <div class="form-group">
                                    <label>Cat√©gorie</label>
                                    <select name="category">
                                        <option value="">Sans cat√©gorie</option>
                                        <option value="Pain">Pain</option>
                                        <option value="Viennoiserie">Viennoiserie</option>
                                        <option value="P√¢tisserie">P√¢tisserie</option>
                                        <option value="Autre">Autre</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Rendement *</label>
                                    <input type="number" name="producedQty" required placeholder="Ex: 10" min="1" step="0.1">
                                </div>
                                <div class="form-group">
                                    <label>Unit√© *</label>
                                    <select name="producedUnit" required>
                                        <option value="piece">pi√®ce(s)</option>
                                        <option value="kg">kg</option>
                                        <option value="L">L</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Temps pr√©paration (min)</label>
                                    <input type="number" name="preparationTime" placeholder="Ex: 45" min="0">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Instructions</label>
                                <textarea name="instructions" rows="3" placeholder="√âtapes de pr√©paration..."></textarea>
                            </div>
                            
                            <hr style="margin: var(--space-lg) 0;">
                            
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-md);">
                                <h3 style="margin: 0;">Ingr√©dients</h3>
                                <button type="button" class="btn" style="background: var(--secondary); color: white;" onclick="addRecipeIngredient()">
                                    ‚ûï Ajouter ingr√©dient
                                </button>
                            </div>
                            
                            <div id="recipeIngredientsList">
                                <!-- Ingredients will be added here -->
                            </div>
                            
                            <div id="recipeCostDisplay" style="background: var(--light); padding: var(--space-md); border-radius: var(--radius-md); margin-top: var(--space-md); display: none;">
                                <strong>Co√ªt total estim√© :</strong> <span id="recipeTotalCost">0 FCFA</span>
                                <br>
                                <strong>Co√ªt unitaire :</strong> <span id="recipeUnitCost">0 FCFA</span>
                            </div>
                            
                            <div style="display: flex; gap: var(--space-md); margin-top: var(--space-lg);">
                                <button type="button" class="btn" style="flex: 1; background: var(--gray); color: white;" onclick="closeModal('createRecipeModal')">
                                    Annuler
                                </button>
                                <button type="submit" class="btn btn-primary" style="flex: 1;">
                                    ‚úÖ Cr√©er la recette
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            document.getElementById('createRecipeForm').addEventListener('submit', handleCreateRecipe);
        };
        
        // Add ingredient row to recipe
        window.addRecipeIngredient = function() {
            const ingredients = appState.data.ingredients || [];
            const container = document.getElementById('recipeIngredientsList');
            const index = container.children.length;
            
            const row = document.createElement('div');
            row.className = 'form-row';
            row.style.marginBottom = 'var(--space-sm)';
            row.dataset.index = index;
            row.innerHTML = `
                <div class="form-group" style="flex: 2;">
                    <select name="ingredient_${index}" required onchange="updateRecipeIngredientUnit(${index})">
                        <option value="">S√©lectionner ingr√©dient...</option>
                        ${ingredients.map(ing => `<option value="${ing.id}" data-unit="${ing.baseUnit}">${ing.name}</option>`).join('')}
                    </select>
                </div>
                <div class="form-group">
                    <input type="number" name="quantity_${index}" required placeholder="Quantit√©" min="0.01" step="0.01" oninput="updateRecipeCost()">
                </div>
                <div class="form-group">
                    <select name="unit_${index}" id="unit_${index}" required onchange="updateRecipeCost()">
                        <option value="">Unit√©</option>
                    </select>
                </div>
                <button type="button" class="btn" style="background: var(--danger); color: white; padding: 12px 16px;" onclick="removeRecipeIngredient(${index})" title="Supprimer">
                    ‚úï
                </button>
            `;
            
            container.appendChild(row);
        };
        
        // Update unit options when ingredient selected
        window.updateRecipeIngredientUnit = function(index) {
            const select = document.querySelector(`[name="ingredient_${index}"]`);
            const unitSelect = document.getElementById(`unit_${index}`);
            
            if (select.value) {
                const option = select.options[select.selectedIndex];
                const baseUnit = option.dataset.unit;
                
                // Set available units
                let units = [baseUnit];
                if (baseUnit === 'g') units.push('kg');
                if (baseUnit === 'ml') units.push('L');
                
                unitSelect.innerHTML = units.map(u => `<option value="${u}">${u}</option>`).join('');
                updateRecipeCost();
            }
        };
        
        // Remove ingredient row
        window.removeRecipeIngredient = function(index) {
            const row = document.querySelector(`[data-index="${index}"]`);
            if (row) row.remove();
            updateRecipeCost();
        };
        
        // Update recipe cost calculation
        window.updateRecipeCost = function() {
            const container = document.getElementById('recipeIngredientsList');
            const rows = container.querySelectorAll('.form-row');
            const ingredients = appState.data.ingredients || [];
            
            let totalCost = 0;
            let hasIngredients = false;
            
            rows.forEach(row => {
                const index = row.dataset.index;
                const ingSelect = document.querySelector(`[name="ingredient_${index}"]`);
                const qtyInput = document.querySelector(`[name="quantity_${index}"]`);
                const unitSelect = document.querySelector(`[name="unit_${index}"]`);
                
                if (ingSelect?.value && qtyInput?.value && unitSelect?.value) {
                    hasIngredients = true;
                    const ing = ingredients.find(i => i.id === ingSelect.value);
                    if (ing) {
                        let qty = Number(qtyInput.value);
                        const unit = unitSelect.value;
                        
                        // Convert to base unit
                        if (unit === 'kg' && ing.baseUnit === 'g') qty *= 1000;
                        if (unit === 'L' && ing.baseUnit === 'ml') qty *= 1000;
                        
                        // Get cost per base unit
                        const costPerUnit = ing.getPricePerBaseUnit ? ing.getPricePerBaseUnit() : 0;
                        totalCost += qty * costPerUnit;
                    }
                }
            });
            
            // Display cost
            const costDisplay = document.getElementById('recipeCostDisplay');
            if (hasIngredients) {
                costDisplay.style.display = 'block';
                document.getElementById('recipeTotalCost').textContent = formatCurrency(totalCost);
                
                const producedQty = Number(document.querySelector('[name="producedQty"]')?.value) || 1;
                const unitCost = totalCost / producedQty;
                document.getElementById('recipeUnitCost').textContent = formatCurrency(unitCost);
            } else {
                costDisplay.style.display = 'none';
            }
        };
        
        // Handle recipe creation
        async function handleCreateRecipe(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const container = document.getElementById('recipeIngredientsList');
            const rows = container.querySelectorAll('.form-row');
            
            // Collect ingredients
            const recipeIngredients = [];
            const ingredients = appState.data.ingredients || [];
            
            rows.forEach(row => {
                const index = row.dataset.index;
                const ingId = formData.get(`ingredient_${index}`);
                const qty = Number(formData.get(`quantity_${index}`));
                const unit = formData.get(`unit_${index}`);
                
                if (ingId && qty && unit) {
                    const ing = ingredients.find(i => i.id === ingId);
                    if (ing) {
                        let baseQty = qty;
                        if (unit === 'kg' && ing.baseUnit === 'g') baseQty = qty * 1000;
                        if (unit === 'L' && ing.baseUnit === 'ml') baseQty = qty * 1000;
                        
                        recipeIngredients.push({
                            ingredientId: ingId,
                            ingredientName: ing.name,
                            quantity: qty,
                            unit: unit,
                            baseQty: baseQty,
                            baseUnit: ing.baseUnit
                        });
                    }
                }
            });
            
            if (recipeIngredients.length === 0) {
                showToast('‚ùå Ajoutez au moins un ingr√©dient', 'error');
                return;
            }
            
            try {
                const recipe = RecipeService.create({
                    name: formData.get('name'),
                    category: formData.get('category'),
                    producedQty: Number(formData.get('producedQty')),
                    producedUnit: formData.get('producedUnit'),
                    preparationTime: Number(formData.get('preparationTime')) || 0,
                    instructions: formData.get('instructions') || ''
                });
                
                // Add ingredients
                recipeIngredients.forEach(ing => {
                    RecipeService.addIngredient(recipe, ing);
                });
                
                // Save to state
                appState.data.recipes.push(recipe);
                saveData();
                
                closeModal('createRecipeModal');
                renderRecipesPage();
                
                showToast(`‚úÖ Recette "${recipe.name}" cr√©√©e avec ${recipeIngredients.length} ingr√©dients`, 'success');
                
            } catch (error) {
                console.error('Error:', error);
                showToast('‚ùå Erreur: ' + error.message, 'error');
            }
        }
        
        // ========================================
        // RECIPE DETAILS
        // ========================================
        
        window.showRecipeDetails = function(recipeId) {
            const recipe = appState.data.recipes.find(r => r.id === recipeId);
            if (!recipe) {
                showToast('‚ùå Recette introuvable', 'error');
                return;
            }
            
            const ingredients = appState.data.ingredients || [];
            const capacity = RecipeService.calculateCapacity(recipe, ingredients);
            
            // Calculate total cost
            let totalCost = 0;
            recipe.ingredients.forEach(recipeIng => {
                const ing = ingredients.find(i => i.id === recipeIng.ingredientId);
                if (ing) {
                    const costPerUnit = ing.getPricePerBaseUnit ? ing.getPricePerBaseUnit() : 0;
                    totalCost += recipeIng.baseQty * costPerUnit;
                }
            });
            
            const unitCost = totalCost / recipe.producedQty;
            
            const modal = document.createElement('div');
            modal.id = 'recipeDetailsModal';
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px;">
                    <div class="modal-header">
                        <h2>üìã ${recipe.name}</h2>
                        <button class="modal-close" onclick="closeModal('recipeDetailsModal')">‚úï</button>
                    </div>
                    <div class="modal-body">
                        <!-- Summary Stats -->
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: var(--space-md); margin-bottom: var(--space-lg);">
                            <div class="stat-card primary">
                                <div class="stat-label">Rendement</div>
                                <div class="stat-value">${recipe.producedQty} ${recipe.producedUnit}</div>
                            </div>
                            <div class="stat-card success">
                                <div class="stat-label">Co√ªt Total</div>
                                <div class="stat-value">${formatCurrency(totalCost)}</div>
                            </div>
                            <div class="stat-card warning">
                                <div class="stat-label">Co√ªt Unitaire</div>
                                <div class="stat-value">${formatCurrency(unitCost)}</div>
                            </div>
                            <div class="stat-card ${capacity.batches === 0 ? 'danger' : 'info'}">
                                <div class="stat-label">Fabricable</div>
                                <div class="stat-value">${capacity.batches} batch${capacity.batches > 1 ? 'es' : ''}</div>
                            </div>
                        </div>
                        
                        ${recipe.category ? `
                            <p style="margin-bottom: var(--space-md);"><strong>Cat√©gorie :</strong> ${recipe.category}</p>
                        ` : ''}
                        
                        ${recipe.preparationTime > 0 ? `
                            <p style="margin-bottom: var(--space-md);"><strong>Temps de pr√©paration :</strong> ${recipe.preparationTime} minutes</p>
                        ` : ''}
                        
                        ${recipe.instructions ? `
                            <div style="background: var(--light); padding: var(--space-md); border-radius: var(--radius-md); margin-bottom: var(--space-lg);">
                                <strong>Instructions :</strong>
                                <p style="margin-top: 8px; white-space: pre-wrap;">${recipe.instructions}</p>
                            </div>
                        ` : ''}
                        
                        <!-- Ingredients List -->
                        <h3 style="margin-bottom: var(--space-md);">üì¶ Ingr√©dients (${recipe.ingredients.length})</h3>
                        <div style="overflow-x: auto; margin-bottom: var(--space-xl);">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead style="background: var(--light);">
                                    <tr>
                                        <th style="padding: 12px; text-align: left;">Ingr√©dient</th>
                                        <th style="padding: 12px; text-align: right;">Quantit√©</th>
                                        <th style="padding: 12px; text-align: right;">Stock Dispo</th>
                                        <th style="padding: 12px; text-align: right;">Co√ªt</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${recipe.ingredients.map(recipeIng => {
                                        const ing = ingredients.find(i => i.id === recipeIng.ingredientId);
                                        if (!ing) return '';
                                        
                                        const stock = ing.getBaseQtyRemaining ? ing.getBaseQtyRemaining() : 0;
                                        const costPerUnit = ing.getPricePerBaseUnit ? ing.getPricePerBaseUnit() : 0;
                                        const ingCost = recipeIng.baseQty * costPerUnit;
                                        const sufficient = stock >= recipeIng.baseQty;
                                        
                                        return `
                                            <tr style="border-bottom: 1px solid var(--light);">
                                                <td style="padding: 12px;">${recipeIng.ingredientName}</td>
                                                <td style="padding: 12px; text-align: right; font-weight: 600;">
                                                    ${recipeIng.quantity} ${recipeIng.unit}
                                                </td>
                                                <td style="padding: 12px; text-align: right; color: ${sufficient ? 'var(--success)' : 'var(--danger)'};">
                                                    ${stock} ${ing.baseUnit}
                                                    ${!sufficient ? ' ‚ö†Ô∏è' : ''}
                                                </td>
                                                <td style="padding: 12px; text-align: right;">${formatCurrency(ingCost)}</td>
                                            </tr>
                                        `;
                                    }).join('')}
                                    <tr style="border-top: 2px solid var(--primary); font-weight: 600;">
                                        <td colspan="3" style="padding: 12px; text-align: right;">TOTAL :</td>
                                        <td style="padding: 12px; text-align: right; color: var(--primary);">${formatCurrency(totalCost)}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        ${capacity.maxBatches === 0 && capacity.limitingIngredient ? `
                            <div style="background: #FFF3CD; padding: var(--space-md); border-radius: var(--radius-md); margin-bottom: var(--space-lg); border-left: 4px solid #FFA502;">
                                <h4 style="margin-bottom: var(--space-sm); color: #856404;">‚ö†Ô∏è Stock insuffisant</h4>
                                <p style="color: #856404;">
                                    Ingr√©dient limitant : <strong>${capacity.limitingIngredient.name}</strong>
                                    <br>
                                    N√©cessaire : ${capacity.limitingIngredient.needed} ${capacity.limitingIngredient.unit}
                                    <br>
                                    Disponible : ${capacity.limitingIngredient.available} ${capacity.limitingIngredient.unit}
                                    <br>
                                    Manque : ${capacity.limitingIngredient.missing} ${capacity.limitingIngredient.unit}
                                </p>
                            </div>
                        ` : capacity.maxBatches > 0 ? `
                            <div style="background: #d4edda; padding: var(--space-md); border-radius: var(--radius-md); margin-bottom: var(--space-lg); border-left: 4px solid #28a745;">
                                <h4 style="margin-bottom: var(--space-sm); color: #155724;">‚úÖ Stock suffisant</h4>
                                <p style="color: #155724;">
                                    Vous pouvez produire jusqu'√† <strong>${capacity.maxBatches} batch(s)</strong>, 
                                    soit <strong>${capacity.maxBatches * recipe.producedQty} ${recipe.producedUnit}</strong>.
                                </p>
                            </div>
                        ` : ''}
                        
                        <!-- Actions -->
                        <div style="display: flex; gap: var(--space-md); margin-top: var(--space-xl);" class="no-print">
                            <button class="btn" style="flex: 1; background: var(--info); color: white;" onclick="window.print()">
                                üñ®Ô∏è Imprimer
                            </button>
                            <button class="btn" style="flex: 1; background: var(--secondary); color: white;" onclick="alert('Modifier - Bient√¥t')">
                                ‚úèÔ∏è Modifier
                            </button>
                            <button class="btn btn-primary" style="flex: 1;" onclick="alert('Produire - Bient√¥t')" ${capacity.batches === 0 ? 'disabled' : ''}>
                                ‚öôÔ∏è Produire
                            </button>
                            <button class="btn" style="background: var(--gray); color: white;" onclick="closeModal('recipeDetailsModal')">
                                Fermer
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        };
        
        // Render categories list for manager
        function renderCategoriesList() {
            const categories = appState.data.categories || [];
            const mainCategories = categories.filter(c => !c.parent);
            
            let html = '';
            mainCategories.forEach(main => {
                html += `
                    <div style="margin-bottom: var(--space-md); border: 2px solid var(--light); border-radius: var(--radius-md); padding: var(--space-sm);">
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: var(--space-sm);">
                            <strong style="font-size: 16px;">${main.name}</strong>
                            <button class="btn" style="padding: 8px 16px; background: var(--danger); color: white;" 
                                onclick="deleteCategory('${main.id}')">
                                üóëÔ∏è Supprimer
                            </button>
                        </div>
                        
                        ${categories.filter(c => c.parent === main.name).map(sub => `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: var(--space-sm); margin-left: var(--space-lg); background: var(--light); border-radius: var(--radius-sm); margin-top: 4px;">
                                <span>‚îî ${sub.name}</span>
                                <button class="btn" style="padding: 6px 12px; background: var(--danger); color: white; font-size: 12px;" 
                                    onclick="deleteCategory('${sub.id}')">
                                    üóëÔ∏è
                                </button>
                            </div>
                        `).join('')}
                    </div>
                `;
            });
            
            return html || '<p style="text-align: center; color: var(--gray);">Aucune cat√©gorie</p>';
        }
        
        // Show category manager
        window.showCategoryManager = function() {
            const modal = document.getElementById('categoryManagerModal');
            if (modal) {
                modal.classList.remove('hidden');
                // Refresh list
                const list = document.getElementById('categoriesList');
                if (list) list.innerHTML = renderCategoriesList();
            }
        };
        
        // Handle add category
        function handleAddCategory(e) {
            e.preventDefault();
            
            const name = document.getElementById('newCategoryName').value.trim();
            const parent = document.getElementById('newCategoryParent').value.trim() || null;
            
            if (!name) {
                showToast('‚ùå Le nom est obligatoire', 'error');
                return;
            }
            
            // Check if exists
            const exists = appState.data.categories.some(c => 
                c.name.toLowerCase() === name.toLowerCase()
            );
            
            if (exists) {
                showToast('‚ùå Cette cat√©gorie existe d√©j√†', 'error');
                return;
            }
            
            // Add category
            const newCategory = {
                id: 'cat_' + Date.now(),
                name: name,
                parent: parent
            };
            
            appState.data.categories.push(newCategory);
            saveData();
            
            // Reset form
            document.getElementById('newCategoryName').value = '';
            document.getElementById('newCategoryParent').value = '';
            
            // Refresh list
            document.getElementById('categoriesList').innerHTML = renderCategoriesList();
            
            showToast('‚úÖ Cat√©gorie ajout√©e !', 'success');
        }
        
        // Delete category
        window.deleteCategory = function(categoryId) {
            if (!confirm('Supprimer cette cat√©gorie ?')) return;
            
            const category = appState.data.categories.find(c => c.id === categoryId);
            if (!category) return;
            
            // Check if has subcategories
            const hasSubs = appState.data.categories.some(c => c.parent === category.name);
            if (hasSubs && !confirm('Cette cat√©gorie a des sous-cat√©gories. Les supprimer aussi ?')) {
                return;
            }
            
            // Check if used by ingredients
            const usedByIngredients = appState.data.ingredients.some(ing => 
                ing.category === category.name
            );
            
            if (usedByIngredients) {
                showToast('‚ùå Cat√©gorie utilis√©e par des ingr√©dients', 'error');
                return;
            }
            
            // Delete category and its subcategories
            appState.data.categories = appState.data.categories.filter(c => 
                c.id !== categoryId && c.parent !== category.name
            );
            
            saveData();
            
            // Refresh list
            document.getElementById('categoriesList').innerHTML = renderCategoriesList();
            
            showToast('‚úÖ Cat√©gorie supprim√©e', 'success');
        };
        
        // ========================================
        // DLC CUSTOM FILTERS
        // ========================================
        
        // Handle DLC filter change
        function handleDlcFilterChange() {
            const filterType = document.getElementById('filterDlcType')?.value;
            const customFilters = document.getElementById('customDlcFilters');
            
            if (filterType === 'custom' || filterType === 'date') {
                if (customFilters) customFilters.classList.remove('hidden');
                
                // Set defaults
                if (filterType === 'custom') {
                    const today = new Date();
                    const future = new Date();
                    future.setMonth(future.getMonth() + 3);
                    
                    const fromInput = document.getElementById('dlcFrom');
                    const toInput = document.getElementById('dlcTo');
                    if (fromInput) fromInput.value = today.toISOString().split('T')[0];
                    if (toInput) toInput.value = future.toISOString().split('T')[0];
                } else if (filterType === 'date') {
                    const today = new Date().toISOString().split('T')[0];
                    const fromInput = document.getElementById('dlcFrom');
                    const toInput = document.getElementById('dlcTo');
                    if (fromInput) fromInput.value = today;
                    if (toInput) toInput.value = today;
                }
            } else {
                if (customFilters) customFilters.classList.add('hidden');
                appState.customDlcFilter = null;
                filterIngredients();
            }
        }
        
        // Apply custom DLC filter
        window.applyCustomDlcFilter = function() {
            const from = document.getElementById('dlcFrom')?.value;
            const to = document.getElementById('dlcTo')?.value;
            
            if (!from || !to) {
                showToast('‚ùå Veuillez renseigner les deux dates', 'error');
                return;
            }
            
            appState.customDlcFilter = {
                from: new Date(from),
                to: new Date(to)
            };
            
            filterIngredients();
            showToast('‚úÖ Filtre DLC appliqu√©', 'success');
        };

        // Filter Ingredients
        function filterIngredients() {
            const search = document.getElementById('searchIngredients')?.value.toLowerCase() || '';
            const category = document.getElementById('filterCategory')?.value || '';
            const alertType = document.getElementById('filterAlert')?.value || '';
            const dlcType = document.getElementById('filterDlcType')?.value || '';
            
            let filtered = appState.data.ingredients || [];
            
            // Search filter
            if (search) {
                filtered = filtered.filter(ing => 
                    ing.name.toLowerCase().includes(search) ||
                    (ing.category || '').toLowerCase().includes(search)
                );
            }
            
            // Category filter
            if (category) {
                filtered = filtered.filter(ing => ing.category === category);
            }
            
            // Alert filter
            if (alertType) {
                filtered = filtered.filter(ing => {
                    const alerts = ing.alerts || [];
                    if (alertType === 'low') return alerts.some(a => a.type === 'STOCK_LOW');
                    return false;
                });
            }
            
            // DLC filter
            if (dlcType && dlcType !== 'custom' && dlcType !== 'date') {
                const now = new Date();
                
                filtered = filtered.filter(ing => {
                    if (!ing.lots || ing.lots.length === 0) return false;
                    
                    return ing.lots.some(lot => {
                        const dlc = new Date(lot.dlc);
                        
                        if (dlcType === 'expired') {
                            return dlc < now;
                        } else if (dlcType === '7days') {
                            const sevenDays = new Date(now);
                            sevenDays.setDate(sevenDays.getDate() + 7);
                            return dlc >= now && dlc <= sevenDays;
                        } else if (dlcType === '30days') {
                            const thirtyDays = new Date(now);
                            thirtyDays.setDate(thirtyDays.getDate() + 30);
                            return dlc >= now && dlc <= thirtyDays;
                        }
                        
                        return false;
                    });
                });
            }
            
            // Custom DLC filter
            if ((dlcType === 'custom' || dlcType === 'date') && appState.customDlcFilter) {
                filtered = filtered.filter(ing => {
                    if (!ing.lots || ing.lots.length === 0) return false;
                    
                    return ing.lots.some(lot => {
                        const dlc = new Date(lot.dlc);
                        return dlc >= appState.customDlcFilter.from && 
                               dlc <= appState.customDlcFilter.to;
                    });
                });
            }
            
            const grid = document.getElementById('ingredientsGrid');
            if (grid) grid.innerHTML = renderIngredientsCards(filtered);
        }

        // Show Add Ingredient Modal
        window.showAddIngredientModal = function() {
            const modal = document.getElementById('addIngredientModal');
            if (modal) modal.classList.remove('hidden');
        };

        // Close Modal
        window.closeModal = function(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.remove();
            }
        };
        
        // Close modal on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const modals = document.querySelectorAll('.modal');
                modals.forEach(modal => modal.remove());
            }
        });
        
        // Close modal on overlay click
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                e.target.remove();
            }
        });

        // Handle Add Ingredient
        async function handleAddIngredient(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = {
                name: formData.get('name'),
                category: formData.get('category'),
                baseUnit: formData.get('baseUnit'),
                alertBaseQty: Number(formData.get('alertQty')) || 0
            };
            
            const receivedBy = formData.get('lotReceivedBy') || '';
            
            // Validation r√©ceptionnaire obligatoire
            if (!receivedBy) {
                showToast('‚ùå R√©ceptionnaire obligatoire pour tra√ßabilit√© HACCP', 'error');
                return;
            }
            
            const lotData = {
                quantity: Number(formData.get('lotQuantity')),
                unit: formData.get('lotUnit'),
                price: Number(formData.get('lotPrice')),
                fees: Number(formData.get('lotFees')) || 0,
                dlc: formData.get('lotDlc'),
                reception: formData.get('lotReception'),
                supplier: formData.get('lotSupplier'),
                lotNumber: formData.get('lotNumber'),
                receivedBy: receivedBy
            };
            
            try {
                // Create ingredient using IngredientService
                const ingredient = IngredientService.create(data);
                
                // Add first lot
                const result = IngredientService.addLot(ingredient, lotData);
                
                // Save to state (convert to plain object for storage)
                appState.data.ingredients.push(result.ingredient.toJSON());
                saveData();
                
                // Close modal and refresh
                closeModal('addIngredientModal');
                e.target.reset();
                renderIngredientsPage();
                
                // Show success message
                showToast('‚úÖ Ingr√©dient ajout√© avec succ√®s !', 'success');
                
            } catch (error) {
                console.error('Error:', error);
                showToast('‚ùå Erreur: ' + error.message, 'error');
            }
        }

        // Show Toast
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                top: 90px;
                right: 20px;
                background: ${type === 'success' ? 'var(--success)' : 'var(--danger)'};
                color: white;
                padding: 16px 24px;
                border-radius: var(--radius-md);
                box-shadow: var(--shadow-lg);
                z-index: 10000;
                animation: slideIn 0.3s ease;
            `;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // ========================================
        // INGREDIENT DETAILS
        // ========================================
        
        // Show ingredient details modal
        window.showIngredientDetails = function(ingredientId) {
            const ingredient = appState.data.ingredients.find(ing => ing.id === ingredientId);
            if (!ingredient) {
                showToast('‚ùå Ingr√©dient introuvable', 'error');
                return;
            }
            
            const stock = ingredient.getBaseQtyRemaining ? ingredient.getBaseQtyRemaining() : 0;
            // ‚úÖ CORRECTION: Utiliser IngredientService
            const stockValue = IngredientService.getStockValue(ingredient);
            const alerts = ingredient.getAlerts ? ingredient.getAlerts() : [];
            const avgCost = ingredient.getPricePerBaseUnit ? ingredient.getPricePerBaseUnit() : 0;
            
            // Sort lots by FIFO
            const lots = ingredient.lots || [];
            const availableLots = lots.filter(l => !l.epuise && l.quantite > 0);
            const emptyLots = lots.filter(l => l.epuise || l.quantite === 0);
            
            const modal = document.createElement('div');
            modal.id = 'ingredientDetailsModal';
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 900px;">
                    <div class="modal-header">
                        <h2>üìã ${ingredient.name}</h2>
                        <button class="modal-close" onclick="closeModal('ingredientDetailsModal')">‚úï</button>
                    </div>
                    <div class="modal-body">
                        <!-- Summary Stats -->
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: var(--space-md); margin-bottom: var(--space-lg);">
                            <div class="stat-card primary">
                                <div class="stat-label">Stock Total</div>
                                <div class="stat-value">${stock} ${ingredient.baseUnit}</div>
                            </div>
                            <div class="stat-card success">
                                <div class="stat-label">Valeur Stock</div>
                                <div class="stat-value">${formatCurrency(stockValue)}</div>
                            </div>
                            <div class="stat-card warning">
                                <div class="stat-label">Co√ªt Moyen</div>
                                <div class="stat-value">${formatCurrency(avgCost)}/${ingredient.baseUnit}</div>
                            </div>
                            <div class="stat-card danger">
                                <div class="stat-label">Lots Actifs</div>
                                <div class="stat-value">${availableLots.length}</div>
                            </div>
                        </div>
                        
                        <!-- Alerts -->
                        ${alerts.length > 0 ? `
                            <div style="background: #FFF3CD; padding: var(--space-md); border-radius: var(--radius-md); margin-bottom: var(--space-lg); border-left: 4px solid #FFA502;">
                                <h3 style="margin-bottom: var(--space-sm); color: #856404;">‚ö†Ô∏è Alertes (${alerts.length})</h3>
                                ${alerts.map(alert => `
                                    <div style="padding: 8px 0; color: #856404;">
                                        ${alert.severity === 'error' ? 'üî¥' : '‚ö†Ô∏è'} ${alert.message}
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        
                        <!-- Available Lots -->
                        <h3 style="margin-bottom: var(--space-md);">üì¶ Lots Disponibles (${availableLots.length})</h3>
                        ${availableLots.length > 0 ? `
                            <div style="overflow-x: auto; margin-bottom: var(--space-xl);">
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead style="background: var(--light);">
                                        <tr>
                                            <th style="padding: 12px; text-align: left;">N¬∞ Lot</th>
                                            <th style="padding: 12px; text-align: left;">Fournisseur</th>
                                            <th style="padding: 12px; text-align: right;">Qt√© Restante</th>
                                            <th style="padding: 12px; text-align: right;">Valeur</th>
                                            <th style="padding: 12px; text-align: left;">DLC</th>
                                            <th style="padding: 12px; text-align: left;">R√©ception</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${availableLots.map(lot => {
                                            const dlcDate = new Date(lot.dlc);
                                            const daysUntil = lot.daysUntilExpiry ? lot.daysUntilExpiry() : 999;
                                            const dlcColor = daysUntil < 7 ? 'var(--danger)' : daysUntil < 30 ? 'var(--warning)' : 'var(--success)';
                                            
                                            return `
                                                <tr style="border-bottom: 1px solid var(--light);">
                                                    <td style="padding: 12px;">${lot.numeroLot || lot.id.slice(0, 8)}</td>
                                                    <td style="padding: 12px;">${lot.fournisseur || '-'}</td>
                                                    <td style="padding: 12px; text-align: right; font-weight: 600;">${lot.quantite} ${ingredient.baseUnit}</td>
                                                    <td style="padding: 12px; text-align: right;">${formatCurrency(lot.getValeurActuelle ? lot.getValeurActuelle() : 0)}</td>
                                                    <td style="padding: 12px; color: ${dlcColor}; font-weight: 600;">
                                                        ${dlcDate.toLocaleDateString('fr-FR')}
                                                        ${daysUntil < 30 ? `<br><small>(${daysUntil}j)</small>` : ''}
                                                    </td>
                                                    <td style="padding: 12px;">${new Date(lot.dateReception).toLocaleDateString('fr-FR')}</td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : `
                            <div style="text-align: center; padding: var(--space-xl); color: var(--gray);">
                                üì¶ Aucun lot disponible
                            </div>
                        `}
                        
                        <!-- Empty Lots History -->
                        ${emptyLots.length > 0 ? `
                            <details style="margin-top: var(--space-lg);">
                                <summary style="cursor: pointer; font-weight: 600; margin-bottom: var(--space-md);">
                                    üìú Historique Lots √âpuis√©s (${emptyLots.length})
                                </summary>
                                <div style="overflow-x: auto;">
                                    <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                                        <thead style="background: var(--light);">
                                            <tr>
                                                <th style="padding: 10px; text-align: left;">N¬∞ Lot</th>
                                                <th style="padding: 10px; text-align: left;">Fournisseur</th>
                                                <th style="padding: 10px; text-align: right;">Qt√© Initiale</th>
                                                <th style="padding: 10px; text-align: left;">DLC</th>
                                                <th style="padding: 10px; text-align: left;">R√©ception</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${emptyLots.map(lot => `
                                                <tr style="border-bottom: 1px solid var(--light); opacity: 0.6;">
                                                    <td style="padding: 10px;">${lot.numeroLot || lot.id.slice(0, 8)}</td>
                                                    <td style="padding: 10px;">${lot.fournisseur || '-'}</td>
                                                    <td style="padding: 10px; text-align: right;">${lot.quantiteInitiale} ${ingredient.baseUnit}</td>
                                                    <td style="padding: 10px;">${new Date(lot.dlc).toLocaleDateString('fr-FR')}</td>
                                                    <td style="padding: 10px;">${new Date(lot.dateReception).toLocaleDateString('fr-FR')}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </details>
                        ` : ''}
                        
                        <!-- Actions -->
                        <div style="display: flex; gap: var(--space-md); margin-top: var(--space-xl);">
                            <button class="btn btn-primary" onclick="closeModal('ingredientDetailsModal'); showAddLotModal('${ingredientId}');">
                                ‚ûï Ajouter un lot
                            </button>
                            <button class="btn" style="background: var(--danger); color: white;" onclick="closeModal('ingredientDetailsModal'); showRecordLossModal('${ingredientId}');">
                                ‚ùå Enregistrer une perte
                            </button>
                            <button class="btn" style="background: var(--secondary); color: white;" onclick="closeModal('ingredientDetailsModal'); showInventoryModal('${ingredientId}');">
                                üìä Inventaire
                            </button>
                            <button class="btn" style="background: var(--gray); color: white; margin-left: auto;" onclick="closeModal('ingredientDetailsModal')">
                                Fermer
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        };

        // ========================================
        // ADD LOT
        // ========================================
        
        window.showAddLotModal = function(ingredientId) {
            const ingredient = appState.data.ingredients.find(ing => ing.id === ingredientId);
            if (!ingredient) {
                showToast('‚ùå Ingr√©dient introuvable', 'error');
                return;
            }
            
            const modal = document.createElement('div');
            modal.id = 'addLotModal';
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>‚ûï Ajouter un lot - ${ingredient.name}</h2>
                        <button class="modal-close" onclick="closeModal('addLotModal')">‚úï</button>
                    </div>
                    <div class="modal-body">
                        <form id="addLotForm">
                            <input type="hidden" name="ingredientId" value="${ingredientId}">
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Quantit√© *</label>
                                    <input type="number" name="quantity" required placeholder="Ex: 25" min="0" step="0.01">
                                </div>
                                <div class="form-group">
                                    <label>Unit√© *</label>
                                    <select name="unit" required>
                                        <option value="${ingredient.baseUnit}">${ingredient.baseUnit}</option>
                                        ${ingredient.baseUnit === 'g' ? '<option value="kg">kg</option>' : ''}
                                        ${ingredient.baseUnit === 'ml' ? '<option value="L">L</option>' : ''}
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Prix d'achat HT *</label>
                                    <input type="number" name="price" required placeholder="Ex: 15000" min="0" step="0.01">
                                </div>
                                <div class="form-group">
                                    <label>Frais d'approche</label>
                                    <input type="number" name="fees" placeholder="Ex: 500" min="0" step="0.01" value="0">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Co√ªt unitaire calcul√©</label>
                                <div id="calculatedCost" style="padding: 12px; background: var(--light); border-radius: var(--radius-md); font-weight: 600; color: var(--primary);">
                                    - FCFA/${ingredient.baseUnit}
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>DLC *</label>
                                    <input type="date" name="dlc" required>
                                </div>
                                <div class="form-group">
                                    <label>Date r√©ception *</label>
                                    <input type="date" name="reception" required>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Fournisseur</label>
                                <input type="text" name="supplier" placeholder="Nom du fournisseur">
                            </div>
                            
                            <div class="form-group">
                                <label>Num√©ro de lot</label>
                                <input type="text" name="lotNumber" placeholder="Ex: LOT123456">
                            </div>
                            
                            <div style="display: flex; gap: var(--space-md); margin-top: var(--space-lg);">
                                <button type="button" class="btn" style="flex: 1; background: var(--gray); color: white;" onclick="closeModal('addLotModal')">
                                    Annuler
                                </button>
                                <button type="submit" class="btn btn-primary" style="flex: 1;">
                                    ‚úÖ Ajouter le lot
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Set default dates
            const today = new Date().toISOString().split('T')[0];
            modal.querySelector('[name="reception"]').value = today;
            
            const futureDate = new Date();
            futureDate.setMonth(futureDate.getMonth() + 6);
            modal.querySelector('[name="dlc"]').value = futureDate.toISOString().split('T')[0];
            
            // Calculate cost on input
            const priceInput = modal.querySelector('[name="price"]');
            const feesInput = modal.querySelector('[name="fees"]');
            const qtyInput = modal.querySelector('[name="quantity"]');
            const unitSelect = modal.querySelector('[name="unit"]');
            
            function updateCost() {
                const price = Number(priceInput.value) || 0;
                const fees = Number(feesInput.value) || 0;
                let qty = Number(qtyInput.value) || 0;
                const unit = unitSelect.value;
                
                // Convert to base unit
                if (unit === 'kg' && ingredient.baseUnit === 'g') qty *= 1000;
                if (unit === 'L' && ingredient.baseUnit === 'ml') qty *= 1000;
                
                if (qty > 0) {
                    const unitCost = (price + fees) / qty;
                    // Show with 2 decimals for precision
                    modal.querySelector('#calculatedCost').textContent = unitCost.toFixed(2) + ' FCFA/' + ingredient.baseUnit;
                }
            }
            
            priceInput.addEventListener('input', updateCost);
            feesInput.addEventListener('input', updateCost);
            qtyInput.addEventListener('input', updateCost);
            unitSelect.addEventListener('change', updateCost);
            
            // Handle form submit
            modal.querySelector('#addLotForm').addEventListener('submit', handleAddLot);
        };
        
        async function handleAddLot(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const ingredientId = formData.get('ingredientId');
            
            const ingredient = appState.data.ingredients.find(ing => ing.id === ingredientId);
            if (!ingredient) {
                showToast('‚ùå Ingr√©dient introuvable', 'error');
                return;
            }
            
            let quantity = Number(formData.get('quantity'));
            const unit = formData.get('unit');
            
            // Convert to base unit for display
            let addedQty = quantity;
            if (unit === 'kg' && ingredient.baseUnit === 'g') addedQty = quantity * 1000;
            if (unit === 'L' && ingredient.baseUnit === 'ml') addedQty = quantity * 1000;
            
            const lotData = {
                quantity: quantity,
                unit: unit,
                price: Number(formData.get('price')),
                fees: Number(formData.get('fees')) || 0,
                dlc: formData.get('dlc'),
                reception: formData.get('reception'),
                supplier: formData.get('supplier'),
                lotNumber: formData.get('lotNumber')
            };
            
            try {
                const result = IngredientService.addLot(ingredient, lotData);
                
                // Update in state
                const index = appState.data.ingredients.findIndex(ing => ing.id === ingredientId);
                if (index !== -1) {
                    appState.data.ingredients[index] = result.ingredient;
                }
                
                saveData();
                closeModal('addLotModal');
                renderIngredientsPage();
                
                showToast(`‚úÖ Lot ajout√© ! +${addedQty} ${ingredient.baseUnit}`, 'success');
                
            } catch (error) {
                console.error('Error:', error);
                showToast('‚ùå Erreur: ' + error.message, 'error');
            }
        }

        // ========================================
        // RECORD LOSS
        // ========================================
        
        window.showRecordLossModal = function(ingredientId) {
            const ingredient = appState.data.ingredients.find(ing => ing.id === ingredientId);
            if (!ingredient) {
                showToast('‚ùå Ingr√©dient introuvable', 'error');
                return;
            }
            
            const stock = ingredient.getBaseQtyRemaining ? ingredient.getBaseQtyRemaining() : 0;
            
            const modal = document.createElement('div');
            modal.id = 'recordLossModal';
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>‚ùå Enregistrer une perte - ${ingredient.name}</h2>
                        <button class="modal-close" onclick="closeModal('recordLossModal')">‚úï</button>
                    </div>
                    <div class="modal-body">
                        <div style="background: var(--light); padding: var(--space-md); border-radius: var(--radius-md); margin-bottom: var(--space-lg);">
                            <strong>Stock actuel :</strong> ${stock} ${ingredient.baseUnit}
                        </div>
                        
                        <form id="recordLossForm">
                            <input type="hidden" name="ingredientId" value="${ingredientId}">
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Quantit√© perdue *</label>
                                    <input type="number" name="quantity" required placeholder="Ex: 500" min="0.01" max="${stock}" step="0.01">
                                </div>
                                <div class="form-group">
                                    <label>Unit√©</label>
                                    <select name="unit">
                                        <option value="${ingredient.baseUnit}">${ingredient.baseUnit}</option>
                                        ${ingredient.baseUnit === 'g' ? '<option value="kg">kg</option>' : ''}
                                        ${ingredient.baseUnit === 'ml' ? '<option value="L">L</option>' : ''}
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Raison de la perte *</label>
                                <select name="reason" required>
                                    <option value="">S√©lectionner...</option>
                                    <option value="casse">Casse / D√©t√©rioration</option>
                                    <option value="dlc">DLC d√©pass√©e</option>
                                    <option value="qualite">Probl√®me qualit√©</option>
                                    <option value="vol">Vol / Perte</option>
                                    <option value="autre">Autre</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>Notes / D√©tails</label>
                                <textarea name="notes" rows="3" placeholder="Pr√©cisions sur la perte..." style="width: 100%; padding: 12px; border: 2px solid var(--light); border-radius: var(--radius-md); font-family: var(--font-body);"></textarea>
                            </div>
                            
                            <div style="display: flex; gap: var(--space-md); margin-top: var(--space-lg);">
                                <button type="button" class="btn" style="flex: 1; background: var(--gray); color: white;" onclick="closeModal('recordLossModal')">
                                    Annuler
                                </button>
                                <button type="submit" class="btn" style="flex: 1; background: var(--danger); color: white;">
                                    ‚ùå Enregistrer la perte
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            modal.querySelector('#recordLossForm').addEventListener('submit', handleRecordLoss);
        };
        
        async function handleRecordLoss(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const ingredientId = formData.get('ingredientId');
            
            const ingredient = appState.data.ingredients.find(ing => ing.id === ingredientId);
            if (!ingredient) {
                showToast('‚ùå Ingr√©dient introuvable', 'error');
                return;
            }
            
            let quantity = Number(formData.get('quantity'));
            const unit = formData.get('unit');
            
            // Convert to base unit
            if (unit === 'kg' && ingredient.baseUnit === 'g') quantity *= 1000;
            if (unit === 'L' && ingredient.baseUnit === 'ml') quantity *= 1000;
            
            const reason = formData.get('reason');
            const notes = formData.get('notes');
            
            try {
                // IngredientService.recordLoss signature: (ingredient, quantity, reason)
                const result = IngredientService.recordLoss(
                    ingredient,
                    quantity,
                    `${reason}${notes ? ' - ' + notes : ''}`
                );
                
                // Update in state
                const index = appState.data.ingredients.findIndex(ing => ing.id === ingredientId);
                if (index !== -1) {
                    appState.data.ingredients[index] = result.ingredient;
                }
                
                saveData();
                closeModal('recordLossModal');
                renderIngredientsPage();
                
                // Calculate loss value from lotsUsed
                const lossValue = result.lotsUsed ? 
                    result.lotsUsed.reduce((sum, l) => sum + l.cost, 0) : 0;
                
                showToast(`‚úÖ Perte enregistr√©e : -${quantity} ${ingredient.baseUnit} (${formatCurrency(lossValue)})`, 'success');
                
            } catch (error) {
                console.error('Error:', error);
                showToast('‚ùå Erreur: ' + error.message, 'error');
            }
        }

        // ========================================
        // INVENTORY
        // ========================================
        
        window.showInventoryModal = function(ingredientId) {
            const ingredient = appState.data.ingredients.find(ing => ing.id === ingredientId);
            if (!ingredient) {
                showToast('‚ùå Ingr√©dient introuvable', 'error');
                return;
            }
            
            const currentStock = ingredient.getBaseQtyRemaining ? ingredient.getBaseQtyRemaining() : 0;
            
            const modal = document.createElement('div');
            modal.id = 'inventoryModal';
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>üìä Inventaire - ${ingredient.name}</h2>
                        <button class="modal-close" onclick="closeModal('inventoryModal')">‚úï</button>
                    </div>
                    <div class="modal-body">
                        <div style="background: var(--light); padding: var(--space-md); border-radius: var(--radius-md); margin-bottom: var(--space-lg);">
                            <strong>Stock syst√®me actuel :</strong> ${currentStock} ${ingredient.baseUnit}
                        </div>
                        
                        <form id="inventoryForm">
                            <input type="hidden" name="ingredientId" value="${ingredientId}">
                            <input type="hidden" name="currentStock" value="${currentStock}">
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Stock r√©el compt√© *</label>
                                    <input type="number" id="countedStock" name="countedStock" required placeholder="Ex: ${currentStock}" min="0" step="0.01">
                                </div>
                                <div class="form-group">
                                    <label>Unit√©</label>
                                    <select name="unit">
                                        <option value="${ingredient.baseUnit}">${ingredient.baseUnit}</option>
                                        ${ingredient.baseUnit === 'g' ? '<option value="kg">kg</option>' : ''}
                                        ${ingredient.baseUnit === 'ml' ? '<option value="L">L</option>' : ''}
                                    </select>
                                </div>
                            </div>
                            
                            <div id="differenceDisplay" style="padding: var(--space-md); border-radius: var(--radius-md); margin-bottom: var(--space-md); display: none;">
                                <strong>Diff√©rence :</strong> <span id="differenceValue"></span>
                            </div>
                            
                            <div class="form-group">
                                <label>Raison de l'ajustement *</label>
                                <select name="reason" required>
                                    <option value="">S√©lectionner...</option>
                                    <option value="inventaire">Inventaire p√©riodique</option>
                                    <option value="erreur_saisie">Erreur de saisie</option>
                                    <option value="casse_non_enregistree">Casse non enregistr√©e</option>
                                    <option value="vol">Vol d√©tect√©</option>
                                    <option value="autre">Autre</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>Notes / Justification *</label>
                                <textarea name="notes" rows="3" required placeholder="Expliquer la raison de l'√©cart..." style="width: 100%; padding: 12px; border: 2px solid var(--light); border-radius: var(--radius-md); font-family: var(--font-body);"></textarea>
                            </div>
                            
                            <div style="display: flex; gap: var(--space-md); margin-top: var(--space-lg);">
                                <button type="button" class="btn" style="flex: 1; background: var(--gray); color: white;" onclick="closeModal('inventoryModal')">
                                    Annuler
                                </button>
                                <button type="submit" class="btn btn-primary" style="flex: 1;">
                                    ‚úÖ Ajuster le stock
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Calculate difference on input
            const countedInput = modal.querySelector('#countedStock');
            const unitSelect = modal.querySelector('[name="unit"]');
            const diffDisplay = modal.querySelector('#differenceDisplay');
            const diffValue = modal.querySelector('#differenceValue');
            
            function updateDifference() {
                let counted = Number(countedInput.value) || 0;
                const unit = unitSelect.value;
                
                // Convert to base unit
                if (unit === 'kg' && ingredient.baseUnit === 'g') counted *= 1000;
                if (unit === 'L' && ingredient.baseUnit === 'ml') counted *= 1000;
                
                const diff = counted - currentStock;
                
                if (countedInput.value) {
                    diffDisplay.style.display = 'block';
                    if (diff > 0) {
                        diffDisplay.style.background = '#d4edda';
                        diffDisplay.style.color = '#155724';
                        diffValue.textContent = `+${diff} ${ingredient.baseUnit} (Exc√©dent)`;
                    } else if (diff < 0) {
                        diffDisplay.style.background = '#f8d7da';
                        diffDisplay.style.color = '#721c24';
                        diffValue.textContent = `${diff} ${ingredient.baseUnit} (Manquant)`;
                    } else {
                        diffDisplay.style.background = '#d4edda';
                        diffDisplay.style.color = '#155724';
                        diffValue.textContent = `Aucune diff√©rence (Stock correct)`;
                    }
                }
            }
            
            countedInput.addEventListener('input', updateDifference);
            unitSelect.addEventListener('change', updateDifference);
            
            modal.querySelector('#inventoryForm').addEventListener('submit', handleInventory);
        };
        
        async function handleInventory(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const ingredientId = formData.get('ingredientId');
            
            const ingredient = appState.data.ingredients.find(ing => ing.id === ingredientId);
            if (!ingredient) {
                showToast('‚ùå Ingr√©dient introuvable', 'error');
                return;
            }
            
            let counted = Number(formData.get('countedStock'));
            const unit = formData.get('unit');
            
            // Convert to base unit
            if (unit === 'kg' && ingredient.baseUnit === 'g') counted *= 1000;
            if (unit === 'L' && ingredient.baseUnit === 'ml') counted *= 1000;
            
            const currentStock = Number(formData.get('currentStock'));
            const reason = formData.get('reason');
            const notes = formData.get('notes');
            
            try {
                const result = IngredientService.adjustInventory(ingredient, {
                    newQuantity: counted,
                    reason,
                    notes,
                    date: new Date().toISOString()
                });
                
                // Update in state
                const index = appState.data.ingredients.findIndex(ing => ing.id === ingredientId);
                if (index !== -1) {
                    appState.data.ingredients[index] = result.ingredient;
                }
                
                saveData();
                closeModal('inventoryModal');
                renderIngredientsPage();
                
                const diff = counted - currentStock;
                const diffText = diff > 0 ? `+${diff}` : `${diff}`;
                showToast(`‚úÖ Inventaire ajust√© : ${diffText} ${ingredient.baseUnit}`, 'success');
                
            } catch (error) {
                console.error('Error:', error);
                showToast('‚ùå Erreur: ' + error.message, 'error');
            }
        }
        
        // Placeholder functions
        window.showIngredientDetails_OLD = function(id) {
            showToast('üìã D√©tails - En d√©veloppement', 'info');
        };

        window.showAddLotModal_OLD = function(id) {
            showToast('‚ûï Ajout lot - En d√©veloppement', 'info');
        };

        window.showRecordLossModal_OLD = function(id) {
            showToast('‚ùå Perte - En d√©veloppement', 'info');
        };

        window.showInventoryModal_OLD = function(id) {
            showToast('üìä Inventaire - En d√©veloppement', 'info');
        };

        // ========================================
        // NAVIGATION
        // ========================================
        
        // Show page
        window.showPage = function(pageName) {
            appState.currentPage = pageName;
            
            // Update active nav
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('data-page') === pageName) {
                    link.classList.add('active');
                }
            });

            // Render page
            switch(pageName) {
                case 'dashboard':
                    renderDashboard();
                    break;
                case 'ingredients':
                    renderIngredientsPage();
                    break;
                case 'recipes':
                    renderRecipesPage();
                    break;
                case 'production':
                    renderProductionsPage();
                    break;
                case 'sales':
                    renderSalesPage();
                    break;
                case 'personnel':
                    renderPersonnelPage();
                    break;
                case 'packs':
                    renderPacksPage();
                    break;
                default:
                    document.getElementById('mainContent').innerHTML = `<h1>${pageName} - En d√©veloppement...</h1>`;
            }
        };

        // Navigation
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const page = link.getAttribute('data-page');
                showPage(page);
            });
        });

        // Language switcher
        document.querySelectorAll('[data-lang]').forEach(btn => {
            btn.addEventListener('click', () => {
                const lang = btn.getAttribute('data-lang');
                appState.currentLang = lang;
                
                // Update active button
                btn.parentElement.querySelectorAll('button').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                // Update translations
                updateTranslations();
                renderDashboard();
            });
        });

        // Currency switcher
        document.querySelectorAll('[data-currency]').forEach(btn => {
            btn.addEventListener('click', () => {
                const currency = btn.getAttribute('data-currency');
                appState.currentCurrency = currency;
                
                // Update active button
                btn.parentElement.querySelectorAll('button').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                // Re-render to update currency
                renderDashboard();
            });
        });

        // Initialize app
        // Load W.E Salon de Th√© demo data
        window.loadDemoWE = function() {
            if (confirm('‚ö†Ô∏è Charger la d√©mo "W.E Salon de Th√©" ?\n\nCeci va remplacer toutes vos donn√©es actuelles par un sc√©nario de salon de th√© complet avec :\n- 18 ingr√©dients\n- 9 recettes (gaufres, jus, g√¢teaux)\n- 2 productions\n- 2 vendeurs\n\nContinuer ?')) {
                try {
                    // Convert ingredients
                    const convertedIngredients = demoWESalon.ingredients.map(ing => {
                        return Ingredient.fromJSON(ing);
                    });
                    
                    // Convert recipes
                    const convertedRecipes = demoWESalon.recipes.map(rec => {
                        return Recipe.fromJSON(rec);
                    });
                    
                    // Convert productions
                    const convertedProductions = demoWESalon.productions.map(prod => {
                        return Production.fromJSON(prod);
                    });
                    
                    // Update appState
                    appState.data = {
                        ingredients: convertedIngredients,
                        recipes: convertedRecipes,
                        productions: convertedProductions,
                        sales: demoWESalon.sales || [],
                        expenses: demoWESalon.expenses || [],
                        categories: demoWESalon.categories || [],
                        vendors: demoWESalon.vendors || [],
                        staff: demoWESalon.staff || []
                    };
                    
                    // Save
                    saveData();
                    
                    // Refresh page
                    showToast('‚úÖ D√©mo "W.E Salon de Th√©" charg√©e avec succ√®s !', 'success');
                    setTimeout(() => location.reload(), 1000);
                    
                } catch (error) {
                    console.error('Erreur chargement d√©mo:', error);
                    showToast('‚ùå Erreur: ' + error.message, 'error');
                }
            }
        };

        function initApp() {
            loadData();
            
            // Load saved currency preference
            const savedCurrency = localStorage.getItem('selectedCurrency');
            if (savedCurrency && currencyFormats[savedCurrency]) {
                appState.currentCurrency = savedCurrency;
            }
            
            // Setup currency switcher
            document.querySelectorAll('[data-currency]').forEach(btn => {
                // Update active state on load
                if (btn.getAttribute('data-currency') === appState.currentCurrency) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
                
                // Add click handler
                btn.addEventListener('click', () => {
                    const newCurrency = btn.getAttribute('data-currency');
                    
                    // Update state
                    appState.currentCurrency = newCurrency;
                    
                    // Save preference
                    localStorage.setItem('selectedCurrency', newCurrency);
                    
                    // Update active button
                    document.querySelectorAll('[data-currency]').forEach(b => {
                        b.classList.remove('active');
                    });
                    btn.classList.add('active');
                    
                    // Re-render current page to update all amounts
                    const currentPage = appState.currentPage;
                    if (currentPage === 'dashboard') {
                        renderDashboard();
                    } else if (currentPage === 'ingredients') {
                        renderIngredientsPage();
                    } else if (currentPage === 'recipes') {
                        renderRecipesPage();
                    } else if (currentPage === 'production') {
                        renderProductionsPage();
                    } else if (currentPage === 'sales') {
                        renderSalesPage();
                    }
                    
                    // Show toast
                    const currencyName = {
                        'XAF': 'FCFA',
                        'EUR': 'Euro (‚Ç¨)',
                        'USD': 'Dollar ($)',
                        'GBP': 'Livre (¬£)'
                    };
                    showToast(`üí± Devise chang√©e : ${currencyName[newCurrency]}`, 'info');
                });
            });
            
            renderDashboard();
            updateAlertsBadge();
        }

        // Start app
        initApp();
    </script>
</body>
</html>
