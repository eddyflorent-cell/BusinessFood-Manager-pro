<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BusinessFood Manager - Gestion Pro</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&family=Bebas+Neue&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Colors - Funky Bakery Theme */
            --primary: #FF6B35;
            --primary-dark: #E55A2B;
            --secondary: #4ECDC4;
            --accent: #FFE66D;
            --success: #26DE81;
            --danger: #FC5C65;
            --warning: #FFA502;
            --info: #45AAF2;
            
            /* Neutrals */
            --dark: #1A1A2E;
            --dark-light: #16213E;
            --gray: #8B8B8B;
            --light: #F8F9FA;
            --white: #FFFFFF;
            
            /* Gradients */
            --gradient-primary: linear-gradient(135deg, #FF6B35 0%, #FFE66D 100%);
            --gradient-dark: linear-gradient(135deg, #1A1A2E 0%, #16213E 100%);
            --gradient-success: linear-gradient(135deg, #26DE81 0%, #4ECDC4 100%);
            
            /* Shadows */
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.08);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.12);
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.16);
            --shadow-primary: 0 8px 24px rgba(255, 107, 53, 0.3);
            
            /* Typography */
            --font-display: 'Bebas Neue', sans-serif;
            --font-body: 'Poppins', sans-serif;
            
            /* Spacing */
            --space-xs: 0.5rem;
            --space-sm: 1rem;
            --space-md: 1.5rem;
            --space-lg: 2rem;
            --space-xl: 3rem;
            
            /* Border Radius */
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 20px;
            --radius-xl: 32px;
            
            /* Transitions */
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            font-family: var(--font-body);
            background: var(--light);
            color: var(--dark);
            overflow-x: hidden;
        }

        /* Layout */
        .app-container {
            display: grid;
            grid-template-columns: 280px 1fr;
            grid-template-rows: 70px 1fr;
            grid-template-areas:
                "sidebar header"
                "sidebar main";
            min-height: 100vh;
        }

        /* Header */
        .header {
            grid-area: header;
            background: var(--white);
            padding: 0 var(--space-lg);
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--shadow-sm);
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: var(--space-md);
        }

        .search-bar {
            position: relative;
            width: 400px;
        }

        .search-bar input {
            width: 100%;
            padding: 12px 20px 12px 48px;
            border: 2px solid transparent;
            background: var(--light);
            border-radius: var(--radius-lg);
            font-family: var(--font-body);
            font-size: 14px;
            transition: var(--transition);
        }

        .search-bar input:focus {
            outline: none;
            border-color: var(--primary);
            background: var(--white);
        }

        .search-bar::before {
            content: 'üîç';
            position: absolute;
            left: 18px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 18px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: var(--space-md);
        }

        /* Language & Currency Switcher */
        .switcher {
            display: flex;
            gap: var(--space-xs);
            background: var(--light);
            padding: 6px;
            border-radius: var(--radius-md);
        }

        .switcher button {
            padding: 8px 16px;
            border: none;
            background: transparent;
            border-radius: var(--radius-sm);
            font-family: var(--font-body);
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            transition: var(--transition);
            color: var(--gray);
        }

        .switcher button.active {
            background: var(--white);
            color: var(--primary);
            box-shadow: var(--shadow-sm);
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            padding: 8px 16px;
            background: var(--gradient-primary);
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow-primary);
        }

        .user-menu:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 32px rgba(255, 107, 53, 0.4);
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--white);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: var(--primary);
            font-size: 16px;
        }

        .user-name {
            color: var(--white);
            font-weight: 600;
            font-size: 14px;
        }

        /* Sidebar */
        .sidebar {
            grid-area: sidebar;
            background: var(--gradient-dark);
            padding: var(--space-lg);
            box-shadow: var(--shadow-lg);
            position: relative;
            overflow-y: auto;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            margin-bottom: var(--space-xl);
            padding-bottom: var(--space-lg);
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }

        .logo-icon {
            width: 48px;
            height: 48px;
            background: var(--gradient-primary);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
        }

        .logo-text {
            font-family: var(--font-display);
            font-size: 28px;
            color: var(--white);
            letter-spacing: 1px;
        }

        .nav-menu {
            list-style: none;
        }

        .nav-item {
            margin-bottom: var(--space-xs);
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            padding: 14px 18px;
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
            border-radius: var(--radius-md);
            transition: var(--transition);
            font-weight: 500;
            font-size: 15px;
            position: relative;
        }

        .nav-link:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--white);
            transform: translateX(4px);
        }

        .nav-link.active {
            background: var(--gradient-primary);
            color: var(--white);
            box-shadow: var(--shadow-primary);
        }

        .nav-link.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 70%;
            background: var(--white);
            border-radius: 0 4px 4px 0;
        }

        .nav-icon {
            font-size: 22px;
            width: 28px;
            text-align: center;
        }

        .nav-badge {
            margin-left: auto;
            background: var(--danger);
            color: var(--white);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
        }

        /* Main Content */
        .main-content {
            grid-area: main;
            padding: var(--space-lg);
            overflow-y: auto;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .page-header {
            margin-bottom: var(--space-lg);
        }

        .page-title {
            font-family: var(--font-display);
            font-size: 48px;
            color: var(--dark);
            margin-bottom: var(--space-xs);
            letter-spacing: 1px;
        }

        .page-subtitle {
            color: var(--gray);
            font-size: 16px;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: var(--space-md);
            margin-bottom: var(--space-xl);
        }

        .stat-card {
            background: var(--white);
            padding: var(--space-lg);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            position: relative;
            overflow: hidden;
            transition: var(--transition);
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
        }

        .stat-card.primary::before {
            background: var(--gradient-primary);
        }

        .stat-card.success::before {
            background: var(--gradient-success);
        }

        .stat-card.warning::before {
            background: linear-gradient(135deg, #FFA502 0%, #FFE66D 100%);
        }

        .stat-card.danger::before {
            background: linear-gradient(135deg, #FC5C65 0%, #FF6B35 100%);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-sm);
        }

        .stat-label {
            color: var(--gray);
            font-size: 14px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-icon {
            font-size: 32px;
            opacity: 0.3;
        }

        .stat-value {
            font-size: 36px;
            font-weight: 800;
            color: var(--dark);
            margin-bottom: var(--space-xs);
        }

        .stat-change {
            display: flex;
            align-items: center;
            gap: var(--space-xs);
            font-size: 13px;
            font-weight: 600;
        }

        .stat-change.positive {
            color: var(--success);
        }

        .stat-change.negative {
            color: var(--danger);
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: var(--radius-md);
            font-family: var(--font-body);
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: var(--space-xs);
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: var(--white);
            box-shadow: var(--shadow-primary);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 32px rgba(255, 107, 53, 0.4);
        }

        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-md);
            margin-bottom: var(--space-xl);
        }

        .action-card {
            background: var(--white);
            padding: var(--space-lg);
            border-radius: var(--radius-lg);
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            border: 2px solid transparent;
        }

        .action-card:hover {
            border-color: var(--primary);
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .action-icon {
            font-size: 48px;
            margin-bottom: var(--space-sm);
        }

        .action-title {
            font-weight: 600;
            font-size: 16px;
            color: var(--dark);
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .app-container {
                grid-template-columns: 1fr;
                grid-template-areas:
                    "header"
                    "main";
            }

            .sidebar {
                position: fixed;
                left: -280px;
                top: 0;
                height: 100vh;
                z-index: 1000;
                transition: var(--transition);
            }

            .sidebar.open {
                left: 0;
            }
        }

        /* Loading Animation */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: var(--space-xl);
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--light);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Hidden class */
        .hidden {
            display: none !important;
        }

        /* Ingredients Module Styles */
        .ingredient-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            box-shadow: var(--shadow-sm);
            transition: var(--transition);
            border: 2px solid transparent;
        }
        
        .ingredient-card:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow-md);
            transform: translateY(-4px);
        }
        
        /* üõ°Ô∏è Style pour packs √† perte */
        .ingredient-card.loss-warning {
            border-color: var(--danger);
            background: linear-gradient(135deg, #fff 0%, #ffebee 100%);
        }
        
        .ingredient-card.loss-warning:hover {
            border-color: var(--danger);
            box-shadow: 0 4px 16px rgba(252, 92, 101, 0.3);
        }
        
        .ingredient-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--space-md);
            padding-bottom: var(--space-md);
            border-bottom: 2px solid var(--light);
        }
        
        .ingredient-name {
            font-weight: 700;
            font-size: 18px;
            color: var(--dark);
            margin-bottom: 4px;
        }
        
        .ingredient-category {
            display: inline-block;
            background: var(--light);
            color: var(--gray);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .alert-badge {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }
        
        .alert-badge.warning {
            background: #FFF3CD;
        }
        
        .alert-badge.danger {
            background: #F8D7DA;
        }
        
        .ingredient-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--space-sm);
            margin-bottom: var(--space-md);
        }
        
        .stat-item {
            display: flex;
            flex-direction: column;
        }
        
        .stat-label {
            font-size: 11px;
            text-transform: uppercase;
            color: var(--gray);
            font-weight: 600;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        
        .stat-value {
            font-size: 16px;
            font-weight: 700;
            color: var(--dark);
        }
        
        .text-danger {
            color: var(--danger) !important;
        }
        
        .ingredient-alerts {
            margin-bottom: var(--space-md);
        }
        
        .alert-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: var(--radius-sm);
            font-size: 13px;
            margin-bottom: 6px;
        }
        
        .alert-item.warning {
            background: #FFF3CD;
            color: #856404;
        }
        
        .alert-item.error {
            background: #F8D7DA;
            color: #721C24;
        }
        
        .alert-more {
            font-size: 12px;
            color: var(--gray);
            text-align: center;
            margin-top: 4px;
        }
        
        .ingredient-actions {
            display: flex;
            gap: 8px;
        }
        
        .action-btn {
            flex: 1;
            padding: 10px;
            border: 2px solid var(--light);
            background: white;
            border-radius: var(--radius-md);
            font-size: 18px;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .action-btn:hover {
            border-color: var(--primary);
            background: var(--light);
            transform: scale(1.05);
        }
        
        /* Progress bar */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--light);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--success);
            transition: width 0.3s ease;
        }
        
        .progress-fill.low {
            background: var(--warning);
        }
        
        .progress-fill.exhausted {
            background: var(--gray);
        }
        
        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }
        
        .modal-content {
            background: white;
            border-radius: var(--radius-xl);
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }
        
        .modal-header {
            padding: var(--space-lg);
            border-bottom: 2px solid var(--light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 {
            font-family: var(--font-display);
            font-size: 28px;
            margin: 0;
        }
        
        .modal-close {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background: var(--light);
            font-size: 20px;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .modal-close:hover {
            background: var(--danger);
            color: white;
        }
        
        .modal-body {
            padding: var(--space-lg);
        }
        
        .form-group {
            margin-bottom: var(--space-md);
        }
        
        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--dark);
            font-size: 14px;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--light);
            border-radius: var(--radius-md);
            font-family: var(--font-body);
            font-size: 14px;
            transition: var(--transition);
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-md);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes slideOut {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(100px);
            }
        }
        
        /* Ingredient lines for recipe forms */
        .ingredient-line {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr auto;
            gap: var(--space-sm);
            margin-bottom: var(--space-sm);
            align-items: center;
        }
        
        .ingredient-line select,
        .ingredient-line input {
            width: 100%;
        }
        
        @media (max-width: 768px) {
            .ingredient-line {
                grid-template-columns: 1fr;
            }
        }
        
        /* Print styles for recipes */
        @media print {
            /* Hide everything except recipe modal */
            body > *:not(.modal) {
                display: none !important;
            }
            
            /* Show only recipe modal */
            .modal {
                position: static !important;
                background: white !important;
                padding: 0 !important;
            }
            
            .modal-content {
                box-shadow: none !important;
                max-width: 100% !important;
                margin: 0 !important;
                border: none !important;
            }
            
            /* Hide buttons and close */
            .modal-close,
            .modal-footer,
            .ingredient-actions,
            button {
                display: none !important;
            }
            
            /* Recipe title */
            .modal-header {
                border: none !important;
                padding: 20px 0 !important;
            }
            
            .modal-header h2 {
                font-size: 24pt !important;
                margin: 0 !important;
            }
            
            /* Recipe content */
            .modal-body {
                padding: 0 !important;
            }
            
            /* Stats cards */
            .stat-card {
                break-inside: avoid;
                page-break-inside: avoid;
                border: 1px solid #ddd !important;
                padding: 10px !important;
            }
            
            /* Ingredients table */
            table {
                width: 100% !important;
                border-collapse: collapse !important;
                margin: 20px 0 !important;
            }
            
            table th,
            table td {
                border: 1px solid #ddd !important;
                padding: 8px !important;
                text-align: left !important;
            }
            
            table th {
                background-color: #f5f5f5 !important;
                font-weight: bold !important;
            }
            
            /* Instructions */
            pre {
                white-space: pre-wrap !important;
                font-family: Arial, sans-serif !important;
                font-size: 11pt !important;
                line-height: 1.6 !important;
                page-break-inside: avoid !important;
            }
            
            /* Page breaks */
            h3 {
                page-break-after: avoid !important;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo">
                <div class="logo-icon">üçû</div>
                <span class="logo-text" data-i18n="app_name">BUSINESSFOOD</span>
            </div>

            <nav>
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a href="#" class="nav-link active" data-page="dashboard">
                            <span class="nav-icon">üìä</span>
                            <span data-i18n="dashboard">Dashboard</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-page="ingredients">
                            <span class="nav-icon">üì¶</span>
                            <span data-i18n="ingredients">Ingr√©dients</span>
                            <span class="nav-badge" id="ingredientsAlertBadge"></span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-page="recipes">
                            <span class="nav-icon">üìã</span>
                            <span data-i18n="recipes">Recettes</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-page="packs">
                            <span class="nav-icon">üéÅ</span>
                            <span>Packs</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-page="profitability">
                            <span class="nav-icon">üìä</span>
                            <span>Rentabilit√©</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-page="production">
                            <span class="nav-icon">‚öôÔ∏è</span>
                            <span data-i18n="production">Production</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-page="sales">
                            <span class="nav-icon">üí∞</span>
                            <span data-i18n="sales">Ventes</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-page="expenses">
                            <span class="nav-icon">üí∏</span>
                            <span data-i18n="expenses">D√©penses</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-page="suppliers">
                            <span class="nav-icon">üöö</span>
                            <span data-i18n="suppliers">Fournisseurs</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-page="personnel">
                            <span class="nav-icon">üë•</span>
                            <span data-i18n="personnel">Personnel</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-page="clients">
                            <span class="nav-icon">üë§</span>
                            <span data-i18n="clients">Clients</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-page="settings">
                            <span class="nav-icon">‚öôÔ∏è</span>
                            <span data-i18n="settings">Param√®tres</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </aside>

        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <div class="search-bar">
                    <input type="text" data-i18n-placeholder="search_placeholder" placeholder="Rechercher...">
                </div>
            </div>

            <div class="header-right">
                <!-- Demo Mode Button -->
                <button class="btn" style="background: var(--warning); color: var(--dark); font-weight: 700;" onclick="loadDemoData()">
                    üé≠ Mode D√©mo
                </button>
                
                <!-- Language Switcher -->
                <div class="switcher">
                    <button class="active" data-lang="fr">üá´üá∑ FR</button>
                    <button data-lang="en">üá¨üáß EN</button>
                </div>

                <!-- Currency Switcher -->
                <div class="switcher">
                    <button class="active" data-currency="EUR">‚Ç¨</button>
                    <button data-currency="GBP">¬£</button>
                    <button data-currency="USD">$</button>
                </div>

                <!-- User Menu -->
                <div class="user-menu">
                    <div class="user-avatar">FG</div>
                    <span class="user-name">Fotsi</span>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content" id="mainContent">
            <!-- Dashboard will be loaded here -->
        </main>
    </div>

    <script type="module">
        // Import CORE services (v53.0 - Nouvelle d√©mo r√©aliste)
        import { IngredientService } from './src/core/services/IngredientService.js?v=55.6';
        import { RecipeService } from './src/core/services/RecipeService.js?v=55.6';
        import { SaleService } from './src/core/services/SaleService.js?v=55.6';
        import { DashboardService } from './src/core/services/DashboardService.js?v=55.6';
        import { ExpenseService } from './src/core/services/ExpenseService.js?v=55.6';
        import { ProfitabilityService } from './src/core/services/ProfitabilityService.js?v=55.6';
        import { PlatformCommissionService } from './src/core/services/PlatformCommissionService.js?v=55.6';
        import { IngredientImporter } from './src/core/services/IngredientImporter.js?v=55.6';
        import { PackService } from './src/core/services/PackService.js?v=55.6';
        import { StorageManager } from './src/core/data/StorageManager.js?v=55.6';
        import { IngredientDatabaseCore } from './src/core/data/IngredientDatabaseCore.js?v=55.6';
        
        // Import CORE models
        import { Ingredient } from './src/core/models/Ingredient.js?v=55.6';
        import { Lot } from './src/core/models/Lot.js?v=55.6';
        import { Recipe, RecipeIngredient } from './src/core/models/Recipe.js?v=55.6';
        import { Production, UsedLot } from './src/core/models/Production.js?v=55.6';
        import { Sale, SaleItem } from './src/core/models/Sale.js?v=55.6';
        import { Expense } from './src/core/models/Expense.js?v=55.6';
        import { Pack, PackItem } from './src/core/models/Pack.js?v=55.6';
        
        // Import DEMO DATA
        import { demoSalonModerne as demoWESalon } from './src/demo-we-salon.js?v=55.6';
        
        // Make classes available globally for demo data conversion and loadData
        window.Ingredient = Ingredient;
        window.Lot = Lot;
        window.Recipe = Recipe;
        window.RecipeIngredient = RecipeIngredient;
        window.Production = Production;
        window.UsedLot = UsedLot;
        window.Sale = Sale;
        window.SaleItem = SaleItem;
        window.Expense = Expense;
        window.Pack = Pack;
        window.PackItem = PackItem;
        
        // ========================================
        // DEMO DATA (inline)
        // ========================================
        
        const demoData = {
            categories: [
                { id: 'cat_1', name: 'C√©r√©ales & Farines', parent: null },
                { id: 'cat_1_1', name: 'Bl√©', parent: 'C√©r√©ales & Farines' },
                { id: 'cat_1_2', name: 'Ma√Øs', parent: 'C√©r√©ales & Farines' },
                { id: 'cat_2', name: 'Sucres & √âdulcorants', parent: null },
                { id: 'cat_2_1', name: 'Sucres blancs', parent: 'Sucres & √âdulcorants' },
                { id: 'cat_2_2', name: 'Sucres bruns', parent: 'Sucres & √âdulcorants' },
                { id: 'cat_3', name: 'Mati√®res grasses', parent: null },
                { id: 'cat_3_1', name: 'Beurres', parent: 'Mati√®res grasses' },
                { id: 'cat_3_2', name: 'Huiles', parent: 'Mati√®res grasses' },
                { id: 'cat_4', name: 'Produits laitiers', parent: null },
                { id: 'cat_4_1', name: 'Lait', parent: 'Produits laitiers' },
                { id: 'cat_4_2', name: '≈íufs', parent: 'Produits laitiers' },
                { id: 'cat_5', name: 'Additifs & Levures', parent: null },
                { id: 'cat_5_1', name: 'Levures', parent: 'Additifs & Levures' },
                { id: 'cat_5_2', name: 'Sel', parent: 'Additifs & Levures' },
                { id: 'cat_6', name: 'Chocolats & Cacao', parent: null },
                { id: 'cat_6_1', name: 'Cacao poudre', parent: 'Chocolats & Cacao' }
            ],
            
            ingredients: [
                {
                    id: 'ing_1',
                    name: 'Farine de bl√© T55',
                    category: 'Bl√©',
                    baseUnit: 'g',
                    displayUnit: 'kg',
                    alertBaseQty: 5000,
                    baseQtyRemaining: 23000,
                    stockValue: 69000,
                    lots: [{
                        id: 'lot_1_1',
                        quantiteInitiale: 25000,
                        quantite: 23000,
                        prixTotal: 75000,
                        fraisApproche: 3000,
                        dlc: new Date('2026-07-15').toISOString(),
                        dateReception: new Date('2026-01-10').toISOString(),
                        fournisseur: 'Minoterie du Cameroun',
                        numeroLot: 'MCF-2026-001',
                        epuise: false
                    }],
                    alerts: [],
                    createdAt: new Date('2026-01-10').toISOString(),
                    updatedAt: new Date('2026-01-17').toISOString()
                },
                {
                    id: 'ing_2',
                    name: 'Farine de bl√© T65',
                    category: 'Bl√©',
                    baseUnit: 'g',
                    displayUnit: 'kg',
                    alertBaseQty: 3000,
                    baseQtyRemaining: 8500,
                    stockValue: 30600,
                    lots: [{
                        id: 'lot_2_1',
                        quantiteInitiale: 10000,
                        quantite: 8500,
                        prixTotal: 32000,
                        fraisApproche: 2000,
                        dlc: new Date('2026-07-20').toISOString(),
                        dateReception: new Date('2026-01-12').toISOString(),
                        fournisseur: 'Minoterie du Cameroun',
                        numeroLot: 'MCF-2026-002',
                        epuise: false
                    }],
                    alerts: [],
                    createdAt: new Date('2026-01-12').toISOString(),
                    updatedAt: new Date('2026-01-17').toISOString()
                },
                {
                    id: 'ing_3',
                    name: 'Sucre cristallis√©',
                    category: 'Sucres blancs',
                    baseUnit: 'g',
                    displayUnit: 'kg',
                    alertBaseQty: 5000,
                    baseQtyRemaining: 18300,
                    stockValue: 13176,
                    lots: [{
                        id: 'lot_3_1',
                        quantiteInitiale: 25000,
                        quantite: 18300,
                        prixTotal: 18000,
                        fraisApproche: 0,
                        dlc: new Date('2028-01-15').toISOString(),
                        dateReception: new Date('2026-01-05').toISOString(),
                        fournisseur: 'SOSUCAM',
                        numeroLot: 'SSC-2026-A12',
                        epuise: false
                    }],
                    alerts: [],
                    createdAt: new Date('2026-01-05').toISOString(),
                    updatedAt: new Date('2026-01-17').toISOString()
                },
                {
                    id: 'ing_4',
                    name: 'Beurre doux 82%',
                    category: 'Beurres',
                    baseUnit: 'g',
                    displayUnit: 'kg',
                    alertBaseQty: 2000,
                    baseQtyRemaining: 3200,
                    stockValue: 22400,
                    lots: [{
                        id: 'lot_4_1',
                        quantiteInitiale: 5000,
                        quantite: 3200,
                        prixTotal: 35000,
                        fraisApproche: 2000,
                        dlc: new Date('2026-04-15').toISOString(),
                        dateReception: new Date('2026-01-15').toISOString(),
                        fournisseur: 'Laiterie Centrale',
                        numeroLot: 'LC-BTR-2026-18',
                        epuise: false
                    }],
                    createdAt: new Date('2026-01-15').toISOString(),
                    updatedAt: new Date('2026-01-17').toISOString()
                },
                {
                    id: 'ing_5',
                    name: 'Lait entier liquide',
                    category: 'Lait',
                    baseUnit: 'ml',
                    displayUnit: 'L',
                    alertBaseQty: 3000,
                    baseQtyRemaining: 6800,
                    stockValue: 4080,
                    lots: [{
                        id: 'lot_5_1',
                        quantiteInitiale: 10000,
                        quantite: 6800,
                        prixTotal: 6000,
                        fraisApproche: 500,
                        dlc: new Date(Date.now() + 1 * 24 * 60 * 60 * 1000).toISOString(),
                        dateReception: new Date('2026-01-18').toISOString(),
                        fournisseur: 'Laiterie Centrale',
                        numeroLot: 'LC-LAIT-2026-20',
                        epuise: false
                    }],
                    createdAt: new Date('2026-01-18').toISOString(),
                    updatedAt: new Date('2026-01-18').toISOString()
                },
                {
                    id: 'ing_6',
                    name: '≈íufs frais calibre L',
                    category: '≈íufs',
                    baseUnit: 'piece',
                    displayUnit: 'piece',
                    alertBaseQty: 20,
                    baseQtyRemaining: 38,
                    stockValue: 5700,
                    lots: [{
                        id: 'lot_6_1',
                        quantiteInitiale: 60,
                        quantite: 38,
                        prixTotal: 9000,
                        fraisApproche: 0,
                        dlc: new Date('2026-02-08').toISOString(),
                        dateReception: new Date('2026-01-18').toISOString(),
                        fournisseur: 'Ferme Avicole du Sud',
                        numeroLot: 'FAS-OEUFS-2026-15',
                        epuise: false
                    }],
                    alerts: [],
                    createdAt: new Date('2026-01-18').toISOString(),
                    updatedAt: new Date('2026-01-18').toISOString()
                },
                {
                    id: 'ing_7',
                    name: 'Levure fra√Æche',
                    category: 'Levures',
                    baseUnit: 'g',
                    displayUnit: 'g',
                    alertBaseQty: 200,
                    baseQtyRemaining: 320,
                    stockValue: 1600,
                    lots: [{
                        id: 'lot_7_1',
                        quantiteInitiale: 500,
                        quantite: 320,
                        prixTotal: 2500,
                        fraisApproche: 0,
                        dlc: new Date(Date.now() + 2 * 24 * 60 * 60 * 1000).toISOString(),
                        dateReception: new Date('2026-01-18').toISOString(),
                        fournisseur: 'Lesaffre Cameroun',
                        numeroLot: 'LES-LF-2026-08',
                        epuise: false
                    }],
                    createdAt: new Date('2026-01-18').toISOString(),
                    updatedAt: new Date('2026-01-18').toISOString()
                }
            ],
            
            
                recipes: [],
                productions: [],
                sales: [],
                expenses: [
                    { id: 'exp_demo_1', label: 'Loyer atelier janvier', category: 'Loyer', date: new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().split('T')[0], amount: 850, currency: 'EUR', notes: 'Loyer mensuel atelier de production', createdAt: new Date().toISOString() },
                    { id: 'exp_demo_2', label: '√âlectricit√© + gaz', category: '√ânergie', date: new Date(new Date().getFullYear(), new Date().getMonth(), 5).toISOString().split('T')[0], amount: 210, currency: 'EUR', notes: 'Facture fournisseur √©nergie', createdAt: new Date().toISOString() }
                ],
                suppliers: [
                    { id: 'sup_demo_1', name: 'Minoterie du Cameroun', category: 'Grossiste', contact: 'Jean Dupont', phone: '+237 699 000 001', email: 'contact@minoterie-cm.com', address: 'Zone industrielle, Douala', notes: 'Fournisseur principal farines. Livraison le mardi.', createdAt: new Date().toISOString() },
                    { id: 'sup_demo_2', name: 'Laiterie Centrale', category: 'Producteur', contact: 'Marie Fouda', phone: '+237 699 000 002', email: 'marie@laiterie-centrale.cm', address: 'Route de Bafoussam, Yaound√©', notes: 'Beurre, lait, ≈ìufs. Livraison fra√Æcheur J+1.', createdAt: new Date().toISOString() }
                ],
                clients: [
                    { id: 'cli_demo_1', name: 'Restaurant Le Palais', phone: '+237 699 111 111', email: 'contact@lepalais.cm', tags: ['VIP', 'Professionnel'], notes: 'Commande hebdomadaire. Paiement 30j.', createdAt: new Date().toISOString() },
                    { id: 'cli_demo_2', name: 'H√¥tel Azur', phone: '+237 699 222 222', email: 'achat@hotel-azur.cm', tags: ['Professionnel', 'R√©current'], notes: 'Petit-d√©jeuner buffet. Livraison 6h.', createdAt: new Date().toISOString() }
                ],
                lossHistory: [
                    { id: 'loss_demo_1', timestamp: new Date(new Date().getFullYear(), new Date().getMonth(), new Date().getDate() - 2).toISOString(), ingredientId: 'ing_5', ingredientName: 'Lait entier liquide', quantity: 2000, unit: 'ml', reason: 'chaine_froid', notes: 'Coupure √©lectricit√© 4h - r√©frig√©rateur hors service', value: 1200 }
                ],
                vendors: [],
                staff: []
        };
        
        // ========================================
        // DEMO MODE
        // ========================================
        
        // Load demo data
        window.loadDemoData = function() {
            if (!confirm('‚ö†Ô∏è Charger les donn√©es de d√©monstration ?\n\nCela remplacera toutes les donn√©es actuelles par un jeu de donn√©es complet pour une boulangerie.')) {
                return;
            }
            
            try {
                console.log('üé≠ Loading demo data...');
                
                // Load demo data and convert to proper class instances
                appState.data.categories = demoData.categories;
                
                // Convert ingredients JSON to Ingredient instances
                appState.data.ingredients = demoData.ingredients.map((ingData, index) => {
                    try {
                        const Ingredient = window.Ingredient;
                        if (Ingredient && Ingredient.fromJSON) {
                            return Ingredient.fromJSON(ingData);
                        } else {
                            return ingData;
                        }
                    } catch (err) {
                        console.error('‚ùå Error converting ingredient:', err, ingData);
                        return ingData;
                    }
                });
                
                appState.data.recipes = demoData.recipes || [];
                appState.data.productions = demoData.productions || [];
                appState.data.sales = demoData.sales || [];
                appState.data.expenses = demoData.expenses || [];
                appState.data.suppliers = demoData.suppliers || [];
                appState.data.clients = demoData.clients || [];
                appState.data.lossHistory = demoData.lossHistory || [];
                appState.data.vendors = demoData.vendors || [];
                appState.data.staff = demoData.staff || [];
                
                // Save to storage
                saveData();
                
                // Refresh current page
                showPage(appState.currentPage);
                
                showToast('üé≠ Mode D√©mo activ√© ! ' + demoData.ingredients.length + ' ingr√©dients + fournisseurs + clients + pertes charg√©s', 'success');
                
            } catch (error) {
                console.error('Erreur chargement d√©mo:', error);
                showToast('‚ùå Erreur: ' + error.message, 'error');
            }
        };
        
        // ========================================
        // I18N & TRANSLATIONS
        // ========================================

        // i18n Translations
        const translations = {
            fr: {
                app_name: 'BUSINESSFOOD',
                dashboard: 'Tableau de bord',
                ingredients: 'Ingr√©dients',
                recipes: 'Recettes',
                production: 'Production',
                sales: 'Ventes',
                expenses: 'D√©penses',
                suppliers: 'Fournisseurs',
                personnel: 'Personnel',
                clients: 'Clients',
                settings: 'Param√®tres',
                search_placeholder: 'Rechercher...',
                welcome: 'Bienvenue',
                today_overview: 'Aper√ßu d\'aujourd\'hui',
                total_revenue: 'Chiffre d\'affaires',
                total_margin: 'Marge brute',
                stock_value: 'Valeur stock',
                alerts: 'Alertes',
                quick_actions: 'Actions rapides',
                add_ingredient: 'Ajouter ingr√©dient',
                new_recipe: 'Nouvelle recette',
                record_sale: 'Enregistrer vente',
                add_expense: 'Ajouter d√©pense'
            },
            en: {
                app_name: 'BUSINESSFOOD',
                dashboard: 'Dashboard',
                ingredients: 'Ingredients',
                recipes: 'Recipes',
                production: 'Production',
                sales: 'Sales',
                expenses: 'Expenses',
                suppliers: 'Suppliers',
                personnel: 'Staff',
                clients: 'Clients',
                settings: 'Settings',
                search_placeholder: 'Search...',
                welcome: 'Welcome',
                today_overview: 'Today\'s overview',
                total_revenue: 'Total Revenue',
                total_margin: 'Gross Margin',
                stock_value: 'Stock Value',
                alerts: 'Alerts',
                quick_actions: 'Quick Actions',
                add_ingredient: 'Add ingredient',
                new_recipe: 'New recipe',
                record_sale: 'Record sale',
                add_expense: 'Add expense'
            }
        };

        // Currency Formats
        const currencyFormats = {
            EUR: { symbol: '‚Ç¨', position: 'after', decimals: 2, separator: ',' },
            GBP: { symbol: '¬£', position: 'before', decimals: 2, separator: ',' },
            USD: { symbol: '$', position: 'before', decimals: 2, separator: ',' }
        };
        
        // Taux de change (base: EUR)
        const exchangeRates = {
            EUR: 1,           // 1 EUR = 1 EUR (devise de r√©f√©rence)
            GBP: 0.85,        // 1 GBP = 0.85 EUR (1 EUR = 1.18 GBP)
            USD: 1.09         // 1 USD = 1.09 EUR (1 EUR = 0.92 USD)
        };
        
        // Convertir montant de EUR vers devise cible
        function convertCurrency(amountInEUR, targetCurrency) {
            if (targetCurrency === 'EUR') return amountInEUR;
            return amountInEUR / exchangeRates[targetCurrency];
        }
        
        // Convertir montant de devise source vers EUR
        function convertToEUR(amount, sourceCurrency) {
            if (sourceCurrency === 'EUR') return amount;
            return amount * exchangeRates[sourceCurrency];
        }

        // App State
        const appState = {
            currentLang: 'fr',
            currentCurrency: 'EUR',
            currentPage: 'dashboard',
            exchangeRates: {
                'EUR': 1.0,
                'GBP': 0.85,
                'USD': 1.09
            },
            data: {
                ingredients: [],
                recipes: [],
                productions: [],
                sales: [],
                expenses: [],
                packs: [],
                staff: [],
                suppliers: [],
                clients: [],
                lossHistory: [],
                movements: [],
                categories: [
                    // Cat√©gories par d√©faut
                    { id: 'cat1', name: 'Farines', parent: null },
                    { id: 'cat2', name: 'Farine T55', parent: 'Farines' },
                    { id: 'cat3', name: 'Farine T65', parent: 'Farines' },
                    { id: 'cat4', name: 'Sucres', parent: null },
                    { id: 'cat5', name: 'Sucre blanc', parent: 'Sucres' },
                    { id: 'cat6', name: 'Sucre roux', parent: 'Sucres' },
                    { id: 'cat7', name: 'Mati√®res grasses', parent: null },
                    { id: 'cat8', name: 'Oeufs & Lait', parent: null },
                    { id: 'cat9', name: 'Additifs', parent: null }
                ],
                settings: {
                    // üí∞ COEFFICIENT D√âPENSES FIXES
                    // Prend en compte loyer, salaires, √©lectricit√©, etc.
                    // Formule : Co√ªt r√©el = Co√ªt ingr√©dients √ó coefficient
                    // Exemple : 1.40 = 40% de d√©penses fixes
                    overheadCoefficient: 1.40,  // Par d√©faut 40%
                    
                    // Affichage
                    showDirectCost: true,  // Afficher co√ªt direct ET co√ªt total
                    
                    // Pour calcul auto (futur module D√©penses)
                    autoCalculateCoefficient: false
                }
            },
            customDlcFilter: null
        };

        // Load data from StorageManager
        function loadData() {
            const saved = StorageManager.load();
            if (saved) {
                // Convert ingredients back to class instances
                if (saved.ingredients && window.Ingredient && window.Ingredient.fromJSON) {
                    saved.ingredients = saved.ingredients.map(ing => {
                        try {
                            return window.Ingredient.fromJSON(ing);
                        } catch (err) {
                            console.error('Error converting ingredient on load:', err);
                            return ing;
                        }
                    });
                }
                
                // Convert recipes back to class instances
                if (saved.recipes && window.Recipe && window.Recipe.fromJSON) {
                    saved.recipes = saved.recipes.map(recipe => {
                        try {
                            return window.Recipe.fromJSON(recipe);
                        } catch (err) {
                            console.error('Error converting recipe on load:', err);
                            return recipe;
                        }
                    });
                }
                
                // Convert productions back to class instances
                if (saved.productions && window.Production && window.Production.fromJSON) {
                    saved.productions = saved.productions.map(prod => {
                        try {
                            return window.Production.fromJSON(prod);
                        } catch (err) {
                            console.error('Error converting production on load:', err);
                            return prod;
                        }
                    });
                }
                
                // Convert sales back to class instances
                if (saved.sales && window.Sale && window.Sale.fromJSON) {
                    saved.sales = saved.sales.map(sale => {
                        try {
                            return window.Sale.fromJSON(sale);
                        } catch (err) {
                            console.error('Error converting sale on load:', err);
                            return sale;
                        }
                    });
                }
                
                // Convert expenses back to class instances
                if (saved.expenses && window.Expense && window.Expense.fromJSON) {
                    saved.expenses = saved.expenses.map(expense => {
                        try {
                            return window.Expense.fromJSON(expense);
                        } catch (err) {
                            console.error('Error converting expense on load:', err);
                            return expense;
                        }
                    });
                }
                
                // Convert packs back to class instances
                if (saved.packs && window.Pack && window.Pack.fromJSON) {
                    saved.packs = saved.packs.map(pack => {
                        try {
                            return window.Pack.fromJSON(pack);
                        } catch (err) {
                            console.error('Error converting pack on load:', err);
                            return pack;
                        }
                    });
                }
                
                appState.data = saved;
                // Ensure new fields exist (migration for older saves)
                if (!appState.data.suppliers) appState.data.suppliers = [];
                if (!appState.data.clients) appState.data.clients = [];
                if (!appState.data.lossHistory) appState.data.lossHistory = [];
                if (!appState.data.movements) appState.data.movements = [];
            }
        }
        
        /**
         * Initialise la base d'ingr√©dients avec les 100 ingr√©dients essentiels
         * Se d√©clenche automatiquement si la base est vide ou contient moins de 50 ingr√©dients
         */
        function initializeIngredientDatabase() {
            try {
                // V√©rifier si la base a besoin d'√™tre initialis√©e
                const currentCount = appState.data.ingredients.length;
                
                // D√©tecter les ingr√©dients corrompus (undefined)
                const corruptedCount = appState.data.ingredients.filter(ing => 
                    !ing.name || ing.name === 'undefined' || !ing.id
                ).length;
                
                if (corruptedCount > 0) {
                    console.warn(`‚ö†Ô∏è ${corruptedCount} ingr√©dients corrompus d√©tect√©s, nettoyage...`);
                    // Supprimer les ingr√©dients corrompus
                    appState.data.ingredients = appState.data.ingredients.filter(ing => 
                        ing.name && ing.name !== 'undefined' && ing.id
                    );
                    StorageManager.save(appState.data);
                }
                
                const validCount = appState.data.ingredients.length;
                
                // Si moins de 50 ingr√©dients, on propose d'ajouter la base
                if (validCount < 50) {
                    console.log(`üóÇÔ∏è Base d'ingr√©dients d√©tect√©e : ${validCount} ingr√©dients`);
                    console.log('üì• Chargement de la base de 100 ingr√©dients essentiels...');
                    
                    // R√©cup√©rer les ingr√©dients de la base
                    const coreIngredients = IngredientDatabaseCore.ingredients;
                    
                    // Convertir en instances Ingredient avec ID unique
                    const newIngredients = coreIngredients.map(data => {
                        // Cr√©er un ID unique bas√© sur le nom si pas d'ID
                        const ingredientId = data.id || `ING-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                        
                        // V√©rifier si l'ingr√©dient existe d√©j√† (par nom)
                        const exists = appState.data.ingredients.find(ing => 
                            ing.name.toLowerCase() === data.name.toLowerCase()
                        );
                        
                        if (exists) {
                            // D√©j√† pr√©sent, on skip
                            return null;
                        }
                        
                        // Cr√©er le nouvel ingr√©dient avec le bon format
                        const ingredient = new Ingredient({
                            id: ingredientId,
                            name: data.name,
                            category: data.category || '',
                            baseUnit: data.baseUnit || 'g',
                            displayUnit: data.baseUnit || 'g',
                            alertBaseQty: 0,
                            yieldPercent: data.yieldPercent || 100,
                            wasteType: data.wasteType || '',
                            lots: [],
                            createdAt: new Date(),
                            updatedAt: new Date()
                        });
                        
                        // Ajouter les allerg√®nes si pr√©sents
                        if (data.allergens && Array.isArray(data.allergens)) {
                            ingredient.allergens = data.allergens;
                        }
                        
                        // Ajouter le prix moyen si pr√©sent (pour info)
                        if (data.avgPricePerKg) {
                            ingredient.avgPricePerKg = data.avgPricePerKg;
                        }
                        
                        return ingredient;
                    }).filter(ing => ing !== null); // Enlever les nulls (doublons)
                    
                    // Ajouter √† la base existante
                    appState.data.ingredients = [...appState.data.ingredients, ...newIngredients];
                    
                    // Sauvegarder
                    StorageManager.save(appState.data);
                    
                    console.log(`‚úÖ ${newIngredients.length} ingr√©dients ajout√©s √† la base !`);
                    console.log(`üìä Total : ${appState.data.ingredients.length} ingr√©dients disponibles`);
                    
                    // Afficher une notification √† l'utilisateur
                    showToast(`‚úÖ ${newIngredients.length} ingr√©dients professionnels ajout√©s automatiquement !`, 'success');
                    
                    return true;
                }
                
                console.log(`‚úÖ Base d'ingr√©dients d√©j√† initialis√©e (${currentCount} ingr√©dients)`);
                return false;
                
            } catch (error) {
                console.error('‚ùå Erreur lors de l\'initialisation de la base d\'ingr√©dients:', error);
                return false;
            }
        }

        // Save data to StorageManager
        function saveData() {
            StorageManager.save(appState.data);
            // Sauvegarder aussi les taux de change
            localStorage.setItem('exchangeRates', JSON.stringify(appState.exchangeRates));
        }
        
        // Charger les taux de change
        function loadExchangeRates() {
            const saved = localStorage.getItem('exchangeRates');
            if (saved) {
                try {
                    appState.exchangeRates = JSON.parse(saved);
                } catch (e) {
                    console.error('Error loading exchange rates:', e);
                }
            }
        }

        // i18n Translation function
        function t(key) {
            return translations[appState.currentLang][key] || key;
        }

        // Update UI translations
        function updateTranslations() {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                el.textContent = t(key);
            });

            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                el.placeholder = t(key);
            });
        }

        // Format currency
        function formatCurrency(amount) {
            // Tous les montants sont stock√©s en EUR (devise de r√©f√©rence)
            // On convertit selon la devise s√©lectionn√©e
            const convertedAmount = convertCurrency(amount, appState.currentCurrency);
            const format = currencyFormats[appState.currentCurrency];
            const value = convertedAmount.toFixed(format.decimals).replace('.', format.separator);
            
            if (format.position === 'before') {
                return `${format.symbol}${value}`;
            } else {
                return `${value} ${format.symbol}`;
            }
        }
        
        // Format date FR (JJ/MM/AAAA)
        function formatDateFR(date) {
            const d = date instanceof Date ? date : new Date(date);
            const day = String(d.getDate()).padStart(2, '0');
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const year = d.getFullYear();
            return `${day}/${month}/${year}`;
        }

        // Render Dashboard
        function renderDashboard() {
            const stats = DashboardService.getDashboardStats(appState.data);
            
            // --- HACCP KPIs ---
            const now = new Date();
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            
            // Pertes du mois (stock√©es dans appState.data.lossHistory)
            const lossHistory = appState.data.lossHistory || [];
            const monthLosses = lossHistory.filter(l => new Date(l.timestamp) >= startOfMonth);
            const monthLossValue = monthLosses.reduce((s, l) => s + (l.value || 0), 0);
            const monthRevenue = stats.sales.revenue || 0;
            const lossPercent = monthRevenue > 0 ? ((monthLossValue / monthRevenue) * 100).toFixed(1) : '0.0';
            
            // Valeur stock instantan√©
            const stockValue = stats.stock.total;
            
            // Lots DLC urgents (J-2 / J-1)
            const ingredients = appState.data.ingredients || [];
            const urgentLots = [];
            ingredients.forEach(ing => {
                if (!ing.lots) return;
                ing.lots.forEach(lot => {
                    if (lot.epuise || !lot.dlc) return;
                    const dlcDate = new Date(lot.dlc);
                    const daysLeft = Math.ceil((dlcDate - now) / (1000 * 60 * 60 * 24));
                    if (daysLeft <= 2 && lot.quantite > 0) {
                        urgentLots.push({ ing: ing.name, lot: lot.numeroLot || lot.id, daysLeft, qty: lot.quantite, unit: ing.baseUnit });
                    }
                });
            });
            
            const html = `
                <div class="page-header">
                    <h1 class="page-title" data-i18n="welcome">${t('welcome')}</h1>
                    <p class="page-subtitle" data-i18n="today_overview">${t('today_overview')}</p>
                </div>

                <!-- ‚ïê‚ïê‚ïê HACCP TILES ‚ïê‚ïê‚ïê -->
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:var(--space-md);margin-bottom:var(--space-xl);">
                    <!-- Pertes alimentaires -->
                    <div style="background:linear-gradient(135deg,#fc5c65,#ff6b35);border-radius:var(--radius-lg);padding:var(--space-lg);color:white;position:relative;overflow:hidden;box-shadow:0 8px 24px rgba(252,92,101,0.35);">
                        <div style="font-size:13px;font-weight:700;text-transform:uppercase;letter-spacing:1px;opacity:0.85;margin-bottom:8px;">üóë Pertes alimentaires (mois)</div>
                        <div style="font-size:34px;font-weight:800;margin-bottom:4px;">${formatCurrency(monthLossValue)}</div>
                        <div style="font-size:14px;opacity:0.9;">${lossPercent}% du CA mensuel</div>
                        <div style="font-size:12px;opacity:0.75;margin-top:4px;">${monthLosses.length} perte${monthLosses.length !== 1 ? 's' : ''} enregistr√©e${monthLosses.length !== 1 ? 's' : ''}</div>
                        <div style="position:absolute;right:16px;bottom:16px;font-size:48px;opacity:0.15;">üóë</div>
                    </div>
                    
                    <!-- Valeur stock T -->
                    <div style="background:linear-gradient(135deg,#26de81,#4ecdc4);border-radius:var(--radius-lg);padding:var(--space-lg);color:white;position:relative;overflow:hidden;box-shadow:0 8px 24px rgba(38,222,129,0.35);">
                        <div style="font-size:13px;font-weight:700;text-transform:uppercase;letter-spacing:1px;opacity:0.85;margin-bottom:8px;">üì¶ Valeur stock instant T</div>
                        <div style="font-size:34px;font-weight:800;margin-bottom:4px;">${formatCurrency(stockValue)}</div>
                        <div style="font-size:14px;opacity:0.9;">Ingr√©dients + produits finis</div>
                        <div style="font-size:12px;opacity:0.75;margin-top:4px;">${ingredients.length} ingr√©dient${ingredients.length !== 1 ? 's' : ''} en stock</div>
                        <div style="position:absolute;right:16px;bottom:16px;font-size:48px;opacity:0.15;">üì¶</div>
                    </div>
                    
                    <!-- Lots DLC urgents -->
                    <div onclick="showPage('ingredients')" style="cursor:pointer;background:${urgentLots.length > 0 ? 'linear-gradient(135deg,#ffa502,#ffe66d)' : 'linear-gradient(135deg,#45aaf2,#4ecdc4)'};border-radius:var(--radius-lg);padding:var(--space-lg);color:white;position:relative;overflow:hidden;box-shadow:0 8px 24px rgba(255,165,2,${urgentLots.length > 0 ? '0.35' : '0.15'});transition:transform 0.2s;">
                        <div style="font-size:13px;font-weight:700;text-transform:uppercase;letter-spacing:1px;opacity:0.85;margin-bottom:8px;">‚ö†Ô∏è Lots DLC urgents (J-2/J-1)</div>
                        <div style="font-size:34px;font-weight:800;margin-bottom:4px;">${urgentLots.length}</div>
                        <div style="font-size:14px;opacity:0.9;">${urgentLots.length > 0 ? 'Lots √† traiter en priorit√©' : 'Aucun lot critique'}</div>
                        ${urgentLots.length > 0 ? `<div style="font-size:12px;opacity:0.9;margin-top:4px;">${urgentLots.slice(0,2).map(l => `${l.ing} (J${l.daysLeft <= 0 ? ' expir√©' : '-' + l.daysLeft})`).join(', ')}${urgentLots.length > 2 ? '...' : ''}</div>` : ''}
                        <div style="position:absolute;right:16px;bottom:16px;font-size:48px;opacity:0.15;">‚ö†Ô∏è</div>
                    </div>
                </div>

                <!-- ‚ïê‚ïê‚ïê STATS CLASSIQUES ‚ïê‚ïê‚ïê -->
                <div class="stats-grid">
                    <div class="stat-card success">
                        <div class="stat-header">
                            <span class="stat-label" data-i18n="total_margin">${t('total_margin')}</span>
                            <span class="stat-icon">üìà</span>
                        </div>
                        <div class="stat-value">${formatCurrency(stats.sales.margin)}</div>
                        <div class="stat-change positive">
                            <span>‚Üó</span>
                            <span>Marge brute cumul</span>
                        </div>
                    </div>

                    <div class="stat-card primary">
                        <div class="stat-header">
                            <span class="stat-label">CA Total</span>
                            <span class="stat-icon">üí∞</span>
                        </div>
                        <div class="stat-value">${formatCurrency(stats.sales.revenue)}</div>
                        <div class="stat-change positive">
                            <span>üõí</span>
                            <span>${stats.sales.count} vente${stats.sales.count !== 1 ? 's' : ''}</span>
                        </div>
                    </div>

                    <div class="stat-card danger">
                        <div class="stat-header">
                            <span class="stat-label" data-i18n="alerts">${t('alerts')}</span>
                            <span class="stat-icon">‚ö†Ô∏è</span>
                        </div>
                        <div class="stat-value">${stats.alerts.length}</div>
                        <div class="stat-change">
                            <span>N√©cessitent attention</span>
                        </div>
                    </div>
                </div>

                <h2 style="font-family: var(--font-display); font-size: 32px; margin-bottom: var(--space-md);" data-i18n="quick_actions">${t('quick_actions')}</h2>
                <div class="quick-actions">
                    <div class="action-card" onclick="showPage('ingredients')">
                        <div class="action-icon">üì¶</div>
                        <div class="action-title" data-i18n="add_ingredient">${t('add_ingredient')}</div>
                    </div>
                    <div class="action-card" onclick="showPage('recipes')">
                        <div class="action-icon">üìã</div>
                        <div class="action-title" data-i18n="new_recipe">${t('new_recipe')}</div>
                    </div>
                    <div class="action-card" onclick="showPage('production')">
                        <div class="action-icon">‚öôÔ∏è</div>
                        <div class="action-title" data-i18n="new_production">${t('new_production')}</div>
                    </div>
                    <div class="action-card" onclick="showPage('sales')">
                        <div class="action-icon">üí∞</div>
                        <div class="action-title" data-i18n="record_sale">${t('record_sale')}</div>
                    </div>
                    <div class="action-card" onclick="showPage('expenses')">
                        <div class="action-icon">üí∏</div>
                        <div class="action-title" data-i18n="add_expense">${t('add_expense')}</div>
                    </div>
                    <div class="action-card" onclick="loadDemoWE()" style="border: 2px dashed var(--primary);">
                        <div class="action-icon">üßá</div>
                        <div class="action-title">D√©mo Salon Moderne</div>
                    </div>
                </div>
            `;

            document.getElementById('mainContent').innerHTML = html;
            updateTranslations();
        }

        // ========================================
        // MODULE INGR√âDIENTS
        // ========================================
        
        // Render Ingredients Page
        function renderIngredientsPage() {
            const ingredients = appState.data.ingredients || [];
            
            const html = `
                <div class="page-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h1 class="page-title" data-i18n="ingredients">Ingr√©dients</h1>
                            <p class="page-subtitle">${ingredients.length} ingr√©dients ‚Ä¢ ${(() => {
                                const count = getAlertsCount();
                                return count === 0 ? 'Aucune alerte' : count === 1 ? '1 alerte' : count + ' alertes';
                            })()}</p>
                        </div>
                        <div style="display: flex; gap: var(--space-sm);">
                            <button class="btn" style="background: var(--purple, #9333ea); color: white;" onclick="showImportWizard()" title="Assistant d'import guid√©">
                                <span>üßô</span>
                                <span>Assistant</span>
                            </button>
                            <button class="btn" style="background: var(--danger); color: white;" onclick="confirmDeleteAllIngredients()" title="Effacer tous les ingr√©dients">
                                <span>üóëÔ∏è</span>
                                <span>Effacer Tout</span>
                            </button>
                            <button class="btn" style="background: var(--info); color: white;" onclick="downloadIngredientCSVTemplate()" title="T√©l√©charger le mod√®le CSV vierge">
                                <span>üìÑ</span>
                                <span>Mod√®le CSV</span>
                            </button>
                            <button class="btn" style="background: var(--secondary); color: white;" onclick="showImportModal()">
                                <span>üì•</span>
                                <span>Importer</span>
                            </button>
                            <button class="btn" style="background: var(--success); color: white;" onclick="showExportModal()">
                                <span>üì§</span>
                                <span>Exporter</span>
                            </button>
                            <button class="btn btn-primary" onclick="showAddIngredientModal()">
                                <span>‚ûï</span>
                                <span data-i18n="add_ingredient">Ajouter ingr√©dient</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Filters -->
                <div style="background: white; padding: var(--space-md); border-radius: var(--radius-lg); margin-bottom: var(--space-md); box-shadow: var(--shadow-sm);">
                    <div style="display: flex; gap: var(--space-md); flex-wrap: wrap; align-items: flex-end;">
                        <div style="flex: 1; min-width: 250px;">
                            <input type="text" id="searchIngredients" placeholder="üîç Rechercher..." 
                                style="width: 100%; padding: 12px 20px; border: 2px solid var(--light); border-radius: var(--radius-md); font-family: var(--font-body);">
                        </div>
                        
                        <div style="flex: 1; min-width: 200px;">
                            <label style="display: block; font-size: 12px; font-weight: 600; color: var(--gray); margin-bottom: 6px;">Cat√©gorie</label>
                            <select id="filterCategory" style="width: 100%; padding: 12px 20px; border: 2px solid var(--light); border-radius: var(--radius-md); font-family: var(--font-body);">
                                <option value="">Toutes cat√©gories</option>
                                ${getCategoriesOptions()}
                            </select>
                        </div>
                        
                        <div style="flex: 1; min-width: 200px;">
                            <label style="display: block; font-size: 12px; font-weight: 600; color: var(--gray); margin-bottom: 6px;">Alerte Stock</label>
                            <select id="filterAlert" style="width: 100%; padding: 12px 20px; border: 2px solid var(--light); border-radius: var(--radius-md); font-family: var(--font-body);">
                                <option value="">Tous les stocks</option>
                                <option value="low">Stock bas uniquement</option>
                            </select>
                        </div>
                        
                        <div style="flex: 1; min-width: 200px;">
                            <label style="display: block; font-size: 12px; font-weight: 600; color: var(--gray); margin-bottom: 6px;">Filtre DLC</label>
                            <select id="filterDlcType" style="width: 100%; padding: 12px 20px; border: 2px solid var(--light); border-radius: var(--radius-md); font-family: var(--font-body);">
                                <option value="">Toutes DLC</option>
                                <option value="expired">DLC d√©pass√©e</option>
                                <option value="7days">DLC < 7 jours</option>
                                <option value="30days">DLC < 30 jours</option>
                                <option value="custom">P√©riode personnalis√©e</option>
                                <option value="date">Date pr√©cise</option>
                            </select>
                        </div>
                        
                        <button class="btn" style="background: var(--secondary); color: white;" onclick="showCategoryManager()">
                            ‚öôÔ∏è G√©rer cat√©gories
                        </button>
                    </div>
                    
                    <!-- Custom DLC Filters (hidden by default) -->
                    <div id="customDlcFilters" class="hidden" style="margin-top: var(--space-md); padding-top: var(--space-md); border-top: 2px solid var(--light);">
                        <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: var(--space-md);">
                            <div>
                                <label style="display: block; font-size: 12px; font-weight: 600; color: var(--gray); margin-bottom: 6px;">Du</label>
                                <input type="date" id="dlcFrom" style="width: 100%; padding: 12px 16px; border: 2px solid var(--light); border-radius: var(--radius-md); font-family: var(--font-body);">
                            </div>
                            <div>
                                <label style="display: block; font-size: 12px; font-weight: 600; color: var(--gray); margin-bottom: 6px;">Au</label>
                                <input type="date" id="dlcTo" style="width: 100%; padding: 12px 16px; border: 2px solid var(--light); border-radius: var(--radius-md); font-family: var(--font-body);">
                            </div>
                            <button class="btn btn-primary" onclick="applyCustomDlcFilter()" style="align-self: flex-end;">
                                Appliquer
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Ingredients Grid -->
                <div id="ingredientsGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: var(--space-md);">
                    ${renderIngredientsCards(ingredients)}
                </div>

                <!-- Empty State -->
                ${ingredients.length === 0 ? `
                    <div style="text-align: center; padding: var(--space-xl); background: white; border-radius: var(--radius-lg); margin-top: var(--space-lg);">
                        <div style="font-size: 64px; margin-bottom: var(--space-md);">üì¶</div>
                        <h3 style="font-family: var(--font-display); font-size: 24px; margin-bottom: var(--space-sm);">Aucun ingr√©dient</h3>
                        <p style="color: var(--gray); margin-bottom: var(--space-md);">Commencez par ajouter votre premier ingr√©dient</p>
                        <button class="btn btn-primary" onclick="showAddIngredientModal()">
                            ‚ûï Ajouter un ingr√©dient
                        </button>
                    </div>
                ` : ''}

                <!-- Add Ingredient Modal -->
                <div id="addIngredientModal" class="modal hidden">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2 data-i18n="add_ingredient">Ajouter un ingr√©dient</h2>
                            <button class="modal-close" onclick="closeModal('addIngredientModal')">‚úï</button>
                        </div>
                        <div class="modal-body">
                            <form id="addIngredientForm">
                                <div class="form-group">
                                    <label>Nom de l'ingr√©dient *</label>
                                    <input type="text" name="name" id="ingredientNameInput" required placeholder="Ex: Farine T55" autocomplete="off">
                                    <div id="ingredientSuggestions" style="display: none; position: absolute; background: white; border: 2px solid var(--primary); border-radius: var(--radius-md); box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-height: 300px; overflow-y: auto; z-index: 1000; width: calc(100% - 32px);"></div>
                                    <small style="color: var(--gray);">
                                        üí° Tapez les premi√®res lettres pour voir les suggestions avec rendements pr√©-configur√©s
                                    </small>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Cat√©gorie</label>
                                        <select name="category">
                                            <option value="">Aucune cat√©gorie</option>
                                            ${getCategoriesOptions()}
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Unit√© de base *</label>
                                        <select name="baseUnit" required>
                                            <option value="g">Grammes (g)</option>
                                            <option value="ml">Millilitres (ml)</option>
                                            <option value="piece">Pi√®ces</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>Seuil d'alerte stock</label>
                                    <input type="number" name="alertQty" placeholder="Ex: 1000" min="0">
                                </div>
                                
                                <!-- Section Rendements PRO (v51) -->
                                <h3 style="margin-top: var(--space-lg); margin-bottom: var(--space-md); font-family: var(--font-display);">
                                    üí∞ Co√ªts r√©els (Rendements PRO)
                                </h3>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Rendement (%) *</label>
                                        <input type="number" name="yieldPercent" value="100" min="1" max="100" step="0.1" required>
                                        <small style="color: var(--gray);">
                                            Partie utilisable apr√®s √©pluchage/parage. Ex: Ananas = 40%, Farine = 100%
                                        </small>
                                    </div>
                                    <div class="form-group">
                                        <label>Type de d√©chet</label>
                                        <input type="text" name="wasteType" placeholder="Ex: Peau + c≈ìur">
                                        <small style="color: var(--gray);">
                                            √âpluchures, os, peau, trognon, noyau, etc.
                                        </small>
                                    </div>
                                </div>
                                
                                <div style="background: linear-gradient(135deg, #fff9e6 0%, #fff3d6 100%); padding: var(--space-md); border-radius: var(--radius-md); border-left: 4px solid #f59e0b; margin-bottom: var(--space-md);">
                                    <div style="display: flex; align-items: flex-start; gap: var(--space-sm);">
                                        <span style="font-size: 20px;">‚ÑπÔ∏è</span>
                                        <div style="flex: 1;">
                                            <strong style="color: #f59e0b; display: block; margin-bottom: 4px;">Impact du rendement sur le co√ªt</strong>
                                            <p style="margin: 0; font-size: 13px; line-height: 1.5; color: #78350f;">
                                                Le rendement ajuste automatiquement le co√ªt r√©el. 
                                                <br>
                                                <strong>Exemple :</strong> 1kg achet√© √† 2‚Ç¨ avec rendement 80% = co√ªt r√©el de 2,50‚Ç¨/kg (+25%)
                                                <br>
                                                Un ananas √† 40% de rendement co√ªte r√©ellement <strong>√ó2,5 son prix d'achat !</strong>
                                            </p>
                                        </div>
                                    </div>
                                </div>
                                
                                <h3 style="margin-top: var(--space-lg); margin-bottom: var(--space-md); font-family: var(--font-display);">
                                    R√©ception du lot
                                </h3>
                                
                                <div class="form-group">
                                    <label>R√©ceptionnaire (optionnel)</label>
                                    <select name="lotReceivedBy">
                                        <option value="">Qui a r√©ceptionn√© ce lot ?</option>
                                        ${(appState.data.staff || []).filter(s => s.active).map(s => `
                                            <option value="${s.name}">${s.name} (${s.role})</option>
                                        `).join('')}
                                    </select>
                                    <small style="color: var(--gray);">Personne qui a v√©rifi√© et r√©ceptionn√© cette livraison (optionnel, tra√ßabilit√© HACCP)</small>
                                </div>
                                
                                <h3 style="margin-top: var(--space-lg); margin-bottom: var(--space-md); font-family: var(--font-display);">
                                    Premier lot
                                </h3>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Quantit√© *</label>
                                        <input type="number" name="lotQuantity" required placeholder="Ex: 5000" min="0" step="0.01">
                                    </div>
                                    <div class="form-group">
                                        <label>Unit√© *</label>
                                        <select name="lotUnit" required>
                                            <option value="g">Grammes (g)</option>
                                            <option value="kg">Kilogrammes (kg)</option>
                                            <option value="ml">Millilitres (ml)</option>
                                            <option value="cL">Centilitres (cL)</option>
                                            <option value="L">Litres (L)</option>
                                            <option value="piece">Pi√®ces</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Prix d'achat *</label>
                                        <input type="number" name="lotPrice" required placeholder="Ex: 5000" min="0" step="0.01">
                                    </div>
                                    <div class="form-group">
                                        <label>Frais d'approche</label>
                                        <input type="number" name="lotFees" placeholder="Ex: 500" min="0" step="0.01">
                                    </div>
                                </div>
                                
                                <!-- Multi-devises (v51) -->
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Devise d'achat *</label>
                                        <select name="lotCurrency" id="lotCurrency" required onchange="updateExchangeRateField()">
                                            <option value="EUR">‚Ç¨ Euro (par d√©faut)</option>
                                            <option value="GBP">¬£ Livre Sterling</option>
                                            <option value="USD">$ Dollar US</option>
                                        </select>
                                        <small style="color: var(--gray);">Devise utilis√©e pour cet achat</small>
                                    </div>
                                    <div class="form-group">
                                        <label>Taux de change (vers EUR)</label>
                                        <input type="number" name="lotExchangeRate" id="lotExchangeRate" placeholder="Auto" min="0" step="0.0001" disabled>
                                        <small style="color: var(--gray);" id="exchangeRateHelper">
                                            Achat en EUR - Pas de conversion
                                        </small>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>DLC *</label>
                                        <input type="date" name="lotDlc" required>
                                    </div>
                                    <div class="form-group">
                                        <label>Date r√©ception *</label>
                                        <input type="date" name="lotReception" required>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>Fournisseur</label>
                                    <input type="text" name="lotSupplier" placeholder="Nom du fournisseur">
                                </div>
                                <div class="form-group">
                                    <label>Num√©ro de lot</label>
                                    <input type="text" name="lotNumber" placeholder="Ex: LOT123456">
                                </div>
                                
                                <div style="display: flex; gap: var(--space-md); margin-top: var(--space-lg);">
                                    <button type="button" class="btn" style="flex: 1; background: var(--gray); color: white;" onclick="closeModal('addIngredientModal')">
                                        Annuler
                                    </button>
                                    <button type="submit" class="btn btn-primary" style="flex: 1;">
                                        ‚úÖ Ajouter
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- Category Manager Modal -->
                <div id="categoryManagerModal" class="modal hidden">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2>‚öôÔ∏è Gestion des Cat√©gories</h2>
                            <button class="modal-close" onclick="closeModal('categoryManagerModal')">‚úï</button>
                        </div>
                        <div class="modal-body">
                            <!-- Add New Category -->
                            <div style="background: var(--light); padding: var(--space-md); border-radius: var(--radius-md); margin-bottom: var(--space-lg);">
                                <h3 style="font-weight: 600; margin-bottom: var(--space-sm);">‚ûï Nouvelle cat√©gorie</h3>
                                <form id="addCategoryForm" style="display: flex; gap: var(--space-sm);">
                                    <input type="text" id="newCategoryName" placeholder="Nom de la cat√©gorie" required
                                        style="flex: 1; padding: 12px 16px; border: 2px solid white; border-radius: var(--radius-md); font-family: var(--font-body);">
                                    <input type="text" id="newCategoryParent" placeholder="Cat√©gorie parente (optionnel)"
                                        style="flex: 1; padding: 12px 16px; border: 2px solid white; border-radius: var(--radius-md); font-family: var(--font-body);">
                                    <button type="submit" class="btn btn-primary">Ajouter</button>
                                </form>
                            </div>
                            
                            <!-- Categories List -->
                            <h3 style="font-weight: 600; margin-bottom: var(--space-md);">üìã Cat√©gories existantes</h3>
                            <div id="categoriesList" style="max-height: 400px; overflow-y: auto;">
                                ${renderCategoriesList()}
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('mainContent').innerHTML = html;
            
            // Event listeners
            document.getElementById('searchIngredients')?.addEventListener('input', filterIngredients);
            document.getElementById('filterCategory')?.addEventListener('change', filterIngredients);
            document.getElementById('filterAlert')?.addEventListener('change', filterIngredients);
            document.getElementById('filterDlcType')?.addEventListener('change', handleDlcFilterChange);
            document.getElementById('addIngredientForm')?.addEventListener('submit', handleAddIngredient);
            document.getElementById('addCategoryForm')?.addEventListener('submit', handleAddCategory);
            
            // Set default dates
            const today = new Date().toISOString().split('T')[0];
            const receptionInput = document.querySelector('[name="lotReception"]');
            if (receptionInput) receptionInput.value = today;
            
            const futureDate = new Date();
            futureDate.setMonth(futureDate.getMonth() + 6);
            const dlcInput = document.querySelector('[name="lotDlc"]');
            if (dlcInput) dlcInput.value = futureDate.toISOString().split('T')[0];
            
            // Update sidebar badge
            updateAlertsBadge();
        }

        // Render Ingredients Cards
        function renderIngredientsCards(ingredients) {
            if (ingredients.length === 0) return '';
            
            return ingredients.map(ing => {
                // Appeler les m√©thodes pour calculer les valeurs
                const stock = ing.getBaseQtyRemaining ? ing.getBaseQtyRemaining() : (ing.baseQtyRemaining || 0);
                // ‚úÖ CORRECTION: Utiliser IngredientService pour calculer la valeur
                const stockValue = IngredientService.getStockValue(ing);
                const alerts = ing.getAlerts ? ing.getAlerts() : (ing.alerts || []);
                
                const hasLowStock = alerts.some(a => a.type === 'STOCK_LOW');
                const hasDlcIssue = alerts.some(a => a.type && a.type.includes('DLC'));
                
                return `
                    <div class="ingredient-card" data-ingredient-id="${ing.id}">
                        <div class="ingredient-header">
                            <div>
                                <h3 class="ingredient-name">${ing.name}</h3>
                                <span class="ingredient-category">${ing.category || 'Non class√©'}</span>
                                ${(() => {
                                    const yieldPercent = Number(ing.yieldPercent);
                                    if (yieldPercent && yieldPercent > 0 && yieldPercent < 100) {
                                        return `
                                            <div style="margin-top: 4px; font-size: 12px; color: var(--warning); font-weight: 500;">
                                                üìä Rendement : ${yieldPercent}%
                                                ${ing.wasteType ? `<span style="color: var(--gray);"> ‚Ä¢ ${ing.wasteType}</span>` : ''}
                                            </div>
                                        `;
                                    }
                                    return '';
                                })()}
                            </div>
                            ${hasLowStock || hasDlcIssue ? `
                                <div class="alert-badge ${hasDlcIssue ? 'danger' : 'warning'}">
                                    ${hasDlcIssue ? 'üî¥' : '‚ö†Ô∏è'}
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="ingredient-stats">
                            <div class="stat-item">
                                <span class="stat-label">Stock</span>
                                <span class="stat-value ${hasLowStock ? 'text-danger' : ''}">${stock} ${ing.baseUnit}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Valeur</span>
                                <span class="stat-value">${formatCurrency(stockValue)}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Lots</span>
                                <span class="stat-value">${ing.lots?.length || 0}</span>
                            </div>
                        </div>
                        
                        ${alerts.length > 0 ? `
                            <div class="ingredient-alerts">
                                ${alerts.slice(0, 2).map(alert => `
                                    <div class="alert-item ${alert.severity}">
                                        <span>${alert.severity === 'error' ? 'üî¥' : '‚ö†Ô∏è'}</span>
                                        <span>${alert.message}</span>
                                    </div>
                                `).join('')}
                                ${alerts.length > 2 ? `<div class="alert-more">+${alerts.length - 2} autres</div>` : ''}
                            </div>
                        ` : ''}
                        
                        <div class="ingredient-actions" style="display:flex;gap:6px;flex-wrap:wrap;">
                            <button class="action-btn" style="flex:1;min-width:60px;font-size:13px;padding:8px 4px;" onclick="showIngredientDetails('${ing.id}')" title="Voir lots + mouvements">
                                üìä D√©tails
                            </button>
                            <button class="action-btn" style="flex:1;min-width:60px;font-size:13px;padding:8px 4px;" onclick="showAddLotModal('${ing.id}')" title="R√©ception lot">
                                ‚ûï R√©ception
                            </button>
                            <button class="action-btn" style="flex:1;min-width:60px;font-size:13px;padding:8px 4px;border-color:var(--danger);color:var(--danger);" onclick="showRecordLossModal('${ing.id}')" title="D√©clarer une perte">
                                üóë Perte
                            </button>
                            <button class="action-btn" style="flex:1;min-width:60px;font-size:13px;padding:8px 4px;" onclick="showInventoryModal('${ing.id}')" title="Inventaire physique">
                                üìã Inventaire
                            </button>
                            <button class="action-btn" style="flex:1;min-width:60px;font-size:13px;padding:8px 4px;" onclick="showEditIngredientModal('${ing.id}')" title="Modifier la fiche">
                                ‚úé Fiche
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Get alerts count
        function getAlertsCount() {
            const ingredients = appState.data.ingredients || [];
            return ingredients.reduce((count, ing) => {
                // ‚úÖ TOUJOURS utiliser getAlerts() pour calcul dynamique
                if (typeof ing.getAlerts === 'function') {
                    const alerts = ing.getAlerts();
                    return count + alerts.length;
                }
                // Si pas de m√©thode, pas d'alertes
                return count;
            }, 0);
        }
        
        // Update alerts badge in sidebar
        function updateAlertsBadge() {
            const count = getAlertsCount();
            const badge = document.getElementById('ingredientsAlertBadge');
            if (badge) {
                if (count > 0) {
                    badge.textContent = count;
                    badge.style.display = 'inline-block';
                } else {
                    badge.style.display = 'none';
                }
            }
        }
        
        // ========================================
        // CATEGORIES MANAGEMENT
        // ========================================
        
        // Get categories as select options
        function getCategoriesOptions() {
            const categories = appState.data.categories || [];
            const mainCategories = categories.filter(c => !c.parent);
            
            let html = '';
            mainCategories.forEach(main => {
                html += `<optgroup label="${main.name}">`;
                html += `<option value="${main.name}">${main.name}</option>`;
                
                // Add subcategories
                const subs = categories.filter(c => c.parent === main.name);
                subs.forEach(sub => {
                    html += `<option value="${sub.name}">  ‚îî ${sub.name}</option>`;
                });
                
                html += '</optgroup>';
            });
            
            return html;
        }
        
        // ========================================
        // RECIPES PAGE
        // ========================================
        
        function renderRecipesPage() {
            const recipes = appState.data.recipes || [];
            
            const html = `
                <div class="page-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h1 class="page-title">üìã Recettes</h1>
                        <div style="display: flex; gap: var(--space-sm);">
                            <button class="btn" style="background: var(--danger); color: white;" onclick="confirmDeleteAllRecipes()" title="Effacer toutes les recettes">
                                <span>üóëÔ∏è</span>
                                <span>Effacer Tout</span>
                            </button>
                            <button class="btn" style="background: var(--info); color: white;" onclick="downloadRecipeCSVTemplate()" title="T√©l√©charger le mod√®le CSV vierge">
                                <span>üìÑ</span>
                                <span>Mod√®le CSV</span>
                            </button>
                            <button class="btn btn-primary" onclick="showCreateRecipeModal()">
                                ‚ûï Nouvelle Recette
                            </button>
                        </div>
                    </div>
                </div>

                <div class="filters-bar">
                    <input type="text" id="searchRecipes" placeholder="üîç Rechercher..." class="search-input">
                    
                    <select id="filterRecipeCategory" class="filter-select">
                        <option value="">Toutes cat√©gories</option>
                        <option value="Pain">Pain</option>
                        <option value="Viennoiserie">Viennoiserie</option>
                        <option value="P√¢tisserie">P√¢tisserie</option>
                    </select>
                </div>

                <div id="recipesGrid" class="ingredients-grid">
                    ${recipes.length === 0 ? `
                        <div class="empty-state">
                            <div class="empty-icon">üìã</div>
                            <h3>Aucune recette</h3>
                            <p>Cr√©ez votre premi√®re recette</p>
                        </div>
                    ` : renderRecipeCards(recipes)}
                </div>
            `;
            
            document.getElementById('mainContent').innerHTML = html;
            
            document.getElementById('searchRecipes')?.addEventListener('input', filterRecipes);
            document.getElementById('filterRecipeCategory')?.addEventListener('change', filterRecipes);
        }

        // ========================================
        // PROFITABILITY PAGE (PHASE 2)
        // ========================================
        
        function renderProfitabilityPage() {
            // Analyser la rentabilit√© de tous les produits
            const analysis = ProfitabilityService.analyzeProfitability(
                appState.data.recipes || [],
                appState.data.packs || [],
                appState.data.ingredients || []
            );
            
            const { products, stats, recommendations } = analysis;
            
            const html = `
                <div class="page-header">
                    <div>
                        <h1 class="page-title">üìä Analyse Rentabilit√©</h1>
                        <p class="page-subtitle">Identifiez les produits rentables et ceux √† optimiser</p>
                    </div>
                </div>
                
                <!-- Statistiques globales -->
                <div class="stats-grid" style="margin-bottom: var(--space-lg);">
                    <div class="stat-card">
                        <div class="stat-header">
                            <span class="stat-label">Total Produits</span>
                            <span class="stat-icon">üì¶</span>
                        </div>
                        <div class="stat-value">${stats.total}</div>
                        <div class="stat-footer">Recettes + Packs</div>
                    </div>
                    
                    <div class="stat-card danger">
                        <div class="stat-header">
                            <span class="stat-label">En Perte</span>
                            <span class="stat-icon">üî¥</span>
                        </div>
                        <div class="stat-value">${stats.inLoss}</div>
                        <div class="stat-footer">Marge n√©gative</div>
                    </div>
                    
                    <div class="stat-card warning">
                        <div class="stat-header">
                            <span class="stat-label">Marge Faible</span>
                            <span class="stat-icon">üü°</span>
                        </div>
                        <div class="stat-value">${stats.lowMargin}</div>
                        <div class="stat-footer">Marge &lt; 25%</div>
                    </div>
                    
                    <div class="stat-card success">
                        <div class="stat-header">
                            <span class="stat-label">Excellents</span>
                            <span class="stat-icon">üü¢</span>
                        </div>
                        <div class="stat-value">${stats.excellent}</div>
                        <div class="stat-footer">Marge ‚â• 50%</div>
                    </div>
                </div>
                
                <!-- Recommandations -->
                ${recommendations.length > 0 ? `
                    <div style="background: linear-gradient(135deg, #fff9e6 0%, #fff3d6 100%); padding: var(--space-md); border-radius: var(--radius-md); border-left: 4px solid #f59e0b; margin-bottom: var(--space-lg);">
                        <h3 style="color: #f59e0b; margin-bottom: var(--space-sm); display: flex; align-items: center; gap: var(--space-xs);">
                            <span>üí°</span>
                            <span>Recommandations Automatiques</span>
                        </h3>
                        <div style="display: flex; flex-direction: column; gap: var(--space-sm);">
                            ${recommendations.slice(0, 5).map(rec => `
                                <div style="display: flex; align-items: start; gap: var(--space-sm); padding: var(--space-sm); background: white; border-radius: var(--radius-sm);">
                                    <span style="font-size: 20px;">${rec.icon}</span>
                                    <div style="flex: 1;">
                                        <strong style="color: var(--dark);">${rec.product || 'G√©n√©ral'}</strong>
                                        <p style="margin: 4px 0; font-size: 13px; color: #78350f;">${rec.message}</p>
                                        <p style="margin: 0; font-size: 12px; color: #78350f;"><strong>Action:</strong> ${rec.action}</p>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
                
                <!-- Filtres et tri -->
                <div style="background: white; padding: var(--space-md); border-radius: var(--radius-md); margin-bottom: var(--space-md); box-shadow: var(--shadow-sm);">
                    <div style="display: flex; gap: var(--space-md); align-items: center; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 200px;">
                            <input type="text" id="searchProfitability" placeholder="üîç Rechercher un produit..." 
                                   style="width: 100%; padding: 12px 16px; border: 2px solid var(--light); border-radius: var(--radius-md); font-family: var(--font-body);">
                        </div>
                        <div>
                            <label style="font-size: 13px; color: var(--gray); margin-right: 8px;">Type:</label>
                            <select id="filterProfitType" style="padding: 10px 16px; border: 2px solid var(--light); border-radius: var(--radius-md); font-family: var(--font-body);">
                                <option value="all">Tous</option>
                                <option value="recipe">Recettes</option>
                                <option value="pack">Packs</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-size: 13px; color: var(--gray); margin-right: 8px;">Classification:</label>
                            <select id="filterProfitClassification" style="padding: 10px 16px; border: 2px solid var(--light); border-radius: var(--radius-md); font-family: var(--font-body);">
                                <option value="all">Toutes</option>
                                <option value="loss">üî¥ Pertes</option>
                                <option value="low">üü° Faibles</option>
                                <option value="medium">‚ö™ Correctes</option>
                                <option value="high">üü¢ Excellentes</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-size: 13px; color: var(--gray); margin-right: 8px;">Trier par:</label>
                            <select id="sortProfitBy" style="padding: 10px 16px; border: 2px solid var(--light); border-radius: var(--radius-md); font-family: var(--font-body);">
                                <option value="margin-asc">Marge ‚Üë</option>
                                <option value="margin-desc">Marge ‚Üì</option>
                                <option value="name-asc">Nom A‚ÜíZ</option>
                                <option value="name-desc">Nom Z‚ÜíA</option>
                                <option value="cost-asc">Co√ªt ‚Üë</option>
                                <option value="cost-desc">Co√ªt ‚Üì</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Tableau des produits -->
                <div id="profitabilityTable" style="background: white; border-radius: var(--radius-md); box-shadow: var(--shadow-sm); overflow: hidden;">
                    ${renderProfitabilityTable(products)}
                </div>
            `;
            
            document.getElementById('mainContent').innerHTML = html;
            
            // Event listeners pour filtres
            document.getElementById('searchProfitability')?.addEventListener('input', filterProfitabilityTable);
            document.getElementById('filterProfitType')?.addEventListener('change', filterProfitabilityTable);
            document.getElementById('filterProfitClassification')?.addEventListener('change', filterProfitabilityTable);
            document.getElementById('sortProfitBy')?.addEventListener('change', filterProfitabilityTable);
        }
        
        function renderProfitabilityTable(products) {
            if (products.length === 0) {
                return `
                    <div class="empty-state">
                        <div class="empty-icon">üìä</div>
                        <h3>Aucun produit √† analyser</h3>
                        <p>Cr√©ez des recettes et d√©finissez des prix de vente pour voir l'analyse</p>
                    </div>
                `;
            }
            
            return `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: var(--light); border-bottom: 2px solid var(--light);">
                            <th style="padding: 16px; text-align: left; font-weight: 600; color: var(--dark);">Statut</th>
                            <th style="padding: 16px; text-align: left; font-weight: 600; color: var(--dark);">Produit</th>
                            <th style="padding: 16px; text-align: right; font-weight: 600; color: var(--dark);">Co√ªt</th>
                            <th style="padding: 16px; text-align: right; font-weight: 600; color: var(--dark);">Prix</th>
                            <th style="padding: 16px; text-align: right; font-weight: 600; color: var(--dark);">Marge</th>
                            <th style="padding: 16px; text-align: right; font-weight: 600; color: var(--dark);">Prix Sugg√©r√©</th>
                            <th style="padding: 16px; text-align: center; font-weight: 600; color: var(--dark);">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${products.map(product => `
                            <tr style="border-bottom: 1px solid var(--light); transition: background 0.2s;" 
                                onmouseover="this.style.background='var(--light)'" 
                                onmouseout="this.style.background='white'">
                                <td style="padding: 16px;">
                                    <span style="font-size: 24px;">${product.classification.icon}</span>
                                </td>
                                <td style="padding: 16px;">
                                    <div>
                                        <strong style="color: var(--dark);">${product.name}</strong>
                                        <div style="font-size: 12px; color: var(--gray); margin-top: 4px;">
                                            ${product.type === 'recipe' ? 'üìã Recette' : 'üéÅ Pack'} ‚Ä¢ ${product.category}
                                        </div>
                                    </div>
                                </td>
                                <td style="padding: 16px; text-align: right;">
                                    <strong style="color: var(--danger);">${formatCurrency(product.cost)}</strong>
                                </td>
                                <td style="padding: 16px; text-align: right;">
                                    <strong style="color: var(--success);">${formatCurrency(product.price)}</strong>
                                </td>
                                <td style="padding: 16px; text-align: right;">
                                    <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 4px;">
                                        <strong style="color: ${product.classification.color}; font-size: 16px;">
                                            ${product.marginPercent >= 0 ? '+' : ''}${product.marginPercent.toFixed(1)}%
                                        </strong>
                                        <span style="font-size: 11px; color: ${product.classification.color}; font-weight: 600;">
                                            ${product.classification.label}
                                        </span>
                                    </div>
                                </td>
                                <td style="padding: 16px; text-align: right;">
                                    <div style="font-size: 12px; color: var(--gray);">
                                        <div style="margin-bottom: 4px;">
                                            <strong>30%:</strong> ${formatCurrency(product.suggestedPrices.margin30)}
                                        </div>
                                        <div style="margin-bottom: 4px;">
                                            <strong>50%:</strong> ${formatCurrency(product.suggestedPrices.margin50)}
                                        </div>
                                    </div>
                                </td>
                                <td style="padding: 16px; text-align: center;">
                                    <button class="btn btn-sm" onclick="showProductPriceSimulator('${product.id}', '${product.type}')" 
                                            style="padding: 6px 12px; font-size: 12px; background: var(--primary); color: white; border: none; border-radius: var(--radius-sm); cursor: pointer;">
                                        üí∞ Simuler
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }
        
        function filterProfitabilityTable() {
            const searchTerm = document.getElementById('searchProfitability')?.value || '';
            const typeFilter = document.getElementById('filterProfitType')?.value || 'all';
            const classFilter = document.getElementById('filterProfitClassification')?.value || 'all';
            const sortBy = document.getElementById('sortProfitBy')?.value || 'margin-asc';
            
            // Analyser √† nouveau avec filtres
            const analysis = ProfitabilityService.analyzeProfitability(
                appState.data.recipes || [],
                appState.data.packs || [],
                appState.data.ingredients || []
            );
            
            let products = analysis.products;
            
            // Filtrer
            products = ProfitabilityService.filterProducts(products, {
                type: typeFilter,
                classification: classFilter,
                search: searchTerm
            });
            
            // Trier
            const [sortField, sortOrder] = sortBy.split('-');
            products = ProfitabilityService.sortProducts(products, sortField, sortOrder);
            
            // Re-render table
            document.getElementById('profitabilityTable').innerHTML = renderProfitabilityTable(products);
        }
        
        // Placeholder pour simulateur de prix (√† d√©velopper dans fonctionnalit√© 3)
        window.showProductPriceSimulator = function(productId, productType) {
            showToast('üí° Simulateur de prix - Bient√¥t disponible !', 'info');
        };

        // Render recipe cards
        function renderRecipeCards(recipes) {
            const settings = appState.data.settings || { overheadCoefficient: 1.0, showDirectCost: true };
            
            return recipes.map(recipe => {
                const capacity = RecipeService.calculateCapacity(recipe, appState.data.ingredients);
                const cost = RecipeService.calculateCost(recipe, appState.data.ingredients);
                const pricePerUnit = cost.totalCost / (recipe.producedQty || 1);
                
                // Calcul marge si prix de vente d√©fini
                const sellingPrice = recipe.sellingPrice || 0;
                const marginAmount = sellingPrice - pricePerUnit;
                const marginPercent = sellingPrice > 0 ? (marginAmount / sellingPrice * 100) : 0;
                
                // üõ°Ô∏è BADGES RENTABILIT√â (comme les packs)
                let profitBadge = '';
                let cardClass = 'ingredient-card';
                
                if (sellingPrice > 0) {
                    if (marginAmount < 0) {
                        // PERTE
                        profitBadge = '<span style="background: var(--danger); color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; margin-left: 8px;">üî¥ PERTE</span>';
                        cardClass += ' loss-warning';
                    } else if (marginPercent < 10) {
                        // FAIBLE MARGE
                        profitBadge = '<span style="background: var(--warning); color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; margin-left: 8px;">üü° FAIBLE MARGE</span>';
                    } else {
                        // RENTABLE
                        profitBadge = '<span style="background: var(--success); color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; margin-left: 8px;">üü¢ RENTABLE</span>';
                    }
                }
                
                return `
                    <div class="${cardClass}">
                        <div class="ingredient-header">
                            <div>
                                <h3 class="ingredient-name">${recipe.name}${profitBadge}</h3>
                                <span class="ingredient-category">${recipe.category || 'Sans cat√©gorie'}</span>
                            </div>
                            ${sellingPrice > 0 ? `
                                <div class="ingredient-stock ${marginPercent >= 25 ? 'success' : 'warning'}">
                                    ${marginPercent.toFixed(0)}%
                                </div>
                            ` : `
                                <div class="ingredient-stock" style="background: var(--gray);">
                                    Pas de PV
                                </div>
                            `}
                        </div>
                        
                        <div class="ingredient-stats">
                            <div class="stat-item">
                                <span class="stat-label">Co√ªt/unit√©</span>
                                <span class="stat-value">${formatCurrency(pricePerUnit)}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Rendement</span>
                                <span class="stat-value">${recipe.producedQty} ${recipe.producedUnit}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Fabricable</span>
                                <span class="stat-value ${capacity.batches === 0 ? 'text-danger' : ''}">${capacity.batches} fois</span>
                            </div>
                        </div>
                        
                        ${sellingPrice > 0 ? `
                            <div style="background: ${marginPercent < 10 ? '#fff3cd' : '#d4edda'}; padding: 8px 12px; border-radius: 6px; font-size: 13px; margin-top: 8px;">
                                üí∞ PV: ${formatCurrency(sellingPrice)} | 
                                Marge: ${formatCurrency(marginAmount)} (${marginPercent.toFixed(1)}%)
                            </div>
                        ` : ''}
                        
                        <div class="ingredient-actions">
                            <button class="action-btn" onclick="showRecipeDetails('${recipe.id}')" title="D√©tails">üëÅÔ∏è</button>
                            <button class="action-btn" onclick="showEditRecipeModal('${recipe.id}')" title="Modifier">‚úèÔ∏è</button>
                            <button class="action-btn" onclick="showProduceRecipeModal('${recipe.id}')" title="Produire">‚öôÔ∏è</button>
                            <button class="action-btn" onclick="duplicateRecipe('${recipe.id}')" title="Dupliquer">üìã</button>
                            <button class="action-btn" onclick="deleteRecipe('${recipe.id}')" title="Supprimer">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ========================================
        // CRUD RECETTES - COMPLET
        // ========================================
        
        /**
         * Affiche le modal d'√©dition d'une recette
         */
        window.showEditRecipeModal = function(recipeId) {
            const recipe = appState.data.recipes.find(r => r.id === recipeId);
            if (!recipe) {
                showToast('‚ùå Recette introuvable', 'error');
                return;
            }
            
            const modal = document.createElement('div');
            modal.id = 'editRecipeModal';
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 900px;">
                    <div class="modal-header">
                        <h2>‚úèÔ∏è Modifier la recette</h2>
                        <button class="modal-close" onclick="closeModal('editRecipeModal')">‚úï</button>
                    </div>
                    <div class="modal-body">
                        <form id="editRecipeForm">
                            <input type="hidden" name="recipeId" value="${recipe.id}">
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Nom de la recette *</label>
                                    <input type="text" name="name" value="${recipe.name}" required>
                                </div>
                                <div class="form-group">
                                    <label>Cat√©gorie</label>
                                    <select name="category">
                                        <option value="">Aucune</option>
                                        <option value="Pain" ${recipe.category === 'Pain' ? 'selected' : ''}>Pain</option>
                                        <option value="Viennoiserie" ${recipe.category === 'Viennoiserie' ? 'selected' : ''}>Viennoiserie</option>
                                        <option value="P√¢tisserie" ${recipe.category === 'P√¢tisserie' ? 'selected' : ''}>P√¢tisserie</option>
                                        <option value="Snacking" ${recipe.category === 'Snacking' ? 'selected' : ''}>Snacking</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Quantit√© produite *</label>
                                    <input type="number" name="producedQty" value="${recipe.producedQty}" required min="1" step="1">
                                </div>
                                <div class="form-group">
                                    <label>Unit√© *</label>
                                    <select name="producedUnit">
                                        <option value="pi√®ce" ${recipe.producedUnit === 'pi√®ce' ? 'selected' : ''}>pi√®ce</option>
                                        <option value="kg" ${recipe.producedUnit === 'kg' ? 'selected' : ''}>kg</option>
                                        <option value="L" ${recipe.producedUnit === 'L' ? 'selected' : ''}>L</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Prix de vente unitaire</label>
                                    <input type="number" name="sellingPrice" value="${recipe.sellingPrice || ''}" min="0" step="0.01" placeholder="Optionnel">
                                    <small style="color: var(--gray);">Prix de vente par ${recipe.producedUnit}</small>
                                </div>
                            </div>
                            
                            <!-- Ingr√©dients -->
                            <div style="margin-top: var(--space-lg);">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-md);">
                                    <h3>Ingr√©dients</h3>
                                    <button type="button" class="btn btn-primary" onclick="addIngredientLineEdit()">
                                        ‚ûï Ajouter ingr√©dient
                                    </button>
                                </div>
                                
                                <div id="ingredientsListEdit">
                                    ${recipe.ingredients.map((ing, index) => {
                                        const ingredient = appState.data.ingredients.find(i => i.id === ing.ingredientId);
                                        return `
                                            <div class="ingredient-line" data-index="${index}">
                                                <select class="ingredient-select" name="ingredientId_${index}" required>
                                                    <option value="">S√©lectionner...</option>
                                                    ${appState.data.ingredients.map(i => `
                                                        <option value="${i.id}" ${i.id === ing.ingredientId ? 'selected' : ''}>
                                                            ${i.name}
                                                        </option>
                                                    `).join('')}
                                                </select>
                                                <input type="number" name="quantity_${index}" value="${ing.quantity}" required min="0" step="0.01" placeholder="Quantit√©">
                                                <select name="unit_${index}">
                                                    <option value="g" ${ing.unit === 'g' ? 'selected' : ''}>g</option>
                                                    <option value="kg" ${ing.unit === 'kg' ? 'selected' : ''}>kg</option>
                                                    <option value="ml" ${ing.unit === 'ml' ? 'selected' : ''}>ml</option>
                                                    <option value="L" ${ing.unit === 'L' ? 'selected' : ''}>L</option>
                                                    <option value="pi√®ce" ${ing.unit === 'pi√®ce' ? 'selected' : ''}>pi√®ce</option>
                                                </select>
                                                <button type="button" class="btn" style="background: var(--danger); color: white;" onclick="removeIngredientLineEdit(${index})">
                                                    ‚úï
                                                </button>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                            
                            <!-- Co√ªt calcul√© -->
                            <div id="costPreview" style="margin-top: var(--space-lg); padding: var(--space-md); background: var(--light); border-radius: var(--radius-md);">
                                <div style="font-weight: 600; margin-bottom: var(--space-sm);">üí∞ Co√ªt estim√©</div>
                                <div id="costDetails"></div>
                            </div>
                            
                            <div style="display: flex; gap: var(--space-md); margin-top: var(--space-xl);">
                                <button type="button" class="btn" style="flex: 1; background: var(--gray); color: white;" onclick="closeModal('editRecipeModal')">
                                    Annuler
                                </button>
                                <button type="submit" class="btn btn-primary" style="flex: 1;">
                                    üíæ Enregistrer
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Calculer le co√ªt initial
            updateCostPreviewEdit();
            
            // Recalculer √† chaque changement
            modal.querySelectorAll('input, select').forEach(el => {
                el.addEventListener('change', updateCostPreviewEdit);
            });
            
            // Handle form submit
            modal.querySelector('#editRecipeForm').addEventListener('submit', handleEditRecipe);
        };
        
        let ingredientCounterEdit = 0;
        
        window.addIngredientLineEdit = function() {
            const container = document.getElementById('ingredientsListEdit');
            const index = ingredientCounterEdit++;
            
            const line = document.createElement('div');
            line.className = 'ingredient-line';
            line.dataset.index = index;
            line.innerHTML = `
                <select class="ingredient-select" name="ingredientId_${index}" required>
                    <option value="">S√©lectionner...</option>
                    ${appState.data.ingredients.map(i => `
                        <option value="${i.id}">${i.name}</option>
                    `).join('')}
                </select>
                <input type="number" name="quantity_${index}" required min="0" step="0.01" placeholder="Quantit√©">
                <select name="unit_${index}">
                    <option value="g">g</option>
                    <option value="kg">kg</option>
                    <option value="ml">ml</option>
                    <option value="L">L</option>
                    <option value="pi√®ce">pi√®ce</option>
                </select>
                <button type="button" class="btn" style="background: var(--danger); color: white;" onclick="removeIngredientLineEdit(${index})">
                    ‚úï
                </button>
            `;
            
            container.appendChild(line);
            
            // Recalculer le co√ªt
            line.querySelectorAll('input, select').forEach(el => {
                el.addEventListener('change', updateCostPreviewEdit);
            });
        };
        
        window.removeIngredientLineEdit = function(index) {
            const line = document.querySelector(`#ingredientsListEdit .ingredient-line[data-index="${index}"]`);
            if (line) {
                line.remove();
                updateCostPreviewEdit();
            }
        };
        
        function updateCostPreviewEdit() {
            const form = document.getElementById('editRecipeForm');
            if (!form) return;
            
            const formData = new FormData(form);
            const producedQty = Number(formData.get('producedQty')) || 1;
            const sellingPrice = Number(formData.get('sellingPrice')) || 0;
            
            // Collecter les ingr√©dients
            const ingredients = [];
            const lines = document.querySelectorAll('#ingredientsListEdit .ingredient-line');
            lines.forEach(line => {
                const index = line.dataset.index;
                const ingredientId = formData.get(`ingredientId_${index}`);
                const quantity = Number(formData.get(`quantity_${index}`));
                const unit = formData.get(`unit_${index}`);
                
                if (ingredientId && quantity) {
                    ingredients.push({ ingredientId, quantity, unit });
                }
            });
            
            // Calculer le co√ªt
            let totalCost = 0;
            ingredients.forEach(ing => {
                const ingredient = appState.data.ingredients.find(i => i.id === ing.ingredientId);
                if (!ingredient) return;
                
                const pricePerBaseUnit = ingredient.getPricePerBaseUnit ? ingredient.getPricePerBaseUnit() : 0;
                
                // Convertir en unit√© de base
                let qtyInBaseUnit = ing.quantity;
                if (ing.unit === 'kg' && ingredient.baseUnit === 'g') qtyInBaseUnit *= 1000;
                if (ing.unit === 'L' && ingredient.baseUnit === 'ml') qtyInBaseUnit *= 1000;
                if (ing.unit === 'g' && ingredient.baseUnit === 'kg') qtyInBaseUnit /= 1000;
                if (ing.unit === 'ml' && ingredient.baseUnit === 'L') qtyInBaseUnit /= 1000;
                
                totalCost += pricePerBaseUnit * qtyInBaseUnit;
            });
            
            const costPerUnit = totalCost / producedQty;
            const margin = sellingPrice > 0 ? ((sellingPrice - costPerUnit) / sellingPrice * 100) : 0;
            
            document.getElementById('costDetails').innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--space-md);">
                    <div>
                        <div style="font-size: 12px; color: var(--gray);">Co√ªt total</div>
                        <div style="font-size: 18px; font-weight: 700; color: var(--primary);">${formatCurrency(totalCost)}</div>
                    </div>
                    <div>
                        <div style="font-size: 12px; color: var(--gray);">Co√ªt/unit√©</div>
                        <div style="font-size: 18px; font-weight: 700; color: var(--warning);">${formatCurrency(costPerUnit)}</div>
                    </div>
                    ${sellingPrice > 0 ? `
                        <div>
                            <div style="font-size: 12px; color: var(--gray);">Marge</div>
                            <div style="font-size: 18px; font-weight: 700; color: ${margin < 0 ? 'var(--danger)' : 'var(--success)'};">
                                ${margin.toFixed(1)}%
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }
        
        async function handleEditRecipe(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const recipeId = formData.get('recipeId');
            
            // Collecter les ingr√©dients
            const ingredients = [];
            const lines = document.querySelectorAll('#ingredientsListEdit .ingredient-line');
            lines.forEach(line => {
                const index = line.dataset.index;
                const ingredientId = formData.get(`ingredientId_${index}`);
                const quantity = Number(formData.get(`quantity_${index}`));
                const unit = formData.get(`unit_${index}`);
                
                if (ingredientId && quantity) {
                    ingredients.push({ ingredientId, quantity, unit });
                }
            });
            
            if (ingredients.length === 0) {
                showToast('‚ùå Ajoutez au moins un ingr√©dient', 'error');
                return;
            }
            
            const recipeData = {
                name: formData.get('name'),
                category: formData.get('category'),
                producedQty: Number(formData.get('producedQty')),
                producedUnit: formData.get('producedUnit'),
                sellingPrice: Number(formData.get('sellingPrice')) || null,
                ingredients: ingredients
            };
            
            try {
                // Trouver et mettre √† jour la recette
                const recipeIndex = appState.data.recipes.findIndex(r => r.id === recipeId);
                if (recipeIndex === -1) {
                    showToast('‚ùå Recette introuvable', 'error');
                    return;
                }
                
                // Mettre √† jour en conservant l'ID
                appState.data.recipes[recipeIndex] = {
                    ...appState.data.recipes[recipeIndex],
                    ...recipeData,
                    updatedAt: new Date()
                };
                
                saveData();
                renderRecipesPage();
                closeModal('editRecipeModal');
                
                showToast(`‚úÖ Recette "${recipeData.name}" mise √† jour !`, 'success');
                
            } catch (error) {
                console.error('Edit recipe error:', error);
                showToast('‚ùå Erreur : ' + error.message, 'error');
            }
        }
        
        /**
         * Dupliquer une recette
         */
        window.duplicateRecipe = function(recipeId) {
            const recipe = appState.data.recipes.find(r => r.id === recipeId);
            if (!recipe) {
                showToast('‚ùå Recette introuvable', 'error');
                return;
            }
            
            const newRecipe = {
                ...recipe,
                id: 'recipe_' + Date.now(),
                name: recipe.name + ' (copie)',
                createdAt: new Date(),
                updatedAt: new Date()
            };
            
            appState.data.recipes.push(newRecipe);
            saveData();
            renderRecipesPage();
            
            showToast(`‚úÖ Recette "${newRecipe.name}" cr√©√©e !`, 'success');
        };
        
        /**
         * Supprimer une recette
         */
        window.deleteRecipe = function(recipeId) {
            const recipe = appState.data.recipes.find(r => r.id === recipeId);
            if (!recipe) {
                showToast('‚ùå Recette introuvable', 'error');
                return;
            }
            
            // V√©rifier si utilis√©e dans des productions
            const productions = appState.data.productions || [];
            const usedInProductions = productions.filter(p => p.recipeId === recipeId);
            
            if (usedInProductions.length > 0) {
                if (!confirm(`‚ö†Ô∏è Cette recette est utilis√©e dans ${usedInProductions.length} production(s). Supprimer quand m√™me ?`)) {
                    return;
                }
            }
            
            if (!confirm(`üóëÔ∏è Supprimer la recette "${recipe.name}" ?\n\nCette action est irr√©versible.`)) {
                return;
            }
            
            // Supprimer
            appState.data.recipes = appState.data.recipes.filter(r => r.id !== recipeId);
            saveData();
            renderRecipesPage();
            
            showToast(`üóëÔ∏è Recette "${recipe.name}" supprim√©e`, 'success');
        };
        
        /**
         * Modal de production
         */
        window.showProduceRecipeModal = function(recipeId) {
            const recipe = appState.data.recipes.find(r => r.id === recipeId);
            if (!recipe) {
                showToast('‚ùå Recette introuvable', 'error');
                return;
            }
            
            const capacity = RecipeService.calculateCapacity(recipe, appState.data.ingredients);
            const cost = RecipeService.calculateCost(recipe, appState.data.ingredients);
            
            const modal = document.createElement('div');
            modal.id = 'produceRecipeModal';
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 700px;">
                    <div class="modal-header">
                        <h2>‚öôÔ∏è Produire : ${recipe.name}</h2>
                        <button class="modal-close" onclick="closeModal('produceRecipeModal')">‚úï</button>
                    </div>
                    <div class="modal-body">
                        <!-- Capacit√© -->
                        <div style="background: ${capacity.batches === 0 ? '#fee' : '#e6f7ed'}; padding: var(--space-md); border-radius: var(--radius-md); margin-bottom: var(--space-lg); border-left: 4px solid ${capacity.batches === 0 ? 'var(--danger)' : 'var(--success)'};">
                            <div style="font-weight: 600; margin-bottom: var(--space-sm);">
                                ${capacity.batches === 0 ? '‚ùå' : '‚úÖ'} Capacit√© de production
                            </div>
                            ${capacity.batches === 0 ? `
                                <p style="margin: 0; color: var(--danger);">
                                    Impossible de produire : stock insuffisant pour ${capacity.missingIngredients.length} ingr√©dient(s)
                                </p>
                                <ul style="margin-top: var(--space-sm); font-size: 13px;">
                                    ${capacity.missingIngredients.map(ing => `
                                        <li>${ing.name} : manque ${ing.missing} ${ing.unit}</li>
                                    `).join('')}
                                </ul>
                            ` : `
                                <p style="margin: 0; color: var(--success);">
                                    Vous pouvez produire jusqu'√† <strong>${capacity.batches} fois</strong> cette recette avec votre stock actuel
                                </p>
                            `}
                        </div>
                        
                        ${capacity.batches > 0 ? `
                            <form id="produceForm">
                                <input type="hidden" name="recipeId" value="${recipe.id}">
                                
                                <div class="form-group">
                                    <label>Nombre de fois √† produire *</label>
                                    <input type="number" name="batches" value="1" min="1" max="${capacity.batches}" required>
                                    <small style="color: var(--gray);">Maximum : ${capacity.batches} fois</small>
                                </div>
                                
                                <div class="form-group">
                                    <label>Date de production</label>
                                    <input type="date" name="productionDate" value="${new Date().toISOString().split('T')[0]}" required>
                                </div>
                                
                                <!-- R√©sum√© -->
                                <div id="productionSummary" style="background: var(--light); padding: var(--space-md); border-radius: var(--radius-md); margin-top: var(--space-md);">
                                    <div style="font-weight: 600; margin-bottom: var(--space-sm);">üìä R√©sum√© de production</div>
                                    <div id="summaryDetails"></div>
                                </div>
                                
                                <div style="display: flex; gap: var(--space-md); margin-top: var(--space-xl);">
                                    <button type="button" class="btn" style="flex: 1; background: var(--gray); color: white;" onclick="closeModal('produceRecipeModal')">
                                        Annuler
                                    </button>
                                    <button type="submit" class="btn btn-primary" style="flex: 1;">
                                        ‚öôÔ∏è Lancer la production
                                    </button>
                                </div>
                            </form>
                        ` : `
                            <button class="btn" style="width: 100%; background: var(--gray); color: white;" onclick="closeModal('produceRecipeModal')">
                                Fermer
                            </button>
                        `}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            if (capacity.batches > 0) {
                // Mettre √† jour le r√©sum√©
                const batchesInput = modal.querySelector('input[name="batches"]');
                updateProductionSummary();
                
                batchesInput.addEventListener('input', updateProductionSummary);
                
                function updateProductionSummary() {
                    const batches = Number(batchesInput.value) || 1;
                    const totalProduced = recipe.producedQty * batches;
                    const totalCost = cost.totalCost * batches;
                    
                    document.getElementById('summaryDetails').innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-md);">
                            <div>
                                <div style="font-size: 12px; color: var(--gray);">Quantit√© produite</div>
                                <div style="font-size: 20px; font-weight: 700; color: var(--primary);">
                                    ${totalProduced} ${recipe.producedUnit}
                                </div>
                            </div>
                            <div>
                                <div style="font-size: 12px; color: var(--gray);">Co√ªt total</div>
                                <div style="font-size: 20px; font-weight: 700; color: var(--warning);">
                                    ${formatCurrency(totalCost)}
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                // Handle form submit
                modal.querySelector('#produceForm').addEventListener('submit', handleProduceRecipe);
            }
        };
        
        async function handleProduceRecipe(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const recipeId = formData.get('recipeId');
            const batches = Number(formData.get('batches'));
            const productionDate = formData.get('productionDate');
            
            const recipe = appState.data.recipes.find(r => r.id === recipeId);
            if (!recipe) {
                showToast('‚ùå Recette introuvable', 'error');
                return;
            }
            
            try {
                // Utiliser ProductionService pour produire
                const result = ProductionService.produce(
                    recipe,
                    batches,
                    productionDate,
                    appState.data.ingredients
                );
                
                if (!result.success) {
                    showToast('‚ùå ' + result.error, 'error');
                    return;
                }
                
                // Ajouter la production
                const production = result.production;
                appState.data.productions = appState.data.productions || [];
                appState.data.productions.push(production);
                
                // Mettre √† jour les ingr√©dients
                appState.data.ingredients = result.ingredients;
                
                saveData();
                closeModal('produceRecipeModal');
                renderRecipesPage();
                
                const totalProduced = recipe.producedQty * batches;
                showToast(`‚úÖ Production termin√©e : ${totalProduced} ${recipe.producedUnit} de "${recipe.name}"`, 'success');
                
            } catch (error) {
                console.error('Production error:', error);
                showToast('‚ùå Erreur : ' + error.message, 'error');
            }
        }
        
        // ========================================
        // PRODUCTIONS PAGE
        // ========================================
        
        function renderProductionsPage() {
            const productions = appState.data.productions || [];
            
            let html = `
                <div class="page-container">
                    <div class="page-header">
                        <h1 class="page-title">‚öôÔ∏è Productions</h1>
                        <button class="btn btn-primary" onclick="showNewProductionModal()">
                            ‚ûï Nouvelle Production
                        </button>
                    </div>
                    
                    ${productions.length === 0 ? `
                        <div class="empty-state">
                            <div class="empty-icon">‚öôÔ∏è</div>
                            <h3>Aucune production</h3>
                            <p>Lancez votre premi√®re production pour commencer</p>
                            <button class="btn btn-primary" onclick="showNewProductionModal()">
                                ‚ûï Nouvelle Production
                            </button>
                        </div>
                    ` : `
                        <div class="filters-bar">
                            <input type="text" id="searchProductions" placeholder="üîç Rechercher..." class="search-input">
                            <select id="filterProductionRecipe" class="filter-select">
                                <option value="">Toutes les recettes</option>
                                ${[...new Set(productions.map(p => p.recipeName))].map(name => `
                                    <option value="${name}">${name}</option>
                                `).join('')}
                            </select>
                        </div>
                        
                        <div class="stats-grid" style="margin-bottom: var(--space-lg);">
                            <div class="stat-card primary">
                                <div class="stat-label">Productions</div>
                                <div class="stat-value">${productions.length}</div>
                            </div>
                            <div class="stat-card success">
                                <div class="stat-label">Produits finis</div>
                                <div class="stat-value">${productions.reduce((sum, p) => sum + p.producedQty, 0)}</div>
                            </div>
                            <div class="stat-card warning">
                                <div class="stat-label">Stock restant</div>
                                <div class="stat-value">${productions.reduce((sum, p) => sum + p.remainingQty, 0)}</div>
                            </div>
                            <div class="stat-card info">
                                <div class="stat-label">Valeur stock</div>
                                <div class="stat-value">${formatCurrency(DashboardService.getFinishedGoodsStockValue(productions))}</div>
                            </div>
                        </div>
                        
                        <div id="productionsListContainer" class="ingredients-list">
                            ${renderProductionCards(productions)}
                        </div>
                    `}
                </div>
            `;
            
            document.getElementById('mainContent').innerHTML = html;
            
            if (productions.length > 0) {
                document.getElementById('searchProductions')?.addEventListener('input', filterProductions);
                document.getElementById('filterProductionRecipe')?.addEventListener('change', filterProductions);
            }
        }
        
        // Render production cards
        function renderProductionCards(productions) {
            return productions.map(production => {
                const progressPercent = (production.remainingQty / production.producedQty) * 100;
                const status = production.remainingQty === 0 ? 'exhausted' : (progressPercent < 30 ? 'low' : 'ok');
                
                return `
                    <div class="ingredient-card">
                        <div class="ingredient-header">
                            <div>
                                <h3 class="ingredient-name">${production.recipeName}</h3>
                                <p class="ingredient-meta">
                                    Production du ${formatDateFR(production.productionDate)}
                                    ${production.operator ? ` ‚Ä¢ Par ${production.operator}` : ''}
                                </p>
                            </div>
                            <div class="ingredient-stock ${status}">
                                ${production.remainingQty} / ${production.producedQty} ${production.producedUnit}
                            </div>
                        </div>
                        
                        <div class="ingredient-stats">
                            <div class="stat-item">
                                <span class="stat-label">Multiplicateur</span>
                                <span class="stat-value">√ó${production.multiplier}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Co√ªt total</span>
                                <span class="stat-value">${formatCurrency(production.costTotal)}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Co√ªt unitaire</span>
                                <span class="stat-value">${formatCurrency(production.costPerUnit)}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Valeur restante</span>
                                <span class="stat-value">${formatCurrency(
                                    typeof production.getRemainingValue === 'function' 
                                        ? production.getRemainingValue() 
                                        : (production.remainingQty / production.producedQty) * production.costTotal
                                )}</span>
                            </div>
                        </div>
                        
                        <div class="progress-bar" style="margin-top: var(--space-md);">
                            <div class="progress-fill ${status}" style="width: ${progressPercent}%"></div>
                        </div>
                        
                        <div class="ingredient-actions">
                            <button class="action-btn" onclick="showProductionDetails('${production.id}')" title="D√©tails">üëÅÔ∏è</button>
                            ${production.remainingQty > 0 ? `
                                <button class="action-btn" onclick="alert('Vendre - Bient√¥t')" title="Vendre">üí∞</button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Filter productions
        function filterProductions() {
            const searchTerm = document.getElementById('searchProductions').value.toLowerCase();
            const recipeFilter = document.getElementById('filterProductionRecipe').value;
            
            let filtered = appState.data.productions || [];
            
            if (searchTerm) {
                filtered = filtered.filter(p => 
                    p.recipeName.toLowerCase().includes(searchTerm) ||
                    p.operator.toLowerCase().includes(searchTerm)
                );
            }
            
            if (recipeFilter) {
                filtered = filtered.filter(p => p.recipeName === recipeFilter);
            }
            
            document.getElementById('productionsListContainer').innerHTML = renderProductionCards(filtered);
        }
        
        // Show new production modal (placeholder)
        window.showNewProductionModal = function() {
            const recipes = appState.data.recipes || [];
            const ingredients = appState.data.ingredients || [];
            
            if (recipes.length === 0) {
                showToast('‚ùå Cr√©ez d\'abord une recette', 'error');
                return;
            }
            
            const modal = document.createElement('div');
            modal.id = 'newProductionModal';
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 900px;">
                    <div class="modal-header">
                        <h2>‚öôÔ∏è Nouvelle Production</h2>
                        <button class="modal-close" onclick="closeModal('newProductionModal')">‚úï</button>
                    </div>
                    <div class="modal-body">
                        <form id="newProductionForm">
                            <!-- S√©lection recette -->
                            <div class="form-group">
                                <label>Recette *</label>
                                <select name="recipeId" id="productionRecipeSelect" required onchange="updateProductionPreview()">
                                    <option value="">S√©lectionner une recette...</option>
                                    ${recipes.map(r => `<option value="${r.id}">${r.name} (${r.producedQty} ${r.producedUnit})</option>`).join('')}
                                </select>
                            </div>
                            
                            <!-- Multiplicateur -->
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Multiplicateur (batches) *</label>
                                    <div style="display: flex; gap: var(--space-md); align-items: center;">
                                        <input type="range" id="multiplierSlider" min="1" max="10" value="1" 
                                               oninput="updateMultiplierValue(); updateProductionPreview();" 
                                               style="flex: 1;">
                                        <input type="number" name="multiplier" id="multiplierInput" required 
                                               min="1" value="1" style="width: 80px;"
                                               oninput="updateMultiplierSlider(); updateProductionPreview();">
                                    </div>
                                    <small style="color: var(--gray);">1 batch = quantit√© de base de la recette</small>
                                </div>
                            </div>
                            
                            <!-- Informations optionnelles -->
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Op√©rateur (optionnel)</label>
                                    <select name="operator">
                                        <option value="">Qui produit ?</option>
                                        ${(appState.data.staff || []).filter(s => s.active).map(s => `
                                            <option value="${s.name}">${s.name} (${s.role})</option>
                                        `).join('')}
                                    </select>
                                    <small style="color: var(--gray);">Responsable de cette production (optionnel, tra√ßabilit√© HACCP)</small>
                                </div>
                                <div class="form-group">
                                    <label>Notes</label>
                                    <input type="text" name="notes" placeholder="Notes de production">
                                </div>
                            </div>
                            
                            <hr style="margin: var(--space-lg) 0;">
                            
                            <!-- Pr√©visualisation -->
                            <div id="productionPreview">
                                <p style="text-align: center; color: var(--gray);">
                                    S√©lectionnez une recette pour voir la pr√©visualisation
                                </p>
                            </div>
                            
                            <!-- Boutons -->
                            <div style="display: flex; gap: var(--space-md); margin-top: var(--space-xl);">
                                <button type="button" class="btn" style="flex: 1; background: var(--gray); color: white;" onclick="closeModal('newProductionModal')">
                                    Annuler
                                </button>
                                <button type="submit" class="btn btn-primary" style="flex: 1;" id="produceButton" disabled>
                                    ‚öôÔ∏è Produire
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            document.getElementById('newProductionForm').addEventListener('submit', handleNewProduction);
        };
        
        // Update multiplier value from slider
        window.updateMultiplierValue = function() {
            const slider = document.getElementById('multiplierSlider');
            const input = document.getElementById('multiplierInput');
            input.value = slider.value;
        };
        
        // Update multiplier slider from input
        window.updateMultiplierSlider = function() {
            const slider = document.getElementById('multiplierSlider');
            const input = document.getElementById('multiplierInput');
            const value = Math.max(1, Math.min(100, Number(input.value) || 1));
            input.value = value;
            if (value <= 10) {
                slider.value = value;
            }
        };
        
        // Update production preview
        window.updateProductionPreview = function() {
            const recipeId = document.getElementById('productionRecipeSelect').value;
            const multiplier = Number(document.getElementById('multiplierInput').value) || 1;
            const preview = document.getElementById('productionPreview');
            const produceBtn = document.getElementById('produceButton');
            
            if (!recipeId) {
                preview.innerHTML = `
                    <p style="text-align: center; color: var(--gray);">
                        S√©lectionnez une recette pour voir la pr√©visualisation
                    </p>
                `;
                produceBtn.disabled = true;
                return;
            }
            
            const recipe = appState.data.recipes.find(r => r.id === recipeId);
            const ingredients = appState.data.ingredients || [];
            
            if (!recipe) {
                preview.innerHTML = '<p style="color: var(--danger);">‚ùå Recette introuvable</p>';
                produceBtn.disabled = true;
                return;
            }
            
            // Calculer capacit√©
            const capacity = RecipeService.calculateCapacity(recipe, ingredients);
            const canProduce = capacity.batches >= multiplier;
            
            // Calculer quantit√© totale produite
            const totalProduced = recipe.producedQty * multiplier;
            
            // Calculer co√ªt estim√©
            let totalCost = 0;
            const ingredientsList = recipe.ingredients.map(recipeIng => {
                const ing = ingredients.find(i => i.id === recipeIng.ingredientId);
                if (!ing) {
                    return {
                        name: recipeIng.ingredientName,
                        needed: recipeIng.baseQty * multiplier,
                        available: 0,
                        unit: recipeIng.baseUnit,
                        sufficient: false,
                        cost: 0
                    };
                }
                
                const needed = recipeIng.baseQty * multiplier;
                const available = ing.getBaseQtyRemaining ? ing.getBaseQtyRemaining() : 0;
                const costPerUnit = ing.getPricePerBaseUnit ? ing.getPricePerBaseUnit() : 0;
                const cost = needed * costPerUnit;
                totalCost += cost;
                
                return {
                    name: recipeIng.ingredientName,
                    needed,
                    available,
                    unit: recipeIng.baseUnit,
                    sufficient: available >= needed,
                    cost
                };
            });
            
            const unitCost = totalProduced > 0 ? totalCost / totalProduced : 0;
            
            // Afficher pr√©visualisation
            preview.innerHTML = `
                <div style="background: var(--light); padding: var(--space-md); border-radius: var(--radius-md); margin-bottom: var(--space-md);">
                    <h3 style="margin-bottom: var(--space-md);">üìä R√©sum√© Production</h3>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--space-md);">
                        <div>
                            <strong>Recette :</strong><br>
                            ${recipe.name}
                        </div>
                        <div>
                            <strong>Quantit√© produite :</strong><br>
                            ${totalProduced} ${recipe.producedUnit}
                        </div>
                        <div>
                            <strong>Multiplicateur :</strong><br>
                            √ó${multiplier} batch${multiplier > 1 ? 'es' : ''}
                        </div>
                        <div>
                            <strong>Co√ªt total :</strong><br>
                            ${formatCurrency(totalCost)}
                        </div>
                        <div>
                            <strong>Co√ªt unitaire :</strong><br>
                            ${formatCurrency(unitCost)}
                        </div>
                        <div>
                            <strong>Capacit√© max :</strong><br>
                            ${capacity.batches} batch${capacity.batches > 1 ? 'es' : ''}
                        </div>
                    </div>
                </div>
                
                <h3 style="margin-bottom: var(--space-md);">üì¶ Ingr√©dients n√©cessaires</h3>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead style="background: var(--light);">
                            <tr>
                                <th style="padding: 12px; text-align: left;">Ingr√©dient</th>
                                <th style="padding: 12px; text-align: right;">N√©cessaire</th>
                                <th style="padding: 12px; text-align: right;">Disponible</th>
                                <th style="padding: 12px; text-align: right;">Statut</th>
                                <th style="padding: 12px; text-align: right;">Co√ªt</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${ingredientsList.map(item => `
                                <tr style="border-bottom: 1px solid var(--light);">
                                    <td style="padding: 12px;">${item.name}</td>
                                    <td style="padding: 12px; text-align: right; font-weight: 600;">
                                        ${item.needed} ${item.unit}
                                    </td>
                                    <td style="padding: 12px; text-align: right; color: ${item.sufficient ? 'var(--success)' : 'var(--danger)'};">
                                        ${item.available} ${item.unit}
                                    </td>
                                    <td style="padding: 12px; text-align: right;">
                                        ${item.sufficient ? '‚úÖ OK' : '‚ö†Ô∏è INSUFFISANT'}
                                    </td>
                                    <td style="padding: 12px; text-align: right;">
                                        ${formatCurrency(item.cost)}
                                    </td>
                                </tr>
                            `).join('')}
                            <tr style="border-top: 2px solid var(--primary); font-weight: 600;">
                                <td colspan="4" style="padding: 12px; text-align: right;">TOTAL :</td>
                                <td style="padding: 12px; text-align: right; color: var(--primary);">
                                    ${formatCurrency(totalCost)}
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                ${!canProduce ? `
                    <div style="background: #FFF3CD; padding: var(--space-md); border-radius: var(--radius-md); margin-top: var(--space-md); border-left: 4px solid #FFA502;">
                        <h4 style="margin-bottom: var(--space-sm); color: #856404;">‚ö†Ô∏è Stock insuffisant</h4>
                        <p style="color: #856404; margin: 0;">
                            Vous ne pouvez produire que <strong>${capacity.batches} batch${capacity.batches > 1 ? 'es' : ''}</strong> 
                            avec le stock actuel${capacity.limitingIngredient ? ` (limit√© par: ${capacity.limitingIngredient})` : ''}.
                        </p>
                    </div>
                ` : `
                    <div style="background: #d4edda; padding: var(--space-md); border-radius: var(--radius-md); margin-top: var(--space-md); border-left: 4px solid #28a745;">
                        <p style="color: #155724; margin: 0;">
                            ‚úÖ <strong>Stock suffisant</strong> pour produire ${multiplier} batch${multiplier > 1 ? 'es' : ''} !
                        </p>
                    </div>
                `}
            `;
            
            produceBtn.disabled = !canProduce;
        };
        
        // Handle new production
        async function handleNewProduction(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const recipeId = formData.get('recipeId');
            const multiplier = Number(formData.get('multiplier'));
            const operator = formData.get('operator') || '';
            const notes = formData.get('notes') || '';
            
            const recipe = appState.data.recipes.find(r => r.id === recipeId);
            if (!recipe) {
                showToast('‚ùå Recette introuvable', 'error');
                return;
            }
            
            try {
                // Produire avec RecipeService
                const result = RecipeService.produce(
                    recipe, 
                    appState.data.ingredients,
                    multiplier,
                    { operator, notes }
                );
                
                // Mettre √† jour les ingr√©dients
                result.ingredientUpdates.forEach(update => {
                    const index = appState.data.ingredients.findIndex(i => i.id === update.ingredientId);
                    if (index !== -1) {
                        appState.data.ingredients[index] = update.ingredient;
                    }
                });
                
                // Ajouter la production
                appState.data.productions.push(result.production);
                
                // Sauvegarder
                saveData();
                
                closeModal('newProductionModal');
                renderProductionsPage();
                
                showToast(`‚úÖ Production "${recipe.name}" cr√©√©e : ${result.production.producedQty} ${result.production.producedUnit}`, 'success');
                
            } catch (error) {
                console.error('Erreur production:', error);
                showToast('‚ùå Erreur: ' + error.message, 'error');
            }
        }
        
        // Show production details (placeholder)
        window.showProductionDetails = function(productionId) {
            showToast('üöß D√©tails production - En d√©veloppement', 'info');
        };

        // ========================================
        // SALES PAGE
        // ========================================
        
        function renderSalesPage() {
            const sales = appState.data.sales || [];
            const vendors = appState.data.vendors || [];
            
            // Calculate stats
            const totalRevenue = sales.reduce((sum, s) => sum + s.revenue, 0);
            const totalCOGS = sales.reduce((sum, s) => sum + s.cogs, 0);
            const totalMargin = totalRevenue - totalCOGS;
            const avgMarginPercent = totalRevenue > 0 ? (totalMargin / totalRevenue) * 100 : 0;
            const totalCommissions = sales.reduce((sum, s) => sum + s.commission, 0);
            
            let html = `
                <div class="page-container">
                    <div class="page-header">
                        <h1 class="page-title">üí∞ Ventes</h1>
                        <button class="btn btn-primary" onclick="showNewSaleModal()">
                            ‚ûï Nouvelle Vente
                        </button>
                    </div>
                    
                    ${sales.length === 0 ? `
                        <div class="empty-state">
                            <div class="empty-icon">üí∞</div>
                            <h3>Aucune vente</h3>
                            <p>Enregistrez votre premi√®re vente pour commencer</p>
                            <button class="btn btn-primary" onclick="showNewSaleModal()">
                                ‚ûï Nouvelle Vente
                            </button>
                        </div>
                    ` : `
                        <div class="filters-bar">
                            <input type="text" id="searchSales" placeholder="üîç Rechercher..." class="search-input">
                            <select id="filterSaleVendor" class="filter-select">
                                <option value="">Tous les vendeurs</option>
                                ${vendors.map(v => `
                                    <option value="${v.id}">${v.name}</option>
                                `).join('')}
                            </select>
                        </div>
                        
                        <div class="stats-grid" style="margin-bottom: var(--space-lg);">
                            <div class="stat-card success">
                                <div class="stat-label">Chiffre d'Affaires</div>
                                <div class="stat-value">${formatCurrency(totalRevenue)}</div>
                            </div>
                            <div class="stat-card warning">
                                <div class="stat-label">Co√ªt des Ventes</div>
                                <div class="stat-value">${formatCurrency(totalCOGS)}</div>
                            </div>
                            <div class="stat-card primary">
                                <div class="stat-label">Marge Brute</div>
                                <div class="stat-value">${formatCurrency(totalMargin)}</div>
                            </div>
                            <div class="stat-card info">
                                <div class="stat-label">Marge %</div>
                                <div class="stat-value">${avgMarginPercent.toFixed(1)}%</div>
                            </div>
                            <div class="stat-card secondary">
                                <div class="stat-label">Commissions</div>
                                <div class="stat-value">${formatCurrency(totalCommissions)}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Ventes</div>
                                <div class="stat-value">${sales.length}</div>
                            </div>
                        </div>
                        
                        <div id="salesListContainer" class="ingredients-list">
                            ${renderSaleCards(sales)}
                        </div>
                    `}
                </div>
            `;
            
            document.getElementById('mainContent').innerHTML = html;
            
            if (sales.length > 0) {
                document.getElementById('searchSales')?.addEventListener('input', filterSales);
                document.getElementById('filterSaleVendor')?.addEventListener('change', filterSales);
            }
        }
        
        // Render sale cards
        function renderSaleCards(sales) {
            return sales.map(sale => {
                const saleDate = sale.saleDate instanceof Date ? sale.saleDate : new Date(sale.saleDate);
                const marginPercent = sale.marginPercent || 0;
                const marginStatus = marginPercent > 30 ? 'success' : (marginPercent > 15 ? 'warning' : 'danger');
                
                return `
                    <div class="ingredient-card">
                        <div class="ingredient-header">
                            <div>
                                <h3 class="ingredient-name">Vente #${sale.id.substring(0, 8)}</h3>
                                <p class="ingredient-meta">
                                    ${formatDateFR(saleDate)}
                                    ${sale.vendorName ? ` ‚Ä¢ ${sale.vendorName}` : ''}
                                    ‚Ä¢ ${sale.items?.length || 0} produit${(sale.items?.length || 0) > 1 ? 's' : ''}
                                </p>
                            </div>
                            <div class="ingredient-stock ${marginStatus}">
                                ${formatCurrency(sale.revenue)}
                            </div>
                        </div>
                        
                        <div class="ingredient-stats">
                            <div class="stat-item">
                                <span class="stat-label">CA</span>
                                <span class="stat-value">${formatCurrency(sale.revenue)}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">COGS</span>
                                <span class="stat-value">${formatCurrency(sale.cogs)}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Marge</span>
                                <span class="stat-value">${formatCurrency(sale.margin)}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Marge %</span>
                                <span class="stat-value">${marginPercent.toFixed(1)}%</span>
                            </div>
                            ${sale.commission > 0 ? `
                                <div class="stat-item">
                                    <span class="stat-label">Commission</span>
                                    <span class="stat-value">${formatCurrency(sale.commission)}</span>
                                </div>
                            ` : ''}
                        </div>
                        
                        ${sale.items && sale.items.length > 0 ? `
                            <div style="margin-top: var(--space-md); padding-top: var(--space-md); border-top: 1px solid var(--light);">
                                <strong>Produits vendus :</strong>
                                <ul style="margin: var(--space-sm) 0 0 var(--space-md); padding: 0;">
                                    ${sale.items.map(item => `
                                        <li>${item.quantity} ${item.unit} ${item.itemName} @ ${formatCurrency(item.unitPrice)}</li>
                                    `).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        
                        <div class="ingredient-actions">
                            <button class="action-btn" onclick="showSaleDetails('${sale.id}')" title="D√©tails">üëÅÔ∏è</button>
                            <button class="action-btn" onclick="alert('Annuler - Bient√¥t')" title="Annuler">‚ùå</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Filter sales
        function filterSales() {
            const searchTerm = document.getElementById('searchSales').value.toLowerCase();
            const vendorFilter = document.getElementById('filterSaleVendor').value;
            
            let filtered = appState.data.sales || [];
            
            if (searchTerm) {
                filtered = filtered.filter(s => 
                    s.id.toLowerCase().includes(searchTerm) ||
                    s.vendorName.toLowerCase().includes(searchTerm) ||
                    s.items.some(item => item.itemName.toLowerCase().includes(searchTerm))
                );
            }
            
            if (vendorFilter) {
                filtered = filtered.filter(s => s.vendorId === vendorFilter);
            }
            
            document.getElementById('salesListContainer').innerHTML = renderSaleCards(filtered);
        }
        
        // Show new sale modal
        window.showNewSaleModal = function() {
            const productions = appState.data.productions?.filter(p => p.remainingQty > 0) || [];
            const packs = appState.data.packs?.filter(p => p.active) || [];
            const vendors = appState.data.vendors || [];
            
            if (productions.length === 0 && packs.length === 0) {
                showToast('‚ùå Aucun produit disponible. Cr√©ez une production ou un pack.', 'error');
                return;
            }
            
            const modal = document.createElement('div');
            modal.id = 'newSaleModal';
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 900px;">
                    <div class="modal-header">
                        <h2>üí∞ Nouvelle Vente</h2>
                        <button class="modal-close" onclick="closeModal('newSaleModal')">‚úï</button>
                    </div>
                    <div class="modal-body">
                        <form id="newSaleForm">
                            <!-- Product selection (Packs + Productions) -->
                            <div class="form-group">
                                <label>Produit *</label>
                                <select id="saleProductSelect" required>
                                    <option value="">S√©lectionner un produit...</option>
                                    ${packs.length > 0 ? `
                                        <optgroup label="üéÅ Packs">
                                            ${packs.map(pack => {
                                                const recipes = appState.data.recipes || [];
                                                const ingredients = appState.data.ingredients || [];
                                                const settings = appState.data.settings || { overheadCoefficient: 1.0 };
                                                const costResult = pack.getCost(recipes, ingredients, settings);
                                                const cost = typeof costResult === 'object' ? costResult.total : costResult;
                                                const hasStock = pack.hasStock(productions, 1);
                                                return `
                                                    <option value="pack_${pack.id}" 
                                                            data-type="pack"
                                                            data-name="${pack.name}" 
                                                            data-unit="pack" 
                                                            data-cost-per-unit="${cost}" 
                                                            data-price="${pack.price}"
                                                            data-remaining="999"
                                                            ${!hasStock ? 'disabled' : ''}>
                                                        ${pack.name} - ${formatCurrency(pack.price)} ${!hasStock ? '(Rupture stock)' : ''}
                                                    </option>
                                                `;
                                            }).join('')}
                                        </optgroup>
                                    ` : ''}
                                    ${productions.length > 0 ? `
                                        <optgroup label="‚öôÔ∏è Productions">
                                            ${productions.map(p => `
                                                <option value="prod_${p.id}" 
                                                        data-type="production"
                                                        data-recipe-id="${p.recipeId}" 
                                                        data-name="${p.recipeName}" 
                                                        data-unit="${p.producedUnit}" 
                                                        data-cost-per-unit="${p.costPerUnit}" 
                                                        data-remaining="${p.remainingQty}">
                                                    ${p.recipeName} (${p.remainingQty} ${p.producedUnit} dispo)
                                                </option>
                                            `).join('')}
                                        </optgroup>
                                    ` : ''}
                                </select>
                            </div>
                            
                            <!-- Quantity and price -->
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Quantit√© *</label>
                                    <input type="number" id="saleQuantity" required min="0.1" step="0.1" 
                                           placeholder="Quantit√©" oninput="updateSalePreview()">
                                    <small id="stockAvailable" style="color: var(--gray);"></small>
                                </div>
                                <div class="form-group">
                                    <label>Prix unitaire (EUR/‚Ç¨) *</label>
                                    <input type="number" id="saleUnitPrice" required min="0" step="1" 
                                           placeholder="Prix de vente" oninput="updateSalePreview()">
                                    <small id="suggestedPrice" style="color: var(--info);"></small>
                                </div>
                            </div>
                            
                            <!-- Vendor selection -->
                            <div class="form-group">
                                <label>Vendeur</label>
                                <select id="saleVendorSelect" onchange="updateSalePreview()">
                                    <option value="">Aucun vendeur</option>
                                    ${vendors.map(v => `
                                        <option value="${v.id}" data-commission="${v.commissionRate}" data-name="${v.name}">
                                            ${v.name} (${v.commissionRate}% commission)
                                        </option>
                                    `).join('')}
                                </select>
                            </div>
                            
                            <!-- Notes -->
                            <div class="form-group">
                                <label>Notes</label>
                                <textarea id="saleNotes" rows="2" placeholder="Notes de vente (optionnel)"></textarea>
                            </div>
                            
                            <hr style="margin: var(--space-lg) 0;">
                            
                            <!-- Preview -->
                            <div id="salePreview">
                                <p style="text-align: center; color: var(--gray);">
                                    Remplissez les champs pour voir le r√©capitulatif
                                </p>
                            </div>
                            
                            <!-- Buttons -->
                            <div style="display: flex; gap: var(--space-md); margin-top: var(--space-xl);">
                                <button type="button" class="btn" style="flex: 1; background: var(--gray); color: white;" 
                                        onclick="closeModal('newSaleModal')">
                                    Annuler
                                </button>
                                <button type="submit" class="btn btn-primary" style="flex: 1;" id="sellButton" disabled>
                                    üí∞ Vendre
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Event listeners
            document.getElementById('saleProductSelect').addEventListener('change', updateSalePreview);
            document.getElementById('newSaleForm').addEventListener('submit', handleNewSale);
            
            updateSalePreview();
        };
        
        // Update sale preview
        window.updateSalePreview = function() {
            const productSelect = document.getElementById('saleProductSelect');
            const quantity = Number(document.getElementById('saleQuantity').value) || 0;
            const unitPriceInput = document.getElementById('saleUnitPrice');
            const unitPrice = Number(unitPriceInput.value) || 0;
            const vendorSelect = document.getElementById('saleVendorSelect');
            const preview = document.getElementById('salePreview');
            const sellButton = document.getElementById('sellButton');
            
            const selectedOption = productSelect.options[productSelect.selectedIndex];
            const productId = productSelect.value;
            
            if (!productId) {
                preview.innerHTML = `
                    <p style="text-align: center; color: var(--gray);">
                        S√©lectionnez un produit pour voir le r√©capitulatif
                    </p>
                `;
                sellButton.disabled = true;
                return;
            }
            
            const productType = selectedOption.getAttribute('data-type') || 'production';
            const productName = selectedOption.getAttribute('data-name') || selectedOption.getAttribute('data-recipe-name');
            const unit = selectedOption.getAttribute('data-unit');
            const costPerUnit = Number(selectedOption.getAttribute('data-cost-per-unit'));
            const remaining = Number(selectedOption.getAttribute('data-remaining'));
            
            // Pour les packs, pr√©-remplir le prix si vide
            if (productType === 'pack' && !unitPriceInput.value) {
                const packPrice = Number(selectedOption.getAttribute('data-price'));
                if (packPrice > 0) {
                    unitPriceInput.value = packPrice;
                }
            }
            
            // Update stock available message
            if (productType === 'pack') {
                document.getElementById('stockAvailable').textContent = `Pack disponible en stock`;
            } else {
                document.getElementById('stockAvailable').textContent = `Stock disponible: ${remaining} ${unit}`;
            }
            
            // Suggested price (cost + 50% margin)
            const suggestedPrice = Math.round(costPerUnit * 1.5);
            document.getElementById('suggestedPrice').textContent = `Prix sugg√©r√© (marge 50%): ${formatCurrency(suggestedPrice)}`;
            
            // Calculate totals
            const unitPriceValue = Number(unitPriceInput.value) || 0;
            const revenue = quantity * unitPriceValue;
            const cogs = quantity * costPerUnit;
            const margin = revenue - cogs;
            const marginPercent = revenue > 0 ? (margin / revenue) * 100 : 0;
            
            // Commission
            let commissionRate = 0;
            let commission = 0;
            let vendorName = '';
            if (vendorSelect.value) {
                const vendorOption = vendorSelect.options[vendorSelect.selectedIndex];
                commissionRate = Number(vendorOption.getAttribute('data-commission')) || 0;
                commission = (revenue * commissionRate) / 100;
                vendorName = vendorOption.getAttribute('data-name');
            }
            
            // Check stock (packs always available, productions check remaining)
            const canSell = quantity > 0 && unitPriceValue > 0 && 
                           (productType === 'pack' || quantity <= remaining);
            
            // Display preview
            preview.innerHTML = `
                <div style="background: var(--light); padding: var(--space-md); border-radius: var(--radius-md); margin-bottom: var(--space-md);">
                    <h3 style="margin-bottom: var(--space-md);">üìä R√©capitulatif Vente</h3>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-md);">
                        <div>
                            <strong>Produit :</strong><br>
                            ${productName}
                        </div>
                        <div>
                            <strong>Quantit√© :</strong><br>
                            ${quantity} ${unit}
                        </div>
                        <div>
                            <strong>Prix unitaire :</strong><br>
                            ${formatCurrency(unitPrice)}
                        </div>
                        <div>
                            <strong>Chiffre d'Affaires :</strong><br>
                            <span style="color: var(--success); font-weight: 600;">${formatCurrency(revenue)}</span>
                        </div>
                        <div>
                            <strong>Co√ªt de revient :</strong><br>
                            ${formatCurrency(cogs)}
                        </div>
                        <div>
                            <strong>Marge brute :</strong><br>
                            <span style="color: ${margin > 0 ? 'var(--success)' : 'var(--danger)'}; font-weight: 600;">
                                ${formatCurrency(margin)} (${marginPercent.toFixed(1)}%)
                            </span>
                        </div>
                        ${vendorName ? `
                            <div>
                                <strong>Vendeur :</strong><br>
                                ${vendorName}
                            </div>
                            <div>
                                <strong>Commission (${commissionRate}%) :</strong><br>
                                ${formatCurrency(commission)}
                            </div>
                        ` : ''}
                    </div>
                </div>
                
                ${!canSell ? `
                    <div style="background: #FFF3CD; padding: var(--space-md); border-radius: var(--radius-md); border-left: 4px solid #FFA502;">
                        <h4 style="margin-bottom: var(--space-sm); color: #856404;">‚ö†Ô∏è V√©rification</h4>
                        ${quantity === 0 ? '<p style="color: #856404; margin: 0;">Entrez une quantit√©</p>' : ''}
                        ${quantity > remaining ? `<p style="color: #856404; margin: 0;">Stock insuffisant (dispo: ${remaining} ${unit})</p>` : ''}
                        ${unitPrice === 0 ? '<p style="color: #856404; margin: 0;">Entrez un prix de vente</p>' : ''}
                    </div>
                ` : `
                    <div style="background: #d4edda; padding: var(--space-md); border-radius: var(--radius-md); border-left: 4px solid #28a745;">
                        <p style="color: #155724; margin: 0;">
                            ‚úÖ <strong>Pr√™t √† vendre</strong> !
                        </p>
                    </div>
                `}
            `;
            
            sellButton.disabled = !canSell;
        };
        
        // Handle new sale
        async function handleNewSale(e) {
            e.preventDefault();
            
            const productSelect = document.getElementById('saleProductSelect');
            const selectedOption = productSelect.options[productSelect.selectedIndex];
            
            const recipeId = selectedOption.getAttribute('data-recipe-id');
            const recipeName = selectedOption.getAttribute('data-recipe-name');
            const unit = selectedOption.getAttribute('data-unit');
            const quantity = Number(document.getElementById('saleQuantity').value);
            const unitPrice = Number(document.getElementById('saleUnitPrice').value);
            
            const vendorSelect = document.getElementById('saleVendorSelect');
            let vendorId = null;
            let vendorName = '';
            let commissionRate = 0;
            
            if (vendorSelect.value) {
                const vendorOption = vendorSelect.options[vendorSelect.selectedIndex];
                vendorId = vendorSelect.value;
                vendorName = vendorOption.getAttribute('data-name');
                commissionRate = Number(vendorOption.getAttribute('data-commission')) || 0;
            }
            
            const notes = document.getElementById('saleNotes').value;
            
            // Double-check stock availability
            const remaining = Number(selectedOption.getAttribute('data-remaining'));
            if (quantity > remaining) {
                showToast(`‚ùå Stock insuffisant ! Disponible: ${remaining} ${unit}, Demand√©: ${quantity} ${unit}`, 'error');
                return;
            }
            
            if (quantity <= 0) {
                showToast('‚ùå Quantit√© invalide', 'error');
                return;
            }
            
            if (unitPrice <= 0) {
                showToast('‚ùå Prix invalide', 'error');
                return;
            }
            
            try {
                // Prepare sale data
                const saleData = {
                    items: [{
                        type: 'recipe',
                        itemId: recipeId,
                        itemName: recipeName,
                        quantity,
                        unit,
                        unitPrice
                    }],
                    vendorId,
                    vendorName,
                    commissionRate,
                    notes,
                    saleDate: new Date()
                };
                
                // Find vendor if selected
                const vendor = vendorId ? appState.data.vendors.find(v => v.id === vendorId) : null;
                
                // Create sale using SaleService
                const result = SaleService.create(saleData, appState.data.productions, vendor);
                
                // Update productions
                result.productionUpdates.forEach(update => {
                    const index = appState.data.productions.findIndex(p => p.id === update.productionId);
                    if (index !== -1) {
                        appState.data.productions[index] = update.production;
                    }
                });
                
                // Add sale
                appState.data.sales.push(result.sale);
                
                // Save
                saveData();
                
                closeModal('newSaleModal');
                renderSalesPage();
                
                showToast(`‚úÖ Vente enregistr√©e : ${formatCurrency(result.sale.revenue)} (marge: ${result.sale.marginPercent.toFixed(1)}%)`, 'success');
                
            } catch (error) {
                console.error('Erreur vente:', error);
                showToast('‚ùå Erreur: ' + error.message, 'error');
            }
        }
        
        // Show sale details (placeholder)
        window.showSaleDetails = function(saleId) {
            showToast('üöß D√©tails vente - En d√©veloppement', 'info');
        };

        // ========================================
        // PERSONNEL PAGE
        // ========================================
        
        function renderPersonnelPage() {
            const staff = appState.data.staff || [];
            
            let html = `
                <div class="page-container">
                    <div class="page-header">
                        <h1 class="page-title">üë• Personnel</h1>
                        <button class="btn btn-primary" onclick="showNewStaffModal()">‚ûï Ajouter Membre</button>
                    </div>
                    ${staff.length === 0 ? `
                        <div class="empty-state">
                            <div class="empty-icon">üë•</div>
                            <h3>Aucun membre du personnel</h3>
                            <p>Ajoutez les membres de votre √©quipe</p>
                            <button class="btn btn-primary" onclick="showNewStaffModal()">‚ûï Ajouter Membre</button>
                        </div>
                    ` : `
                        <div class="stats-grid" style="margin-bottom: var(--space-lg);">
                            <div class="stat-card primary">
                                <div class="stat-label">Total Personnel</div>
                                <div class="stat-value">${staff.length}</div>
                            </div>
                            <div class="stat-card success">
                                <div class="stat-label">Actifs</div>
                                <div class="stat-value">${staff.filter(s => s.active).length}</div>
                            </div>
                        </div>
                        <div class="ingredients-list">
                            ${staff.map(member => `
                                <div class="ingredient-card">
                                    <div class="ingredient-header">
                                        <div>
                                            <h3 class="ingredient-name">${member.name}</h3>
                                            <p class="ingredient-meta">${member.role}${member.phone ? ' ‚Ä¢ ' + member.phone : ''}</p>
                                        </div>
                                        <div class="ingredient-stock ${member.active ? 'success' : 'danger'}">
                                            ${member.active ? 'Actif' : 'Inactif'}
                                        </div>
                                    </div>
                                    <div class="ingredient-actions">
                                        <button class="action-btn" onclick="editStaffMember('${member.id}')" title="Modifier">‚úèÔ∏è</button>
                                        <button class="action-btn" onclick="deleteStaffMember('${member.id}')" title="Supprimer">üóëÔ∏è</button>
                                        <button class="action-btn" onclick="toggleStaffStatus('${member.id}')" title="${member.active ? 'D√©sactiver' : 'Activer'}">
                                            ${member.active ? 'üî¥' : 'üü¢'}
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `}
                </div>
            `;
            document.getElementById('mainContent').innerHTML = html;
        }
        
        window.showNewStaffModal = function() {
            const modal = document.createElement('div');
            modal.id = 'newStaffModal';
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>üë• Nouveau Membre</h2>
                        <button class="modal-close" onclick="closeModal('newStaffModal')">‚úï</button>
                    </div>
                    <div class="modal-body">
                        <form id="newStaffForm">
                            <div class="form-group">
                                <label>Nom complet *</label>
                                <input type="text" id="staffName" required>
                            </div>
                            <div class="form-group">
                                <label>R√¥le *</label>
                                <select id="staffRole" required>
                                    <option value="">S√©lectionner...</option>
                                    <option value="Chef">Chef</option>
                                    <option value="P√¢tissier">P√¢tissier</option>
                                    <option value="Vendeur">Vendeur</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>T√©l√©phone</label>
                                <input type="tel" id="staffPhone">
                            </div>
                            <div style="display: flex; gap: var(--space-md); margin-top: var(--space-xl);">
                                <button type="button" class="btn" style="flex: 1;" onclick="closeModal('newStaffModal')">Annuler</button>
                                <button type="submit" class="btn btn-primary" style="flex: 1;">‚ûï Ajouter</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            document.getElementById('newStaffForm').addEventListener('submit', handleNewStaff);
        };
        
        function handleNewStaff(e) {
            e.preventDefault();
            const newMember = {
                id: 'staff_' + Date.now(),
                name: document.getElementById('staffName').value,
                role: document.getElementById('staffRole').value,
                phone: document.getElementById('staffPhone').value || '',
                active: true
            };
            appState.data.staff = appState.data.staff || [];
            appState.data.staff.push(newMember);
            saveData();
            closeModal('newStaffModal');
            renderPersonnelPage();
            showToast('‚úÖ ' + newMember.name + ' ajout√©', 'success');
        }
        
        window.editStaffMember = function(staffId) {
            const member = appState.data.staff.find(s => s.id === staffId);
            if (!member) return;
            
            const modal = document.createElement('div');
            modal.id = 'editStaffModal';
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>‚úèÔ∏è Modifier Membre</h2>
                        <button class="modal-close" onclick="closeModal('editStaffModal')">‚úï</button>
                    </div>
                    <div class="modal-body">
                        <form id="editStaffForm">
                            <div class="form-group">
                                <label>Nom complet *</label>
                                <input type="text" id="editStaffName" value="${member.name}" required>
                            </div>
                            <div class="form-group">
                                <label>R√¥le *</label>
                                <select id="editStaffRole" required>
                                    <option value="">S√©lectionner...</option>
                                    <option value="Chef" ${member.role === 'Chef' || member.role === 'Chef cuisinier' ? 'selected' : ''}>Chef</option>
                                    <option value="P√¢tissier" ${member.role === 'P√¢tissier' || member.role === 'P√¢tissi√®re' ? 'selected' : ''}>P√¢tissier</option>
                                    <option value="Vendeur" ${member.role === 'Vendeur' || member.role === 'Vendeuse' ? 'selected' : ''}>Vendeur</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>T√©l√©phone</label>
                                <input type="tel" id="editStaffPhone" value="${member.phone || ''}">
                            </div>
                            <input type="hidden" id="editStaffId" value="${member.id}">
                            <div style="display: flex; gap: var(--space-md); margin-top: var(--space-xl);">
                                <button type="button" class="btn" style="flex: 1;" onclick="closeModal('editStaffModal')">Annuler</button>
                                <button type="submit" class="btn btn-primary" style="flex: 1;">üíæ Enregistrer</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            document.getElementById('editStaffForm').addEventListener('submit', handleEditStaff);
        };
        
        function handleEditStaff(e) {
            e.preventDefault();
            const staffId = document.getElementById('editStaffId').value;
            const member = appState.data.staff.find(s => s.id === staffId);
            if (member) {
                member.name = document.getElementById('editStaffName').value;
                member.role = document.getElementById('editStaffRole').value;
                member.phone = document.getElementById('editStaffPhone').value || '';
                saveData();
                closeModal('editStaffModal');
                renderPersonnelPage();
                showToast('‚úÖ ' + member.name + ' modifi√©', 'success');
            }
        }
        
        window.toggleStaffStatus = function(staffId) {
            const member = appState.data.staff.find(s => s.id === staffId);
            if (member) {
                member.active = !member.active;
                saveData();
                renderPersonnelPage();
                showToast(member.name + ' ' + (member.active ? 'activ√©' : 'd√©sactiv√©'), 'info');
            }
        };
        
        window.deleteStaffMember = function(staffId) {
            const member = appState.data.staff.find(s => s.id === staffId);
            if (!member) return;
            
            if (confirm('‚ö†Ô∏è Supprimer ' + member.name + ' ?\n\nCette action est irr√©versible.')) {
                appState.data.staff = appState.data.staff.filter(s => s.id !== staffId);
                saveData();
                renderPersonnelPage();
                showToast('üóëÔ∏è ' + member.name + ' supprim√©', 'success');
            }
        };

        // ========================================
        // PACKS PAGE
        // ========================================
        
        function renderPacksPage() {
            const packs = appState.data.packs || [];
            const recipes = appState.data.recipes || [];
            const ingredients = appState.data.ingredients || [];
            const productions = appState.data.productions || [];
            const settings = appState.data.settings || { overheadCoefficient: 1.0, showDirectCost: true };
            
            let html = `
                <div class="page-container">
                    <div class="page-header">
                        <h1 class="page-title">üéÅ Packs</h1>
                        <button class="btn btn-primary" onclick="showNewPackModal()">‚ûï Cr√©er Pack</button>
                    </div>
                    ${packs.length === 0 ? `
                        <div class="empty-state">
                            <div class="empty-icon">üéÅ</div>
                            <h3>Aucun pack</h3>
                            <p>Cr√©ez des packs de produits pour vendre plusieurs articles ensemble</p>
                        </div>
                    ` : `
                        <div class="stats-grid" style="margin-bottom: var(--space-lg);">
                            <div class="stat-card primary">
                                <div class="stat-label">Total Packs</div>
                                <div class="stat-value">${packs.length}</div>
                            </div>
                            <div class="stat-card success">
                                <div class="stat-label">Actifs</div>
                                <div class="stat-value">${packs.filter(p => p.active).length}</div>
                            </div>
                        </div>
                        <div class="ingredients-list">
                            ${packs.map(pack => {
                                const costResult = pack.getCost ? pack.getCost(recipes, ingredients, settings) : 0;
                                
                                // G√©rer co√ªt simple ou d√©taill√©
                                let cost, directCost, coefficient;
                                if (typeof costResult === 'object' && costResult.total !== undefined) {
                                    cost = costResult.total;
                                    directCost = costResult.direct;
                                    coefficient = costResult.coefficient;
                                } else {
                                    cost = costResult;
                                    directCost = costResult;
                                    coefficient = 1.0;
                                }
                                
                                const margin = pack.price - cost;
                                const marginPercent = pack.price > 0 ? (margin / pack.price) * 100 : 0;
                                const hasStock = pack.hasStock ? pack.hasStock(productions, 1) : false;
                                
                                // üõ°Ô∏è INDICATEURS RENTABILIT√â
                                let profitBadge = '';
                                let cardClass = 'ingredient-card';
                                
                                if (margin < 0) {
                                    // PERTE
                                    profitBadge = '<span style="background: var(--danger); color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">üî¥ PERTE</span>';
                                    cardClass += ' loss-warning';
                                } else if (marginPercent < 10) {
                                    // FAIBLE MARGE
                                    profitBadge = '<span style="background: var(--warning); color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">üü° FAIBLE MARGE</span>';
                                } else {
                                    // RENTABLE
                                    profitBadge = '<span style="background: var(--success); color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">üü¢ RENTABLE</span>';
                                }
                                
                                return `
                                    <div class="${cardClass}">
                                        <div class="ingredient-header">
                                            <div>
                                                <h3 class="ingredient-name">${pack.name} ${profitBadge}</h3>
                                                <p class="ingredient-meta">
                                                    ${pack.items ? pack.items.length : 0} produit${(pack.items && pack.items.length > 1) ? 's' : ''}
                                                    ${pack.description ? ' ‚Ä¢ ' + pack.description : ''}
                                                </p>
                                            </div>
                                            <div class="ingredient-stock ${pack.active && hasStock ? 'success' : 'danger'}">
                                                ${formatCurrency(pack.price)}
                                            </div>
                                        </div>
                                        <div class="ingredient-stats">
                                            <div class="stat-item">
                                                <span class="stat-label">Prix</span>
                                                <span class="stat-value">${formatCurrency(pack.price)}</span>
                                            </div>
                                            ${settings.showDirectCost && directCost !== cost ? `
                                                <div class="stat-item">
                                                    <span class="stat-label">Co√ªt direct</span>
                                                    <span class="stat-value" style="font-size: 0.9em; color: var(--gray);">${formatCurrency(directCost)}</span>
                                                </div>
                                                <div class="stat-item">
                                                    <span class="stat-label">Co√ªt total (√ó${coefficient.toFixed(2)})</span>
                                                    <span class="stat-value">${formatCurrency(cost)}</span>
                                                </div>
                                            ` : `
                                                <div class="stat-item">
                                                    <span class="stat-label">Co√ªt</span>
                                                    <span class="stat-value">${formatCurrency(cost)}</span>
                                                </div>
                                            `}
                                            <div class="stat-item">
                                                <span class="stat-label">Marge</span>
                                                <span class="stat-value" style="color: ${margin < 0 ? 'var(--danger)' : 'var(--success)'}">
                                                    ${margin < 0 ? '-' : '+'}${formatCurrency(Math.abs(margin))}
                                                </span>
                                            </div>
                                            <div class="stat-item">
                                                <span class="stat-label">Marge %</span>
                                                <span class="stat-value" style="color: ${marginPercent < 0 ? 'var(--danger)' : marginPercent < 10 ? 'var(--warning)' : 'var(--success)'}; font-weight: 700;">
                                                    ${marginPercent.toFixed(1)}%
                                                </span>
                                            </div>
                                            <div class="stat-item">
                                                <span class="stat-label">Stock</span>
                                                <span class="stat-value">${hasStock ? '‚úÖ Dispo' : '‚ùå Rupture'}</span>
                                            </div>
                                        </div>
                                        <div style="margin-top: var(--space-md); padding-top: var(--space-md); border-top: 1px solid var(--light);">
                                            <strong>Contenu :</strong>
                                            <ul style="margin: var(--space-sm) 0 0 var(--space-md); padding: 0;">
                                                ${pack.items ? pack.items.map(item => `
                                                    <li>${item.quantity} ${item.unit} ${item.productionName}</li>
                                                `).join('') : ''}
                                            </ul>
                                        </div>
                                        <div class="ingredient-actions">
                                            <button class="action-btn" onclick="editPack('${pack.id}')" title="Modifier">‚úèÔ∏è</button>
                                            <button class="action-btn" onclick="deletePack('${pack.id}')" title="Supprimer">üóëÔ∏è</button>
                                            <button class="action-btn" onclick="togglePackStatus('${pack.id}')" title="${pack.active ? 'D√©sactiver' : 'Activer'}">
                                                ${pack.active ? 'üî¥' : 'üü¢'}
                                            </button>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `}
                </div>
            `;
            document.getElementById('mainContent').innerHTML = html;
        }
        
        window.showNewPackModal = function() {
            const recipes = appState.data.recipes || [];
            if (recipes.length === 0) {
                showToast('‚ùå Cr√©ez d\'abord des recettes', 'error');
                return;
            }
            
            const modal = document.createElement('div');
            modal.id = 'newPackModal';
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 900px;">
                    <div class="modal-header">
                        <h2>üéÅ Cr√©er Pack</h2>
                        <button class="modal-close" onclick="closeModal('newPackModal')">‚úï</button>
                    </div>
                    <div class="modal-body">
                        <form id="newPackForm">
                            <div class="form-group">
                                <label>Nom du pack *</label>
                                <input type="text" id="packName" required placeholder="Ex: Pack Petit-D√©jeuner">
                            </div>
                            <div class="form-group">
                                <label>Description</label>
                                <textarea id="packDescription" rows="2" placeholder="Description du pack"></textarea>
                            </div>
                            <h3 style="margin-top: var(--space-lg);">Produits inclus</h3>
                            <div id="packItemsContainer">
                                <div class="pack-item-row" data-index="0">
                                    <div class="form-row" style="align-items: flex-end;">
                                        <div class="form-group" style="flex: 2;">
                                            <label>Produit</label>
                                            <select class="pack-item-product" required>
                                                <option value="">S√©lectionner...</option>
                                                ${recipes.map(r => `
                                                    <option value="${r.id}" data-name="${r.name}" data-unit="${r.producedUnit}">
                                                        ${r.name}
                                                    </option>
                                                `).join('')}
                                            </select>
                                        </div>
                                        <div class="form-group" style="flex: 1;">
                                            <label>Quantit√©</label>
                                            <input type="number" class="pack-item-quantity" required min="1" step="1" value="1">
                                        </div>
                                        <button type="button" class="btn" style="background: var(--danger);" onclick="removePackItem(0)">‚ùå</button>
                                    </div>
                                </div>
                            </div>
                            <button type="button" class="btn" onclick="addPackItem(); updateSuggestedPackPrice();" style="margin-top: var(--space-md);">
                                ‚ûï Ajouter Produit
                            </button>
                            <div style="margin-top: var(--space-lg); padding: var(--space-md); background: var(--light); border-radius: var(--radius-md);">
                                <div class="form-row">
                                    <div class="form-group" style="flex: 1;">
                                        <label>Prix de vente (EUR/‚Ç¨) *</label>
                                        <input type="number" id="packPrice" required min="0" step="0.01" placeholder="0.00" oninput="checkPackProfitability()">
                                        <div id="profitabilityIndicator" style="margin-top: var(--space-xs); font-size: 0.875rem; font-weight: 600;"></div>
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <label>Prix sugg√©r√© (marge 30%)</label>
                                        <div style="display: flex; align-items: center; gap: var(--space-sm);">
                                            <input type="text" id="suggestedPackPrice" value="Calculer..." readonly style="background: var(--white); cursor: not-allowed; flex: 1;">
                                            <button type="button" class="btn btn-sm" style="background: var(--success);" onclick="applySuggestedPackPrice()">Appliquer</button>
                                        </div>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-sm" style="margin-top: var(--space-sm); background: var(--info);" onclick="updateSuggestedPackPrice()">
                                    üîÑ Recalculer prix sugg√©r√©
                                </button>
                            </div>
                            <div style="display: flex; gap: var(--space-md); margin-top: var(--space-xl);">
                                <button type="button" class="btn" style="flex: 1;" onclick="closeModal('newPackModal')">Annuler</button>
                                <button type="submit" class="btn btn-primary" style="flex: 1;">üéÅ Cr√©er Pack</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            document.getElementById('newPackForm').addEventListener('submit', handleNewPack);
        };
        
        let packItemIndex = 1;
        window.addPackItem = function() {
            const recipes = appState.data.recipes || [];
            const container = document.getElementById('packItemsContainer');
            const newRow = document.createElement('div');
            newRow.className = 'pack-item-row';
            newRow.setAttribute('data-index', packItemIndex);
            newRow.innerHTML = `
                <div class="form-row" style="align-items: flex-end;">
                    <div class="form-group" style="flex: 2;">
                        <label>Produit</label>
                        <select class="pack-item-product" required>
                            <option value="">S√©lectionner...</option>
                            ${recipes.map(r => `
                                <option value="${r.id}" data-name="${r.name}" data-unit="${r.producedUnit}">
                                    ${r.name}
                                </option>
                            `).join('')}
                        </select>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>Quantit√©</label>
                        <input type="number" class="pack-item-quantity" required min="1" step="1" value="1">
                    </div>
                    <button type="button" class="btn" style="background: var(--danger);" onclick="removePackItem(${packItemIndex})">‚ùå</button>
                </div>
            `;
            container.appendChild(newRow);
            packItemIndex++;
        };
        
        window.removePackItem = function(index) {
            const row = document.querySelector('[data-index="' + index + '"]');
            if (row && document.querySelectorAll('.pack-item-row').length > 1) {
                row.remove();
                // Recalculer prix sugg√©r√© apr√®s suppression
                if (typeof updateSuggestedPackPrice === 'function') {
                    updateSuggestedPackPrice();
                }
            } else {
                showToast('‚ö†Ô∏è Un pack doit contenir au moins 1 produit', 'warning');
            }
        };
        
        // Fonction pour calculer et afficher le prix sugg√©r√©
        window.updateSuggestedPackPrice = function() {
            const recipes = appState.data.recipes || [];
            const ingredients = appState.data.ingredients || [];
            const settings = appState.data.settings || { overheadCoefficient: 1.0 };
            
            // D√©terminer quel modal est ouvert
            const suggestedPriceField = document.getElementById('suggestedPackPrice');
            if (!suggestedPriceField) return; // Pas de modal ouvert
            
            // R√©cup√©rer les items s√©lectionn√©s
            const items = [];
            const container = document.getElementById('packItemsContainer') || document.getElementById('editPackItemsContainer');
            if (!container) return;
            
            container.querySelectorAll('.pack-item-row').forEach(row => {
                const productSelect = row.querySelector('.pack-item-product');
                const quantity = Number(row.querySelector('.pack-item-quantity').value);
                if (productSelect && productSelect.value && quantity > 0) {
                    const option = productSelect.options[productSelect.selectedIndex];
                    items.push({
                        productionId: productSelect.value,
                        productionName: option.getAttribute('data-name'),
                        quantity: quantity,
                        unit: option.getAttribute('data-unit')
                    });
                }
            });
            
            if (items.length === 0) {
                suggestedPriceField.value = 'Ajouter des produits...';
                window.currentSuggestedPrice = 0;
                return;
            }
            
            // Cr√©er un pack temporaire pour calculer le co√ªt
            try {
                const tempPack = new Pack({
                    id: 'temp',
                    name: 'temp',
                    description: '',
                    items: items.map(item => new PackItem(item)),
                    price: 0,
                    active: true,
                    createdAt: new Date()
                });
                
                const suggestedPrice = tempPack.getSuggestedPrice(recipes, ingredients, 30, settings);
                const costResult = tempPack.getCost(recipes, ingredients, settings);
                
                // Affichage avec d√©tails si coefficient actif
                if (typeof costResult === 'object' && costResult.coefficient > 1) {
                    suggestedPriceField.value = formatCurrency(suggestedPrice) + 
                        ` (co√ªt: ${formatCurrency(costResult.direct)} √ó${costResult.coefficient.toFixed(2)} = ${formatCurrency(costResult.total)})`;
                } else {
                    suggestedPriceField.value = formatCurrency(suggestedPrice);
                }
                
                window.currentSuggestedPrice = suggestedPrice;
            } catch (error) {
                suggestedPriceField.value = 'Erreur calcul';
                window.currentSuggestedPrice = 0;
                console.error('Erreur calcul prix sugg√©r√©:', error);
            }
        };
        
        // Fonction pour appliquer le prix sugg√©r√©
        window.applySuggestedPackPrice = function() {
            if (window.currentSuggestedPrice && window.currentSuggestedPrice > 0) {
                // D√©terminer quel champ prix utiliser
                const priceField = document.getElementById('packPrice') || document.getElementById('editPackPrice');
                if (priceField) {
                    priceField.value = window.currentSuggestedPrice.toFixed(2);
                    showToast('‚úÖ Prix sugg√©r√© appliqu√©', 'success');
                    
                    // Mettre √† jour l'indicateur si disponible
                    if (typeof checkPackProfitability === 'function') {
                        checkPackProfitability();
                    }
                }
            } else {
                showToast('‚ö†Ô∏è Calculez d\'abord le prix sugg√©r√©', 'warning');
            }
        };
        
        // üõ°Ô∏è Fonction pour v√©rifier rentabilit√© en temps r√©el
        window.checkPackProfitability = function() {
            const indicator = document.getElementById('profitabilityIndicator');
            if (!indicator) return;
            
            const priceField = document.getElementById('packPrice');
            if (!priceField) return;
            
            const price = Number(priceField.value);
            if (!price || price <= 0) {
                indicator.innerHTML = '';
                return;
            }
            
            const recipes = appState.data.recipes || [];
            const ingredients = appState.data.ingredients || [];
            const settings = appState.data.settings || { overheadCoefficient: 1.0 };
            
            // R√©cup√©rer items actuels
            const items = [];
            const container = document.getElementById('packItemsContainer');
            if (!container) return;
            
            container.querySelectorAll('.pack-item-row').forEach(row => {
                const productSelect = row.querySelector('.pack-item-product');
                const quantity = Number(row.querySelector('.pack-item-quantity').value);
                if (productSelect && productSelect.value && quantity > 0) {
                    const option = productSelect.options[productSelect.selectedIndex];
                    items.push({
                        productionId: productSelect.value,
                        productionName: option.getAttribute('data-name'),
                        quantity: quantity,
                        unit: option.getAttribute('data-unit')
                    });
                }
            });
            
            if (items.length === 0) {
                indicator.innerHTML = '‚ö†Ô∏è Ajoutez des produits pour calculer';
                indicator.style.color = 'var(--warning)';
                return;
            }
            
            // Calculer co√ªt
            try {
                const tempPack = new Pack({
                    id: 'temp',
                    name: 'temp',
                    description: '',
                    items: items.map(item => new PackItem(item)),
                    price: price,
                    active: true,
                    createdAt: new Date()
                });
                
                const costResult = tempPack.getCost(recipes, ingredients, settings);
                const cost = typeof costResult === 'object' ? costResult.total : costResult;
                const directCost = typeof costResult === 'object' ? costResult.direct : costResult;
                const coefficient = typeof costResult === 'object' ? costResult.coefficient : 1.0;
                
                const margin = price - cost;
                const marginPercent = price > 0 ? (margin / price) * 100 : 0;
                
                // Affichage avec d√©tails coefficient
                let costInfo = '';
                if (coefficient > 1) {
                    costInfo = ` (direct: ${directCost.toFixed(2)}‚Ç¨ √ó${coefficient.toFixed(2)})`;
                }
                
                if (margin < 0) {
                    indicator.innerHTML = `üî¥ PERTE: ${Math.abs(margin).toFixed(2)} ‚Ç¨ (${Math.abs(marginPercent).toFixed(1)}%)${costInfo}`;
                    indicator.style.color = 'var(--danger)';
                } else if (marginPercent < 10) {
                    indicator.innerHTML = `üü° Marge faible: +${margin.toFixed(2)} ‚Ç¨ (${marginPercent.toFixed(1)}%)${costInfo}`;
                    indicator.style.color = 'var(--warning)';
                } else {
                    indicator.innerHTML = `üü¢ Rentable: +${margin.toFixed(2)} ‚Ç¨ (${marginPercent.toFixed(1)}%)${costInfo}`;
                    indicator.style.color = 'var(--success)';
                }
            } catch (error) {
                indicator.innerHTML = '‚ö†Ô∏è Erreur calcul';
                indicator.style.color = 'var(--danger)';
            }
        };
        
        function handleNewPack(e) {
            e.preventDefault();
            const name = document.getElementById('packName').value;
            const description = document.getElementById('packDescription').value;
            const price = Number(document.getElementById('packPrice').value);
            
            const items = [];
            document.querySelectorAll('.pack-item-row').forEach(row => {
                const productSelect = row.querySelector('.pack-item-product');
                const quantity = Number(row.querySelector('.pack-item-quantity').value);
                if (productSelect.value) {
                    const option = productSelect.options[productSelect.selectedIndex];
                    items.push({
                        productionId: productSelect.value,
                        productionName: option.getAttribute('data-name'),
                        quantity: quantity,
                        unit: option.getAttribute('data-unit')
                    });
                }
            });
            
            const recipes = appState.data.recipes || [];
            const ingredients = appState.data.ingredients || [];
            
            // Fonction pour cr√©er le pack
            function createPack(allowLoss = false) {
                try {
                    const newPack = PackService.create({
                        name,
                        description,
                        items,
                        price,
                        allowLoss
                    }, recipes, ingredients);
                    
                    appState.data.packs = appState.data.packs || [];
                    appState.data.packs.push(newPack);
                    saveData();
                    closeModal('newPackModal');
                    renderPacksPage();
                    showToast('‚úÖ Pack "' + name + '" cr√©√© !', 'success');
                } catch (error) {
                    // Si c'est une alerte de perte
                    if (error.message.includes('ALERTE PERTE')) {
                        // Afficher confirmation
                        if (confirm(
                            error.message + '\n\n' +
                            '‚ö†Ô∏è Voulez-vous cr√©er ce pack MALGR√â la perte ?\n\n' +
                            'Ceci peut √™tre justifi√© pour:\n' +
                            '‚Ä¢ Offres promotionnelles\n' +
                            '‚Ä¢ Liquidation de stock\n' +
                            '‚Ä¢ Strat√©gie commerciale sp√©cifique'
                        )) {
                            // Cr√©er avec allowLoss = true
                            createPack(true);
                        }
                    } else {
                        // Autre erreur
                        showToast('‚ùå ' + error.message, 'error');
                    }
                }
            }
            
            // Lancer la cr√©ation
            createPack(false);
        }
        
        window.togglePackStatus = function(packId) {
            const pack = appState.data.packs.find(p => p.id === packId);
            if (pack) {
                pack.active = !pack.active;
                saveData();
                renderPacksPage();
                showToast('Pack ' + (pack.active ? 'activ√©' : 'd√©sactiv√©'), 'info');
            }
        };
        
        window.editPack = function(packId) {
            const pack = appState.data.packs.find(p => p.id === packId);
            if (!pack) {
                showToast('‚ùå Pack introuvable', 'error');
                return;
            }
            
            const recipes = appState.data.recipes || [];
            const ingredients = appState.data.ingredients || [];
            
            if (recipes.length === 0) {
                showToast('‚ùå Aucune recette disponible', 'error');
                return;
            }
            
            // Calculer prix sugg√©r√©
            const suggestedPrice = pack.getSuggestedPrice(recipes, ingredients, 30);
            
            const modal = document.createElement('div');
            modal.id = 'editPackModal';
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 900px;">
                    <div class="modal-header">
                        <h2>‚úèÔ∏è Modifier Pack</h2>
                        <button class="modal-close" onclick="closeModal('editPackModal')">‚úï</button>
                    </div>
                    <div class="modal-body">
                        <form id="editPackForm">
                            <div class="form-group">
                                <label>Nom du pack *</label>
                                <input type="text" id="editPackName" required placeholder="Ex: Pack Petit-D√©jeuner" value="${pack.name}">
                            </div>
                            <div class="form-group">
                                <label>Description</label>
                                <textarea id="editPackDescription" rows="2" placeholder="Description du pack">${pack.description || ''}</textarea>
                            </div>
                            <h3 style="margin-top: var(--space-lg);">Produits inclus</h3>
                            <div id="editPackItemsContainer">
                                ${pack.items.map((item, index) => `
                                    <div class="pack-item-row" data-index="${index}">
                                        <div class="form-row" style="align-items: flex-end;">
                                            <div class="form-group" style="flex: 2;">
                                                <label>Produit</label>
                                                <select class="pack-item-product" required>
                                                    <option value="">S√©lectionner...</option>
                                                    ${recipes.map(r => `
                                                        <option value="${r.id}" 
                                                            data-name="${r.name}" 
                                                            data-unit="${r.producedUnit}"
                                                            ${r.id === item.productionId ? 'selected' : ''}>
                                                            ${r.name}
                                                        </option>
                                                    `).join('')}
                                                </select>
                                            </div>
                                            <div class="form-group" style="flex: 1;">
                                                <label>Quantit√©</label>
                                                <input type="number" class="pack-item-quantity" required min="1" step="1" value="${item.quantity}">
                                            </div>
                                            <button type="button" class="btn" style="background: var(--danger);" onclick="removePackItem(${index})">‚ùå</button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            <button type="button" class="btn" style="margin-top: var(--space-sm); background: var(--info);" onclick="addPackItemToEdit()">‚ûï Ajouter Produit</button>
                            <div style="margin-top: var(--space-lg); padding: var(--space-md); background: var(--light); border-radius: var(--radius-md);">
                                <div class="form-row">
                                    <div class="form-group" style="flex: 1;">
                                        <label>Prix de vente *</label>
                                        <input type="number" id="editPackPrice" required min="0" step="0.01" value="${pack.price}">
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <label>Prix sugg√©r√© (marge 30%)</label>
                                        <div style="display: flex; align-items: center; gap: var(--space-sm);">
                                            <input type="text" value="${formatCurrency(suggestedPrice)}" readonly style="background: var(--white); cursor: not-allowed;">
                                            <button type="button" class="btn btn-sm" style="background: var(--success);" onclick="document.getElementById('editPackPrice').value = ${suggestedPrice}">Appliquer</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: var(--space-sm); cursor: pointer;">
                                    <input type="checkbox" id="editPackActive" ${pack.active ? 'checked' : ''}>
                                    <span>Pack actif (visible pour vente)</span>
                                </label>
                            </div>
                            <div class="modal-footer" style="display: flex; justify-content: flex-end; gap: var(--space-sm);">
                                <button type="button" class="btn" onclick="closeModal('editPackModal')">Annuler</button>
                                <button type="submit" class="btn btn-primary">üíæ Enregistrer</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Gestion du formulaire
            document.getElementById('editPackForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const name = document.getElementById('editPackName').value;
                const description = document.getElementById('editPackDescription').value;
                const price = Number(document.getElementById('editPackPrice').value);
                const active = document.getElementById('editPackActive').checked;
                
                const items = [];
                document.querySelectorAll('#editPackItemsContainer .pack-item-row').forEach(row => {
                    const productSelect = row.querySelector('.pack-item-product');
                    const quantity = Number(row.querySelector('.pack-item-quantity').value);
                    if (productSelect.value) {
                        const option = productSelect.options[productSelect.selectedIndex];
                        items.push({
                            productionId: productSelect.value,
                            productionName: option.getAttribute('data-name'),
                            quantity: quantity,
                            unit: option.getAttribute('data-unit')
                        });
                    }
                });
                
                // Fonction pour mettre √† jour le pack
                function updatePack(allowLoss = false) {
                    try {
                        PackService.update(
                            pack, 
                            { name, description, price, items, active }, 
                            recipes,
                            ingredients,
                            allowLoss
                        );
                        saveData();
                        closeModal('editPackModal');
                        renderPacksPage();
                        showToast('‚úÖ Pack "' + name + '" modifi√© !', 'success');
                    } catch (error) {
                        // Si c'est une alerte de perte
                        if (error.message.includes('ALERTE PERTE')) {
                            // Afficher confirmation
                            if (confirm(
                                error.message + '\n\n' +
                                '‚ö†Ô∏è Voulez-vous modifier ce pack MALGR√â la perte ?\n\n' +
                                'Ceci peut √™tre justifi√© pour:\n' +
                                '‚Ä¢ Offres promotionnelles\n' +
                                '‚Ä¢ Liquidation de stock\n' +
                                '‚Ä¢ Strat√©gie commerciale sp√©cifique'
                            )) {
                                // Modifier avec allowLoss = true
                                updatePack(true);
                            }
                        } else {
                            // Autre erreur
                            showToast('‚ùå ' + error.message, 'error');
                        }
                    }
                }
                
                // Lancer la mise √† jour
                updatePack(false);
            });
            
            setTimeout(() => modal.classList.add('active'), 10);
        };
        
        // Ajouter produit en mode √©dition
        let editPackItemIndex = 1000; // √âviter conflits avec index cr√©ation
        window.addPackItemToEdit = function() {
            const recipes = appState.data.recipes || [];
            const container = document.getElementById('editPackItemsContainer');
            const newRow = document.createElement('div');
            newRow.className = 'pack-item-row';
            newRow.setAttribute('data-index', editPackItemIndex);
            newRow.innerHTML = `
                <div class="form-row" style="align-items: flex-end;">
                    <div class="form-group" style="flex: 2;">
                        <label>Produit</label>
                        <select class="pack-item-product" required>
                            <option value="">S√©lectionner...</option>
                            ${recipes.map(r => `
                                <option value="${r.id}" data-name="${r.name}" data-unit="${r.producedUnit}">
                                    ${r.name}
                                </option>
                            `).join('')}
                        </select>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>Quantit√©</label>
                        <input type="number" class="pack-item-quantity" required min="1" step="1" value="1">
                    </div>
                    <button type="button" class="btn" style="background: var(--danger);" onclick="removePackItem(${editPackItemIndex})">‚ùå</button>
                </div>
            `;
            container.appendChild(newRow);
            editPackItemIndex++;
        };
        
        window.deletePack = function(packId) {
            const pack = appState.data.packs.find(p => p.id === packId);
            if (!pack) return;
            if (confirm('‚ö†Ô∏è Supprimer le pack "' + pack.name + '" ?\n\nCette action est irr√©versible.')) {
                appState.data.packs = appState.data.packs.filter(p => p.id !== packId);
                saveData();
                renderPacksPage();
                showToast('üóëÔ∏è Pack "' + pack.name + '" supprim√©', 'success');
            }
        };
        
        window.editRecipe = function(recipeId) {
            showToast('üöß Modification recette - En d√©veloppement', 'info');
        };
        
        window.deleteRecipe = function(recipeId) {
            const recipe = appState.data.recipes.find(r => r.id === recipeId);
            if (!recipe) return;
            if (confirm('‚ö†Ô∏è Supprimer la recette "' + recipe.name + '" ?\n\nCette action est irr√©versible.')) {
                appState.data.recipes = appState.data.recipes.filter(r => r.id !== recipeId);
                saveData();
                renderRecipesPage();
                showToast('üóëÔ∏è Recette "' + recipe.name + '" supprim√©e', 'success');
            }
        };

        // Filter recipes
        function filterRecipes() {
            const search = document.getElementById('searchRecipes')?.value.toLowerCase() || '';
            const category = document.getElementById('filterRecipeCategory')?.value || '';
            
            let filtered = appState.data.recipes || [];
            
            if (search) {
                filtered = filtered.filter(r => r.name.toLowerCase().includes(search));
            }
            
            if (category) {
                filtered = filtered.filter(r => r.category === category);
            }
            
            document.getElementById('recipesGrid').innerHTML = 
                filtered.length > 0 ? renderRecipeCards(filtered) : '<div class="empty-state"><p>Aucune recette</p></div>';
        }

        window.showCreateRecipeModal = function() {
            const ingredients = appState.data.ingredients || [];
            
            const modal = document.createElement('div');
            modal.id = 'createRecipeModal';
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px;">
                    <div class="modal-header">
                        <h2>üìã Nouvelle Recette</h2>
                        <button class="modal-close" onclick="closeModal('createRecipeModal')">‚úï</button>
                    </div>
                    <div class="modal-body">
                        <form id="createRecipeForm">
                            <div class="form-row">
                                <div class="form-group" style="flex: 2;">
                                    <label>Nom de la recette *</label>
                                    <input type="text" name="name" required placeholder="Ex: Croissant au beurre">
                                </div>
                                <div class="form-group">
                                    <label>Cat√©gorie</label>
                                    <select name="category">
                                        <option value="">Sans cat√©gorie</option>
                                        <option value="Pain">Pain</option>
                                        <option value="Viennoiserie">Viennoiserie</option>
                                        <option value="P√¢tisserie">P√¢tisserie</option>
                                        <option value="Autre">Autre</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Rendement *</label>
                                    <input type="number" name="producedQty" required placeholder="Ex: 10" min="1" step="0.1">
                                </div>
                                <div class="form-group">
                                    <label>Unit√© *</label>
                                    <select name="producedUnit" required>
                                        <option value="piece">pi√®ce(s)</option>
                                        <option value="kg">kg</option>
                                        <option value="L">L</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Temps pr√©paration (min)</label>
                                    <input type="number" name="preparationTime" placeholder="Ex: 45" min="0">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Instructions</label>
                                <textarea name="instructions" rows="3" placeholder="√âtapes de pr√©paration..."></textarea>
                            </div>
                            
                            <hr style="margin: var(--space-lg) 0;">
                            
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-md);">
                                <h3 style="margin: 0;">Ingr√©dients</h3>
                                <button type="button" class="btn" style="background: var(--secondary); color: white;" onclick="addRecipeIngredient()">
                                    ‚ûï Ajouter ingr√©dient
                                </button>
                            </div>
                            
                            <div id="recipeIngredientsList">
                                <!-- Ingredients will be added here -->
                            </div>
                            
                            <div id="recipeCostDisplay" style="background: var(--light); padding: var(--space-md); border-radius: var(--radius-md); margin-top: var(--space-md); display: none;">
                                <strong>Co√ªt total estim√© :</strong> <span id="recipeTotalCost">0 ‚Ç¨</span>
                                <br>
                                <strong>Co√ªt unitaire :</strong> <span id="recipeUnitCost">0 ‚Ç¨</span>
                            </div>
                            
                            <div style="display: flex; gap: var(--space-md); margin-top: var(--space-lg);">
                                <button type="button" class="btn" style="flex: 1; background: var(--gray); color: white;" onclick="closeModal('createRecipeModal')">
                                    Annuler
                                </button>
                                <button type="submit" class="btn btn-primary" style="flex: 1;">
                                    ‚úÖ Cr√©er la recette
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            document.getElementById('createRecipeForm').addEventListener('submit', handleCreateRecipe);
        };
        
        // Add ingredient row to recipe
        window.addRecipeIngredient = function() {
            const ingredients = appState.data.ingredients || [];
            // Trier alphab√©tiquement
            const sortedIngredients = [...ingredients].sort((a, b) => a.name.localeCompare(b.name));
            
            const container = document.getElementById('recipeIngredientsList');
            const index = container.children.length;
            
            const row = document.createElement('div');
            row.className = 'form-row';
            row.style.marginBottom = 'var(--space-sm)';
            row.dataset.index = index;
            row.innerHTML = `
                <div class="form-group" style="flex: 2;">
                    <input type="text" 
                           id="ingredientSearch_${index}" 
                           placeholder="üîç Rechercher un ingr√©dient..." 
                           style="width: 100%; padding: 12px; border: 2px solid var(--light); border-radius: var(--radius-md); margin-bottom: 8px;"
                           oninput="filterIngredientSelect(${index})">
                    <select name="ingredient_${index}" 
                            id="ingredientSelect_${index}" 
                            required 
                            onchange="updateRecipeIngredientUnit(${index})"
                            style="width: 100%;">
                        <option value="">S√©lectionner ingr√©dient...</option>
                        ${sortedIngredients.map(ing => `<option value="${ing.id}" data-unit="${ing.baseUnit}">${ing.name}</option>`).join('')}
                    </select>
                </div>
                <div class="form-group">
                    <input type="number" name="quantity_${index}" required placeholder="Quantit√©" min="0.01" step="0.01" oninput="updateRecipeCost()">
                </div>
                <div class="form-group">
                    <select name="unit_${index}" id="unit_${index}" required onchange="updateRecipeCost()">
                        <option value="">Unit√©</option>
                    </select>
                </div>
                <button type="button" class="btn" style="background: var(--danger); color: white; padding: 12px 16px;" onclick="removeRecipeIngredient(${index})" title="Supprimer">
                    ‚úï
                </button>
            `;
            
            container.appendChild(row);
        };
        
        // Fonction de filtrage du select ingr√©dients
        window.filterIngredientSelect = function(index) {
            const searchInput = document.getElementById(`ingredientSearch_${index}`);
            const select = document.getElementById(`ingredientSelect_${index}`);
            const searchTerm = searchInput.value.toLowerCase();
            
            Array.from(select.options).forEach(option => {
                if (option.value === '') {
                    option.style.display = ''; // Toujours montrer l'option vide
                } else {
                    const text = option.textContent.toLowerCase();
                    option.style.display = text.includes(searchTerm) ? '' : 'none';
                }
            });
        };
        
        // Update unit options when ingredient selected
        window.updateRecipeIngredientUnit = function(index) {
            const select = document.querySelector(`[name="ingredient_${index}"]`);
            const unitSelect = document.getElementById(`unit_${index}`);
            
            if (select.value) {
                const option = select.options[select.selectedIndex];
                const baseUnit = option.dataset.unit;
                
                // Set available units
                let units = [baseUnit];
                if (baseUnit === 'g') units.push('kg');
                if (baseUnit === 'ml') units.push('L');
                
                unitSelect.innerHTML = units.map(u => `<option value="${u}">${u}</option>`).join('');
                updateRecipeCost();
            }
        };
        
        // Remove ingredient row
        window.removeRecipeIngredient = function(index) {
            const row = document.querySelector(`[data-index="${index}"]`);
            if (row) row.remove();
            updateRecipeCost();
        };
        
        // Update recipe cost calculation
        window.updateRecipeCost = function() {
            const container = document.getElementById('recipeIngredientsList');
            const rows = container.querySelectorAll('.form-row');
            const ingredients = appState.data.ingredients || [];
            
            let totalCost = 0;
            let hasIngredients = false;
            
            rows.forEach(row => {
                const index = row.dataset.index;
                const ingSelect = document.querySelector(`[name="ingredient_${index}"]`);
                const qtyInput = document.querySelector(`[name="quantity_${index}"]`);
                const unitSelect = document.querySelector(`[name="unit_${index}"]`);
                
                if (ingSelect?.value && qtyInput?.value && unitSelect?.value) {
                    hasIngredients = true;
                    const ing = ingredients.find(i => i.id === ingSelect.value);
                    if (ing) {
                        let qty = Number(qtyInput.value);
                        const unit = unitSelect.value;
                        
                        // Convert to base unit
                        if (unit === 'kg' && ing.baseUnit === 'g') qty *= 1000;
                        if (unit === 'L' && ing.baseUnit === 'ml') qty *= 1000;
                        
                        // Get cost per base unit
                        const costPerUnit = ing.getPricePerBaseUnit ? ing.getPricePerBaseUnit() : 0;
                        totalCost += qty * costPerUnit;
                    }
                }
            });
            
            // Display cost
            const costDisplay = document.getElementById('recipeCostDisplay');
            if (hasIngredients) {
                costDisplay.style.display = 'block';
                document.getElementById('recipeTotalCost').textContent = formatCurrency(totalCost);
                
                const producedQty = Number(document.querySelector('[name="producedQty"]')?.value) || 1;
                const unitCost = totalCost / producedQty;
                document.getElementById('recipeUnitCost').textContent = formatCurrency(unitCost);
            } else {
                costDisplay.style.display = 'none';
            }
        };
        
        // Handle recipe creation
        async function handleCreateRecipe(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const container = document.getElementById('recipeIngredientsList');
            const rows = container.querySelectorAll('.form-row');
            
            // Collect ingredients
            const recipeIngredients = [];
            const ingredients = appState.data.ingredients || [];
            
            rows.forEach(row => {
                const index = row.dataset.index;
                const ingId = formData.get(`ingredient_${index}`);
                const qty = Number(formData.get(`quantity_${index}`));
                const unit = formData.get(`unit_${index}`);
                
                if (ingId && qty && unit) {
                    const ing = ingredients.find(i => i.id === ingId);
                    if (ing) {
                        let baseQty = qty;
                        if (unit === 'kg' && ing.baseUnit === 'g') baseQty = qty * 1000;
                        if (unit === 'L' && ing.baseUnit === 'ml') baseQty = qty * 1000;
                        
                        recipeIngredients.push({
                            ingredientId: ingId,
                            ingredientName: ing.name,
                            quantity: qty,
                            unit: unit,
                            baseQty: baseQty,
                            baseUnit: ing.baseUnit
                        });
                    }
                }
            });
            
            if (recipeIngredients.length === 0) {
                showToast('‚ùå Ajoutez au moins un ingr√©dient', 'error');
                return;
            }
            
            try {
                const recipe = RecipeService.create({
                    name: formData.get('name'),
                    category: formData.get('category'),
                    producedQty: Number(formData.get('producedQty')),
                    producedUnit: formData.get('producedUnit'),
                    preparationTime: Number(formData.get('preparationTime')) || 0,
                    instructions: formData.get('instructions') || ''
                });
                
                // Add ingredients
                recipeIngredients.forEach(ing => {
                    RecipeService.addIngredient(recipe, ing);
                });
                
                // Save to state
                appState.data.recipes.push(recipe);
                saveData();
                
                closeModal('createRecipeModal');
                renderRecipesPage();
                
                showToast(`‚úÖ Recette "${recipe.name}" cr√©√©e avec ${recipeIngredients.length} ingr√©dients`, 'success');
                
            } catch (error) {
                console.error('Error:', error);
                showToast('‚ùå Erreur: ' + error.message, 'error');
            }
        }
        
        // ========================================
        // RECIPE DETAILS
        // ========================================
        
        window.showRecipeDetails = function(recipeId) {
            const recipe = appState.data.recipes.find(r => r.id === recipeId);
            if (!recipe) {
                showToast('‚ùå Recette introuvable', 'error');
                return;
            }
            
            const ingredients = appState.data.ingredients || [];
            const capacity = RecipeService.calculateCapacity(recipe, ingredients);
            
            // Calculate total cost
            let totalCost = 0;
            recipe.ingredients.forEach(recipeIng => {
                const ing = ingredients.find(i => i.id === recipeIng.ingredientId);
                if (ing) {
                    const costPerUnit = ing.getPricePerBaseUnit ? ing.getPricePerBaseUnit() : 0;
                    totalCost += recipeIng.baseQty * costPerUnit;
                }
            });
            
            const unitCost = totalCost / recipe.producedQty;
            
            const modal = document.createElement('div');
            modal.id = 'recipeDetailsModal';
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px;">
                    <div class="modal-header">
                        <h2>üìã ${recipe.name}</h2>
                        <button class="modal-close" onclick="closeModal('recipeDetailsModal')">‚úï</button>
                    </div>
                    <div class="modal-body">
                        <!-- Summary Stats -->
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: var(--space-md); margin-bottom: var(--space-lg);">
                            <div class="stat-card primary">
                                <div class="stat-label">Rendement</div>
                                <div class="stat-value">${recipe.producedQty} ${recipe.producedUnit}</div>
                            </div>
                            <div class="stat-card success">
                                <div class="stat-label">Co√ªt Total</div>
                                <div class="stat-value">${formatCurrency(totalCost)}</div>
                            </div>
                            <div class="stat-card warning">
                                <div class="stat-label">Co√ªt Unitaire</div>
                                <div class="stat-value">${formatCurrency(unitCost)}</div>
                            </div>
                            <div class="stat-card ${capacity.batches === 0 ? 'danger' : 'info'}">
                                <div class="stat-label">Fabricable</div>
                                <div class="stat-value">${capacity.batches} batch${capacity.batches > 1 ? 'es' : ''}</div>
                            </div>
                        </div>
                        
                        ${recipe.category ? `
                            <p style="margin-bottom: var(--space-md);"><strong>Cat√©gorie :</strong> ${recipe.category}</p>
                        ` : ''}
                        
                        ${recipe.preparationTime > 0 ? `
                            <p style="margin-bottom: var(--space-md);"><strong>Temps de pr√©paration :</strong> ${recipe.preparationTime} minutes</p>
                        ` : ''}
                        
                        ${recipe.instructions ? `
                            <div style="background: var(--light); padding: var(--space-md); border-radius: var(--radius-md); margin-bottom: var(--space-lg);">
                                <strong>Instructions :</strong>
                                <p style="margin-top: 8px; white-space: pre-wrap;">${recipe.instructions}</p>
                            </div>
                        ` : ''}
                        
                        <!-- Ingredients List -->
                        <h3 style="margin-bottom: var(--space-md);">üì¶ Ingr√©dients (${recipe.ingredients.length})</h3>
                        <div style="overflow-x: auto; margin-bottom: var(--space-xl);">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead style="background: var(--light);">
                                    <tr>
                                        <th style="padding: 12px; text-align: left;">Ingr√©dient</th>
                                        <th style="padding: 12px; text-align: right;">Quantit√©</th>
                                        <th style="padding: 12px; text-align: right;">Stock Dispo</th>
                                        <th style="padding: 12px; text-align: right;">Co√ªt</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${recipe.ingredients.map(recipeIng => {
                                        const ing = ingredients.find(i => i.id === recipeIng.ingredientId);
                                        if (!ing) return '';
                                        
                                        const stock = ing.getBaseQtyRemaining ? ing.getBaseQtyRemaining() : 0;
                                        const costPerUnit = ing.getPricePerBaseUnit ? ing.getPricePerBaseUnit() : 0;
                                        const ingCost = recipeIng.baseQty * costPerUnit;
                                        const sufficient = stock >= recipeIng.baseQty;
                                        
                                        return `
                                            <tr style="border-bottom: 1px solid var(--light);">
                                                <td style="padding: 12px;">${recipeIng.ingredientName}</td>
                                                <td style="padding: 12px; text-align: right; font-weight: 600;">
                                                    ${recipeIng.quantity} ${recipeIng.unit}
                                                </td>
                                                <td style="padding: 12px; text-align: right; color: ${sufficient ? 'var(--success)' : 'var(--danger)'};">
                                                    ${stock} ${ing.baseUnit}
                                                    ${!sufficient ? ' ‚ö†Ô∏è' : ''}
                                                </td>
                                                <td style="padding: 12px; text-align: right;">${formatCurrency(ingCost)}</td>
                                            </tr>
                                        `;
                                    }).join('')}
                                    <tr style="border-top: 2px solid var(--primary); font-weight: 600;">
                                        <td colspan="3" style="padding: 12px; text-align: right;">TOTAL :</td>
                                        <td style="padding: 12px; text-align: right; color: var(--primary);">${formatCurrency(totalCost)}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        ${capacity.maxBatches === 0 && capacity.limitingIngredient ? `
                            <div style="background: #FFF3CD; padding: var(--space-md); border-radius: var(--radius-md); margin-bottom: var(--space-lg); border-left: 4px solid #FFA502;">
                                <h4 style="margin-bottom: var(--space-sm); color: #856404;">‚ö†Ô∏è Stock insuffisant</h4>
                                <p style="color: #856404;">
                                    Ingr√©dient limitant : <strong>${capacity.limitingIngredient.name}</strong>
                                    <br>
                                    N√©cessaire : ${capacity.limitingIngredient.needed} ${capacity.limitingIngredient.unit}
                                    <br>
                                    Disponible : ${capacity.limitingIngredient.available} ${capacity.limitingIngredient.unit}
                                    <br>
                                    Manque : ${capacity.limitingIngredient.missing} ${capacity.limitingIngredient.unit}
                                </p>
                            </div>
                        ` : capacity.maxBatches > 0 ? `
                            <div style="background: #d4edda; padding: var(--space-md); border-radius: var(--radius-md); margin-bottom: var(--space-lg); border-left: 4px solid #28a745;">
                                <h4 style="margin-bottom: var(--space-sm); color: #155724;">‚úÖ Stock suffisant</h4>
                                <p style="color: #155724;">
                                    Vous pouvez produire jusqu'√† <strong>${capacity.maxBatches} batch(s)</strong>, 
                                    soit <strong>${capacity.maxBatches * recipe.producedQty} ${recipe.producedUnit}</strong>.
                                </p>
                            </div>
                        ` : ''}
                        
                        <!-- Actions -->
                        <div style="display: flex; gap: var(--space-md); margin-top: var(--space-xl);" class="no-print">
                            <button class="btn" style="flex: 1; background: var(--info); color: white;" onclick="window.print()">
                                üñ®Ô∏è Imprimer
                            </button>
                            <button class="btn" style="flex: 1; background: var(--secondary); color: white;" onclick="alert('Modifier - Bient√¥t')">
                                ‚úèÔ∏è Modifier
                            </button>
                            <button class="btn btn-primary" style="flex: 1;" onclick="alert('Produire - Bient√¥t')" ${capacity.batches === 0 ? 'disabled' : ''}>
                                ‚öôÔ∏è Produire
                            </button>
                            <button class="btn" style="background: var(--gray); color: white;" onclick="closeModal('recipeDetailsModal')">
                                Fermer
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        };
        
        // Render categories list for manager
        function renderCategoriesList() {
            const categories = appState.data.categories || [];
            const mainCategories = categories.filter(c => !c.parent);
            
            let html = '';
            mainCategories.forEach(main => {
                html += `
                    <div style="margin-bottom: var(--space-md); border: 2px solid var(--light); border-radius: var(--radius-md); padding: var(--space-sm);">
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: var(--space-sm);">
                            <strong style="font-size: 16px;">${main.name}</strong>
                            <button class="btn" style="padding: 8px 16px; background: var(--danger); color: white;" 
                                onclick="deleteCategory('${main.id}')">
                                üóëÔ∏è Supprimer
                            </button>
                        </div>
                        
                        ${categories.filter(c => c.parent === main.name).map(sub => `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: var(--space-sm); margin-left: var(--space-lg); background: var(--light); border-radius: var(--radius-sm); margin-top: 4px;">
                                <span>‚îî ${sub.name}</span>
                                <button class="btn" style="padding: 6px 12px; background: var(--danger); color: white; font-size: 12px;" 
                                    onclick="deleteCategory('${sub.id}')">
                                    üóëÔ∏è
                                </button>
                            </div>
                        `).join('')}
                    </div>
                `;
            });
            
            return html || '<p style="text-align: center; color: var(--gray);">Aucune cat√©gorie</p>';
        }
        
        // Show category manager
        window.showCategoryManager = function() {
            const modal = document.getElementById('categoryManagerModal');
            if (modal) {
                modal.classList.remove('hidden');
                // Refresh list
                const list = document.getElementById('categoriesList');
                if (list) list.innerHTML = renderCategoriesList();
            }
        };
        
        // Handle add category
        function handleAddCategory(e) {
            e.preventDefault();
            
            const name = document.getElementById('newCategoryName').value.trim();
            const parent = document.getElementById('newCategoryParent').value.trim() || null;
            
            if (!name) {
                showToast('‚ùå Le nom est obligatoire', 'error');
                return;
            }
            
            // Check if exists
            const exists = appState.data.categories.some(c => 
                c.name.toLowerCase() === name.toLowerCase()
            );
            
            if (exists) {
                showToast('‚ùå Cette cat√©gorie existe d√©j√†', 'error');
                return;
            }
            
            // Add category
            const newCategory = {
                id: 'cat_' + Date.now(),
                name: name,
                parent: parent
            };
            
            appState.data.categories.push(newCategory);
            saveData();
            
            // Reset form
            document.getElementById('newCategoryName').value = '';
            document.getElementById('newCategoryParent').value = '';
            
            // Refresh list
            document.getElementById('categoriesList').innerHTML = renderCategoriesList();
            
            // NOUVEAU : Rafra√Æchir le dropdown cat√©gories dans le formulaire d'ajout d'ingr√©dient
            const categorySelect = document.querySelector('#addIngredientForm select[name="category"]');
            if (categorySelect) {
                categorySelect.innerHTML = `
                    <option value="">Aucune cat√©gorie</option>
                    ${getCategoriesOptions()}
                `;
            }
            
            showToast('‚úÖ Cat√©gorie ajout√©e !', 'success');
        }
        
        // Delete category
        window.deleteCategory = function(categoryId) {
            if (!confirm('Supprimer cette cat√©gorie ?')) return;
            
            const category = appState.data.categories.find(c => c.id === categoryId);
            if (!category) return;
            
            // Check if has subcategories
            const hasSubs = appState.data.categories.some(c => c.parent === category.name);
            if (hasSubs && !confirm('Cette cat√©gorie a des sous-cat√©gories. Les supprimer aussi ?')) {
                return;
            }
            
            // Check if used by ingredients
            const usedByIngredients = appState.data.ingredients.some(ing => 
                ing.category === category.name
            );
            
            if (usedByIngredients) {
                showToast('‚ùå Cat√©gorie utilis√©e par des ingr√©dients', 'error');
                return;
            }
            
            // Delete category and its subcategories
            appState.data.categories = appState.data.categories.filter(c => 
                c.id !== categoryId && c.parent !== category.name
            );
            
            saveData();
            
            // Refresh list
            document.getElementById('categoriesList').innerHTML = renderCategoriesList();
            
            showToast('‚úÖ Cat√©gorie supprim√©e', 'success');
        };
        
        // ========================================
        // DLC CUSTOM FILTERS
        // ========================================
        
        // Handle DLC filter change
        function handleDlcFilterChange() {
            const filterType = document.getElementById('filterDlcType')?.value;
            const customFilters = document.getElementById('customDlcFilters');
            
            if (filterType === 'custom' || filterType === 'date') {
                if (customFilters) customFilters.classList.remove('hidden');
                
                // Set defaults
                if (filterType === 'custom') {
                    const today = new Date();
                    const future = new Date();
                    future.setMonth(future.getMonth() + 3);
                    
                    const fromInput = document.getElementById('dlcFrom');
                    const toInput = document.getElementById('dlcTo');
                    if (fromInput) fromInput.value = today.toISOString().split('T')[0];
                    if (toInput) toInput.value = future.toISOString().split('T')[0];
                } else if (filterType === 'date') {
                    const today = new Date().toISOString().split('T')[0];
                    const fromInput = document.getElementById('dlcFrom');
                    const toInput = document.getElementById('dlcTo');
                    if (fromInput) fromInput.value = today;
                    if (toInput) toInput.value = today;
                }
            } else {
                if (customFilters) customFilters.classList.add('hidden');
                appState.customDlcFilter = null;
                filterIngredients();
            }
        }
        
        // Apply custom DLC filter
        window.applyCustomDlcFilter = function() {
            const from = document.getElementById('dlcFrom')?.value;
            const to = document.getElementById('dlcTo')?.value;
            
            if (!from || !to) {
                showToast('‚ùå Veuillez renseigner les deux dates', 'error');
                return;
            }
            
            appState.customDlcFilter = {
                from: new Date(from),
                to: new Date(to)
            };
            
            filterIngredients();
            showToast('‚úÖ Filtre DLC appliqu√©', 'success');
        };

        // Filter Ingredients
        function filterIngredients() {
            const search = document.getElementById('searchIngredients')?.value.toLowerCase() || '';
            const category = document.getElementById('filterCategory')?.value || '';
            const alertType = document.getElementById('filterAlert')?.value || '';
            const dlcType = document.getElementById('filterDlcType')?.value || '';
            
            let filtered = appState.data.ingredients || [];
            
            // Search filter
            if (search) {
                filtered = filtered.filter(ing => 
                    ing.name.toLowerCase().includes(search) ||
                    (ing.category || '').toLowerCase().includes(search)
                );
            }
            
            // Category filter
            if (category) {
                filtered = filtered.filter(ing => ing.category === category);
            }
            
            // Alert filter
            if (alertType) {
                filtered = filtered.filter(ing => {
                    const alerts = ing.alerts || [];
                    if (alertType === 'low') return alerts.some(a => a.type === 'STOCK_LOW');
                    return false;
                });
            }
            
            // DLC filter
            if (dlcType && dlcType !== 'custom' && dlcType !== 'date') {
                const now = new Date();
                
                filtered = filtered.filter(ing => {
                    if (!ing.lots || ing.lots.length === 0) return false;
                    
                    return ing.lots.some(lot => {
                        const dlc = new Date(lot.dlc);
                        
                        if (dlcType === 'expired') {
                            return dlc < now;
                        } else if (dlcType === '7days') {
                            const sevenDays = new Date(now);
                            sevenDays.setDate(sevenDays.getDate() + 7);
                            return dlc >= now && dlc <= sevenDays;
                        } else if (dlcType === '30days') {
                            const thirtyDays = new Date(now);
                            thirtyDays.setDate(thirtyDays.getDate() + 30);
                            return dlc >= now && dlc <= thirtyDays;
                        }
                        
                        return false;
                    });
                });
            }
            
            // Custom DLC filter
            if ((dlcType === 'custom' || dlcType === 'date') && appState.customDlcFilter) {
                filtered = filtered.filter(ing => {
                    if (!ing.lots || ing.lots.length === 0) return false;
                    
                    return ing.lots.some(lot => {
                        const dlc = new Date(lot.dlc);
                        return dlc >= appState.customDlcFilter.from && 
                               dlc <= appState.customDlcFilter.to;
                    });
                });
            }
            
            const grid = document.getElementById('ingredientsGrid');
            if (grid) grid.innerHTML = renderIngredientsCards(filtered);
        }

        // Show Add Ingredient Modal
        window.showAddIngredientModal = function() {
            const modal = document.getElementById('addIngredientModal');
            if (modal) {
                modal.classList.remove('hidden');
                
                // Initialiser l'auto-compl√©tion
                initIngredientAutocomplete();
            }
        };
        
        /**
         * Initialise l'auto-compl√©tion sur le champ nom d'ingr√©dient
         */
        function initIngredientAutocomplete() {
            const input = document.getElementById('ingredientNameInput');
            const suggestionsBox = document.getElementById('ingredientSuggestions');
            
            if (!input || !suggestionsBox) return;
            
            let selectedIndex = -1;
            
            input.addEventListener('input', function(e) {
                const query = e.target.value.trim().toLowerCase();
                
                if (query.length < 2) {
                    suggestionsBox.style.display = 'none';
                    return;
                }
                
                // Chercher dans la base d'ingr√©dients
                const matches = IngredientDatabaseCore.ingredients.filter(ing => 
                    ing.name.toLowerCase().includes(query)
                ).slice(0, 10); // Max 10 suggestions
                
                if (matches.length === 0) {
                    suggestionsBox.style.display = 'none';
                    return;
                }
                
                // Afficher les suggestions
                suggestionsBox.innerHTML = matches.map((ing, index) => `
                    <div class="suggestion-item" data-index="${index}" style="
                        padding: 12px 16px;
                        cursor: pointer;
                        border-bottom: 1px solid var(--light);
                        transition: background 0.2s;
                    " onmouseover="this.style.background='var(--light)'" onmouseout="this.style.background='white'" onclick="selectIngredientSuggestion(${index})">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong style="color: var(--primary);">${ing.name}</strong>
                                <span style="color: var(--gray); font-size: 13px; margin-left: 8px;">${ing.category}</span>
                            </div>
                            <div style="text-align: right; font-size: 12px;">
                                <div style="color: var(--success); font-weight: 600;">Rendement : ${ing.yieldPercent}%</div>
                                <div style="color: var(--gray);">${ing.wasteType || 'Aucun d√©chet'}</div>
                            </div>
                        </div>
                    </div>
                `).join('');
                
                suggestionsBox.style.display = 'block';
                selectedIndex = -1;
                
                // Stocker les suggestions pour la s√©lection au clavier
                suggestionsBox.dataset.suggestions = JSON.stringify(matches);
            });
            
            // Navigation au clavier
            input.addEventListener('keydown', function(e) {
                const items = suggestionsBox.querySelectorAll('.suggestion-item');
                
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
                    highlightSuggestion(items, selectedIndex);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    selectedIndex = Math.max(selectedIndex - 1, 0);
                    highlightSuggestion(items, selectedIndex);
                } else if (e.key === 'Enter' && selectedIndex >= 0) {
                    e.preventDefault();
                    selectIngredientSuggestion(selectedIndex);
                } else if (e.key === 'Escape') {
                    suggestionsBox.style.display = 'none';
                    selectedIndex = -1;
                }
            });
            
            // Fermer les suggestions si clic ailleurs
            document.addEventListener('click', function(e) {
                if (!input.contains(e.target) && !suggestionsBox.contains(e.target)) {
                    suggestionsBox.style.display = 'none';
                }
            });
        }
        
        /**
         * Met en surbrillance une suggestion
         */
        function highlightSuggestion(items, index) {
            items.forEach((item, i) => {
                if (i === index) {
                    item.style.background = 'var(--primary)';
                    item.style.color = 'white';
                } else {
                    item.style.background = 'white';
                    item.style.color = 'inherit';
                }
            });
        }
        
        /**
         * S√©lectionne une suggestion et pr√©-remplit le formulaire
         */
        window.selectIngredientSuggestion = function(index) {
            const suggestionsBox = document.getElementById('ingredientSuggestions');
            const suggestions = JSON.parse(suggestionsBox.dataset.suggestions || '[]');
            const selected = suggestions[index];
            
            if (!selected) return;
            
            // Pr√©-remplir le formulaire
            document.getElementById('ingredientNameInput').value = selected.name;
            document.querySelector('select[name="category"]').value = selected.category || '';
            document.querySelector('input[name="baseUnit"]').value = selected.baseUnit || 'g';
            document.querySelector('input[name="yieldPercent"]').value = selected.yieldPercent || 100;
            document.querySelector('input[name="wasteType"]').value = selected.wasteType || '';
            
            // Cacher les suggestions
            suggestionsBox.style.display = 'none';
            
            // Notification
            showToast(`‚úÖ ${selected.name} s√©lectionn√© - Rendement ${selected.yieldPercent}% pr√©-rempli !`, 'success');
        };

        // Close Modal
        window.closeModal = function(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                // V√©rifier si le modal existe dans le HTML initial (statique)
                // Si le modal a √©t√© cr√©√© dynamiquement, il faut le supprimer
                // Si le modal est statique (pr√©sent au chargement), il faut juste le cacher
                
                // Modaux statiques : addIngredientModal, categoryManagerModal
                const staticModals = ['addIngredientModal', 'categoryManagerModal'];
                
                if (staticModals.includes(modalId)) {
                    // Modal statique : cacher
                    modal.classList.add('hidden');
                } else {
                    // Modal dynamique : supprimer
                    modal.remove();
                }
            }
        };
        
        // Close modal on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                // Cacher les modaux statiques
                const staticModals = document.querySelectorAll('.modal.hidden');
                staticModals.forEach(modal => modal.classList.add('hidden'));
                
                // Supprimer les modaux dynamiques (ceux sans .hidden initialement)
                const dynamicModals = document.querySelectorAll('.modal:not([id="addIngredientModal"]):not([id="categoryManagerModal"])');
                dynamicModals.forEach(modal => {
                    if (!modal.classList.contains('hidden')) {
                        modal.remove();
                    }
                });
            }
        });
        
        // Close modal on overlay click - D√âSACTIV√â pour √©viter pertes de donn√©es
        // Les modales se ferment uniquement via les boutons Annuler ou X
        /*
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                const modalId = e.target.id;
                if (modalId) {
                    closeModal(modalId);
                }
            }
        });
        */

        // ========================================
        // IMPORT / EXPORT INGR√âDIENTS
        // ========================================
        
        /**
         * Affiche le modal d'import
         */
        window.showImportModal = function() {
            const modal = document.createElement('div');
            modal.id = 'importModal';
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 700px;">
                    <div class="modal-header">
                        <h2>üì• Importer des ingr√©dients</h2>
                        <button class="modal-close" onclick="closeModal('importModal')">‚úï</button>
                    </div>
                    <div class="modal-body">
                        <!-- Format Selection -->
                        <div style="margin-bottom: var(--space-lg);">
                            <label style="display: block; font-weight: 600; margin-bottom: var(--space-sm);">Format du fichier</label>
                            <div style="display: flex; gap: var(--space-md);">
                                <label style="flex: 1; padding: var(--space-md); border: 2px solid var(--light); border-radius: var(--radius-md); cursor: pointer; display: flex; align-items: center; gap: var(--space-sm);">
                                    <input type="radio" name="importFormat" value="json" checked>
                                    <div>
                                        <strong>JSON</strong>
                                        <div style="font-size: 12px; color: var(--gray);">Fichier .json (recommand√©)</div>
                                    </div>
                                </label>
                                <label style="flex: 1; padding: var(--space-md); border: 2px solid var(--light); border-radius: var(--radius-md); cursor: pointer; display: flex; align-items: center; gap: var(--space-sm);">
                                    <input type="radio" name="importFormat" value="csv">
                                    <div>
                                        <strong>CSV</strong>
                                        <div style="font-size: 12px; color: var(--gray);">Fichier .csv (Excel)</div>
                                    </div>
                                </label>
                            </div>
                        </div>
                        
                        <!-- File Upload -->
                        <div id="dropzone" style="
                            border: 3px dashed var(--primary);
                            border-radius: var(--radius-lg);
                            padding: var(--space-xl);
                            text-align: center;
                            background: var(--light);
                            cursor: pointer;
                            transition: all 0.3s;
                        ">
                            <div style="font-size: 48px; margin-bottom: var(--space-md);">üìÅ</div>
                            <p style="font-weight: 600; margin-bottom: var(--space-sm);">Glissez votre fichier ici</p>
                            <p style="color: var(--gray); font-size: 14px; margin-bottom: var(--space-md);">ou cliquez pour s√©lectionner</p>
                            <input type="file" id="fileInput" accept=".json,.csv" style="display: none;">
                            <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                                üìÇ Choisir un fichier
                            </button>
                        </div>
                        
                        <!-- File Info -->
                        <div id="fileInfo" style="display: none; margin-top: var(--space-md); padding: var(--space-md); background: var(--light); border-radius: var(--radius-md);">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong id="fileName"></strong>
                                    <div style="font-size: 12px; color: var(--gray);" id="fileSize"></div>
                                </div>
                                <button class="btn" style="background: var(--danger); color: white;" onclick="clearFile()">
                                    ‚úï Retirer
                                </button>
                            </div>
                        </div>
                        
                        <!-- Preview -->
                        <div id="previewSection" style="display: none; margin-top: var(--space-lg);">
                            <h3 style="margin-bottom: var(--space-md);">üìã Aper√ßu</h3>
                            <div id="previewContent" style="background: white; padding: var(--space-md); border-radius: var(--radius-md); max-height: 300px; overflow-y: auto;"></div>
                        </div>
                        
                        <!-- Import Options -->
                        <div id="importOptions" style="display: none; margin-top: var(--space-lg);">
                            <h3 style="margin-bottom: var(--space-md);">‚öôÔ∏è Options d'import</h3>
                            <label style="display: flex; align-items: center; gap: var(--space-sm); padding: var(--space-md); background: var(--light); border-radius: var(--radius-md);">
                                <input type="checkbox" id="mergeMode" checked>
                                <div>
                                    <strong>Fusion intelligente</strong>
                                    <div style="font-size: 12px; color: var(--gray);">√âvite les doublons (par nom), conserve vos ingr√©dients existants</div>
                                </div>
                            </label>
                        </div>
                        
                        <!-- Actions -->
                        <div style="display: flex; gap: var(--space-md); margin-top: var(--space-xl);">
                            <button type="button" class="btn" style="flex: 1; background: var(--gray); color: white;" onclick="closeModal('importModal')">
                                Annuler
                            </button>
                            <button id="importBtn" class="btn btn-primary" style="flex: 1;" disabled onclick="executeImport()">
                                üì• Importer
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Setup drag & drop
            const dropzone = document.getElementById('dropzone');
            const fileInput = document.getElementById('fileInput');
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropzone.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            ['dragenter', 'dragover'].forEach(eventName => {
                dropzone.addEventListener(eventName, () => {
                    dropzone.style.borderColor = 'var(--success)';
                    dropzone.style.background = '#e6f7ed';
                }, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                dropzone.addEventListener(eventName, () => {
                    dropzone.style.borderColor = 'var(--primary)';
                    dropzone.style.background = 'var(--light)';
                }, false);
            });
            
            dropzone.addEventListener('drop', (e) => {
                const files = e.dataTransfer.files;
                handleFile(files[0]);
            }, false);
            
            fileInput.addEventListener('change', (e) => {
                handleFile(e.target.files[0]);
            });
            
            // Store file for import
            let selectedFile = null;
            
            window.handleFile = function(file) {
                if (!file) return;
                
                selectedFile = file;
                
                // Show file info
                document.getElementById('fileName').textContent = file.name;
                document.getElementById('fileSize').textContent = (file.size / 1024).toFixed(2) + ' KB';
                document.getElementById('fileInfo').style.display = 'block';
                
                // Read and preview
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const content = e.target.result;
                        const format = document.querySelector('input[name="importFormat"]:checked').value;
                        
                        let data;
                        if (format === 'json') {
                            data = JSON.parse(content);
                        } else {
                            // Parse CSV
                            data = parseCSV(content);
                        }
                        
                        showPreview(data);
                        document.getElementById('importOptions').style.display = 'block';
                        document.getElementById('importBtn').disabled = false;
                        
                        // Store parsed data
                        window.importData = data;
                        
                    } catch (error) {
                        showToast('‚ùå Erreur de lecture du fichier : ' + error.message, 'error');
                    }
                };
                reader.readAsText(file);
            };
            
            window.clearFile = function() {
                selectedFile = null;
                fileInput.value = '';
                document.getElementById('fileInfo').style.display = 'none';
                document.getElementById('previewSection').style.display = 'none';
                document.getElementById('importOptions').style.display = 'none';
                document.getElementById('importBtn').disabled = true;
            };
            
            function showPreview(data) {
                const ingredients = Array.isArray(data) ? data : (data.ingredients || []);
                const preview = ingredients.slice(0, 5);
                
                const html = `
                    <div style="font-weight: 600; margin-bottom: var(--space-sm);">
                        ${ingredients.length} ingr√©dient(s) trouv√©(s)
                    </div>
                    <div style="font-size: 13px; color: var(--gray);">
                        Aper√ßu des 5 premiers :
                    </div>
                    <ul style="margin-top: var(--space-sm); list-style: none; padding: 0;">
                        ${preview.map(ing => `
                            <li style="padding: 8px; border-bottom: 1px solid var(--light);">
                                <strong>${ing.name}</strong>
                                ${ing.category ? `<span style="color: var(--gray);"> ‚Ä¢ ${ing.category}</span>` : ''}
                                ${ing.yieldPercent ? `<span style="color: var(--warning);"> ‚Ä¢ Rendement ${ing.yieldPercent}%</span>` : ''}
                            </li>
                        `).join('')}
                    </ul>
                `;
                
                document.getElementById('previewContent').innerHTML = html;
                document.getElementById('previewSection').style.display = 'block';
            }
            
            function parseCSV(content) {
                const lines = content.split('\n').filter(l => l.trim());
                const headers = lines[0].split(',').map(h => h.trim());
                
                return lines.slice(1).map(line => {
                    const values = line.split(',');
                    const obj = {};
                    headers.forEach((header, i) => {
                        obj[header] = values[i] ? values[i].trim() : '';
                    });
                    return obj;
                });
            }
        };
        
        /**
         * Ex√©cute l'import
         */
        window.executeImport = async function() {
            const data = window.importData;
            if (!data) {
                showToast('‚ùå Aucune donn√©e √† importer', 'error');
                return;
            }
            
            const mergeMode = document.getElementById('mergeMode').checked;
            const ingredients = Array.isArray(data) ? data : (data.ingredients || []);
            
            try {
                const result = IngredientImporter.importFromJSON(
                    { ingredients }, 
                    mergeMode ? appState.data.ingredients : []
                );
                
                if (result.success) {
                    // Replace or merge ingredients
                    if (mergeMode) {
                        appState.data.ingredients = result.ingredients;
                    } else {
                        appState.data.ingredients = result.ingredients;
                    }
                    
                    saveData();
                    renderIngredientsPage();
                    closeModal('importModal');
                    
                    showToast(`‚úÖ ${result.new} nouveau(x) ingr√©dient(s) import√©(s) ! Total : ${result.total}`, 'success');
                } else {
                    showToast('‚ùå Erreur lors de l\'import', 'error');
                }
                
            } catch (error) {
                console.error('Import error:', error);
                showToast('‚ùå Erreur : ' + error.message, 'error');
            }
        };
        
        /**
         * Affiche le modal d'export
         */
        window.showExportModal = function() {
            const modal = document.createElement('div');
            modal.id = 'exportModal';
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <div class="modal-header">
                        <h2>üì§ Exporter les ingr√©dients</h2>
                        <button class="modal-close" onclick="closeModal('exportModal')">‚úï</button>
                    </div>
                    <div class="modal-body">
                        <!-- Stats -->
                        <div style="background: var(--light); padding: var(--space-md); border-radius: var(--radius-md); margin-bottom: var(--space-lg);">
                            <div style="font-size: 24px; font-weight: 700; color: var(--primary); margin-bottom: var(--space-sm);">
                                ${appState.data.ingredients.length}
                            </div>
                            <div style="color: var(--gray);">ingr√©dients dans votre base</div>
                        </div>
                        
                        <!-- Format Selection -->
                        <div style="margin-bottom: var(--space-lg);">
                            <label style="display: block; font-weight: 600; margin-bottom: var(--space-sm);">Format d'export</label>
                            <div style="display: flex; gap: var(--space-md);">
                                <label style="flex: 1; padding: var(--space-md); border: 2px solid var(--light); border-radius: var(--radius-md); cursor: pointer;">
                                    <input type="radio" name="exportFormat" value="json" checked>
                                    <div style="margin-top: var(--space-sm);">
                                        <strong>JSON</strong>
                                        <div style="font-size: 12px; color: var(--gray);">Format complet (recommand√©)</div>
                                    </div>
                                </label>
                                <label style="flex: 1; padding: var(--space-md); border: 2px solid var(--light); border-radius: var(--radius-md); cursor: pointer;">
                                    <input type="radio" name="exportFormat" value="csv">
                                    <div style="margin-top: var(--space-sm);">
                                        <strong>CSV</strong>
                                        <div style="font-size: 12px; color: var(--gray);">Compatible Excel</div>
                                    </div>
                                </label>
                            </div>
                        </div>
                        
                        <!-- JSON Options -->
                        <div id="jsonOptions" style="margin-bottom: var(--space-lg);">
                            <label style="display: block; font-weight: 600; margin-bottom: var(--space-sm);">Format JSON</label>
                            <select id="jsonFormat" style="width: 100%; padding: 12px; border: 2px solid var(--light); border-radius: var(--radius-md);">
                                <option value="array">Tableau simple (recommand√©)</option>
                                <option value="categories">Group√© par cat√©gories</option>
                                <option value="full">Complet avec m√©tadonn√©es</option>
                            </select>
                        </div>
                        
                        <!-- Actions -->
                        <div style="display: flex; gap: var(--space-md);">
                            <button type="button" class="btn" style="flex: 1; background: var(--gray); color: white;" onclick="closeModal('exportModal')">
                                Annuler
                            </button>
                            <button class="btn btn-primary" style="flex: 1;" onclick="executeExport()">
                                üì• T√©l√©charger
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Show/hide options based on format
            document.querySelectorAll('input[name="exportFormat"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    document.getElementById('jsonOptions').style.display = 
                        e.target.value === 'json' ? 'block' : 'none';
                });
            });
        };
        
        /**
         * Ex√©cute l'export
         */
        window.executeExport = function() {
            const format = document.querySelector('input[name="exportFormat"]:checked').value;
            const ingredients = appState.data.ingredients;
            
            if (ingredients.length === 0) {
                showToast('‚ùå Aucun ingr√©dient √† exporter', 'error');
                return;
            }
            
            try {
                if (format === 'json') {
                    const jsonFormat = document.getElementById('jsonFormat').value;
                    IngredientImporter.downloadJSON(ingredients, 'ingredients_export', jsonFormat);
                } else {
                    IngredientImporter.downloadCSV(ingredients, 'ingredients_export');
                }
                
                closeModal('exportModal');
                showToast(`‚úÖ ${ingredients.length} ingr√©dients export√©s !`, 'success');
                
            } catch (error) {
                console.error('Export error:', error);
                showToast('‚ùå Erreur lors de l\'export : ' + error.message, 'error');
            }
        };

        // Handle Add Ingredient
        // ========================================
        // MULTI-DEVISES (v51)
        // ========================================
        
        // Les taux de change sont maintenant dans appState.exchangeRates (configurables)
        
        // Met √† jour le champ de taux de change selon la devise s√©lectionn√©e
        window.updateExchangeRateField = function() {
            const currencySelect = document.getElementById('lotCurrency');
            const rateInput = document.getElementById('lotExchangeRate');
            const helper = document.getElementById('exchangeRateHelper');
            
            if (!currencySelect || !rateInput || !helper) return;
            
            const currency = currencySelect.value;
            
            if (currency === 'EUR') {
                // EUR : pas de conversion
                rateInput.value = '';
                rateInput.disabled = true;
                helper.textContent = 'Achat en EUR - Pas de conversion';
                helper.style.color = 'var(--gray)';
            } else {
                // Autre devise : pr√©-remplir avec taux actuel
                const rate = appState.exchangeRates[currency] || 1.0;
                rateInput.value = rate;
                rateInput.disabled = false;
                
                const symbol = currency === 'GBP' ? '¬£' : '$';
                helper.innerHTML = `
                    Taux sugg√©r√© : 1 ${symbol} = ${rate} ‚Ç¨
                    <br>
                    <span style="font-style: italic; font-size: 11px;">Modifiable si votre taux est diff√©rent</span>
                `;
                helper.style.color = '#f59e0b';
            }
        };
        
        // ========================================
        // INGREDIENT MANAGEMENT
        // ========================================
        
        async function handleAddIngredient(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = {
                name: formData.get('name'),
                category: formData.get('category'),
                baseUnit: formData.get('baseUnit'),
                alertBaseQty: Number(formData.get('alertQty')) || 0,
                // v51 : Rendements
                yieldPercent: Number(formData.get('yieldPercent')) || 100,
                wasteType: formData.get('wasteType') || ''
            };
            
            const receivedBy = formData.get('lotReceivedBy') || '';
            
            // v51 : Devise et taux de change
            const currency = formData.get('lotCurrency') || 'EUR';
            let exchangeRate = 1.0;
            
            if (currency !== 'EUR') {
                const inputRate = Number(formData.get('lotExchangeRate'));
                if (inputRate && inputRate > 0) {
                    exchangeRate = inputRate;
                } else {
                    exchangeRate = appState.exchangeRates[currency] || 1.0;
                }
            }
            
            const lotData = {
                quantity: Number(formData.get('lotQuantity')),
                unit: formData.get('lotUnit'),
                price: Number(formData.get('lotPrice')),
                fees: Number(formData.get('lotFees')) || 0,
                dlc: formData.get('lotDlc'),
                reception: formData.get('lotReception'),
                supplier: formData.get('lotSupplier'),
                lotNumber: formData.get('lotNumber'),
                receivedBy: receivedBy,
                // v51 : Multi-devises
                currency: currency,
                exchangeRate: exchangeRate
            };
            
            try {
                // Create ingredient using IngredientService
                const ingredient = IngredientService.create(data);
                
                // Add first lot
                const result = IngredientService.addLot(ingredient, lotData);
                
                // Save to state (convert to plain object for storage)
                appState.data.ingredients.push(result.ingredient.toJSON());
                saveData();
                
                // Close modal and refresh
                closeModal('addIngredientModal');
                e.target.reset();
                renderIngredientsPage();
                
                // Show success message with rendement info
                let successMsg = '‚úÖ Ingr√©dient ajout√© avec succ√®s !';
                if (data.yieldPercent < 100) {
                    const multiplier = (100 / data.yieldPercent).toFixed(2);
                    successMsg += ` (Rendement ${data.yieldPercent}% ‚Üí co√ªt √ó${multiplier})`;
                }
                showToast(successMsg, 'success');
                
            } catch (error) {
                console.error('Error:', error);
                showToast('‚ùå Erreur: ' + error.message, 'error');
            }
        }

        // Show Toast
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                top: 90px;
                right: 20px;
                background: ${type === 'success' ? 'var(--success)' : 'var(--danger)'};
                color: white;
                padding: 16px 24px;
                border-radius: var(--radius-md);
                box-shadow: var(--shadow-lg);
                z-index: 10000;
                animation: slideIn 0.3s ease;
            `;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // ========================================
        // INGREDIENT DETAILS
        // ========================================
        
        // Show ingredient details modal
        window.showIngredientDetails = function(ingredientId) {
            const ingredient = appState.data.ingredients.find(ing => ing.id === ingredientId);
            if (!ingredient) {
                showToast('‚ùå Ingr√©dient introuvable', 'error');
                return;
            }
            
            const stock = ingredient.getBaseQtyRemaining ? ingredient.getBaseQtyRemaining() : 0;
            // ‚úÖ CORRECTION: Utiliser IngredientService
            const stockValue = IngredientService.getStockValue(ingredient);
            const alerts = ingredient.getAlerts ? ingredient.getAlerts() : [];
            const avgCost = ingredient.getPricePerBaseUnit ? ingredient.getPricePerBaseUnit() : 0;
            
            // Sort lots by FIFO
            const lots = ingredient.lots || [];
            const availableLots = lots.filter(l => !l.epuise && l.quantite > 0);
            const emptyLots = lots.filter(l => l.epuise || l.quantite === 0);
            
            const modal = document.createElement('div');
            modal.id = 'ingredientDetailsModal';
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 900px;">
                    <div class="modal-header">
                        <h2>üìã ${ingredient.name}</h2>
                        <button class="modal-close" onclick="closeModal('ingredientDetailsModal')">‚úï</button>
                    </div>
                    <div class="modal-body">
                        <!-- Rendement Info -->
                        ${(() => {
                            const yieldPercent = Number(ingredient.yieldPercent);
                            if (yieldPercent && yieldPercent > 0 && yieldPercent < 100) {
                                return `
                                    <div style="background: linear-gradient(135deg, #fff9e6 0%, #fff3d6 100%); padding: var(--space-md); border-radius: var(--radius-md); margin-bottom: var(--space-lg); border-left: 4px solid #f59e0b;">
                                        <div style="display: flex; align-items: center; gap: var(--space-sm);">
                                            <span style="font-size: 24px;">üìä</span>
                                            <div>
                                                <strong style="color: #f59e0b;">Rendement : ${yieldPercent}%</strong>
                                                ${ingredient.wasteType ? `
                                                    <div style="font-size: 13px; color: var(--gray); margin-top: 4px;">
                                                        Type de d√©chet : ${ingredient.wasteType}
                                                    </div>
                                                ` : ''}
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }
                            return '';
                        })()}
                        
                        <!-- Summary Stats -->
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: var(--space-md); margin-bottom: var(--space-lg);">
                            <div class="stat-card primary">
                                <div class="stat-label">Stock Total</div>
                                <div class="stat-value">${stock} ${ingredient.baseUnit}</div>
                            </div>
                            <div class="stat-card success">
                                <div class="stat-label">Valeur Stock</div>
                                <div class="stat-value">${formatCurrency(stockValue)}</div>
                            </div>
                            <div class="stat-card warning">
                                <div class="stat-label">Co√ªt Moyen</div>
                                <div class="stat-value">${formatCurrency(avgCost)}/${ingredient.baseUnit}</div>
                            </div>
                            <div class="stat-card danger">
                                <div class="stat-label">Lots Actifs</div>
                                <div class="stat-value">${availableLots.length}</div>
                            </div>
                        </div>
                        
                        <!-- Alerts -->
                        ${alerts.length > 0 ? `
                            <div style="background: #FFF3CD; padding: var(--space-md); border-radius: var(--radius-md); margin-bottom: var(--space-lg); border-left: 4px solid #FFA502;">
                                <h3 style="margin-bottom: var(--space-sm); color: #856404;">‚ö†Ô∏è Alertes (${alerts.length})</h3>
                                ${alerts.map(alert => `
                                    <div style="padding: 8px 0; color: #856404;">
                                        ${alert.severity === 'error' ? 'üî¥' : '‚ö†Ô∏è'} ${alert.message}
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        
                        <!-- Available Lots -->
                        <h3 style="margin-bottom: var(--space-md);">üì¶ Lots Disponibles (${availableLots.length})</h3>
                        ${availableLots.length > 0 ? `
                            <div style="overflow-x: auto; margin-bottom: var(--space-xl);">
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead style="background: var(--light);">
                                        <tr>
                                            <th style="padding: 12px; text-align: left;">N¬∞ Lot</th>
                                            <th style="padding: 12px; text-align: left;">Fournisseur</th>
                                            <th style="padding: 12px; text-align: right;">Qt√© Restante</th>
                                            <th style="padding: 12px; text-align: right;">Valeur</th>
                                            <th style="padding: 12px; text-align: left;">DLC</th>
                                            <th style="padding: 12px; text-align: left;">R√©ception</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${availableLots.map(lot => {
                                            const dlcDate = new Date(lot.dlc);
                                            const now = new Date();
                                            const daysLeft = Math.ceil((dlcDate - now) / (1000 * 60 * 60 * 24));
                                            const dlcColor = daysLeft <= 0 ? '#dc2626' : daysLeft <= 2 ? '#dc2626' : daysLeft <= 7 ? 'var(--warning)' : 'var(--success)';
                                            let dlcBadge = '';
                                            if (daysLeft <= 0) dlcBadge = `<span style="background:#dc2626;color:white;font-size:11px;font-weight:700;padding:2px 6px;border-radius:4px;margin-left:4px;">EXPIR√â</span>`;
                                            else if (daysLeft === 1) dlcBadge = `<span style="background:#dc2626;color:white;font-size:11px;font-weight:700;padding:2px 6px;border-radius:4px;margin-left:4px;">J-1 ‚ö†Ô∏è</span>`;
                                            else if (daysLeft === 2) dlcBadge = `<span style="background:var(--warning);color:white;font-size:11px;font-weight:700;padding:2px 6px;border-radius:4px;margin-left:4px;">J-2 ‚ö†Ô∏è</span>`;
                                            const lotValue = lot.getValeurActuelle ? lot.getValeurActuelle() : (lot.quantite * ((lot.prixTotal + (lot.fraisApproche||0)) / (lot.quantiteInitiale || 1)));
                                            
                                            return `
                                                <tr style="border-bottom: 1px solid var(--light);${daysLeft <= 2 ? 'background:#fff5f5;' : ''}">
                                                    <td style="padding: 12px;">${lot.numeroLot || lot.id.slice(0, 8)}</td>
                                                    <td style="padding: 12px;">${lot.fournisseur || '-'}</td>
                                                    <td style="padding: 12px; text-align: right; font-weight: 600;">${lot.quantite} ${ingredient.baseUnit}</td>
                                                    <td style="padding: 12px; text-align: right;">${formatCurrency(lotValue)}</td>
                                                    <td style="padding: 12px; color: ${dlcColor}; font-weight: 600;">
                                                        ${dlcDate.toLocaleDateString('fr-FR')}
                                                        ${dlcBadge}
                                                    </td>
                                                    <td style="padding: 12px;">${lot.dateReception ? new Date(lot.dateReception).toLocaleDateString('fr-FR') : '-'}</td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : `
                            <div style="text-align: center; padding: var(--space-xl); color: var(--gray);">
                                üì¶ Aucun lot disponible
                            </div>
                        `}
                        
                        <!-- Empty Lots History -->
                        ${emptyLots.length > 0 ? `
                            <details style="margin-top: var(--space-lg);">
                                <summary style="cursor: pointer; font-weight: 600; margin-bottom: var(--space-md);">
                                    üìú Historique Lots √âpuis√©s (${emptyLots.length})
                                </summary>
                                <div style="overflow-x: auto;">
                                    <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                                        <thead style="background: var(--light);">
                                            <tr>
                                                <th style="padding: 10px; text-align: left;">N¬∞ Lot</th>
                                                <th style="padding: 10px; text-align: left;">Fournisseur</th>
                                                <th style="padding: 10px; text-align: right;">Qt√© Initiale</th>
                                                <th style="padding: 10px; text-align: left;">DLC</th>
                                                <th style="padding: 10px; text-align: left;">R√©ception</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${emptyLots.map(lot => `
                                                <tr style="border-bottom: 1px solid var(--light); opacity: 0.6;">
                                                    <td style="padding: 10px;">${lot.numeroLot || lot.id.slice(0, 8)}</td>
                                                    <td style="padding: 10px;">${lot.fournisseur || '-'}</td>
                                                    <td style="padding: 10px; text-align: right;">${lot.quantiteInitiale} ${ingredient.baseUnit}</td>
                                                    <td style="padding: 10px;">${new Date(lot.dlc).toLocaleDateString('fr-FR')}</td>
                                                    <td style="padding: 10px;">${new Date(lot.dateReception).toLocaleDateString('fr-FR')}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </details>
                        ` : ''}
                        
                        <!-- Loss History for this ingredient -->
                        ${(() => {
                            const ingLosses = (appState.data.lossHistory || []).filter(l => l.ingredientId === ingredientId).slice(-8).reverse();
                            if (ingLosses.length === 0) return '';
                            return `
                                <h3 style="margin-bottom:var(--space-md);margin-top:var(--space-xl);">üìâ Derni√®res pertes (${ingLosses.length})</h3>
                                <div style="overflow-x:auto;margin-bottom:var(--space-lg);">
                                    <table style="width:100%;border-collapse:collapse;font-size:13px;">
                                        <thead style="background:var(--light);">
                                            <tr>
                                                <th style="padding:10px;text-align:left;">Date</th>
                                                <th style="padding:10px;text-align:left;">Motif</th>
                                                <th style="padding:10px;text-align:right;">Quantit√©</th>
                                                <th style="padding:10px;text-align:right;">Valeur</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${ingLosses.map(l => `
                                                <tr style="border-bottom:1px solid var(--light);">
                                                    <td style="padding:10px;">${new Date(l.timestamp).toLocaleDateString('fr-FR')}</td>
                                                    <td style="padding:10px;">${l.reason === 'chaine_froid' ? '‚ùÑÔ∏è Cha√Æne du froid' : l.reason === 'perime' ? 'üïê P√©rim√©' : l.reason === 'casse' ? 'üí• Casse' : l.reason}</td>
                                                    <td style="padding:10px;text-align:right;font-weight:600;color:var(--danger);">-${l.quantity} ${l.unit}</td>
                                                    <td style="padding:10px;text-align:right;">${formatCurrency(l.value || 0)}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            `;
                        })()}
                        
                        <!-- Actions -->
                        <div style="display: flex; gap: var(--space-md); margin-top: var(--space-xl); flex-wrap:wrap;">
                            <button class="btn btn-primary" onclick="closeModal('ingredientDetailsModal'); showAddLotModal('${ingredientId}');">
                                ‚ûï R√©ception
                            </button>
                            <button class="btn" style="background: var(--danger); color: white;" onclick="closeModal('ingredientDetailsModal'); showRecordLossModal('${ingredientId}');">
                                üóë Perte
                            </button>
                            <button class="btn" style="background: var(--secondary); color: white;" onclick="closeModal('ingredientDetailsModal'); showInventoryModal('${ingredientId}');">
                                üìã Inventaire
                            </button>
                            <button class="btn" style="background: var(--gray); color: white; margin-left: auto;" onclick="closeModal('ingredientDetailsModal')">
                                Fermer
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        };

        // ========================================
        // ADD LOT
        // ========================================
        
        window.showAddLotModal = function(ingredientId) {
            const ingredient = appState.data.ingredients.find(ing => ing.id === ingredientId);
            if (!ingredient) {
                showToast('‚ùå Ingr√©dient introuvable', 'error');
                return;
            }
            
            const modal = document.createElement('div');
            modal.id = 'addLotModal';
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>‚ûï Ajouter un lot - ${ingredient.name}</h2>
                        <button class="modal-close" onclick="closeModal('addLotModal')">‚úï</button>
                    </div>
                    <div class="modal-body">
                        <form id="addLotForm">
                            <input type="hidden" name="ingredientId" value="${ingredientId}">
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Quantit√© *</label>
                                    <input type="number" name="quantity" required placeholder="Ex: 25" min="0" step="0.01">
                                </div>
                                <div class="form-group">
                                    <label>Unit√© *</label>
                                    <select name="unit" required>
                                        <option value="${ingredient.baseUnit}">${ingredient.baseUnit}</option>
                                        ${ingredient.baseUnit === 'g' ? '<option value="kg">kg</option>' : ''}
                                        ${ingredient.baseUnit === 'ml' ? '<option value="L">L</option>' : ''}
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Prix d'achat HT *</label>
                                    <input type="number" name="price" required placeholder="Ex: 15000" min="0" step="0.01">
                                </div>
                                <div class="form-group">
                                    <label>Frais d'approche</label>
                                    <input type="number" name="fees" placeholder="Ex: 500" min="0" step="0.01" value="0">
                                </div>
                            </div>
                            
                            <!-- Multi-devises (v51) -->
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Devise d'achat *</label>
                                    <select name="currency" id="lotCurrencyModal" required onchange="updateExchangeRateFieldModal()">
                                        <option value="EUR">‚Ç¨ Euro (par d√©faut)</option>
                                        <option value="GBP">¬£ Livre Sterling</option>
                                        <option value="USD">$ Dollar US</option>
                                    </select>
                                    <small style="color: var(--gray);">Devise utilis√©e pour cet achat</small>
                                </div>
                                <div class="form-group">
                                    <label>Taux de change (vers EUR)</label>
                                    <input type="number" name="exchangeRate" id="lotExchangeRateModal" placeholder="Auto" min="0" step="0.0001" disabled>
                                    <small style="color: var(--gray);" id="exchangeRateHelperModal">
                                        Achat en EUR - Pas de conversion
                                    </small>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Co√ªt unitaire calcul√©</label>
                                <div id="calculatedCost" style="padding: 12px; background: var(--light); border-radius: var(--radius-md); font-weight: 600; color: var(--primary);">
                                    - ‚Ç¨/${ingredient.baseUnit}
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>DLC *</label>
                                    <input type="date" name="dlc" required>
                                </div>
                                <div class="form-group">
                                    <label>Date r√©ception *</label>
                                    <input type="date" name="reception" required>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Fournisseur</label>
                                <input type="text" name="supplier" placeholder="Nom du fournisseur">
                            </div>
                            
                            <div class="form-group">
                                <label>Num√©ro de lot</label>
                                <input type="text" name="lotNumber" placeholder="Ex: LOT123456">
                            </div>
                            
                            <div style="display: flex; gap: var(--space-md); margin-top: var(--space-lg);">
                                <button type="button" class="btn" style="flex: 1; background: var(--gray); color: white;" onclick="closeModal('addLotModal')">
                                    Annuler
                                </button>
                                <button type="submit" class="btn btn-primary" style="flex: 1;">
                                    ‚úÖ Ajouter le lot
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Set default dates
            const today = new Date().toISOString().split('T')[0];
            modal.querySelector('[name="reception"]').value = today;
            
            const futureDate = new Date();
            futureDate.setMonth(futureDate.getMonth() + 6);
            modal.querySelector('[name="dlc"]').value = futureDate.toISOString().split('T')[0];
            
            // Calculate cost on input
            const priceInput = modal.querySelector('[name="price"]');
            const feesInput = modal.querySelector('[name="fees"]');
            const qtyInput = modal.querySelector('[name="quantity"]');
            const unitSelect = modal.querySelector('[name="unit"]');
            
            function updateCost() {
                const price = Number(priceInput.value) || 0;
                const fees = Number(feesInput.value) || 0;
                let qty = Number(qtyInput.value) || 0;
                const unit = unitSelect.value;
                
                // Convert to base unit
                if (unit === 'kg' && ingredient.baseUnit === 'g') qty *= 1000;
                if (unit === 'L' && ingredient.baseUnit === 'ml') qty *= 1000;
                
                if (qty > 0) {
                    const unitCost = (price + fees) / qty;
                    // Show with 2 decimals for precision
                    modal.querySelector('#calculatedCost').textContent = unitCost.toFixed(2) + ' ‚Ç¨/' + ingredient.baseUnit;
                }
            }
            
            priceInput.addEventListener('input', updateCost);
            feesInput.addEventListener('input', updateCost);
            qtyInput.addEventListener('input', updateCost);
            unitSelect.addEventListener('change', updateCost);
            
            // Fonction pour mettre √† jour le taux de change dans ce modal
            window.updateExchangeRateFieldModal = function() {
                const currencySelect = document.getElementById('lotCurrencyModal');
                const rateInput = document.getElementById('lotExchangeRateModal');
                const helper = document.getElementById('exchangeRateHelperModal');
                
                if (!currencySelect || !rateInput || !helper) return;
                
                const currency = currencySelect.value;
                
                if (currency === 'EUR') {
                    rateInput.value = '';
                    rateInput.disabled = true;
                    helper.textContent = 'Achat en EUR - Pas de conversion';
                    helper.style.color = 'var(--gray)';
                } else {
                    const rate = appState.exchangeRates[currency] || 1.0;
                    rateInput.value = rate;
                    rateInput.disabled = false;
                    
                    const symbol = currency === 'GBP' ? '¬£' : '$';
                    helper.innerHTML = `
                        Taux sugg√©r√© : 1 ${symbol} = ${rate} ‚Ç¨
                        <br>
                        <span style="font-style: italic; font-size: 11px;">Modifiable si votre taux est diff√©rent</span>
                    `;
                    helper.style.color = '#f59e0b';
                }
            };
            
            // Handle form submit
            modal.querySelector('#addLotForm').addEventListener('submit', handleAddLot);
        };
        
        async function handleAddLot(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const ingredientId = formData.get('ingredientId');
            
            const ingredient = appState.data.ingredients.find(ing => ing.id === ingredientId);
            if (!ingredient) {
                showToast('‚ùå Ingr√©dient introuvable', 'error');
                return;
            }
            
            let quantity = Number(formData.get('quantity'));
            const unit = formData.get('unit');
            
            // Convert to base unit for display
            let addedQty = quantity;
            if (unit === 'kg' && ingredient.baseUnit === 'g') addedQty = quantity * 1000;
            if (unit === 'L' && ingredient.baseUnit === 'ml') addedQty = quantity * 1000;
            
            const lotData = {
                quantity: quantity,
                unit: unit,
                price: Number(formData.get('price')),
                fees: Number(formData.get('fees')) || 0,
                dlc: formData.get('dlc'),
                reception: formData.get('reception'),
                supplier: formData.get('supplier'),
                lotNumber: formData.get('lotNumber'),
                // v51 : Multi-devises
                currency: formData.get('currency') || 'EUR',
                exchangeRate: formData.get('currency') === 'EUR' ? 1.0 : (Number(formData.get('exchangeRate')) || 1.0)
            };
            
            try {
                const result = IngredientService.addLot(ingredient, lotData);
                
                // Update in state
                const index = appState.data.ingredients.findIndex(ing => ing.id === ingredientId);
                if (index !== -1) {
                    appState.data.ingredients[index] = result.ingredient;
                }
                
                saveData();
                closeModal('addLotModal');
                renderIngredientsPage();
                
                showToast(`‚úÖ Lot ajout√© ! +${addedQty} ${ingredient.baseUnit}`, 'success');
                
            } catch (error) {
                console.error('Error:', error);
                showToast('‚ùå Erreur: ' + error.message, 'error');
            }
        }

        // ========================================
        // RECORD LOSS
        // ========================================
        
        window.showRecordLossModal = function(ingredientId) {
            const ingredient = appState.data.ingredients.find(ing => ing.id === ingredientId);
            if (!ingredient) {
                showToast('‚ùå Ingr√©dient introuvable', 'error');
                return;
            }
            
            const stock = ingredient.getBaseQtyRemaining ? ingredient.getBaseQtyRemaining() : 0;
            
            const modal = document.createElement('div');
            modal.id = 'recordLossModal';
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>‚ùå Enregistrer une perte - ${ingredient.name}</h2>
                        <button class="modal-close" onclick="closeModal('recordLossModal')">‚úï</button>
                    </div>
                    <div class="modal-body">
                        <div style="background: var(--light); padding: var(--space-md); border-radius: var(--radius-md); margin-bottom: var(--space-lg);">
                            <strong>Stock actuel :</strong> ${stock} ${ingredient.baseUnit}
                        </div>
                        
                        <form id="recordLossForm">
                            <input type="hidden" name="ingredientId" value="${ingredientId}">
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Quantit√© perdue *</label>
                                    <input type="number" name="quantity" required placeholder="Ex: 500" min="0.01" max="${stock}" step="0.01">
                                </div>
                                <div class="form-group">
                                    <label>Unit√©</label>
                                    <select name="unit">
                                        <option value="${ingredient.baseUnit}">${ingredient.baseUnit}</option>
                                        ${ingredient.baseUnit === 'g' ? '<option value="kg">kg</option>' : ''}
                                        ${ingredient.baseUnit === 'ml' ? '<option value="L">L</option>' : ''}
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Raison de la perte *</label>
                                <select name="reason" required>
                                    <option value="">S√©lectionner...</option>
                                    <option value="perime">üïê P√©rim√© (DLC d√©pass√©e)</option>
                                    <option value="chaine_froid">‚ùÑÔ∏è Cha√Æne du froid rompue</option>
                                    <option value="casse">üí• Casse / D√©t√©rioration physique</option>
                                    <option value="contamination">‚ò£Ô∏è Contamination / Hygi√®ne</option>
                                    <option value="qualite">‚ö†Ô∏è Probl√®me qualit√©</option>
                                    <option value="vol">üîí Vol / Disparition</option>
                                    <option value="autre">‚ùì Autre</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>Notes / D√©tails</label>
                                <textarea name="notes" rows="3" placeholder="Pr√©cisions sur la perte..." style="width: 100%; padding: 12px; border: 2px solid var(--light); border-radius: var(--radius-md); font-family: var(--font-body);"></textarea>
                            </div>
                            
                            <div style="display: flex; gap: var(--space-md); margin-top: var(--space-lg);">
                                <button type="button" class="btn" style="flex: 1; background: var(--gray); color: white;" onclick="closeModal('recordLossModal')">
                                    Annuler
                                </button>
                                <button type="button" class="btn" style="background:#ff6b35;color:white;padding:10px 16px;" title="Mettre le stock √† z√©ro (tout jeter)" onclick="document.querySelector('[name=quantity]').value=${stock}; document.querySelector('[name=quantity]').dispatchEvent(new Event('change'));">
                                    üóë Tout jeter
                                </button>
                                <button type="submit" class="btn" style="flex: 1; background: var(--danger); color: white;">
                                    ‚ùå Enregistrer la perte
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            modal.querySelector('#recordLossForm').addEventListener('submit', handleRecordLoss);
        };
        
        async function handleRecordLoss(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const ingredientId = formData.get('ingredientId');
            
            const ingredient = appState.data.ingredients.find(ing => ing.id === ingredientId);
            if (!ingredient) {
                showToast('‚ùå Ingr√©dient introuvable', 'error');
                return;
            }
            
            let quantity = Number(formData.get('quantity'));
            const unit = formData.get('unit');
            
            // Convert to base unit
            if (unit === 'kg' && ingredient.baseUnit === 'g') quantity *= 1000;
            if (unit === 'L' && ingredient.baseUnit === 'ml') quantity *= 1000;
            
            const reason = formData.get('reason');
            const notes = formData.get('notes');
            
            try {
                // IngredientService.recordLoss signature: (ingredient, quantity, reason)
                const result = IngredientService.recordLoss(
                    ingredient,
                    quantity,
                    `${reason}${notes ? ' - ' + notes : ''}`
                );
                
                // Update in state
                const index = appState.data.ingredients.findIndex(ing => ing.id === ingredientId);
                if (index !== -1) {
                    appState.data.ingredients[index] = result.ingredient;
                }
                
                saveData();
                closeModal('recordLossModal');
                renderIngredientsPage();
                
                // Calculate loss value from lotsUsed
                const lossValue = result.lotsUsed ? 
                    result.lotsUsed.reduce((sum, l) => sum + l.cost, 0) : 0;
                
                // Track in lossHistory for dashboard KPIs
                if (!appState.data.lossHistory) appState.data.lossHistory = [];
                appState.data.lossHistory.push({
                    id: 'loss_' + Date.now(),
                    timestamp: new Date().toISOString(),
                    ingredientId,
                    ingredientName: ingredient.name,
                    quantity,
                    unit: ingredient.baseUnit,
                    reason,
                    notes,
                    value: lossValue
                });
                saveData();
                
                showToast(`‚úÖ Perte enregistr√©e : -${quantity} ${ingredient.baseUnit} (${formatCurrency(lossValue)})`, 'success');
                
            } catch (error) {
                console.error('Error:', error);
                showToast('‚ùå Erreur: ' + error.message, 'error');
            }
        }

        // ========================================
        // INVENTORY
        // ========================================
        
        window.showInventoryModal = function(ingredientId) {
            const ingredient = appState.data.ingredients.find(ing => ing.id === ingredientId);
            if (!ingredient) {
                showToast('‚ùå Ingr√©dient introuvable', 'error');
                return;
            }
            
            const currentStock = ingredient.getBaseQtyRemaining ? ingredient.getBaseQtyRemaining() : 0;
            
            const modal = document.createElement('div');
            modal.id = 'inventoryModal';
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>üìä Inventaire - ${ingredient.name}</h2>
                        <button class="modal-close" onclick="closeModal('inventoryModal')">‚úï</button>
                    </div>
                    <div class="modal-body">
                        <div style="background: var(--light); padding: var(--space-md); border-radius: var(--radius-md); margin-bottom: var(--space-lg);">
                            <strong>Stock syst√®me actuel :</strong> ${currentStock} ${ingredient.baseUnit}
                        </div>
                        
                        <form id="inventoryForm">
                            <input type="hidden" name="ingredientId" value="${ingredientId}">
                            <input type="hidden" name="currentStock" value="${currentStock}">
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Stock r√©el compt√© *</label>
                                    <input type="number" id="countedStock" name="countedStock" required placeholder="Ex: ${currentStock}" min="0" step="0.01">
                                </div>
                                <div class="form-group">
                                    <label>Unit√©</label>
                                    <select name="unit">
                                        <option value="${ingredient.baseUnit}">${ingredient.baseUnit}</option>
                                        ${ingredient.baseUnit === 'g' ? '<option value="kg">kg</option>' : ''}
                                        ${ingredient.baseUnit === 'ml' ? '<option value="L">L</option>' : ''}
                                    </select>
                                </div>
                            </div>
                            
                            <div id="differenceDisplay" style="padding: var(--space-md); border-radius: var(--radius-md); margin-bottom: var(--space-md); display: none;">
                                <strong>Diff√©rence :</strong> <span id="differenceValue"></span>
                            </div>
                            
                            <div class="form-group">
                                <label>Raison de l'ajustement *</label>
                                <select name="reason" required>
                                    <option value="">S√©lectionner...</option>
                                    <option value="inventaire">Inventaire p√©riodique</option>
                                    <option value="erreur_saisie">Erreur de saisie</option>
                                    <option value="casse_non_enregistree">Casse non enregistr√©e</option>
                                    <option value="vol">Vol d√©tect√©</option>
                                    <option value="autre">Autre</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>Notes / Justification *</label>
                                <textarea name="notes" rows="3" required placeholder="Expliquer la raison de l'√©cart..." style="width: 100%; padding: 12px; border: 2px solid var(--light); border-radius: var(--radius-md); font-family: var(--font-body);"></textarea>
                            </div>
                            
                            <div style="display: flex; gap: var(--space-md); margin-top: var(--space-lg);">
                                <button type="button" class="btn" style="flex: 1; background: var(--gray); color: white;" onclick="closeModal('inventoryModal')">
                                    Annuler
                                </button>
                                <button type="submit" class="btn btn-primary" style="flex: 1;">
                                    ‚úÖ Ajuster le stock
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Calculate difference on input
            const countedInput = modal.querySelector('#countedStock');
            const unitSelect = modal.querySelector('[name="unit"]');
            const diffDisplay = modal.querySelector('#differenceDisplay');
            const diffValue = modal.querySelector('#differenceValue');
            
            function updateDifference() {
                let counted = Number(countedInput.value) || 0;
                const unit = unitSelect.value;
                
                // Convert to base unit
                if (unit === 'kg' && ingredient.baseUnit === 'g') counted *= 1000;
                if (unit === 'L' && ingredient.baseUnit === 'ml') counted *= 1000;
                
                const diff = counted - currentStock;
                
                if (countedInput.value) {
                    diffDisplay.style.display = 'block';
                    if (diff > 0) {
                        diffDisplay.style.background = '#d4edda';
                        diffDisplay.style.color = '#155724';
                        diffValue.textContent = `+${diff} ${ingredient.baseUnit} (Exc√©dent)`;
                    } else if (diff < 0) {
                        diffDisplay.style.background = '#f8d7da';
                        diffDisplay.style.color = '#721c24';
                        diffValue.textContent = `${diff} ${ingredient.baseUnit} (Manquant)`;
                    } else {
                        diffDisplay.style.background = '#d4edda';
                        diffDisplay.style.color = '#155724';
                        diffValue.textContent = `Aucune diff√©rence (Stock correct)`;
                    }
                }
            }
            
            countedInput.addEventListener('input', updateDifference);
            unitSelect.addEventListener('change', updateDifference);
            
            modal.querySelector('#inventoryForm').addEventListener('submit', handleInventory);
        };
        
        async function handleInventory(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const ingredientId = formData.get('ingredientId');
            
            const ingredient = appState.data.ingredients.find(ing => ing.id === ingredientId);
            if (!ingredient) {
                showToast('‚ùå Ingr√©dient introuvable', 'error');
                return;
            }
            
            let counted = Number(formData.get('countedStock'));
            const unit = formData.get('unit');
            
            // Convert to base unit
            if (unit === 'kg' && ingredient.baseUnit === 'g') counted *= 1000;
            if (unit === 'L' && ingredient.baseUnit === 'ml') counted *= 1000;
            
            const currentStock = Number(formData.get('currentStock'));
            const reason = formData.get('reason');
            const notes = formData.get('notes');
            
            try {
                const result = IngredientService.adjustInventory(ingredient, {
                    newQuantity: counted,
                    reason,
                    notes,
                    date: new Date().toISOString()
                });
                
                // Update in state
                const index = appState.data.ingredients.findIndex(ing => ing.id === ingredientId);
                if (index !== -1) {
                    appState.data.ingredients[index] = result.ingredient;
                }
                
                saveData();
                closeModal('inventoryModal');
                renderIngredientsPage();
                
                const diff = counted - currentStock;
                const diffText = diff > 0 ? `+${diff}` : `${diff}`;
                showToast(`‚úÖ Inventaire ajust√© : ${diffText} ${ingredient.baseUnit}`, 'success');
                
            } catch (error) {
                console.error('Error:', error);
                showToast('‚ùå Erreur: ' + error.message, 'error');
            }
        }
        
        // Placeholder functions
        window.showIngredientDetails_OLD = function(id) {
            showToast('üìã D√©tails - En d√©veloppement', 'info');
        };

        window.showAddLotModal_OLD = function(id) {
            showToast('‚ûï Ajout lot - En d√©veloppement', 'info');
        };

        window.showRecordLossModal_OLD = function(id) {
            showToast('‚ùå Perte - En d√©veloppement', 'info');
        };

        window.showInventoryModal_OLD = function(id) {
            showToast('üìä Inventaire - En d√©veloppement', 'info');
        };

        // ========================================
        // SETTINGS PAGE
        // ========================================
        
        function renderSettingsPage() {
            const html = `
                <div class="page-header">
                    <h1>‚öôÔ∏è Param√®tres</h1>
                </div>
                
                <div style="max-width: 800px; margin: 0 auto;">
                    <!-- Exchange Rates Section -->
                    <div style="background: white; padding: var(--space-xl); border-radius: var(--radius-lg); box-shadow: var(--shadow-sm); margin-bottom: var(--space-xl);">
                        <h2 style="margin-bottom: var(--space-md); font-family: var(--font-display);">
                            üí± Taux de change
                        </h2>
                        <p style="color: var(--gray); margin-bottom: var(--space-lg);">
                            Configurez les taux de change utilis√©s lors de l'ajout de lots en devises √©trang√®res. 
                            Ces taux sont utilis√©s pour convertir automatiquement les prix en EUR.
                        </p>
                        
                        <form id="exchangeRatesForm">
                            <div class="form-group">
                                <label>‚Ç¨ Euro (EUR) - Base de r√©f√©rence</label>
                                <input type="number" value="1.00" disabled style="background: var(--light); cursor: not-allowed;">
                                <small style="color: var(--gray);">L'Euro est la devise de r√©f√©rence (taux fixe = 1.00)</small>
                            </div>
                            
                            <div class="form-group">
                                <label>¬£ Livre Sterling (GBP) ‚Üí EUR</label>
                                <input type="number" id="rateGBP" name="GBP" value="${appState.exchangeRates.GBP}" min="0" step="0.0001" required>
                                <small style="color: var(--gray);">
                                    Exemple : Si 1 ¬£ = 0.85 ‚Ç¨, entrez <strong>0.85</strong>
                                </small>
                            </div>
                            
                            <div class="form-group">
                                <label>$ Dollar US (USD) ‚Üí EUR</label>
                                <input type="number" id="rateUSD" name="USD" value="${appState.exchangeRates.USD}" min="0" step="0.0001" required>
                                <small style="color: var(--gray);">
                                    Exemple : Si 1 $ = 1.09 ‚Ç¨, entrez <strong>1.09</strong>
                                </small>
                            </div>
                            
                            <div style="background: linear-gradient(135deg, #fff9e6 0%, #fff3d6 100%); padding: var(--space-md); border-radius: var(--radius-md); margin-bottom: var(--space-lg); border-left: 4px solid #f59e0b;">
                                <div style="display: flex; align-items: flex-start; gap: var(--space-sm);">
                                    <span style="font-size: 20px;">üí°</span>
                                    <div style="flex: 1;">
                                        <strong style="color: #f59e0b; display: block; margin-bottom: 4px;">Comment trouver le bon taux ?</strong>
                                        <p style="margin: 0; font-size: 13px; line-height: 1.5; color: #78350f;">
                                            Utilisez le <strong>taux r√©el appliqu√© par votre banque</strong> lors de vos achats en devises.
                                            <br>
                                            Vous pouvez le trouver sur votre relev√© bancaire ou demander √† votre conseiller.
                                            <br><br>
                                            <strong>Astuce :</strong> Ces taux ne changent que l√©g√®rement d'un mois √† l'autre. 
                                            Mettez-les √† jour 1 fois par mois suffit pour la plupart des restaurants.
                                        </p>
                                    </div>
                                </div>
                            </div>
                            
                            <button type="submit" class="btn btn-primary" style="width: 100%;">
                                üíæ Enregistrer les taux de change
                            </button>
                        </form>
                    </div>
                    
                    <!-- üí∞ COEFFICIENT D√âPENSES FIXES -->
                    <div style="background: white; padding: var(--space-xl); border-radius: var(--radius-lg); box-shadow: var(--shadow-sm); margin-bottom: var(--space-xl);">
                        <h2 style="margin-bottom: var(--space-md); font-family: var(--font-display);">
                            üí∞ Coefficient d√©penses fixes
                        </h2>
                        <p style="color: var(--gray); margin-bottom: var(--space-lg);">
                            Ce coefficient permet d'int√©grer les <strong>d√©penses fixes</strong> (loyer, salaires, √©lectricit√©, etc.) 
                            dans le calcul du <strong>co√ªt r√©el</strong> de vos produits et packs.
                        </p>
                        
                        <form id="overheadForm">
                            <div class="form-group">
                                <label>Coefficient multiplicateur</label>
                                <input type="number" id="overheadCoefficient" value="${appState.data.settings?.overheadCoefficient || 1.40}" min="1" max="5" step="0.01" required>
                                <small style="color: var(--gray);">
                                    <strong>Valeur par d√©faut : 1.40</strong> (40% de d√©penses fixes)
                                    <br>
                                    Exemple : Co√ªt ingr√©dients 10‚Ç¨ √ó 1.40 = <strong>14‚Ç¨ co√ªt r√©el</strong>
                                </small>
                            </div>
                            
                            <div style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); padding: var(--space-md); border-radius: var(--radius-md); margin-bottom: var(--space-lg); border-left: 4px solid var(--info);">
                                <div style="display: flex; align-items: flex-start; gap: var(--space-sm);">
                                    <span style="font-size: 20px;">üìä</span>
                                    <div style="flex: 1;">
                                        <strong style="color: var(--info); display: block; margin-bottom: 4px;">Comment calculer votre coefficient ?</strong>
                                        <p style="margin: 0; font-size: 13px; line-height: 1.5; color: #0c4a6e;">
                                            <strong>Formule : Coefficient = 1 + (D√©penses fixes mensuelles / Chiffre d'affaires mensuel)</strong>
                                            <br><br>
                                            <strong>Exemple :</strong>
                                            <br>‚Ä¢ D√©penses fixes mensuelles : 2 000 ‚Ç¨
                                            <br>‚Ä¢ CA mensuel : 5 000 ‚Ç¨
                                            <br>‚Ä¢ Coefficient = 1 + (2000 / 5000) = <strong>1.40</strong>
                                            <br><br>
                                            üí° <strong>Valeurs typiques :</strong>
                                            <br>‚Ä¢ Restaurant haute gamme : <strong>1.20 - 1.30</strong> (20-30%)
                                            <br>‚Ä¢ Restaurant standard : <strong>1.35 - 1.45</strong> (35-45%)
                                            <br>‚Ä¢ Food truck / Point chaud : <strong>1.50 - 1.70</strong> (50-70%)
                                        </p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: var(--space-xs);">
                                    <input type="checkbox" id="showDirectCost" ${appState.data.settings?.showDirectCost !== false ? 'checked' : ''}>
                                    <span>Afficher co√ªt direct ET co√ªt total dans les packs</span>
                                </label>
                                <small style="color: var(--gray); margin-left: 24px;">
                                    Affiche : <strong>Co√ªt direct : 10‚Ç¨</strong> puis <strong>Co√ªt total (√ó1.40) : 14‚Ç¨</strong>
                                </small>
                            </div>
                            
                            <button type="submit" class="btn btn-primary" style="width: 100%;">
                                üíæ Enregistrer le coefficient
                            </button>
                        </form>
                    </div>
                    
                    <!-- Future sections placeholder -->
                    <div style="background: var(--light); padding: var(--space-xl); border-radius: var(--radius-lg); text-align: center; color: var(--gray);">
                        <p>üöÄ D'autres param√®tres seront ajout√©s prochainement</p>
                        <small>Th√®mes, notifications, sauvegardes automatiques, etc.</small>
                    </div>
                    
                    <!-- Version & Diagnostic -->
                    <div style="background:white;padding:var(--space-xl);border-radius:var(--radius-lg);box-shadow:var(--shadow-sm);margin-top:var(--space-xl);">
                        <h2 style="margin-bottom:var(--space-md);font-family:var(--font-display);">‚ÑπÔ∏è Version & Diagnostic</h2>
                        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:var(--space-md);margin-bottom:var(--space-lg);">
                            <div style="background:var(--light);padding:var(--space-md);border-radius:var(--radius-md);text-align:center;">
                                <div style="font-size:11px;font-weight:700;text-transform:uppercase;color:var(--gray);margin-bottom:4px;">Version App</div>
                                <div style="font-size:20px;font-weight:800;color:var(--primary);">v55.6-POLISH</div>
                            </div>
                            <div style="background:var(--light);padding:var(--space-md);border-radius:var(--radius-md);text-align:center;">
                                <div style="font-size:11px;font-weight:700;text-transform:uppercase;color:var(--gray);margin-bottom:4px;">Schema Version</div>
                                <div style="font-size:20px;font-weight:800;color:var(--secondary);">55.6</div>
                            </div>
                            <div style="background:var(--light);padding:var(--space-md);border-radius:var(--radius-md);text-align:center;">
                                <div style="font-size:11px;font-weight:700;text-transform:uppercase;color:var(--gray);margin-bottom:4px;">Build Date</div>
                                <div style="font-size:20px;font-weight:800;color:var(--dark);">2026-02-10</div>
                            </div>
                        </div>
                        <button class="btn" style="background:var(--info);color:white;width:100%;" onclick="exportDiagnostic()">
                            üìä Exporter diagnostic (sans donn√©es sensibles)
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('mainContent').innerHTML = html;
            
            // Handle exchange rates form
            document.getElementById('exchangeRatesForm').addEventListener('submit', handleSaveExchangeRates);
            
            // Handle overhead coefficient form
            document.getElementById('overheadForm').addEventListener('submit', handleSaveOverheadCoefficient);
        }
        
        function handleSaveExchangeRates(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            
            // Update rates
            appState.exchangeRates.GBP = Number(formData.get('GBP'));
            appState.exchangeRates.USD = Number(formData.get('USD'));
            
            // Save
            saveData();
            
            showToast('‚úÖ Taux de change enregistr√©s !', 'success');
        }
        
        function handleSaveOverheadCoefficient(e) {
            e.preventDefault();
            
            const coefficient = Number(document.getElementById('overheadCoefficient').value);
            const showDirectCost = document.getElementById('showDirectCost').checked;
            
            // Valider coefficient
            if (coefficient < 1 || coefficient > 5) {
                showToast('‚ùå Le coefficient doit √™tre entre 1.00 et 5.00', 'error');
                return;
            }
            
            // Initialiser settings si n'existe pas
            if (!appState.data.settings) {
                appState.data.settings = {};
            }
            
            // Update settings
            appState.data.settings.overheadCoefficient = coefficient;
            appState.data.settings.showDirectCost = showDirectCost;
            
            // Save
            saveData();
            
            showToast(`‚úÖ Coefficient ${coefficient.toFixed(2)} enregistr√© !`, 'success');
        }
        
        // ========================================
        // NAVIGATION
        // ========================================
        
        // Show page
        window.showPage = function(pageName) {
            appState.currentPage = pageName;
            
            // Update active nav
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('data-page') === pageName) {
                    link.classList.add('active');
                }
            });

            // Render page
            switch(pageName) {
                case 'dashboard':
                    renderDashboard();
                    break;
                case 'ingredients':
                    renderIngredientsPage();
                    break;
                case 'recipes':
                    renderRecipesPage();
                    break;
                case 'production':
                    renderProductionsPage();
                    break;
                case 'sales':
                    renderSalesPage();
                    break;
                case 'personnel':
                    renderPersonnelPage();
                    break;
                case 'packs':
                    renderPacksPage();
                    break;
                case 'profitability':
                    renderProfitabilityPage();
                    break;
                case 'settings':
                    renderSettingsPage();
                    break;
                case 'expenses':
                    renderExpensesPage();
                    break;
                case 'suppliers':
                    renderSuppliersPage();
                    break;
                case 'clients':
                    renderClientsPage();
                    break;
                default:
                    document.getElementById('mainContent').innerHTML = `<h1>${pageName} - En d√©veloppement...</h1>`;
            }
        };

        // Navigation
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const page = link.getAttribute('data-page');
                showPage(page);
            });
        });

        // Language switcher
        document.querySelectorAll('[data-lang]').forEach(btn => {
            btn.addEventListener('click', () => {
                const lang = btn.getAttribute('data-lang');
                appState.currentLang = lang;
                
                // Update active button
                btn.parentElement.querySelectorAll('button').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                // Update translations
                updateTranslations();
                renderDashboard();
            });
        });

        // Currency switcher
        document.querySelectorAll('[data-currency]').forEach(btn => {
            btn.addEventListener('click', () => {
                const currency = btn.getAttribute('data-currency');
                appState.currentCurrency = currency;
                
                // Update active button
                btn.parentElement.querySelectorAll('button').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                // Re-render to update currency
                renderDashboard();
            });
        });

        // Initialize app
        // Load W.E Salon de Th√© demo data
        window.loadDemoWE = function() {
            if (confirm('‚ö†Ô∏è Charger la d√©mo "Le Salon Moderne" ?\n\nCeci va remplacer toutes vos donn√©es par :\n- 21 ingr√©dients avec VRAIS PRIX EUR du march√©\n- 7 recettes COH√âRENTES (gaufres 1kg, nectars, cocktails)\n- Rendements R√âALISTES appliqu√©s\n- Co√ªts calcul√©s avec pertes\n\nContinuer ?')) {
                try {
                    // Vider localStorage
                    console.log('üßπ Nettoyage localStorage...');
                    localStorage.clear();
                    
                    // Convertir les donn√©es
                    const convertedIngredients = demoWESalon.ingredients.map(ing => Ingredient.fromJSON(ing));
                    const convertedRecipes = demoWESalon.recipes.map(rec => Recipe.fromJSON(rec));
                    const convertedProductions = demoWESalon.productions.map(prod => Production.fromJSON(prod));
                    
                    // Mettre √† jour appState
                    appState.data = {
                        ingredients: convertedIngredients,
                        recipes: convertedRecipes,
                        productions: convertedProductions,
                        sales: demoWESalon.sales || [],
                        expenses: demoWESalon.expenses || [],
                        categories: demoWESalon.categories || [],
                        suppliers: demoWESalon.suppliers || [],
                        clients: demoWESalon.clients || [],
                        lossHistory: demoWESalon.lossHistory || [],
                        movements: demoWESalon.movements || [],
                        vendors: demoWESalon.vendors || [],
                        staff: demoWESalon.staff || [],
                        packs: demoWESalon.packs || [],
                        settings: demoWESalon.settings || appState.data.settings || {}
                    };
                    
                    // Sauvegarder
                    saveData();
                    
                    // Recharger
                    showToast('‚úÖ D√©mo "Le Salon Moderne" charg√©e avec succ√®s !', 'success');
                    setTimeout(() => location.reload(), 1000);
                    
                } catch (error) {
                    console.error('Erreur chargement d√©mo:', error);
                    showToast('‚ùå Erreur: ' + error.message, 'error');
                }
            }
        };

        function initApp() {
            loadData();
            
            // Charger les taux de change personnalis√©s
            loadExchangeRates();
            
            // Initialiser automatiquement la base de 100 ingr√©dients si n√©cessaire
            initializeIngredientDatabase();
            
            // Load saved currency preference
            const savedCurrency = localStorage.getItem('selectedCurrency');
            if (savedCurrency && currencyFormats[savedCurrency]) {
                appState.currentCurrency = savedCurrency;
            }
            
            // Setup currency switcher
            document.querySelectorAll('[data-currency]').forEach(btn => {
                // Update active state on load
                if (btn.getAttribute('data-currency') === appState.currentCurrency) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
                
                // Add click handler
                btn.addEventListener('click', () => {
                    const newCurrency = btn.getAttribute('data-currency');
                    
                    // Update state
                    appState.currentCurrency = newCurrency;
                    
                    // Save preference
                    localStorage.setItem('selectedCurrency', newCurrency);
                    
                    // Update active button
                    document.querySelectorAll('[data-currency]').forEach(b => {
                        b.classList.remove('active');
                    });
                    btn.classList.add('active');
                    
                    // Re-render current page to update all amounts
                    const currentPage = appState.currentPage;
                    if (currentPage === 'dashboard') {
                        renderDashboard();
                    } else if (currentPage === 'ingredients') {
                        renderIngredientsPage();
                    } else if (currentPage === 'recipes') {
                        renderRecipesPage();
                    } else if (currentPage === 'production') {
                        renderProductionsPage();
                    } else if (currentPage === 'sales') {
                        renderSalesPage();
                    } else if (currentPage === 'expenses') {
                        renderExpensesPage();
                    } else if (currentPage === 'suppliers') {
                        renderSuppliersPage();
                    } else if (currentPage === 'clients') {
                        renderClientsPage();
                    }
                    
                    // Show toast
                    const currencyName = {
                        'EUR': 'Euro (‚Ç¨)',
                        'GBP': 'Livre Sterling (¬£)',
                        'USD': 'Dollar ($)'
                    };
                    showToast(`üí± Devise chang√©e : ${currencyName[newCurrency]}`, 'info');
                });
            });
            
            renderDashboard();
            updateAlertsBadge();
        }
        
        // ========================================
        // FONCTIONS UTILITAIRES v55.3
        // ========================================
        
        /**
         * Confirmation avant effacement de tous les ingr√©dients
         */
        window.confirmDeleteAllIngredients = function() {
            const count = (appState.data.ingredients || []).length;
            if (count === 0) {
                showToast('‚ÑπÔ∏è Aucun ingr√©dient √† effacer', 'info');
                return;
            }
            
            const confirmed = confirm(
                `‚ö†Ô∏è ATTENTION !\n\n` +
                `Vous √™tes sur le point de supprimer ${count} ingr√©dient${count > 1 ? 's' : ''}.\n\n` +
                `Cette action est IRR√âVERSIBLE.\n\n` +
                `Voulez-vous vraiment continuer ?`
            );
            
            if (confirmed) {
                appState.data.ingredients = [];
                StorageManager.save(appState.data);
                renderIngredientsPage();
                showToast(`‚úÖ ${count} ingr√©dient${count > 1 ? 's' : ''} supprim√©${count > 1 ? 's' : ''}`, 'success');
            }
        };
        
        /**
         * T√©l√©charger le mod√®le CSV vierge pour les ingr√©dients
         */
        window.downloadIngredientCSVTemplate = function() {
            // Version simplifi√©e avec seulement les champs essentiels
            const csvContent = [
                // En-t√™tes (6 colonnes seulement)
                'Nom,Cat√©gorie,Unit√©,Quantit√©,Prix (EUR),Fournisseur',
                // Exemples simples
                'Farine T45,Farines,kg,25,37.50,Metro',
                'Beurre doux,Mati√®res grasses,kg,5,40.00,Metro',
                'Sucre blanc,Sucres,kg,10,12.00,Metro',
                '≈íufs frais,Produits laitiers,pi√®ce,180,0.25,Ferme locale',
                'Lait entier,Produits laitiers,L,20,1.50,Lactalis',
                '',
                '# Instructions:',
                '# - Nom: Nom de l\'ingr√©dient',
                '# - Cat√©gorie: Farines, Sucres, Mati√®res grasses, Produits laitiers, etc.',
                '# - Unit√©: kg, g, L, ml, pi√®ce',
                '# - Quantit√©: Quantit√© du lot',
                '# - Prix (EUR): Prix total du lot en euros',
                '# - Fournisseur: Nom du fournisseur (optionnel)'
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'BFM_Modele_Simple_Ingredients.csv';
            link.click();
            
            showToast('üìÑ Mod√®le CSV simplifi√© t√©l√©charg√©', 'success');
        };
        
        /**
         * T√©l√©charger le mod√®le CSV vierge pour les recettes
         */
        window.downloadRecipeCSVTemplate = function() {
            const csvContent = [
                'Nom recette,Cat√©gorie,Rendement,Unit√©,Temps pr√©paration (min),Instructions,Ingr√©dients (ID:Quantit√©:Unit√© s√©par√©s par |)',
                'Croissant au beurre,Viennoiserie,10,pi√®ce,120,D√©trempe puis tourage 3 fois,ing_farine_t45:500:g|ing_beurre:250:g|ing_sucre:50:g',
                'Pain au chocolat,Viennoiserie,8,pi√®ce,130,D√©trempe puis tourage avec chocolat,ing_farine_t45:500:g|ing_beurre:200:g|ing_chocolat:100:g'
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'BFM_Modele_Recettes.csv';
            link.click();
            
            showToast('üìÑ Mod√®le CSV t√©l√©charg√©', 'success');
        };
        
        /**
         * Assistant d'import guid√© (wizard)
         */
        window.showImportWizard = function() {
            // State de l'assistant (GLOBAL pour √™tre accessible partout)
            window.wizardState = {
                step: 1,
                ingredients: [],
                currentIngredient: {}
            };
            
            // D√©finir les fonctions internes D'ABORD
            window.renderWizardStep = function(state) {
                const body = document.getElementById('wizardBody');
                
                if (state.step === 1) {
                    // √âtape 1 : Choix du mode
                    body.innerHTML = `
                        <div style="text-align: center; padding: var(--space-xl);">
                            <div style="font-size: 64px; margin-bottom: var(--space-lg);">üßô‚Äç‚ôÇÔ∏è</div>
                            <h2 style="margin-bottom: var(--space-md);">Bienvenue dans l'Assistant d'Import</h2>
                            <p style="color: var(--gray); font-size: 16px; margin-bottom: var(--space-xl); max-width: 500px; margin-left: auto; margin-right: auto;">
                                Choisissez votre mode d'import selon votre situation
                            </p>
                            
                            <!-- Choix du mode -->
                            <div style="display: grid; gap: var(--space-lg); max-width: 700px; margin: 0 auto var(--space-xl);">
                                <!-- Mode Rapide -->
                                <div onclick="selectWizardMode('quick')" style="cursor: pointer; padding: var(--space-lg); border: 3px solid var(--light); border-radius: var(--radius-lg); text-align: left; transition: all 0.3s; background: white;">
                                    <div style="display: flex; align-items: start; gap: var(--space-md);">
                                        <div style="font-size: 48px;">‚ö°</div>
                                        <div style="flex: 1;">
                                            <h3 style="margin: 0 0 var(--space-sm) 0; color: var(--primary);">Mode Rapide</h3>
                                            <p style="margin: 0 0 var(--space-sm) 0; color: var(--gray); font-size: 14px;">
                                                Pour tester ou importer rapidement
                                            </p>
                                            <div style="display: flex; gap: var(--space-md); font-size: 13px; color: var(--gray);">
                                                <span>üìù 5 champs</span>
                                                <span>‚è±Ô∏è 30 sec/produit</span>
                                            </div>
                                            <div style="margin-top: var(--space-sm); padding: var(--space-sm); background: #fff9e6; border-radius: var(--radius-sm); font-size: 13px;">
                                                ‚ö†Ô∏è Frais et DLC = valeurs par d√©faut
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Mode Facture (RECOMMAND√â) -->
                                <div onclick="selectWizardMode('invoice')" style="cursor: pointer; padding: var(--space-lg); border: 3px solid var(--success); border-radius: var(--radius-lg); text-align: left; transition: all 0.3s; background: linear-gradient(135deg, #f0fff4 0%, #ffffff 100%); position: relative;">
                                    <div style="position: absolute; top: -12px; right: 16px; background: var(--success); color: white; padding: 4px 12px; border-radius: 999px; font-size: 12px; font-weight: 600;">
                                        RECOMMAND√â
                                    </div>
                                    <div style="display: flex; align-items: start; gap: var(--space-md);">
                                        <div style="font-size: 48px;">üìÑ</div>
                                        <div style="flex: 1;">
                                            <h3 style="margin: 0 0 var(--space-sm) 0; color: var(--success);">Mode Facture</h3>
                                            <p style="margin: 0 0 var(--space-sm) 0; color: var(--gray); font-size: 14px;">
                                                Avec votre facture fournisseur sous les yeux
                                            </p>
                                            <div style="display: flex; gap: var(--space-md); font-size: 13px; color: var(--gray);">
                                                <span>üìù 8 champs</span>
                                                <span>‚è±Ô∏è 1 min/produit</span>
                                            </div>
                                            <div style="margin-top: var(--space-sm); padding: var(--space-sm); background: #e6f7ed; border-radius: var(--radius-sm); font-size: 13px;">
                                                ‚úÖ Donn√©es compl√®tes (frais, DLC r√©els)
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <button class="btn" style="background: var(--gray); color: white;" onclick="closeModal('importWizard')">
                                Annuler
                            </button>
                        </div>
                    `;
                } else if (state.step === 2) {
                    // √âtape 2 : Ajout d'ingr√©dients (adapt√© selon le mode)
                    const isInvoiceMode = state.mode === 'invoice';
                    const modeLabel = isInvoiceMode ? 'üìÑ Mode Facture' : '‚ö° Mode Rapide';
                    const modeHint = isInvoiceMode ? 'Gardez votre facture sous les yeux' : 'Import rapide avec valeurs par d√©faut';
                    
                    body.innerHTML = `
                        <div style="padding: var(--space-md);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-md);">
                                <div>
                                    <h3>üì¶ Ajout d'ingr√©dients</h3>
                                    <p style="font-size: 13px; color: var(--gray); margin: 4px 0 0 0;">${modeLabel} ‚Ä¢ ${modeHint}</p>
                                </div>
                                <span style="color: var(--gray);">${state.ingredients.length} ingr√©dient${state.ingredients.length > 1 ? 's' : ''} ajout√©${state.ingredients.length > 1 ? 's' : ''}</span>
                            </div>
                            
                            <!-- Formulaire adaptatif -->
                            <form id="wizardIngredientForm" style="background: var(--light); padding: var(--space-lg); border-radius: var(--radius-lg); margin-bottom: var(--space-lg);">
                                <!-- Ligne 1 : Nom + Cat√©gorie -->
                                <div class="form-row">
                                    <div class="form-group" style="flex: 2;">
                                        <label>Nom de l'ingr√©dient *</label>
                                        <input type="text" name="name" required placeholder="Ex: Farine T45">
                                    </div>
                                    <div class="form-group">
                                        <label>Cat√©gorie *</label>
                                        <select name="category" required>
                                            <option value="">Choisir...</option>
                                            <option value="Farines">Farines</option>
                                            <option value="Sucres">Sucres</option>
                                            <option value="Mati√®res grasses">Mati√®res grasses</option>
                                            <option value="Produits laitiers">Produits laitiers</option>
                                            <option value="≈íufs">≈íufs</option>
                                            <option value="Levures">Levures</option>
                                            <option value="Chocolats">Chocolats</option>
                                            <option value="Fruits">Fruits</option>
                                            <option value="√âpices">√âpices</option>
                                            <option value="Autre">Autre</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Ligne 2 : Quantit√© + Unit√© + Prix -->
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Quantit√© *</label>
                                        <input type="number" name="quantity" required min="0.01" step="0.01" placeholder="25">
                                    </div>
                                    <div class="form-group">
                                        <label>Unit√© *</label>
                                        <select name="unit" required>
                                            <option value="">Choisir...</option>
                                            <option value="kg">kg</option>
                                            <option value="g">g</option>
                                            <option value="L">L</option>
                                            <option value="ml">ml</option>
                                            <option value="piece">pi√®ce</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Prix HT (‚Ç¨) *</label>
                                        <input type="number" name="price" required min="0" step="0.01" placeholder="37.50">
                                    </div>
                                </div>
                                
                                ${isInvoiceMode ? `
                                    <!-- Mode Facture : Champs suppl√©mentaires -->
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label>Frais approche (‚Ç¨) *</label>
                                            <input type="number" name="approachCost" required min="0" step="0.01" placeholder="2.50" value="0">
                                            <small style="color: var(--gray); font-size: 12px;">Transport, livraison (sur facture)</small>
                                        </div>
                                        <div class="form-group" style="flex: 2;">
                                            <label>DLC *</label>
                                            <input type="date" name="dlc" required>
                                            <small style="color: var(--gray); font-size: 12px;">Date sur l'√©tiquette produit</small>
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label>Date r√©ception</label>
                                            <input type="date" name="receptionDate" value="${new Date().toISOString().split('T')[0]}">
                                        </div>
                                        <div class="form-group" style="flex: 2;">
                                            <label>Fournisseur</label>
                                            <input type="text" name="supplier" placeholder="Metro, Carrefour...">
                                        </div>
                                    </div>
                                ` : `
                                    <!-- Mode Rapide : Seul Fournisseur -->
                                    <div class="form-group">
                                        <label>Fournisseur (optionnel)</label>
                                        <input type="text" name="supplier" placeholder="Metro, Carrefour, Leclerc...">
                                    </div>
                                `}
                                
                                <div style="display: flex; gap: var(--space-md); margin-top: var(--space-md);">
                                    <button type="submit" class="btn btn-primary" style="flex: 1;">
                                        ‚ûï Ajouter cet ingr√©dient
                                    </button>
                                </div>
                            </form>
                            
                            <!-- Liste des ingr√©dients ajout√©s -->
                            ${state.ingredients.length > 0 ? `
                                <div style="background: white; border-radius: var(--radius-lg); padding: var(--space-md); margin-bottom: var(--space-lg);">
                                    <h4 style="margin-bottom: var(--space-md);">üìã Ingr√©dients ajout√©s</h4>
                                    <div style="display: flex; flex-direction: column; gap: var(--space-sm);">
                                        ${state.ingredients.map((ing, idx) => `
                                            <div style="display: flex; justify-content: space-between; align-items: center; padding: var(--space-sm); background: var(--light); border-radius: var(--radius-md);">
                                                <div>
                                                    <strong>${ing.name}</strong>
                                                    <span style="color: var(--gray); font-size: 14px; margin-left: var(--space-sm);">
                                                        ${ing.category} ‚Ä¢ ${ing.quantity} ${ing.unit} ‚Ä¢ ${ing.price}‚Ç¨
                                                    </span>
                                                </div>
                                                <button class="btn" style="background: var(--danger); color: white; padding: 6px 12px;" onclick="removeWizardIngredient(${idx})">
                                                    ‚úï
                                                </button>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : `
                                <div style="text-align: center; padding: var(--space-xl); color: var(--gray);">
                                    <div style="font-size: 48px; margin-bottom: var(--space-md);">üì¶</div>
                                    <p>Aucun ingr√©dient ajout√© pour le moment</p>
                                </div>
                            `}
                            
                            <!-- Boutons de navigation -->
                            <div style="display: flex; gap: var(--space-md); margin-top: var(--space-lg);">
                                <button class="btn" style="flex: 1; background: var(--gray); color: white;" onclick="previousWizardStep()">
                                    ‚Üê Retour
                                </button>
                                <button class="btn btn-primary" style="flex: 1;" onclick="finishWizard()" ${state.ingredients.length === 0 ? 'disabled' : ''}>
                                    ‚úÖ Terminer (${state.ingredients.length})
                                </button>
                            </div>
                        </div>
                    `;
                    
                    // Event listener pour le formulaire
                    document.getElementById('wizardIngredientForm').addEventListener('submit', (e) => {
                        e.preventDefault();
                        const formData = new FormData(e.target);
                        const ingredient = {
                            name: formData.get('name'),
                            category: formData.get('category'),
                            quantity: parseFloat(formData.get('quantity')),
                            unit: formData.get('unit'),
                            price: parseFloat(formData.get('price')),
                            supplier: formData.get('supplier') || ''
                        };
                        
                        // Champs suppl√©mentaires du mode facture
                        if (state.mode === 'invoice') {
                            ingredient.approachCost = parseFloat(formData.get('approachCost')) || 0;
                            ingredient.dlc = formData.get('dlc');
                            ingredient.receptionDate = formData.get('receptionDate') || new Date().toISOString().split('T')[0];
                        }
                        
                        state.ingredients.push(ingredient);
                        e.target.reset();
                        
                        // R√©initialiser la date de r√©ception √† aujourd'hui
                        if (state.mode === 'invoice') {
                            const receptionInput = e.target.querySelector('[name="receptionDate"]');
                            if (receptionInput) {
                                receptionInput.value = new Date().toISOString().split('T')[0];
                            }
                        }
                        
                        renderWizardStep(state);
                        showToast(`‚úÖ ${ingredient.name} ajout√© !`, 'success');
                    });
                }
            };
            
            window.selectWizardMode = function(mode) {
                window.wizardState.mode = mode;
                window.wizardState.step = 2;
                renderWizardStep(window.wizardState);
            };
            
            window.nextWizardStep = function() {
                window.wizardState.step++;
                renderWizardStep(window.wizardState);
            };
            
            window.previousWizardStep = function() {
                window.wizardState.step--;
                renderWizardStep(window.wizardState);
            };
            
            window.removeWizardIngredient = function(index) {
                window.wizardState.ingredients.splice(index, 1);
                renderWizardStep(window.wizardState);
                showToast('üóëÔ∏è Ingr√©dient retir√©', 'info');
            };
            
            window.finishWizard = function() {
                if (window.wizardState.ingredients.length === 0) {
                    showToast('‚ùå Ajoutez au moins un ingr√©dient', 'error');
                    return;
                }
                
                // Convertir en format BFM avec les BONS noms de propri√©t√©s
                const ingredients = window.wizardState.ingredients.map(ing => {
                    // Convertir unit√© en baseUnit
                    let baseUnit, quantityInBaseUnit;
                    if (ing.unit === 'kg') {
                        baseUnit = 'g';
                        quantityInBaseUnit = ing.quantity * 1000;
                    } else if (ing.unit === 'L') {
                        baseUnit = 'ml';
                        quantityInBaseUnit = ing.quantity * 1000;
                    } else {
                        baseUnit = ing.unit;
                        quantityInBaseUnit = ing.quantity;
                    }
                    
                    // Cr√©er le lot avec les BONS noms (selon Lot.js)
                    // Utiliser vraies valeurs si mode facture, sinon valeurs par d√©faut
                    const dlcDate = ing.dlc ? new Date(ing.dlc) : new Date(Date.now() + 365 * 24 * 60 * 60 * 1000);
                    const receptionDate = ing.receptionDate ? new Date(ing.receptionDate) : new Date();
                    const approachCost = ing.approachCost !== undefined ? ing.approachCost : 0;
                    
                    const lot = new Lot({
                        id: 'lot_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                        quantiteInitiale: quantityInBaseUnit,  // ‚úÖ Nom correct
                        quantite: quantityInBaseUnit,           // ‚úÖ Nom correct
                        prixTotal: ing.price,                   // ‚úÖ Nom correct
                        fraisApproche: approachCost,            // ‚úÖ Vraie valeur ou 0
                        dlc: dlcDate,                           // ‚úÖ Vraie DLC ou +1 an
                        dateReception: receptionDate,           // ‚úÖ Vraie date ou aujourd'hui
                        fournisseur: ing.supplier || '',        // ‚úÖ Nom correct
                        numeroLot: `WIZARD-${Date.now()}`,      // ‚úÖ Nom correct
                        receivedBy: ''                          // ‚úÖ Optionnel
                    });
                    
                    // Cr√©er l'ingr√©dient avec les BONS noms (selon Ingredient.js)
                    return new Ingredient({
                        id: 'ing_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                        name: ing.name,
                        category: ing.category,
                        baseUnit: baseUnit,                     // ‚úÖ g, ml, ou piece
                        displayUnit: ing.unit,                  // ‚úÖ kg, L, ou piece
                        yieldPercent: 100,                      // ‚úÖ Pas de perte par d√©faut
                        wasteType: '',                          // ‚úÖ Pas de d√©chet
                        alertBaseQty: baseUnit === 'g' ? 1000 : (baseUnit === 'ml' ? 1000 : 5),
                        lots: [lot]
                    });
                });
                
                // Ajouter √† la base
                appState.data.ingredients = appState.data.ingredients || [];
                appState.data.ingredients.push(...ingredients);
                StorageManager.save(appState.data);
                
                closeModal('importWizard');
                renderIngredientsPage();
                showToast(`‚úÖ ${ingredients.length} ingr√©dient${ingredients.length > 1 ? 's' : ''} import√©${ingredients.length > 1 ? 's' : ''} !`, 'success');
            };
            
            // Cr√©er le modal APR√àS avoir d√©fini toutes les fonctions
            const modal = document.createElement('div');
            modal.id = 'importWizard';
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
                    <div class="modal-header">
                        <h2>üßô Assistant d'Import</h2>
                        <button class="modal-close" onclick="closeModal('importWizard')">‚úï</button>
                    </div>
                    <div class="modal-body" id="wizardBody">
                        <!-- Contenu dynamique -->
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Maintenant on peut appeler renderWizardStep
            renderWizardStep(window.wizardState);
        };
        
        /**
         * Confirmation avant effacement de toutes les recettes
         */
        window.confirmDeleteAllRecipes = function() {
            const count = (appState.data.recipes || []).length;
            if (count === 0) {
                showToast('‚ÑπÔ∏è Aucune recette √† effacer', 'info');
                return;
            }
            
            const confirmed = confirm(
                `‚ö†Ô∏è ATTENTION !\n\n` +
                `Vous √™tes sur le point de supprimer ${count} recette${count > 1 ? 's' : ''}.\n\n` +
                `Cette action est IRR√âVERSIBLE.\n\n` +
                `Voulez-vous vraiment continuer ?`
            );
            
            if (confirmed) {
                appState.data.recipes = [];
                StorageManager.save(appState.data);
                renderRecipesPage();
                showToast(`‚úÖ ${count} recette${count > 1 ? 's' : ''} supprim√©e${count > 1 ? 's' : ''}`, 'success');
            }
        };

        // ========================================
        // FICHE INGR√âDIENT (Edit)
        // ========================================
        window.showEditIngredientModal = function(ingredientId) {
            const ing = appState.data.ingredients.find(i => i.id === ingredientId);
            if (!ing) return;
            const modal = document.createElement('div');
            modal.id = 'editIngModal';
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>‚úé Fiche : ${ing.name}</h2>
                        <button class="modal-close" onclick="closeModal('editIngModal')">‚úï</button>
                    </div>
                    <div class="modal-body">
                        <form id="editIngForm">
                            <input type="hidden" name="id" value="${ing.id}">
                            <div class="form-group"><label>Nom *</label>
                                <input type="text" name="name" value="${ing.name}" required></div>
                            <div class="form-row">
                                <div class="form-group"><label>Cat√©gorie</label>
                                    <input type="text" name="category" value="${ing.category || ''}"></div>
                                <div class="form-group"><label>Seuil alerte</label>
                                    <input type="number" name="alertBaseQty" value="${ing.alertBaseQty || 0}" min="0" step="0.01" inputmode="decimal"></div>
                            </div>
                            <div class="form-row">
                                <div class="form-group"><label>Rendement (%)</label>
                                    <input type="number" name="yieldPercent" value="${ing.yieldPercent || 100}" min="1" max="100" inputmode="decimal"></div>
                                <div class="form-group"><label>Type d√©chet</label>
                                    <input type="text" name="wasteType" value="${ing.wasteType || ''}"></div>
                            </div>
                            <div style="display:flex;gap:var(--space-md);margin-top:var(--space-lg);">
                                <button type="button" class="btn" style="flex:1" onclick="closeModal('editIngModal')">Annuler</button>
                                <button type="submit" class="btn btn-primary" style="flex:1">üíæ Enregistrer</button>
                            </div>
                        </form>
                    </div>
                </div>`;
            document.body.appendChild(modal);
            modal.querySelector('#editIngForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const fd = new FormData(e.target);
                const idx = appState.data.ingredients.findIndex(i => i.id === fd.get('id'));
                if (idx !== -1) {
                    appState.data.ingredients[idx].name = fd.get('name');
                    appState.data.ingredients[idx].category = fd.get('category');
                    appState.data.ingredients[idx].alertBaseQty = Number(fd.get('alertBaseQty')) || 0;
                    appState.data.ingredients[idx].yieldPercent = Number(fd.get('yieldPercent')) || 100;
                    appState.data.ingredients[idx].wasteType = fd.get('wasteType');
                    appState.data.ingredients[idx].updatedAt = new Date().toISOString();
                    saveData();
                    closeModal('editIngModal');
                    renderIngredientsPage();
                    showToast('‚úÖ Fiche mise √† jour', 'success');
                }
            });
        };

        // ========================================
        // MODULE D√âPENSES
        // ========================================

        /** Convertit n'importe quel type de date en string ISO (ex: "2026-01-09") */
        function dateStr(v) {
            if (!v) return "";
            if (typeof v === "string") return v;
            if (v instanceof Date) return v.toISOString();
            if (typeof v === "number") return new Date(v).toISOString();
            return String(v);
        }

        function renderExpensesPage() {
            const expenses = (appState.data.expenses || []).sort((a,b) => new Date(b.date) - new Date(a.date));
            const now = new Date();
            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
            const monthExpenses = expenses.filter(e => new Date(e.date) >= monthStart);
            const monthTotal = monthExpenses.reduce((s, e) => s + (e.amount || 0), 0);
            
            const CATEGORIES = ['Loyer','√ânergie','Salaires','√âquipement','Emballages','Livraison','Marketing','Assurance','Maintenance','Autre'];
            
            const filterMonth = document.getElementById('expFilterMonth') ? 
                document.getElementById('expFilterMonth').value : (now.getFullYear() + '-' + String(now.getMonth()+1).padStart(2,'0'));
            
            const displayExpenses = expenses.filter(e => {
                if (!filterMonth) return true;
                return dateStr(e.date).startsWith(filterMonth);
            });
            const displayTotal = displayExpenses.reduce((s,e) => s + (e.amount||0), 0);
            
            document.getElementById('mainContent').innerHTML = `
                <div class="page-header">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <div>
                            <h1 class="page-title">üí∏ D√©penses</h1>
                            <p class="page-subtitle">${expenses.length} d√©pense${expenses.length!==1?'s':''} ‚Ä¢ Mois en cours : ${formatCurrency(monthTotal)}</p>
                        </div>
                        <button class="btn btn-primary" onclick="showNewExpenseModal()">‚ûï Nouvelle d√©pense</button>
                    </div>
                </div>
                
                <!-- Filtres + total mois -->
                <div style="background:white;padding:var(--space-md);border-radius:var(--radius-lg);margin-bottom:var(--space-md);box-shadow:var(--shadow-sm);display:flex;gap:var(--space-md);align-items:center;flex-wrap:wrap;">
                    <div>
                        <label style="font-size:12px;font-weight:600;color:var(--gray);display:block;margin-bottom:4px;">Mois</label>
                        <input type="month" id="expFilterMonth" value="${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}" 
                            onchange="renderExpensesPage()" 
                            style="padding:10px 14px;border:2px solid var(--light);border-radius:var(--radius-md);font-family:var(--font-body);">
                    </div>
                    <div style="margin-left:auto;background:linear-gradient(135deg,#ff6b35,#ffe66d);padding:12px 24px;border-radius:var(--radius-lg);color:white;font-weight:700;">
                        Total affich√© : ${formatCurrency(displayTotal)}
                    </div>
                </div>
                
                <!-- Liste d√©penses -->
                ${displayExpenses.length === 0 ? `
                    <div style="text-align:center;padding:var(--space-xl);background:white;border-radius:var(--radius-lg);">
                        <div style="font-size:56px;margin-bottom:var(--space-md);">üí∏</div>
                        <h3>Aucune d√©pense pour cette p√©riode</h3>
                        <p style="color:var(--gray);margin-bottom:var(--space-md);">Ajoutez vos charges fixes et variables</p>
                        <button class="btn btn-primary" onclick="showNewExpenseModal()">‚ûï Ajouter une d√©pense</button>
                    </div>
                ` : `
                    <div style="background:white;border-radius:var(--radius-lg);box-shadow:var(--shadow-sm);overflow:hidden;">
                        <table style="width:100%;border-collapse:collapse;">
                            <thead>
                                <tr style="background:var(--light);">
                                    <th style="padding:14px 16px;text-align:left;font-size:12px;text-transform:uppercase;color:var(--gray);">Date</th>
                                    <th style="padding:14px 16px;text-align:left;font-size:12px;text-transform:uppercase;color:var(--gray);">Libell√©</th>
                                    <th style="padding:14px 16px;text-align:left;font-size:12px;text-transform:uppercase;color:var(--gray);">Cat√©gorie</th>
                                    <th style="padding:14px 16px;text-align:right;font-size:12px;text-transform:uppercase;color:var(--gray);">Montant</th>
                                    <th style="padding:14px 16px;text-align:center;font-size:12px;text-transform:uppercase;color:var(--gray);">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${displayExpenses.map(e => `
                                    <tr style="border-top:1px solid var(--light);transition:background 0.2s;" onmouseover="this.style.background='#f9f9f9'" onmouseout="this.style.background=''">
                                        <td style="padding:12px 16px;font-size:14px;">${new Date(e.date).toLocaleDateString('fr-FR')}</td>
                                        <td style="padding:12px 16px;font-weight:600;">${e.label || e.description || '‚Äî'}</td>
                                        <td style="padding:12px 16px;">
                                            <span style="background:var(--light);padding:4px 10px;border-radius:12px;font-size:12px;font-weight:600;">${e.category || 'Autre'}</span>
                                        </td>
                                        <td style="padding:12px 16px;text-align:right;font-weight:700;color:var(--danger);">${formatCurrency(e.amount || 0)}</td>
                                        <td style="padding:12px 16px;text-align:center;">
                                            <button onclick="editExpense('${e.id}')" style="background:none;border:none;cursor:pointer;font-size:18px;margin:0 4px;" title="Modifier">‚úèÔ∏è</button>
                                            <button onclick="deleteExpense('${e.id}')" style="background:none;border:none;cursor:pointer;font-size:18px;margin:0 4px;" title="Supprimer">üóëÔ∏è</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `}
            `;
        }
        
        window.showNewExpenseModal = function() {
            const modal = document.createElement('div');
            modal.id = 'newExpenseModal'; modal.className = 'modal';
            const today = new Date().toISOString().split('T')[0];
            const cats = ['Loyer','√ânergie','Salaires','√âquipement','Emballages','Livraison','Marketing','Assurance','Maintenance','Autre'];
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>üí∏ Nouvelle d√©pense</h2>
                        <button class="modal-close" onclick="closeModal('newExpenseModal')">‚úï</button>
                    </div>
                    <div class="modal-body">
                        <form id="newExpenseForm">
                            <div class="form-group"><label>Libell√© *</label>
                                <input type="text" id="expLabel" required placeholder="Ex: Loyer janvier"></div>
                            <div class="form-row">
                                <div class="form-group"><label>Cat√©gorie *</label>
                                    <select id="expCat" required>
                                        ${cats.map(c => `<option value="${c}">${c}</option>`).join('')}
                                    </select>
                                </div>
                                <div class="form-group"><label>Date *</label>
                                    <input type="date" id="expDate" value="${today}" required></div>
                            </div>
                            <div class="form-group"><label>Montant (${appState.currentCurrency}) *</label>
                                <input type="number" id="expAmount" required min="0.01" step="0.01" inputmode="decimal" placeholder="0.00"></div>
                            <div class="form-group"><label>Notes</label>
                                <textarea id="expNotes" rows="2" style="width:100%;padding:12px;border:2px solid var(--light);border-radius:var(--radius-md);font-family:var(--font-body);" placeholder="Informations compl√©mentaires..."></textarea></div>
                            <div style="display:flex;gap:var(--space-md);margin-top:var(--space-lg);">
                                <button type="button" class="btn" style="flex:1" onclick="closeModal('newExpenseModal')">Annuler</button>
                                <button type="submit" class="btn btn-primary" style="flex:1">üíæ Enregistrer</button>
                            </div>
                        </form>
                    </div>
                </div>`;
            document.body.appendChild(modal);
            modal.querySelector('#newExpenseForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const label = document.getElementById('expLabel').value;
                const amount = Number(document.getElementById('expAmount').value);
                if (!confirm(`Confirmer l'enregistrement ?\n\nüìù ${label}\nüí∞ ${formatCurrency(amount)}`)) return;
                const exp = {
                    id: 'exp_' + Date.now(),
                    label: label,
                    category: document.getElementById('expCat').value,
                    date: dateStr(document.getElementById('expDate').value).slice(0, 10),
                    amount: amount,
                    currency: appState.currentCurrency,
                    notes: document.getElementById('expNotes').value,
                    createdAt: new Date().toISOString()
                };
                if (!appState.data.expenses) appState.data.expenses = [];
                appState.data.expenses.push(exp);
                saveData();
                closeModal('newExpenseModal');
                renderExpensesPage();
                showToast('‚úÖ D√©pense enregistr√©e', 'success');
            });
        };
        
        window.editExpense = function(id) {
            const exp = (appState.data.expenses || []).find(e => e.id === id);
            if (!exp) return;
            const cats = ['Loyer','√ânergie','Salaires','√âquipement','Emballages','Livraison','Marketing','Assurance','Maintenance','Autre'];
            const modal = document.createElement('div');
            modal.id = 'editExpenseModal'; modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>‚úèÔ∏è Modifier d√©pense</h2>
                        <button class="modal-close" onclick="closeModal('editExpenseModal')">‚úï</button>
                    </div>
                    <div class="modal-body">
                        <form id="editExpenseForm">
                            <input type="hidden" id="editExpId" value="${exp.id}">
                            <div class="form-group"><label>Libell√© *</label>
                                <input type="text" id="editExpLabel" value="${exp.label || exp.description || ''}" required></div>
                            <div class="form-row">
                                <div class="form-group"><label>Cat√©gorie</label>
                                    <select id="editExpCat">
                                        ${cats.map(c => `<option value="${c}" ${exp.category===c?'selected':''}>${c}</option>`).join('')}
                                    </select>
                                </div>
                                <div class="form-group"><label>Date *</label>
                                    <input type="date" id="editExpDate" value="${exp.date || ''}" required></div>
                            </div>
                            <div class="form-group"><label>Montant *</label>
                                <input type="number" id="editExpAmount" value="${exp.amount || 0}" required min="0.01" step="0.01" inputmode="decimal"></div>
                            <div style="display:flex;gap:var(--space-md);margin-top:var(--space-lg);">
                                <button type="button" class="btn" style="flex:1" onclick="closeModal('editExpenseModal')">Annuler</button>
                                <button type="submit" class="btn btn-primary" style="flex:1">üíæ Enregistrer</button>
                            </div>
                        </form>
                    </div>
                </div>`;
            document.body.appendChild(modal);
            modal.querySelector('#editExpenseForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const idx = (appState.data.expenses||[]).findIndex(ex => ex.id === document.getElementById('editExpId').value);
                if (idx !== -1) {
                    const label = document.getElementById('editExpLabel').value;
                    const amount = Number(document.getElementById('editExpAmount').value);
                    if (!confirm(`Confirmer la modification ?\n\nüìù ${label}\nüí∞ ${formatCurrency(amount)}`)) return;
                    appState.data.expenses[idx].label = label;
                    appState.data.expenses[idx].category = document.getElementById('editExpCat').value;
                    appState.data.expenses[idx].date = dateStr(document.getElementById('editExpDate').value).slice(0, 10);
                    appState.data.expenses[idx].amount = amount;
                    saveData(); closeModal('editExpenseModal'); renderExpensesPage();
                    showToast('‚úÖ D√©pense modifi√©e', 'success');
                }
            });
        };
        
        window.deleteExpense = function(id) {
            if (!confirm('Supprimer cette d√©pense ?')) return;
            appState.data.expenses = (appState.data.expenses||[]).filter(e => e.id !== id);
            saveData(); renderExpensesPage();
            showToast('üóëÔ∏è D√©pense supprim√©e', 'success');
        };
        
        // ========================================
        // MODULE FOURNISSEURS
        // ========================================
        function renderSuppliersPage() {
            const suppliers = appState.data.suppliers || [];
            document.getElementById('mainContent').innerHTML = `
                <div class="page-header">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <div>
                            <h1 class="page-title">üöö Fournisseurs</h1>
                            <p class="page-subtitle">${suppliers.length} fournisseur${suppliers.length!==1?'s':''}</p>
                        </div>
                        <div style="display:flex;gap:var(--space-sm);">
                            <button class="btn" style="background:var(--secondary);color:white;" onclick="exportSuppliers()">üì§ Exporter</button>
                            <button class="btn btn-primary" onclick="showNewSupplierModal()">‚ûï Nouveau fournisseur</button>
                        </div>
                    </div>
                </div>
                
                ${suppliers.length === 0 ? `
                    <div style="text-align:center;padding:var(--space-xl);background:white;border-radius:var(--radius-lg);">
                        <div style="font-size:56px;margin-bottom:var(--space-md);">üöö</div>
                        <h3>Aucun fournisseur</h3>
                        <p style="color:var(--gray);margin-bottom:var(--space-md);">Ajoutez vos fournisseurs pour g√©rer vos approvisionnements</p>
                        <button class="btn btn-primary" onclick="showNewSupplierModal()">‚ûï Ajouter un fournisseur</button>
                    </div>
                ` : `
                    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:var(--space-md);">
                        ${suppliers.map(s => `
                            <div class="ingredient-card">
                                <div class="ingredient-header">
                                    <div>
                                        <h3 class="ingredient-name">üöö ${s.name}</h3>
                                        <span class="ingredient-category">${s.category || 'G√©n√©ral'}</span>
                                    </div>
                                </div>
                                <div style="font-size:13px;color:var(--gray);margin-bottom:var(--space-sm);">
                                    ${s.contact ? `<div>üë§ ${s.contact}</div>` : ''}
                                    ${s.phone ? `<div>üìû ${s.phone}</div>` : ''}
                                    ${s.email ? `<div>üìß ${s.email}</div>` : ''}
                                    ${s.address ? `<div>üìç ${s.address}</div>` : ''}
                                </div>
                                ${s.notes ? `<div style="font-size:12px;color:var(--gray);font-style:italic;margin-bottom:var(--space-sm);">${s.notes}</div>` : ''}
                                <div class="ingredient-actions">
                                    <button class="action-btn" onclick="editSupplier('${s.id}')" title="Modifier">‚úèÔ∏è</button>
                                    <button class="action-btn" onclick="deleteSupplier('${s.id}')" title="Supprimer" style="color:var(--danger);">üóëÔ∏è</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `}
            `;
        }
        
        window.showNewSupplierModal = function() {
            const modal = document.createElement('div');
            modal.id = 'newSupplierModal'; modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>üöö Nouveau fournisseur</h2>
                        <button class="modal-close" onclick="closeModal('newSupplierModal')">‚úï</button>
                    </div>
                    <div class="modal-body">
                        <form id="newSupplierForm">
                            <div class="form-group"><label>Nom *</label>
                                <input type="text" id="supName" required placeholder="Ex: Metro France"></div>
                            <div class="form-row">
                                <div class="form-group"><label>Cat√©gorie</label>
                                    <select id="supCat">
                                        <option value="Grossiste">Grossiste</option>
                                        <option value="Producteur">Producteur local</option>
                                        <option value="√âpicerie">√âpicerie / Cash</option>
                                        <option value="Boucherie">Boucherie</option>
                                        <option value="March√©">March√©</option>
                                        <option value="Autre">Autre</option>
                                    </select>
                                </div>
                                <div class="form-group"><label>Contact</label>
                                    <input type="text" id="supContact" placeholder="Nom du repr√©sentant"></div>
                            </div>
                            <div class="form-row">
                                <div class="form-group"><label>T√©l√©phone</label>
                                    <input type="tel" id="supPhone"></div>
                                <div class="form-group"><label>Email</label>
                                    <input type="email" id="supEmail"></div>
                            </div>
                            <div class="form-group"><label>Adresse</label>
                                <input type="text" id="supAddress"></div>
                            <div class="form-group"><label>Notes</label>
                                <textarea id="supNotes" rows="2" style="width:100%;padding:12px;border:2px solid var(--light);border-radius:var(--radius-md);font-family:var(--font-body);"></textarea></div>
                            <div style="display:flex;gap:var(--space-md);margin-top:var(--space-lg);">
                                <button type="button" class="btn" style="flex:1" onclick="closeModal('newSupplierModal')">Annuler</button>
                                <button type="submit" class="btn btn-primary" style="flex:1">üíæ Enregistrer</button>
                            </div>
                        </form>
                    </div>
                </div>`;
            document.body.appendChild(modal);
            modal.querySelector('#newSupplierForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const sup = {
                    id: 'sup_' + Date.now(),
                    name: document.getElementById('supName').value,
                    category: document.getElementById('supCat').value,
                    contact: document.getElementById('supContact').value,
                    phone: document.getElementById('supPhone').value,
                    email: document.getElementById('supEmail').value,
                    address: document.getElementById('supAddress').value,
                    notes: document.getElementById('supNotes').value,
                    createdAt: new Date().toISOString()
                };
                if (!appState.data.suppliers) appState.data.suppliers = [];
                appState.data.suppliers.push(sup);
                saveData(); closeModal('newSupplierModal'); renderSuppliersPage();
                showToast('‚úÖ Fournisseur ajout√©', 'success');
            });
        };
        
        window.editSupplier = function(id) {
            const s = (appState.data.suppliers||[]).find(x => x.id === id);
            if (!s) return;
            const modal = document.createElement('div');
            modal.id = 'editSupplierModal'; modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header"><h2>‚úèÔ∏è Modifier fournisseur</h2>
                        <button class="modal-close" onclick="closeModal('editSupplierModal')">‚úï</button></div>
                    <div class="modal-body">
                        <form id="editSupplierForm">
                            <input type="hidden" id="editSupId" value="${s.id}">
                            <div class="form-group"><label>Nom *</label><input type="text" id="editSupName" value="${s.name}" required></div>
                            <div class="form-row">
                                <div class="form-group"><label>Contact</label><input type="text" id="editSupContact" value="${s.contact||''}"></div>
                                <div class="form-group"><label>T√©l√©phone</label><input type="tel" id="editSupPhone" value="${s.phone||''}"></div>
                            </div>
                            <div class="form-row">
                                <div class="form-group"><label>Email</label><input type="email" id="editSupEmail" value="${s.email||''}"></div>
                                <div class="form-group"><label>Adresse</label><input type="text" id="editSupAddress" value="${s.address||''}"></div>
                            </div>
                            <div class="form-group"><label>Notes</label>
                                <textarea id="editSupNotes" rows="2" style="width:100%;padding:12px;border:2px solid var(--light);border-radius:var(--radius-md);font-family:var(--font-body);">${s.notes||''}</textarea></div>
                            <div style="display:flex;gap:var(--space-md);margin-top:var(--space-lg);">
                                <button type="button" class="btn" style="flex:1" onclick="closeModal('editSupplierModal')">Annuler</button>
                                <button type="submit" class="btn btn-primary" style="flex:1">üíæ Enregistrer</button>
                            </div>
                        </form>
                    </div>
                </div>`;
            document.body.appendChild(modal);
            modal.querySelector('#editSupplierForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const idx = (appState.data.suppliers||[]).findIndex(x => x.id === document.getElementById('editSupId').value);
                if (idx !== -1) {
                    appState.data.suppliers[idx] = {
                        ...appState.data.suppliers[idx],
                        name: document.getElementById('editSupName').value,
                        contact: document.getElementById('editSupContact').value,
                        phone: document.getElementById('editSupPhone').value,
                        email: document.getElementById('editSupEmail').value,
                        address: document.getElementById('editSupAddress').value,
                        notes: document.getElementById('editSupNotes').value
                    };
                    saveData(); closeModal('editSupplierModal'); renderSuppliersPage();
                    showToast('‚úÖ Fournisseur modifi√©', 'success');
                }
            });
        };
        
        window.deleteSupplier = function(id) {
            if (!confirm('Supprimer ce fournisseur ?')) return;
            appState.data.suppliers = (appState.data.suppliers||[]).filter(s => s.id !== id);
            saveData(); renderSuppliersPage();
            showToast('üóëÔ∏è Fournisseur supprim√©', 'success');
        };
        
        window.exportSuppliers = function() {
            const suppliers = appState.data.suppliers || [];
            const rows = [['Nom','Cat√©gorie','Contact','T√©l√©phone','Email','Adresse','Notes']];
            suppliers.forEach(s => rows.push([s.name||'',s.category||'',s.contact||'',s.phone||'',s.email||'',s.address||'',s.notes||'']));
            const csv = rows.map(r => r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
            const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
            a.download = 'BFM_Fournisseurs.csv'; a.click();
            showToast('üì§ Export fournisseurs t√©l√©charg√©', 'success');
        };
        
        // ========================================
        // MODULE CLIENTS
        // ========================================
        function renderClientsPage() {
            const clients = appState.data.clients || [];
            const sales = appState.data.sales || [];
            
            document.getElementById('mainContent').innerHTML = `
                <div class="page-header">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <div>
                            <h1 class="page-title">üë§ Clients</h1>
                            <p class="page-subtitle">${clients.length} client${clients.length!==1?'s':''}</p>
                        </div>
                        <div style="display:flex;gap:var(--space-sm);">
                            <button class="btn" style="background:var(--secondary);color:white;" onclick="exportClients()">üì§ Exporter</button>
                            <button class="btn btn-primary" onclick="showNewClientModal()">‚ûï Nouveau client</button>
                        </div>
                    </div>
                </div>
                
                ${clients.length === 0 ? `
                    <div style="text-align:center;padding:var(--space-xl);background:white;border-radius:var(--radius-lg);">
                        <div style="font-size:56px;margin-bottom:var(--space-md);">üë§</div>
                        <h3>Aucun client enregistr√©</h3>
                        <p style="color:var(--gray);margin-bottom:var(--space-md);">G√©rez vos clients professionnels et habituels</p>
                        <button class="btn btn-primary" onclick="showNewClientModal()">‚ûï Ajouter un client</button>
                    </div>
                ` : `
                    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:var(--space-md);">
                        ${clients.map(c => {
                            const clientSales = sales.filter(s => s.clientId === c.id);
                            const totalCA = clientSales.reduce((sum, s) => sum + (s.revenue || 0), 0);
                            return `
                                <div class="ingredient-card">
                                    <div class="ingredient-header">
                                        <div>
                                            <h3 class="ingredient-name">üë§ ${c.name}</h3>
                                            <span class="ingredient-category">${(c.tags||[]).join(', ') || 'Client'}</span>
                                        </div>
                                        ${totalCA > 0 ? `<div style="font-weight:700;color:var(--success);">${formatCurrency(totalCA)}</div>` : ''}
                                    </div>
                                    <div style="font-size:13px;color:var(--gray);margin-bottom:var(--space-sm);">
                                        ${c.phone ? `<div>üìû ${c.phone}</div>` : ''}
                                        ${c.email ? `<div>üìß ${c.email}</div>` : ''}
                                        ${clientSales.length > 0 ? `<div>üõí ${clientSales.length} commande${clientSales.length!==1?'s':''}</div>` : ''}
                                    </div>
                                    ${c.notes ? `<div style="font-size:12px;color:var(--gray);font-style:italic;margin-bottom:var(--space-sm);">${c.notes}</div>` : ''}
                                    <div class="ingredient-actions">
                                        <button class="action-btn" onclick="editClient('${c.id}')" title="Modifier">‚úèÔ∏è</button>
                                        <button class="action-btn" onclick="deleteClient('${c.id}')" title="Supprimer" style="color:var(--danger);">üóëÔ∏è</button>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `}
            `;
        }
        
        window.showNewClientModal = function() {
            const modal = document.createElement('div');
            modal.id = 'newClientModal'; modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header"><h2>üë§ Nouveau client</h2>
                        <button class="modal-close" onclick="closeModal('newClientModal')">‚úï</button></div>
                    <div class="modal-body">
                        <form id="newClientForm">
                            <div class="form-group"><label>Nom / Raison sociale *</label>
                                <input type="text" id="cliName" required placeholder="Ex: Restaurant Le Gourmet"></div>
                            <div class="form-row">
                                <div class="form-group"><label>T√©l√©phone</label><input type="tel" id="cliPhone"></div>
                                <div class="form-group"><label>Email</label><input type="email" id="cliEmail"></div>
                            </div>
                            <div class="form-group"><label>Tags (s√©par√©s par virgule)</label>
                                <input type="text" id="cliTags" placeholder="VIP, Professionnel, Habituel"></div>
                            <div class="form-group"><label>Notes</label>
                                <textarea id="cliNotes" rows="2" style="width:100%;padding:12px;border:2px solid var(--light);border-radius:var(--radius-md);font-family:var(--font-body);"></textarea></div>
                            <div style="display:flex;gap:var(--space-md);margin-top:var(--space-lg);">
                                <button type="button" class="btn" style="flex:1" onclick="closeModal('newClientModal')">Annuler</button>
                                <button type="submit" class="btn btn-primary" style="flex:1">üíæ Enregistrer</button>
                            </div>
                        </form>
                    </div>
                </div>`;
            document.body.appendChild(modal);
            modal.querySelector('#newClientForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const cli = {
                    id: 'cli_' + Date.now(),
                    name: document.getElementById('cliName').value,
                    phone: document.getElementById('cliPhone').value,
                    email: document.getElementById('cliEmail').value,
                    tags: document.getElementById('cliTags').value.split(',').map(t=>t.trim()).filter(Boolean),
                    notes: document.getElementById('cliNotes').value,
                    createdAt: new Date().toISOString()
                };
                if (!appState.data.clients) appState.data.clients = [];
                appState.data.clients.push(cli);
                saveData(); closeModal('newClientModal'); renderClientsPage();
                showToast('‚úÖ Client ajout√©', 'success');
            });
        };
        
        window.editClient = function(id) {
            const c = (appState.data.clients||[]).find(x => x.id === id);
            if (!c) return;
            const modal = document.createElement('div');
            modal.id = 'editClientModal'; modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header"><h2>‚úèÔ∏è Modifier client</h2>
                        <button class="modal-close" onclick="closeModal('editClientModal')">‚úï</button></div>
                    <div class="modal-body">
                        <form id="editClientForm">
                            <input type="hidden" id="editCliId" value="${c.id}">
                            <div class="form-group"><label>Nom *</label><input type="text" id="editCliName" value="${c.name}" required></div>
                            <div class="form-row">
                                <div class="form-group"><label>T√©l√©phone</label><input type="tel" id="editCliPhone" value="${c.phone||''}"></div>
                                <div class="form-group"><label>Email</label><input type="email" id="editCliEmail" value="${c.email||''}"></div>
                            </div>
                            <div class="form-group"><label>Tags</label><input type="text" id="editCliTags" value="${(c.tags||[]).join(', ')}"></div>
                            <div class="form-group"><label>Notes</label>
                                <textarea id="editCliNotes" rows="2" style="width:100%;padding:12px;border:2px solid var(--light);border-radius:var(--radius-md);font-family:var(--font-body);">${c.notes||''}</textarea></div>
                            <div style="display:flex;gap:var(--space-md);margin-top:var(--space-lg);">
                                <button type="button" class="btn" style="flex:1" onclick="closeModal('editClientModal')">Annuler</button>
                                <button type="submit" class="btn btn-primary" style="flex:1">üíæ Enregistrer</button>
                            </div>
                        </form>
                    </div>
                </div>`;
            document.body.appendChild(modal);
            modal.querySelector('#editClientForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const idx = (appState.data.clients||[]).findIndex(x => x.id === document.getElementById('editCliId').value);
                if (idx !== -1) {
                    appState.data.clients[idx] = {
                        ...appState.data.clients[idx],
                        name: document.getElementById('editCliName').value,
                        phone: document.getElementById('editCliPhone').value,
                        email: document.getElementById('editCliEmail').value,
                        tags: document.getElementById('editCliTags').value.split(',').map(t=>t.trim()).filter(Boolean),
                        notes: document.getElementById('editCliNotes').value
                    };
                    saveData(); closeModal('editClientModal'); renderClientsPage();
                    showToast('‚úÖ Client modifi√©', 'success');
                }
            });
        };
        
        window.deleteClient = function(id) {
            if (!confirm('Supprimer ce client ?')) return;
            appState.data.clients = (appState.data.clients||[]).filter(c => c.id !== id);
            saveData(); renderClientsPage();
            showToast('üóëÔ∏è Client supprim√©', 'success');
        };
        
        window.exportClients = function() {
            const clients = appState.data.clients || [];
            const rows = [['Nom','T√©l√©phone','Email','Tags','Notes']];
            clients.forEach(c => rows.push([c.name||'',c.phone||'',c.email||'',(c.tags||[]).join('|'),c.notes||'']));
            const csv = rows.map(r => r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
            const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
            a.download = 'BFM_Clients.csv'; a.click();
            showToast('üì§ Export clients t√©l√©charg√©', 'success');
        };

        // ========================================
        // DIAGNOSTIC & VERSION
        // ========================================
        window.exportDiagnostic = function() {
            const diag = {
                version: 'v55.6-POLISH',
                schemaVersion: '55.6',
                buildDate: '2026-02-10',
                timestamp: new Date().toISOString(),
                counts: {
                    ingredients: (appState.data.ingredients||[]).length,
                    recipes: (appState.data.recipes||[]).length,
                    productions: (appState.data.productions||[]).length,
                    sales: (appState.data.sales||[]).length,
                    expenses: (appState.data.expenses||[]).length,
                    suppliers: (appState.data.suppliers||[]).length,
                    clients: (appState.data.clients||[]).length,
                    staff: (appState.data.staff||[]).length,
                    lossHistory: (appState.data.lossHistory||[]).length
                },
                currency: appState.currentCurrency,
                lang: appState.currentLang
            };
            const blob = new Blob([JSON.stringify(diag, null, 2)], {type:'application/json'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
            a.download = 'BFM_Diagnostic.json'; a.click();
            showToast('üìä Diagnostic export√©', 'success');
        };

        // Start app
        initApp();
    </script>
</body>
</html>
